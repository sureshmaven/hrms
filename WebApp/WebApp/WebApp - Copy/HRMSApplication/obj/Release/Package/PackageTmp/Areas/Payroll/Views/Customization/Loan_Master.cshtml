
@{
    ViewBag.Title = "Loan_Master";
    Layout = "~/Areas/Payroll/Views/Shared/_PayrollLayout.cshtml";
}

<div class="page">
    <div class="form-horizontal form-horizontal2">
        <div class="page_start">
            <div class="leftmenu-container">
                <div class="sidebar-menu">
                    <div class="main_heading left-menu">
                        @{Html.RenderPartial("_PVPayrollMenu");}
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="main_heading">
                        <h1>Loans Structure</h1>
                        @*@{ Html.RenderPartial("_pvEmployeeSearch"); }*@
                        <input type="hidden" id="hdnEmpCode" />
                        <div class="col-md-12">
                            <div class="pull-right mb_10">
                                <button id="addRow" class="btn btn-default"><i class="glyphicon glyphicon-plus"></i> Add</button>
                            </div>
                            <table id="Loan_Master" class="display" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Loan Description</th>
                                        <th>Interest Rate</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                            </table>
                            <br />
                            <div class="col-md-12">
                                <div class="pull-right">
                                    <button id="cancelData" class="btn btn-default">Cancel</button>
                                    <button type="button" id="updatGridData" class="btn btn-sm btn-primary">Update</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    var incIndex = 0;
    var originalData = [];
    var arrDelete = [];
    $(document).ready(function (respData) {

        $('#Loan_Master').DataTable({
            "paging": false,
            "sort": false,
            "searching": false,

            "language": {
                "emptyTable": "No data available. Please enter employee code and search"
            }
        });
       
        CommonApiGET('/Payroll/Customization/GetLoans_MasterData', function (respData) {
       
            orgCancelData = respData;
            fillDataTables(respData);
        });
    });



    function fillDataTables(respData) {

        var LoanMaster = respData;
        $('#Loan_Master').DataTable({
            destroy: true,
            "paging": false,
            "ordering": false,
            "info": false,
            "bFilter": false,
            data: LoanMaster,
            "columns": [
                {
                    "mData": null,
                    "bSortable": false,
                    "mRender": function (data, type, full) {
                        return getColumnTextbox('*' + data.id, data.loan_id);
                    }
                },
                {
                    "mData": null,
                    "bSortable": false,
                    "mRender": function (data, type, full) {
                        return getColumnTextbox('ldes', data.loan_description);
                    }
                },
                {
                    "mData": null,
                    "bSortable": false,
                    "mRender": function (data, type, full) {
                        return getColumnNumber('intrate', data.interest_rate);
                    }
                },
                {
                    "mData": null,
                    "bSortable": false,
                    "mRender": function (data, type, full) {
                       
                        return getColumnButton(data.id, data.Action);
                    }
                },
               
            ],
            "order": [[1, 'asc']]
        });
    }



    $('#addRow').click(function () {
     
        var table = $('#Loan_Master').DataTable();
        var updateData = decodeURIComponent(table.$('input, select').serializeAndEncode());
        var arrUpdate = updateData.split("*");
        var arrSampleObJ = [];
        arrUpdate.forEach(function (element) {
          
            if (element != "") {
                var objEf = {};
                var strRow = element.split("&");
                var id = strRow[0].split("=");
                objEf.id = id[0];
                objEf.loan_id = id[1];

                var ldes = strRow[1].split("=");
                objEf.loan_description = ldes[1];

                var intrate = strRow[2].split("=");
                objEf.interest_rate = intrate[1];

                //var payMonth = strRow[3].split("=");
                //objEf.PayMonths = payMonth[1];

                //var startMonth = strRow[4].split("=");
                //objEf.StartMonth = startMonth[1];

                //var stopMonth = strRow[5].split("=");
                //objEf.StopMonth = stopMonth[1];

                if (isNaN(id[0])) {
                    objEf.Action = "Delete";
                } else {
                    objEf.Action = "Add";
                }
                arrSampleObJ.push(objEf);
            }
        });

        modifiedData = arrSampleObJ;

        incIndex++;
        var incId = "NeW" + incIndex;
        var row = {
            "id": incId,
            "loan_id": "",
            "loan_description": "",
            "interest_rate": "",
            "Action": "Delete"
        };
        modifiedData.push(row);
        fillDataTables(modifiedData);
    });




    function deleteRow(id) {

        var table = $('#Loan_Master').DataTable();
        var updateData = decodeURIComponent(table.$('input, select').serializeAndEncode());
        var arrUpdate = updateData.split("*");
        var arrSampleObJ = [];
        arrUpdate.forEach(function (element) {

            if (element != "") {

                var objEf = {};
                var strRow = element.split("&");
                var id = strRow[0].split("=");
                objEf.id = id[0];
                objEf.loan_id = id[1];

                var ldes = strRow[1].split("=");
                objEf.loan_description = ldes[1];

                var intrate = strRow[2].split("=");
                objEf.interest_rate = intrate[1];

                //var payMonth = strRow[3].split("=");
                //objEf.PayMonths = payMonth[1];

                //var startMonth = strRow[4].split("=");
                //objEf.StartMonth = startMonth[1];

                //var stopMonth = strRow[5].split("=");
                //objEf.StopMonth = stopMonth[1];

                if (isNaN(id[0])) {
                    objEf.Action = "Delete";
                } else {
                    objEf.Action = "Add";
                }
                arrSampleObJ.push(objEf);
            }
        });

        modifiedData = arrSampleObJ;

        modifiedData = modifiedData.filter(function (obj) {
            return obj.id !== id;
        });

        fillDataTables(modifiedData);
    }




    function deleteEntireRow(id) {

        var table = $('#Loan_Master').DataTable();
        var updateData = decodeURIComponent(table.$('input, select').serializeAndEncode());
        var arrUpdate = updateData.split("*");
        var arrSampleObJ = [];
        arrUpdate.forEach(function (element) {
            if (element != "") {
                var objEf = {};
                var strRow = element.split("&");
                var id = strRow[0].split("=");
                objEf.id = id[0];
                objEf.loan_id = id[1];

                var ldes = strRow[1].split("=");
                objEf.loan_description = ldes[1];

                var intrate = strRow[2].split("=");
                objEf.interest_rate = intrate[1];

                //var payMonth = strRow[3].split("=");
                //objEf.PayMonths = payMonth[1];

                //var startMonth = strRow[4].split("=");
                //objEf.StartMonth = startMonth[1];

                //var stopMonth = strRow[5].split("=");
                //objEf.StopMonth = stopMonth[1];

                if (isNaN(id[0])) {
                    objEf.Action = "Delete";
                } else {
                    objEf.Action = "Add";
                }
                arrSampleObJ.push(objEf);
            }
        });

        modifiedData = arrSampleObJ;
        modifiedData = modifiedData.filter(function (obj) {

            if (obj.id != "null" && id != "null") {
                if (obj.id == id) {
                    obj.Action = "Deleted";
                    arrDelete.push(obj);
                } else {
                    return obj.loan_id !== id;
                }
            }
        });

        fillDataTables(modifiedData);
    }





    $('#updatGridData').click(function () {
        
        var table = $('#Loan_Master').DataTable();
        var updateData = decodeURIComponent(table.$('input, select').serializeAndEncode());
        var arrUpdate = updateData.split("*");
        var arrSampleObJ = [];
        arrUpdate.forEach(function (element) {
            if (element != "") {
                var objEf = {};
                var finalObj = {};
                var strRow = element.split("&");
                var id = strRow[0].split("=");
                objEf.id = id[0];
                objEf.loan_id = id[1];

                var ldes = strRow[1].split("=");
                objEf.loan_description = ldes[1];

                var intrate = strRow[2].split("=");
                objEf.interest_rate = intrate[1];

                //var payMonth = strRow[3].split("=");
                //objEf.PayMonths = payMonth[1];

                //var startMonth = strRow[4].split("=");
                //objEf.StartMonth = startMonth[1];

                //var stopMonth = strRow[5].split("=");
                //objEf.StopMonth = stopMonth[1];

                if (isNaN(id[0])) {
                    objEf.Action = "New";
                } else {
                    objEf.Action = "Update";
                }

                if (objEf.loan_id == ""
                    && objEf.loan_description == "" && objEf.interest_rate == "")
                    {
                    console.log("row is empty");
                } else {
                 
                    orgCancelData.map(function (element) {
                       
                        if (element.id == objEf.id && element.loan_description != objEf.loan_description) {

                            objEf.loan_description = objEf.loan_description;
                        }
                        else if (element.id == objEf.id && element.interest_rate != objEf.interest_rate) {

                            objEf.interest_rate = objEf.interest_rate;
                        }
                        else if (element.id == objEf.id
                            && element.loan_description == objEf.loan_description
                            && element.interest_rate == objEf.interest_rate)
                            {
                            objEf = {};
                        } else if (
                            objEf.loan_description != ""
                            || objEf.interest_rate != ""
                            ) {
                            objEf = objEf;
                        } else {
                            objEf = {};
                        }
                    });

                    if (Object.keys(objEf).length > 0) {
                        arrSampleObJ.push(objEf);
                    }

                }

            }
        });
       
        arrDelete.map(function (obj) {
            arrSampleObJ.push(obj);
        });
        var emp_code = $("#hdnEmpCode").val();
        var dataToSend = JSON.stringify({
           // EntityId: emp_code,
            mstrloanobject: arrSampleObJ
        });
        if (emp_code == 0) {
            CommonApiPOST("/Payroll/Customization/updateLoansMastersData", dataToSend, function (isSuccess) {
                if (isSuccess) {
                    setTimeout(function () { window.location.reload(); }, g_pagereload_seconds);
                } else { }
            });
        }
    });


    $("#cancelData").click(function () {
       
        ajaxSpinnerShow();
        //arrSampleObJ = [];
        setTimeout(function () { window.location.reload(); }, g_pagereload_seconds);
        //CommonApiGET('/Payroll/Customization/GetLoans_MasterData', function (respData) {

        //    orgCancelData = respData;
        //    fillDataTables(respData);
        //});
    
    });

</script>
