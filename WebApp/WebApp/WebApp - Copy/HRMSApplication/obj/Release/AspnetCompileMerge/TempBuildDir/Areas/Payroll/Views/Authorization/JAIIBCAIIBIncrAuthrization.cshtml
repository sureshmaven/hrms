@{
    Layout = "~/Areas/Payroll/Views/Shared/_PayrollLayout.cshtml";
}
<div class="page">
    <div class="form-horizontal form-horizontal2">
        <div class="page_start">
		<div class="leftmenu-container">
            <div class="sidebar-menu">
                @{Html.RenderPartial("_PVPayrollMenu");}
            </div>
            <div class="sidebar-content">
                <div class="main_heading heading_main">
                    <h1>JAIIB/CAIIB Increments Authorisation<span class="year-end">@ViewBag.Env_Fm_Fy</span></h1>
                    @{ Html.RenderPartial("_pvEmployeeSearch");}
                    <input type="hidden" id="hdnEmpCode" />
                    <div class="col-md-12">
                        <div class="inner_heading mt_10">
                            <h1>Increment/Incentive Authorisation</h1>
                            <div class="form-horizontal">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-5 control-label">Basic Pay Before Inc:</label>
                                        <div class="col-sm-7">
                                            <input type="text" class="form-control" id="basicpaybeforeinc" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-5 control-label">Increment/Incentive:</label>
                                        <div class="col-sm-7">
                                            <select class="form-control" id="JIIBCIIBIncrementtype" onchange="ddtypechanges()">
                                                <option value="JAIIB" selected>JAIIB</option>
                                                <option value="CAIIB">CAIIB</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-5 control-label">No.of Increment:</label>
                                        <div class="col-sm-7">
                                            <input type="number" class="form-control" id="noofIncrements" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-5 control-label">Increment Amount:</label>
                                        <div class="col-sm-7">
                                            <input type="number" class="form-control" id="incrementamount" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-5 control-label">Increment Date:</label>
                                        <div class="col-sm-7 input-group">
                                            <input type="text" class="form-control" id="incrementdate" onchange="return Dateevent3();" readonly>
                                            @*<span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>*@
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="col-sm-5 control-label">Increment W.E.F Date:</label>
                                        <div class="col-sm-7 input-group">
                                            <input type="text" class="form-control" id="incrementWEFdate" onchange="return Dateevent1();" readonly>
                                            @*<span class="input-group-addon"><i class="glyphicon glyphicon-calendar" readonly></i></span>*@
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="col-md-12">
                            <div class="pull-right">
                                <button type="reset" id="btnCancel" class="btn btn-default calcel">Cancel</button>
                                <button type="submit" onclick="showGlobalModal(msg);" id="btnSubmit" class="btn btn-primary">Authorize</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
			</div>
        </div>
    </div>
</div>

<script>
    var orgJCIList;
    var orgBPBList;

    //document load
    $(document).ready(function () {
        $('#btnSubmit').attr('disabled', false);
    });

    //search based on empcode
    function getDataAfterEmpSearch1440(empcode) {
        // 
        $("#btnSubmit").attr("disabled", false);
        $('#hdnEmpCode').val(empcode);
        var jcitype = $('#JIIBCIIBIncrementtype').val('JAIIB');
        clearfields();
        CommonApiGET('/Payroll/Authorization/GetJAIIBCAIIBDetails?EmpId=' + empcode, function (respData) {
            fillJIIBCIIBTrans(respData);

        });
    }

    //fill the datatables
    function fillJIIBCIIBTrans(respData) {
        // 
        var jci = [];
        var bpb = [];
        var dataObj = JSON.parse(respData);
        jci.push(dataObj.JCIDetails);
        bpb.push(dataObj.BPBDetails);
        //// 
        var jciData = jci[0];
        var bpbData = bpb[0];
        orgJCIList = jciData;
        orgBPBList = bpbData;

        if (orgBPBList[0] != null) {
            $('#basicpaybeforeinc').val(orgBPBList[0].amount);
        }

        if (orgJCIList[0] != null) {
            var JCIdropdown = orgJCIList[0].incr_incen_type;
            $("#JIIBCIIBIncrementtype").val(JCIdropdown);
            $('#noofIncrements').val(orgJCIList[0].no_of_inc);
            $('#incrementamount').val(orgJCIList[0].Incrementamt);
            $('#incrementdate').val(orgJCIList[0].incrementdate);
            $('#incrementWEFdate').val(orgJCIList[0].incr_WEF_date);
            //$('#btnSubmit').attr('disabled', true);
        }
        else {
            $('#btnSubmit').attr('disabled', false);
        }

        if ($('#hdnEmpCode').val() != null) {
            $('#pvTxtEmpCode1440').val($('#hdnEmpCode').val());
        }


        //// 

    }

    //insert/update
    $('#btnSubmit').click(function () {
        // 
        if ($("#hdnEmpCode").val() == "") {
            showGlobalModal("I#Error#Employee Id cannot be empty");
            
        }
        else if ($('#noofIncrements').val() == '') {
            showGlobalModal("I#Error#There is no increment to Authorize for this employee");
            
        }
        else {
            var updJCIdate = $('#JIIBCIIBIncrementtype').val() + "&" + $('#noofIncrements').val() + "&" + $('#incrementamount').val() + "&" + $('#incrementdate').val() + "&" + $('#incrementWEFdate').val();

            var dataToSend = JSON.stringify({
                'EntityId': $("#hdnEmpCode").val(),
                'StringData': updJCIdate,
            });
            CommonApiPOST('/Payroll/Authorization/SaveDataJAIIBCAIIBDetails', dataToSend, function (isSuccess) {
                if (isSuccess) {
                    //window.location.reload();

                    setTimeout(function () { window.location.reload(); }, g_pagereload_seconds);
                } else { }
            });
        }
        
        return false;
    });

    //cancel
    $("#btnCancel").click(function () {
        var empid = $("#hdnEmpCode").val();
        if (empid == "") {
            window.location.reload();
        }
        else {
            ddtypechanges()
        }
    });

    //search data based on type
    function ddtypechanges() {
        // 
        var x = document.getElementById("JIIBCIIBIncrementtype").value;
        if ($('#hdnEmpCode').val() != "") {
            clearfields();
            empcode = $('#hdnEmpCode').val();
            CommonApiGET('/Payroll/Authorization/GetJAIIBCAIIBDetails?EmpId=' + empcode + "&type=" + x, function (respData) {
                if (respData != null) {
                    fillJIIBCIIBTrans(respData);
                }
                else {
                    $('#JIIBCIIBIncrementtype').val("JAIIB");
                    $('#btnSubmit').attr('disabled', false);
                }
            });
        }
    }

    //to clear the fields
    function clearfields() {
        $('#basicpaybeforeinc').val('');
        $('#noofIncrements').val('');
        $('#incrementamount').val('');
        $('#incrementdate').val('');
        $('#incrementWEFdate').val('');
    }

    //select date for incrementdate
    function Dateevent3() {
        var StartDate = document.getElementById('incrementdate').value;
        var EndDate = document.getElementById('incrementWEFdate').value;
        var eDate = moment(EndDate, "DD.MM.YYYY");
        var sDate = moment(StartDate, "DD.MM.YYYY");
        if (StartDate != '' && EndDate != '' && sDate > eDate) {
            showGlobalModal("I#Error#Please ensure that incrementWEFdate is greater than or equal to incrementdate.");
            //alert("Please ensure that incrementWEFdate is greater than or equal to incrementdate.");
            document.getElementById('incrementdate').value = '';
            document.getElementById("incrementdate").focus();
            return false;

        }

        else {


            return true;
        }
    }

    //select for incrementWEFdate
    function Dateevent1() {
        // 
        var Joindate = document.getElementById("incrementdate").value;
        var Retdate = document.getElementById("incrementWEFdate").value;
        var date = moment(Joindate, "DD.MM.YYYY");
        var eDate = moment(Joindate, "DD.MM.YYYY");
        var sDate = moment(Retdate, "DD.MM.YYYY");
        var currentDate1 = moment(Retdate, "DD.MM.YYYY");
        var duration = moment.duration(date.diff(currentDate1));

        var diff = moment.duration(sDate.diff(eDate, 'days'));


        if (duration > 0) {

            showGlobalModal("I#Error#Please ensure that incrementWEFdate is greater than or equal to incrementdate");
            //alert("Please ensure that incrementWEFdate is greater than or equal to incrementdate.");
            document.getElementById('incrementWEFdate').value = '';
            document.getElementById("incrementWEFdate").focus();
            return false;

        }

        else {

            return true;

        }
    }
</script>
<script src="~/Areas/Payroll/Assets/libs/jquery/moment.js"></script>





