select d.LoanSlNo,COUNT(*) AS recvd , 'exec sp_insert_two_sub_Loans @emp_code='+CAST(EmpId as varchar)+', @loan_code='''+l.LoanId +''',@total_amount='+CAST(l.Amount as varchar)+',@total_installment='+CAST(period+intperiod as varchar) +',@remaining_installment='+CAST(period+intperiod-InstNo as varchar) +',@principal_installment='+CAST(period as varchar) +',@interest_installment='+CAST(intperiod as varchar)+',@completed_installment='+CAST(InstNo as varchar)+',@sanction_date='''+CAST(CAST(l.SanDate as Date) as varchar) + ''',@installment_start_date='''+cast( CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as varchar) +''' ,@installment_end_date='''+cast(Dateadd(month, 4,CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end) as varchar)+''',@method=''Interest to be Recovered at End'',@interest_rate=0 ,@installment_amount='+CAST(l.InstAmt as varchar)+' ,@vender_name=''AB-HFL(HYD)'',@interest_installment_amount='+CAST(l.IntRepaid as varchar)+',@total_recovered_amount='+CAST(l.Recovery as varchar)+' ,@fm=''2019-07-01'', @fy=2019;' from ploan l join PEMPMAST m on l.eid=m.eid  join PLoanDet d on d.loanslno=l.LoanSlNo GROUP BY d.LoanSlNo ,EmpId,l.LoanId,l.Amount,period,intperiod,InstNo,l.SanDate,l.InstAmt,l.IntRepaid,l.LoanStart,l.Recovery Having COUNT(d.loanslno)=2
ORDER BY d.loanslno



select   'exec sp_insert_two_sub_Loans_priority1 @emp_code='+CAST(m.Empid as varchar)+', @loan_code='''+CAST(d.LoanId as varchar)+''', @date_disburse='''+CAST(Cast(d.SanDate as Date) as varchar)+''',@loan_amount='+CAST(d.Amount as varchar)+',@interest_rate='+CAST(d.IntRate as varchar)+',@interest_accured='+CAST(d.IntAmount as varchar)+',@principal_amount_recovered='+CAST(d.CumLoanRepaid as varchar)+',@interest_amount_recovered='+CAST(d.CumIntRepaid as varchar)+',@total_amount_recovered='+CAST(d.Recovery as varchar)+',@principal_start_date='''+cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as varchar)+''',@principal_end_date='''+CAST(Dateadd(month,ceiling(cast(period as int)/4*(3)), cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as Date)) as varchar)+''',@interest_start_date='''+CAST(Dateadd(month,ceiling(cast(period as int)+1), cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as Date)) as varchar)+''',@interest_end_date='''+CAST(Dateadd(month,ceiling(cast(period as int)+1+ceiling(cast(IntPeriod as int)/4*(3))), cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as Date)) as varchar)+''',@total_principal_installments='+CAST(ceiling(cast(Period as int)/4*(3)) as varchar)+',@total_interest_installments='+CAST(ceiling(cast(IntPeriod as int)/4*(3)) as varchar)+',@os_principal_amount='+CAST(d.Amount-d.CumLoanRepaid as varchar)+',@os_interest_amount='+CAST(d.IntAccured-d.CumIntRepaid as varchar)+';' 
from PLoanDet d join PEMPMAST m on d.eid=m.eid join PLoan l on d.loanslno=l.LoanSlNo 
where d.Priority=1 and d.loanslno in ( select distinct d.loanslno from ploan p join ploandet d on d.loanslno=p.LoanSlNo  
group by d.loanslno Having count(p.loanslno)=2 ) 
ORDER BY d.loanslno




select 'exec sp_insert_two_sub_Loans_priority2 @emp_code='+CAST(M.Empid as varchar)+', @loan_code='''+CAST(d.LoanId as varchar)+''', @date_disburse='''+CAST(Cast(d.SanDate as Date) as varchar)+''',@loan_amount='+CAST(d.Amount as varchar)+',@interest_rate='+CAST(d.IntRate as varchar)+',@interest_accured='+CAST(d.IntAmount as varchar)+',@principal_amount_recovered='+CAST(d.CumLoanRepaid as varchar)+',@interest_amount_recovered='+CAST(d.CumIntRepaid as varchar)+',@total_amount_recovered='+CAST(d.Recovery as varchar)+',@principal_start_date='''+cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(Dateadd(month,ceiling(cast(l.Period as int)/4*(3))+1, l.SanDate) as Date) else dateadd(month,ceiling(cast(l.Period as int)/4*(3))+1, convert(date,  convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) ) end as varchar)+''',@principal_end_date='''+CAST(Dateadd(month,period, cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as Date)) as varchar)+''',@interest_start_date='''+CAST(Dateadd(month,ceiling(cast(period+ceiling(cast(IntPeriod as int)/4*3) as int)+2), cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as Date)) as varchar)+''',@interest_end_date='''+CAST(Dateadd(month,ceiling(cast(period+IntPeriod as int)), cast(CASE WHEN LoanStart = '' or LoanStart is null then cast(l.SanDate as Date) else convert(date,convert(date,left(LoanStart,4)+'-'+right(LoanStart,2)+'-01'),102) end as Date)) as varchar)+''',@total_principal_installments='+CAST(floor(cast(Period as int)/4) as varchar)+',@total_interest_installments='+CAST(floor(cast(IntPeriod as int)/4) as varchar)+',@os_principal_amount='+CAST(d.Amount-d.CumLoanRepaid as varchar)+',@os_interest_amount='+CAST(d.IntAmount-d.CumIntRepaid as varchar)+';' 
from PLoanDet d join PEMPMAST m on d.eid=m.eid join PLoan l on d.loanslno=l.LoanSlNo 
where d.Priority=2 and d.loanslno in ( select distinct d.loanslno from ploan p join ploandet d on d.loanslno=p.LoanSlNo 
group by d.loanslno Having count(p.loanslno)=2 ) 
ORDER BY d.loanslno
  