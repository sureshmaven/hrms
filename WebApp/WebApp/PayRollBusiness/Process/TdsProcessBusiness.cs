using Mavensoft.Common;
using Mavensoft.DAL.Business;
using Newtonsoft.Json;
using PayRollBusiness.PayrollService;
using PayrollModels;
using PayrollModels.Masters;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Data;
using System.Text;
using System.Threading.Tasks;
using PayrollModels.Process;
using System.Globalization;


namespace PayRollBusiness.Process
{
    public class TdsProcessBusiness : BusinessBase
    {
        DataTable _dtConstants = null;
        DataTable dt_qryconstantsnew = null;
        DataTable _incometaxdbconstant = null;
        LoginCredential loginCredential = null;



        public TdsProcessBusiness(LoginCredential loginCredential) : base(loginCredential)
        {

        }


        Mavensoft.DAL.Db.SqlHelper sh = new Mavensoft.DAL.Db.SqlHelper();

        public async Task<float> calculateBasic(string empcode)
        {

            string payQry = "SELECT distinct m.name as payfieldtype,amount,c.m_id FROM pr_emp_pay_field c JOIN pr_earn_field_master m ON c.m_id=m.id join pr_payslip_customization pc on c.m_id=pc.m_id WHERE c.emp_code = " + empcode + " and pc.field_type='pay_fields' and m.type='pay_fields' and pc.cust_status='Yes' AND c.active=1 AND amount>0;";
            string payallowQry = "select emp_code,all_name,all_amount from pr_emp_payslip_allowance where payslip_mid in(select id from pr_emp_payslip where active=1 and emp_code=" + empcode + ") and " +
                "all_name in('Fixed Personal Allowance','FPIIP','Personal Qual Allowance','SPL Cashier','SPL Jamedar','SPL Typist','SPL Watchman','SPL Stenographer','SPL Electrician','SPL Dafter','SPL Duplicating/xerox machine','SPL Personal Pay')";
            DataSet ds = await _sha.Get_MultiTables_FromQry(payQry+ payallowQry);
            var dtPay = ds.Tables[0];
            var dtpayallowQry = ds.Tables[1];

            float basicData = 0;
            float stag = 0;
            float caiib = 0;
            float jaiib = 0;
            float anual = 0;
            float spl_incr = 0;
            float spl_pay = 0;
            float fpa = 0;
            float fpiip = 0;
            float pqualallow = 0;
            float spl_cash = 0;
            float spl_jamedar = 0;
            float spl_typist = 0;
            float spl_watch = 0;
            float spl_stenograph = 0;
            float spl_electrician = 0;
            float spl_daftar = 0;
            float spl_xerox = 0;
            float spl_personal_pay = 0;

            foreach (DataRow algen in dtPay.Rows)
            {


                string alw_name = algen["payfieldtype"].ToString();
                float alw_amount = float.Parse(algen["amount"].ToString());

                if (alw_name == PrConstants.BASIC)
                {
                    basicData = alw_amount;
                }
                else if (alw_name == PrConstants.STAGNATION_INCREMENT)
                {
                    stag = alw_amount;
                }
                else if (alw_name == PrConstants.CAIIB_INCREMENT)
                {
                    caiib = alw_amount;
                }
                else if (alw_name == PrConstants.JAIIB_INCREMENT)
                {
                    jaiib = alw_amount;
                }
                else if (alw_name == PrConstants.ANNUAL_INCREMENT)
                {
                    anual = alw_amount;
                }
                else if (alw_name == PrConstants.SPECIAL_INCREMENT)
                {
                    spl_incr = alw_amount;
                }
                else if(alw_name==PrConstants.SPECIAL_PAY)
                {
                    spl_pay = alw_amount;
                }
            }
            foreach (DataRow alsplallow in dtpayallowQry.Rows)
            {


                string alw_splname = alsplallow["all_name"].ToString();
                float alw_splamount = float.Parse(alsplallow["all_amount"].ToString());

                if (alw_splname == PrConstants.FPA)
                {
                    fpa = alw_splamount;
                }
                else if (alw_splname == PrConstants.FPIIP)
                {
                    fpiip = alw_splamount;
                }
                else if (alw_splname == PrConstants.PERSONAL_QUAL_ALLOWANCE)
                {
                    pqualallow = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_CASHIER)
                {
                    spl_cash = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_JAMEDAR)
                {
                    spl_jamedar = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_TYPIST)
                {
                    spl_typist = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_WATCHMAN)
                {
                    spl_watch = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_STENOGRAPHER)
                {
                    spl_stenograph = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_ELECTRICIAN)
                {
                    spl_electrician = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_DAFTER)
                {
                    spl_daftar = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_DUPLICATING_XEROX_MACHINE)
                {
                    spl_xerox = alw_splamount;
                }
                else if (alw_splname == PrConstants.SPL_PERSONAL_PAY)
                {
                    spl_personal_pay = alw_splamount;
                }
            }

            float hra_DA_amt = basicData + stag + caiib + jaiib + anual+ fpa + fpiip + pqualallow + spl_cash + spl_jamedar + spl_typist + spl_watch + spl_stenograph + spl_electrician + spl_daftar + spl_xerox + spl_personal_pay;

            return hra_DA_amt;
        }
        public async Task<float> calculateDa(string empcode)
        {

            string payQry = "SELECT distinct m.name as payfieldtype,amount,c.m_id FROM pr_emp_pay_field c JOIN pr_earn_field_master m ON c.m_id=m.id join pr_payslip_customization pc on c.m_id=pc.m_id WHERE c.emp_code = " + empcode + " and pc.field_type='pay_fields' and m.type='pay_fields' and pc.cust_status='Yes' AND c.active=1 AND amount>0;";

            string spclQry = "SELECT m.id,m.name,amount,c.m_type FROM pr_emp_allowances_spl c JOIN pr_allowance_field_master m ON m.id=c.m_id  join pr_payslip_customization pc on c.m_id=pc.m_id WHERE emp_code = " + empcode + " and c.active=1 AND  pc.cust_status='Yes' AND m.type='EMPSA' and pc.field_type='EMPSA' AND amount>0;";

            DataSet ds = await _sha.Get_MultiTables_FromQry(payQry + spclQry);
            var dtPay = ds.Tables[0];
            var dtSpcl = ds.Tables[1];

            float basicData = 0;
            float stag = 0;
            float caiib = 0;
            float jaiib = 0;
            float anual = 0;

            float jamedar = 0;
            float cashier = 0;
            float dafter = 0;
            float driver = 0;
            float watchmen = 0;
            float xerox = 0;
            float totalDa = 0;

            foreach (DataRow spcl in dtSpcl.Rows)
            {

                string alw_name = spcl["name"].ToString();
                float alw_amount = float.Parse(spcl["amount"].ToString());

                if (alw_name == PrConstants.SPL_JAMEDAR)
                {
                    jamedar = alw_amount;
                }
                else if (alw_name == PrConstants.SPL_CASHIER)
                {
                    cashier = alw_amount;
                }
                else if (alw_name == PrConstants.SPL_DAFTER)
                {
                    dafter = alw_amount;
                }
                else if (alw_name == PrConstants.SPL_DRIVER)
                {
                    driver = alw_amount;
                }
                else if (alw_name == PrConstants.SPL_WATCHMAN)
                {
                    watchmen = alw_amount;
                }
                else if (alw_name == PrConstants.SPL_DUPLICATING_XEROX_MACHINE)
                {
                    xerox = alw_amount;
                }
            }

            foreach (DataRow algen in dtPay.Rows)
            {


                string alw_name = algen["payfieldtype"].ToString();
                float alw_amount = float.Parse(algen["amount"].ToString());

                if (alw_name == PrConstants.BASIC)
                {
                    basicData = alw_amount;
                }
                else if (alw_name == PrConstants.STAGNATION_INCREMENT)
                {
                    stag = alw_amount;
                }
                else if (alw_name == PrConstants.CAIIB_INCREMENT)
                {
                    caiib = alw_amount;
                }
                else if (alw_name == PrConstants.JAIIB_INCREMENT)
                {
                    jaiib = alw_amount;
                }
                else if (alw_name == PrConstants.ANNUAL_INCREMENT)
                {
                    anual = alw_amount;
                }
            }

            float hra_DA_amt = basicData + stag + caiib + jaiib + anual + jamedar + cashier + dafter + driver + watchmen + xerox;

            return hra_DA_amt;
        }
        public static DateTime GetCurrentTime(DateTime ldate)
        {
            DateTime serverTime = DateTime.Now;
            DateTime utcTime = serverTime.ToUniversalTime();
            // convert it to Utc using timezone setting of server computer
            TimeZoneInfo tzi = TimeZoneInfo.FindSystemTimeZoneById("India Standard Time");
            DateTime localTime = TimeZoneInfo.ConvertTimeFromUtc(utcTime, tzi);
            return localTime;
        }
        public async Task<IList<CommonReportModel>> getTDSTaxOption(string taxoption)
        {
            CommonReportModel crm = new CommonReportModel();
            IList<CommonReportModel> lst = new List<CommonReportModel>();
            int RowCnt = 0;
            int SlNo = 1;
            string str_qry = "";
            DateTime RetirementDate = GetCurrentTime(DateTime.Now).Date;
            if (taxoption == "^1")
            {
                str_qry = "Select e.EmpId,e.ShortName as EmpName, desig.Name as Designation, tax_option_emp.[Option] from Employees e join " +
                    " [pr_tax_option_emp_wise] tax_option_emp on e.EmpId=tax_option_emp.EmpId join Designations desig on e.Currentdesignation = desig.Id " +
                    " and e.RetirementDate >= '"+ RetirementDate+"' order by e.EmpId asc";
            }
            //str_qry = "select e.EmpId,e.ShortName as EmpName, desig.Name, tax_rate_emp.Options from Employees e join pr_tax_rate_emp_wise tax_rate_emp on e.EmpId=tax_rate_emp.Emp_code " +
            //" join Designations desig on e.Currentdesignation = desig.Id";
            DataTable dt_gettaxop = await _sha.Get_Table_FromQry(str_qry);
            foreach (DataRow drs in dt_gettaxop.Rows)
            {
                lst.Add(new CommonReportModel
                {
                    RowId = RowCnt++,
                    SlNo = SlNo++.ToString(),

                    column1 = drs["EmpId"].ToString(),
                    column2 = drs["EmpName"].ToString(),
                    column3 = drs["Designation"].ToString(),
                    column4 = drs["Option"].ToString(),
                });
            }
            return lst;
        }
        
        public async Task<IList<CommonReportModel>> getTDSTaxOptionSearch(string emp_code)
        {
            CommonReportModel crm = new CommonReportModel();
            IList<CommonReportModel> lst = new List<CommonReportModel>();
            int RowCnt = 0;
            int SlNo = 1;
            string str_qry = "";
            DateTime RetirementDate = GetCurrentTime(DateTime.Now).Date;
            if (emp_code != "^1" && emp_code != "")
            {
                str_qry = "Select e.EmpId,e.ShortName as EmpName, desig.Name as Designation, tax_option_emp.[Option] from Employees e join " +
                    " [pr_tax_option_emp_wise] tax_option_emp on e.EmpId=tax_option_emp.EmpId join Designations desig on e.Currentdesignation = desig.Id " +
                    " and e.RetirementDate >= '" + RetirementDate + "' and e.EmpId =" + emp_code + "  order by e.EmpId asc";
            }
            else
            {
                str_qry = "Select e.EmpId,e.ShortName as EmpName, desig.Name as Designation, tax_option_emp.[Option] from Employees e join " +
                           " [pr_tax_option_emp_wise] tax_option_emp on e.EmpId=tax_option_emp.EmpId join Designations desig on e.Currentdesignation = desig.Id " +
                           " and e.RetirementDate >= '" + RetirementDate + "'  order by e.EmpId asc";
            }
            //str_qry = "select e.EmpId,e.ShortName as EmpName, desig.Name, tax_rate_emp.Options from Employees e join pr_tax_rate_emp_wise tax_rate_emp on e.EmpId=tax_rate_emp.Emp_code " +
            //" join Designations desig on e.Currentdesignation = desig.Id";
            DataTable dt_gettaxop = await _sha.Get_Table_FromQry(str_qry);
            foreach (DataRow drs in dt_gettaxop.Rows)
            {
                lst.Add(new CommonReportModel
                {
                    RowId = RowCnt++,
                    SlNo = SlNo++.ToString(),

                    column1 = drs["EmpId"].ToString(),
                    column2 = drs["EmpName"].ToString(),
                    column3 = drs["Designation"].ToString(),
                    column4 = drs["Option"].ToString(),
                });
            }
            return lst;
        }
        public async Task<string> SearchEmployee(string EmpCode)
        {
            List<EmployeeSearchResult> retList = new List<EmployeeSearchResult>();
            string emp_option = "";
            string str_qryempcode = "";
            //List <string>retList = new List<string>();
            //string ECode = "",EName = "",EDesignation = "",EBranch = "",EDoj = "",EDRetire = "",EDoc = "", EselOpt="";

            string strQry = "select e.EmpId,CONCAT(e.FirstName,' ',e.LastName) as Name,convert(varchar,e.DOJ,105) as DOJ,convert(varchar,e.RetirementDate,105) as RetirementDate,d.Name as Designation,"
            + " case when b.Name = 'OtherBranch' then dep.name  else b.Name end deptbranch from employees e"
            + " join Designations d on e.CurrentDesignation = d.Id"
            + " join Branches b on e.Branch = b.Id"
            + " join Departments dep on e.Department = dep.Id where empid =" + EmpCode + "";

            DataTable dtEmpDetails = null;
            try
            {
                dtEmpDetails = await _sha.Get_Table_FromQry(strQry);
            }
            catch
            {
            }

            if (dtEmpDetails == null || dtEmpDetails.Rows.Count == 0)
            {
                strQry = "select e.empid, e.EmpId,CONCAT(e.FirstName,' ',e.LastName) as Name,convert(varchar,e.DOJ,105) as DOJ,convert(varchar,e.RetirementDate,105) as RetirementDate,d.Name as Designation,"
                + " case when b.Name = 'OtherBranch' then dep.name  else b.Name end deptbranch from employees e"
                + " join Designations d on e.CurrentDesignation = d.Id "
                + " join Branches b on e.Branch = b.Id join Departments dep on e.Department = dep.Id ";

                int ecode = 0;
                if (int.TryParse(EmpCode, out ecode))
                {
                    strQry += " where  e.RetirementDate>=CAST(CAST(GETDATE() AS DATE) AS DATETIME) and empid LIKE '" + EmpCode + "%'; ";
                }
                else
                {
                    strQry += " where  e.RetirementDate>=CAST(CAST(GETDATE() AS DATE) AS DATETIME) and  FirstName LIKE '%" + EmpCode + "%' OR LastName LIKE '%" + EmpCode + "%'; ";
                }

                dtEmpDetails = await _sha.Get_Table_FromQry(strQry);
            }
            DateTime curdate = Convert.ToDateTime(DateTime.Now.ToString("yyyy-MM-dd"));
            //int curFY = _LoginCredential.FY;
            string[] arrFm = _LoginCredential.FinancialMonthDate.ToString("yyyy-MM").Split('-');
            int curFY = Convert.ToInt32(arrFm[0]);
            int curFM = Convert.ToInt32(arrFm[1]);

            str_qryempcode = "Select [Option] from pr_tax_option_emp_wise where EmpId=" + EmpCode + ";";
            DataTable dt_empopt = await _sha.Get_Table_FromQry(str_qryempcode);

            //int i_fy = Convert.ToInt32(FM);
            if (dt_empopt.Rows.Count > 0)
            {
                if (dt_empopt.Rows[0]["Option"].ToString() == "2")
                {
                    emp_option = "Option 2";
                }
                else if (dt_empopt.Rows[0]["Option"].ToString() == "1")
                {
                    emp_option = "Option 1";
                }
            }
            else
            {
                emp_option = "No Option";
            }
            foreach (DataRow drEDet in dtEmpDetails.Rows)
            {
                DateTime retdate = Convert.ToDateTime(drEDet["RetirementDate"]);
                int reFm = retdate.Month;
                int retFy = retdate.Year;

                if (curFY >= retFy && curFM > reFm)
                {

                    retList.Add(new EmployeeSearchResult
                    {
                        ECode = "",
                        EName = "",
                        EDesignation = "",
                        EBranch = "",
                        EDoj = "",
                        EDRetire = "",
                        EDoc = "",
                        EselOpt = "",
                    });
                }

                else
                {
                    retList.Add(new EmployeeSearchResult
                    {
                        ECode = drEDet["empid"].ToString(),
                        EName = drEDet["Name"].ToString(),
                        EDesignation = drEDet["Designation"].ToString(),
                        EBranch = drEDet["deptbranch"].ToString(),
                        EDoj = drEDet["DOJ"].ToString(),
                        EDRetire = drEDet["RetirementDate"].ToString(),
                        EDoc = Convert.ToDateTime(drEDet["DOJ"].ToString()).AddMonths(12).ToString("dd-MM-yyyy"),
                        EselOpt = emp_option,
                    });
                }


            }

            return JsonConvert.SerializeObject(retList);

        }
        public async Task<IList<CommonReportModel>> UpdateTDSTaxOption(string empcodetaxoptions)
        {
            CommonReportModel crm = new CommonReportModel();
            IList<CommonReportModel> lst = new List<CommonReportModel>();
            int RowCnt = 0;
            int SlNo = 1;
            int iFY = _LoginCredential.FY;
            int empcodetax, i_qry = 0;
            char option;
            bool b_qry = false;
            string str_qry = "";
            DataTable dt_qrysearch, dt_qryinsert, dt_qryupdate;
            string str_searquery, str_insquery, str_updsquery, str_Mess1 = "", str_Mess2;
            option = empcodetaxoptions[empcodetaxoptions.Length - 1];
            empcodetax = Convert.ToInt32(empcodetaxoptions.Substring(0, empcodetaxoptions.Length - 1));
            try
            {
                str_searquery = "Select [EmpId] from pr_tax_option_emp_wise where [EmpId]=" + empcodetax + "";
                //if exists then update or else insert
                dt_qrysearch = sh.Get_Table_FromQry(str_searquery);
                if (dt_qrysearch.Rows.Count > 0)
                {
                    str_updsquery = "Update pr_tax_option_emp_wise set [Option]=" + option + " where EmpId=" + empcodetax + ";";
                    b_qry = sh.Run_UPDDEL_ExecuteNonQuery(str_updsquery);
                }
                else
                {
                    str_insquery = "Insert into pr_tax_option_emp_wise (EmpId,fy,[Option],trans_id) Values (" + empcodetax + "," + iFY + "," + option + ",1000);";
                    i_qry = sh.Run_INS_ExecuteScalar(str_insquery);
                }
                if (b_qry == true || i_qry == 1)
                {
                    str_qry = "Select e.EmpId,e.ShortName as EmpName, desig.Name as Designation, tax_option_emp.[Option] from Employees e join " +
                    " [pr_tax_option_emp_wise] tax_option_emp on e.EmpId=tax_option_emp.EmpId join Designations desig on e.Currentdesignation = desig.Id order by e.Empid asc";

                    DataTable dt_gettaxop = await _sha.Get_Table_FromQry(str_qry);
                    foreach (DataRow drs in dt_gettaxop.Rows)
                    {
                        lst.Add(new CommonReportModel
                        {
                            RowId = RowCnt++,
                            SlNo = SlNo++.ToString(),

                            column1 = drs["EmpId"].ToString(),
                            column2 = drs["EmpName"].ToString(),
                            column3 = drs["Designation"].ToString(),
                            column4 = drs["Option"].ToString(),
                        });
                    }
                }
            }
            catch (Exception ex)
            {

            }
            return lst;
        }
        //public string getEmpselectedTaxOption(string empid)
        //{
        //    string str_option="No Option Selected",str_opt="";
        //    string str_qrygetempopt= "Select [Empid],[Option] from pr_tax_option_emp_wise where [EmpId]="+empid+"";
        //    DataTable dt_getselopt = sh.Get_Table_FromQry(str_qrygetempopt);
        //    if(dt_getselopt.Rows.Count>0)
        //    {
        //        str_opt = dt_getselopt.Rows[0]["Option"].ToString();
        //        if(str_opt=="1")
        //        {
        //            str_option = "Option 1";
        //            return str_option;
        //        }
        //        else if (str_opt=="2")
        //        {
        //            str_option = "Option 2";
        //            return str_option;
        //        }
        //    }
        //    else
        //    {
        //        return str_option;
        //    }
        //    return str_option;
        //}
        public async Task<string> getTdsDetailsNew(string empCode, bool final)
        {
            DateTime Financial_md = (_LoginCredential.FinancialMonthDate);
            int iFY = _LoginCredential.FY;
            int dtFM = _LoginCredential.FM;
            int rounding_tds_per_month = 0;
            string strConvert;
            bool empcode = empCode.All(char.IsDigit);
            //foreach (char c in empCode)
            //{
            //    if (Char.IsLetter(c))
            //        empCode = "0";
            //}
            if (empcode == true)
            {
                string checkQry = "select id from pr_emp_payslip where active=1 and emp_code = " + Convert.ToInt32(empCode) + " ;";

                DataTable checkTable = await _sha.Get_Table_FromQry(checkQry);
                //if (checkTable.Rows.Count <= 0)
                //{
                //    return "E#TDS Process#Process Payslip For Employee ID " + empCode;
                //}
                //else
                //{
                string name = "";
                string per_address = "";
                string pan_no = "";
                string emp_code = "";
                string designation = "";
                string sex = "";
                string fm = "";
                string employer_name_address = PrConstants.Name;
                string employer_pan = PrConstants.PAN;
                string employer_tan = PrConstants.TAN;


                float totaltaxdeductedfrm16 = 0;
                float standard_deduction = 0;

                decimal stndedpercent = 0.04m; // added new on 25/06/2020

                float ent_allowance = 0;
                float emp_tax = 0;
                decimal? other = 0;
                int? count = 0;
                decimal? houseloan_allownace = 0;
                decimal? loan_instl_amt = 0;
                decimal? aggregate_of_4 = 0;
                decimal? Income_chargable = 0;
                decimal? total_gross_income = 0;
                decimal? deductible = 0;
                decimal? total_income = 0;
                float income = 0;
                float tds_per_month = 0;
                float edu_cess = 0;
                float tax_payable = 0;
                float tax_till = 0;
                float total_tax_till = 0;
                float tax_balance = 0;

                //decimal? house_rent_allowance = 0;
                //decimal? total_section = 0;

                //decimal? min_allowance = PrConstants.SECTION_C;
                //decimal? min_allowance80DD = PrConstants.SECTION_80DD;
                //decimal? min_allowance80CCD = PrConstants.SECTION_80CCD;
                //decimal? min_allowance80U = PrConstants.SECTION_80U;
                //decimal? min_allowance80DDB = PrConstants.SECTION_80DDB;
                //decimal? min_allowance80D_P = PrConstants.SECTION_80D_P;
                //decimal? min_allowance80D_F = PrConstants.SECTION_80D_F;
                //decimal? min_allowance80EE = PrConstants.SECTION_80EE;
                //decimal? min_allowance24b = PrConstants.SECTION_24b;
                decimal? max_allowance = 0;
                decimal? max_allowanceGG = 0;
                decimal? max_allowanceGGB = 0;
                decimal? max_allowance80CCD = 0;
                decimal? max_allowance80ee = 0;
                decimal? max_allowance80DB = 0;
                decimal? max_allowance80DD = 0;
                decimal? max_allowance80U = 0;
                decimal? max_allowance80D_P = 0;
                decimal? max_allowance80D_F = 0;
                decimal? max_allowance24B = 0;
                decimal? max_allowance_other = 0;
                decimal? min_allowance_other = PrConstants.OTHER_SECTION;
                decimal? round_income = 0;
                decimal? section_87a = 0;
                //decimal? da = 0;

                decimal? paid_by_emp = 0;


                int FY = _LoginCredential.FY;
                //string fmonth = _LoginCredential.f
                string FM = _LoginCredential.FinancialMonthDate.ToString("yyyy-MM-dd");
                string fin_month = _LoginCredential.FinancialMonthDate.ToString("dd-MM-yyyy");
                //string Env_Fm_Fy = commBus.Fyp_Fy();
                DateTime str = Convert.ToDateTime(FM);
                string checkMonth = str.ToString("MM");
                string checkYear = str.ToString("yyyy");
                int fin_year = FY - 1;
                string startYear = fin_year + "-04-01";
                string endYear = FY + "-03-31";
                int tot_months = 0;
                int months = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(endYear).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(endYear).Month) + 1;
                int monthsnew = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(endYear).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(endYear).Month);
                int months_1 = 0;
                int months_1new = 0;


                //general
                string general = "select CONCAT(emp.FirstName,' ',emp.LastName) as name, " +
                            "per_address, gen.pan_no,gen.emp_code, d.Description as designation,gen.sex " +
                            "from pr_emp_general gen left outer join Employees emp on gen.emp_code = emp.EmpId " +
                            " JOIN Designations d ON d.Id=emp.CurrentDesignation " +
                            "where gen.emp_code = " + Convert.ToInt32(empCode) + ";";

                decimal? basic = 0;
                decimal da_percent = 0;

                decimal? per_allowance = 0;
                decimal? fpa_allow = 0;
                decimal? fpiip = 0;

                decimal? int_ref = 0;
                decimal? t_inc = 0;

                decimal? pf_perk = 0;
                decimal? loan_perk = 0;
                decimal? incentives = 0;
                decimal? spl_allowance = 0;
                decimal? spl_da = 0;
                decimal hra = 0;
                decimal cca = 0;
                decimal? values_of_17_2 = 0;
                decimal? values_of_17_3 = 0;

                //present month
                decimal? pbasic = 0;
                decimal? pda_percent = 0;
                decimal? pcca = 0;
                decimal? phra = 0;
                decimal? pint_ref = 0;
                decimal? pt_inc = 0;
                decimal? pspl_da = 0;
                decimal? pspl_allowance = 0;
                decimal? pper_allowance = 0;
                decimal? pfpa_allow = 0;
                decimal? pfpiip = 0;
                decimal? gross = 0;

                decimal? house_rent_allowance = 0;
                decimal? total_section = 0;
                decimal? balance = 0;
                decimal? gsli = 0;
                int datediff = 1;

                string qryConstants = "SELECT constant, [value] FROM all_constants WHERE app_type='payroll' AND active=1;";

                string qryIncometaxConstants = "SELECT constant, [value] FROM all_constants WHERE app_type='payroll' AND functionality='IncomeTax' AND active=1 and fy=" + iFY + ";";
                string qryFy_FM = "SELECT fy,format(fm,'yyyy-MM-dd') as fm FROM pr_month_details WHERE active=1;";
                string option = "select [Option]  from pr_tax_option_emp_wise where EmpId=" + empCode + "";
                string empretiredate = "SELECT EmpId, RetirementDate from Employees where RetirementDate >= '" + startYear + "' and RetirementDate<= '" + endYear + "' and EmpId=" + empCode + " ";
                //to check payslip generated for financial month
                string emppayslipforfinmon = "select Id from pr_emp_payslip where spl_type in ('Regular', 'StopSalary','Suspended') and emp_code=" + empCode + " and fm='" + FM + "'";
                string strlop_days = "select lop from pr_emp_payslip where fm='" + FM + "'  and lop>0 and emp_code=" + Convert.ToInt32(empCode) + ";";
                string str_zerobasicforcurrfunyear = "select case when sum(er_basic) is null then 0 else sum(er_basic) end as Basic from pr_emp_payslip where fm>='" + startYear + "' and fm<='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + ";";

                //months_1=
                int monthcount = 0;


                DataSet ds1 = await _sha.Get_MultiTables_FromQry(qryConstants + qryFy_FM + qryIncometaxConstants + option + empretiredate +
                    emppayslipforfinmon + strlop_days + str_zerobasicforcurrfunyear);


                _dtConstants = ds1.Tables[0];
                DataTable optn = ds1.Tables[3];
                DataTable dtretiredate = ds1.Tables[4];
                DataTable dtemppayslipforfinmonth = ds1.Tables[5];
                DataTable dt_lopdays = ds1.Tables[6];
                DataTable dt_zerobasic = ds1.Tables[7];
                DateTime dretdattime = Convert.ToDateTime(startYear);
                DateTime d_retdate1 = Convert.ToDateTime(startYear);
                string strretdate = "";
                if (dtretiredate.Rows.Count > 0)
                {
                    DateTime dretdate = Convert.ToDateTime(dtretiredate.Rows[0]["RetirementDate"]);
                    strretdate = dretdate.ToString("yyyy-MM-dd");
                    months_1 = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(strretdate).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(strretdate).Month) + 1;
                    months_1new = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(strretdate).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(strretdate).Month);
                    monthcount = Math.Abs(((Convert.ToDateTime(d_retdate1).Year - Convert.ToDateTime(strretdate).Year) * 12) + Convert.ToDateTime(d_retdate1).Month - Convert.ToDateTime(strretdate).Month) + 1;

                    if (monthcount == 1)
                    {
                        months_1 = monthcount;
                    }
                }
                if (months_1new < 0)
                {
                    months_1new = 0;
                }
                int zerobasic = 0;
                if (dt_zerobasic.Rows.Count > 0)
                {
                    DataRow drzerobasic = dt_zerobasic.Rows[0];

                    object val = drzerobasic["Basic"];
                    if (val == DBNull.Value)
                    {
                        zerobasic = 0;
                    }
                    else
                    {
                        zerobasic = Convert.ToInt32(dt_zerobasic.Rows[0]["Basic"]);
                    }
                  
                }
                if (empCode=="686")
                {
                    decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                           .Where(x => x["constant"].ToString() == "Section80C")
                           .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                    decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80CCD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                    decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80U")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DDB")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                    decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_P")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                    decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_F")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                    decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80EE")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                    decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section24(b)")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                    decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80G")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                    decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80GGB")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                    DataTable _dtFY_FM = ds1.Tables[1];
                    _incometaxdbconstant = ds1.Tables[2];


                    //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                        "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                        "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " " +
                        "and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm = '" + FM + "' and spl_type='Regular'); ";

                    //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                        "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                        "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";

                    //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                    string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                    //allowance ==>Get and Sum all previous months allowances 
                    string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                    //allowance ==> Get all current month allowances
                    string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                    //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                    ////sum Personal Allowance
                    //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                    //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                    ////sum FPIIP
                    //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                    //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                    //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                    //sum PFPerks                                                   
                    string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                    // sum LOANPerks                                                    
                    string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                    // sum Incentive                                                    
                    string incentive = "select distinct sum(amount) as incentive from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    // sum  val 17 -2
                    string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                         "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                    // sum val 17 -3
                    string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                        "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                        " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                    //rent allowance
                    //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                    string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                    //other
                    string otherQry = "select distinct sum(amount) as other from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    //house loan
                    string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                    //section 80c
                    //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                    //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                    //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                    string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                       "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                       "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                       "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and active=1  union all " +
                       " select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                       "paydedu where paydedu.dd_name = 'VPF Deduction' and emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in (select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                       " union all " +
                        "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                        "union all " +
                       "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                       "union all " +
                       "select '7' as id, 'Housing Loan 2B-2C' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2B-2C' and emp_code = " + Convert.ToInt32(empCode) + "  and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                       "union all " +
                       "select '8' as id, 'Housing Loan 2A' as name, sum(paydedu.dd_amount) as amount  from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2A' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                       " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";

                    //section 80ccc
                    string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                    //section 80ccd
                    string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                        " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                    //section other section
                    string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                    //tax till
                    string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                    //other tds deductions
                    //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                    string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                        "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                        "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                    //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                    //VPF
                    string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm <= '" + FM + "' and p.fm >= '" + startYear + "';";
                    string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                 " union all " +
                 " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' " +
                 "union all  " +
                 "select 'Housing Loan 2B-2C',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =  " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "'  and fm>= '" + startYear + "'  and emp_code =  " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2B-2C' " +
                 "union all  " +
                 "select 'Housing Loan 2A',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + "  and payslip_mid in(select id from pr_emp_payslip where fm <  '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2A' ";

                    string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff, (SELECT DATEDIFF(month,'" + startYear + "',Retirementdate) from Employees where EmpId=" + Convert.ToInt32(empCode) + ") as DateDiffRetire;";

                    string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                    string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                        " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";
                    string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                       " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                       " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                    string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                        " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                        " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                    string strpf = " select sum(dd_provident_fund) pf  from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";
                    string strprevlicgsli = "select 'LIC' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'LIC' and payslip_mid " +
                                           " in(select id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "') " +
                                           "union all" +
                                           " select 'GSLI' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'GSLI' and payslip_mid " +
                                           " in(select id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "');";

                    string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                    string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                    DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                        SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                        cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                        loansprevmonth + strdatediff + strincometax + nolopsbasic + SumAllowanceQrynew + ActiveSumAllowanceQrynew + 
                        strpf + strprevlicgsli+ tdssections+ tdssection24);

                    //tables
                    var dtGeneral = ds.Tables[0];
                    var dtBasic = ds.Tables[1];
                    var dtBasicSum = ds.Tables[2];
                    var dtAllowance = ds.Tables[3];
                    var dtSumAllowance = ds.Tables[4];

                    var dtPfperks = ds.Tables[5];
                    var dtLoanPerks = ds.Tables[6];
                    var dtIncentives = ds.Tables[7];
                    var dt172 = ds.Tables[8];
                    var dt173 = ds.Tables[9];
                    var dtRent = ds.Tables[10];
                    var dtOther = ds.Tables[11];
                    var dtHouse = ds.Tables[12];

                    var dtCD = ds.Tables[13];
                    var dtCCC = ds.Tables[14];
                    var dtCCD = ds.Tables[15];
                    var dtEdu = ds.Tables[16];
                    var dtTax = ds.Tables[17];
                    var dtTDS = ds.Tables[18];
                    var dtEmpTax = ds.Tables[19];
                    var dtVpf = ds.Tables[20];
                    var dtActiveSumAllowance = ds.Tables[21];
                    var dt_prevmonthloans = ds.Tables[22];
                    var dt_datediff = ds.Tables[23];
                    var dt_incometax = ds.Tables[24];
                    var dt_nolopbasic = ds.Tables[25];
                    var dtSumAllowancenew = ds.Tables[26];
                    var dtActiveSumAllowancenew = ds.Tables[27];
                    var dt_strpf = ds.Tables[28];
                    var dt_strprevlicgsli = ds.Tables[29];
                    var dt_tdssections = ds.Tables[30];
                    var dt_tdssection24 = ds.Tables[31];

                    int loss_months = 0;
                    decimal? vpf_data = 0;
                    decimal? pf = 0;
                    decimal? lic = 0;
                    decimal? houseloanmain = 0;
                    decimal? houseAddloan_2d = 0;
                    decimal? houseloan2bc = 0;
                    decimal? houseloan2a = 0;

                    if (dtEmpTax.Rows.Count > 0)
                    {
                        DataRow empTax = dtEmpTax.Rows[0];

                        object val = empTax["loss"];
                        if (val == DBNull.Value)
                        {
                            loss_months = 0;
                        }
                        else
                        {
                            loss_months = Convert.ToInt32(empTax["loss"]);
                        }

                    }
                    //vpf

                    if (dtVpf.Rows.Count > 0)
                    {
                        DataRow vpfData = dtVpf.Rows[0];

                        object val = vpfData["amount"];
                        if (val == DBNull.Value)
                        {
                            vpf_data = 0;
                        }
                        else
                        {
                            vpf_data = Convert.ToDecimal(vpfData["amount"]);
                        }

                    }

                    // General Data
                    if (dtGeneral.Rows.Count > 0)
                    {
                        DataRow gen = dtGeneral.Rows[0];
                        name = Convert.ToString(gen["name"]);
                        per_address = Convert.ToString(gen["per_address"]);
                        pan_no = Convert.ToString(gen["pan_no"]);
                        emp_code = Convert.ToString(gen["emp_code"]);
                        designation = Convert.ToString(gen["designation"]);
                        sex = Convert.ToString(gen["sex"]);
                        fm = fin_month;
                    }


                    //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                    if (dtBasic.Rows.Count > 0)
                    {

                        DataRow rbasic = dtBasic.Rows[0];

                        //basic 
                        object val = rbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            pbasic = 0;
                        }
                        else
                        {
                            pbasic = Convert.ToDecimal(rbasic["basic"]) * months_1new;
                        }

                        //da_percent 
                        object val1 = rbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            pda_percent = 0;
                        }
                        else
                        {
                            pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months_1new;
                        }
                        //cca
                        object val2 = rbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            pcca = 0;
                        }
                        else
                        {
                            pcca = Convert.ToDecimal(rbasic["cca"]) * months_1new;
                        }
                        //hra
                        object val3 = rbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            phra = 0;
                        }
                        else
                        {
                            phra = Convert.ToDecimal(rbasic["hra"]) * months_1new;
                        }
                        //int_ref
                        object va4 = rbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            pint_ref = 0;
                        }
                        else
                        {
                            pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months_1new;
                        }

                        object val5 = rbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            pt_inc = 0;
                        }
                        else
                        {
                            pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months_1new;
                        }

                        object val6 = rbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            pspl_da = 0;
                        }
                        else
                        {
                            pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months_1new;
                        }

                        object val7 = rbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            pspl_allowance = 0;
                        }
                        else
                        {
                            pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months_1new;
                        }



                    }


                    if (dt_prevmonthloans.Rows.Count > 0)
                    {
                        foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                        {
                            int loanid = 0;
                            int pflag = 0;
                            int pflag1 = 0;
                            int countofsub = 0;
                            int precoverflag = 0;
                            string val = dr_prelons["loantype"].ToString();
                            string getloanid = "select id  from pr_loan_master where loan_description='" + val + "'";
                            DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                            loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                            string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                            string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                            DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                            DataTable dtcompare = sh.Get_Table_FromQry(comparequery);

                            if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                            {
                                countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                            }


                            if (dtchkloaneligibility.Rows.Count > 0)
                            {
                                pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                            }
                            object amount = dr_prelons["amount"];
                            if (countofsub != precoverflag)
                            {
                                if (val == "Housing Loan Main")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloanmain = 0;
                                    }
                                    else
                                    {
                                        houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Addl.Loan - 2D")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseAddloan_2d = 0;
                                    }
                                    else
                                    {
                                        houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Loan 2B-2C")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloan2bc = 0;
                                    }
                                    else
                                    {
                                        houseloan2bc = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Loan 2A")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloan2a = 0;
                                    }
                                    else
                                    {
                                        houseloan2a = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                            }
                        }
                    }
                    // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance



                    if (dtBasicSum.Rows.Count > 0)
                    {
                        DataRow sbasic = dtBasicSum.Rows[0];

                        //basic 
                        object val = sbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            basic = 0 + pbasic;
                        }
                        else
                        {
                            basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        }

                        //da_percent 
                        object val1 = sbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            da_percent = Convert.ToDecimal(0 + pda_percent);
                        }
                        else
                        {
                            da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        }
                        //cca
                        object val2 = sbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            cca = Convert.ToDecimal(0 + pcca);
                        }
                        else
                        {
                            cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        }
                        //hra
                        object val3 = sbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            hra = Convert.ToDecimal(0 + phra);
                        }
                        else
                        {
                            hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        }
                        //int_ref
                        object va4 = sbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            int_ref = 0 + pint_ref;
                        }
                        else
                        {
                            int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        }

                        object val5 = sbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            t_inc = 0 + pt_inc;
                        }
                        else
                        {
                            t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        }

                        object val6 = sbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            spl_da = 0 + pspl_da;
                        }
                        else
                        {
                            spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        }

                        object val7 = sbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            spl_allowance = 0 + pspl_allowance;
                        }
                        else
                        {
                            spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                        }

                        object val8 = sbasic["pf"];
                        if (val8 == DBNull.Value)
                        {
                            pf = 0;
                        }
                        else
                        {
                            pf = Convert.ToDecimal(sbasic["pf"]);
                        }



                        //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                    }

                    //present allowances pper_allowance,pfpa_allow,pfpiip

                    //foreach (DataRow algen in dtAllowance.Rows)
                    //{


                    //    string alw_name = algen["all_name"].ToString();
                    //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                    //    if (alw_name == "Fixed Personal Allowance")
                    //    {
                    //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == "FPA-HRA Allowance")
                    //    {
                    //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == PrConstants.FPIIP)
                    //    {
                    //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                    //    }

                    //}

                    ////dtSumFixed
                    //if (dtSumFixed.Rows.Count > 0)
                    //{
                    //    DataRow sumf = dtSumFixed.Rows[0];

                    //    object val = sumf["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        per_allowance = 0 + pper_allowance;
                    //    }
                    //    else
                    //    {
                    //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                    //    }

                    //}
                    ////dtsumFPA
                    //if (dtsumFPA.Rows.Count > 0)
                    //{
                    //    DataRow sumfpa = dtsumFPA.Rows[0];

                    //    object val = sumfpa["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpa_allow = 0 + pfpa_allow;
                    //    }
                    //    else
                    //    {
                    //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                    //    }

                    //}
                    ////dtsumfpiip
                    //if (dtsumfpiip.Rows.Count > 0)
                    //{
                    //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                    //    object val = sumfpiip["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpiip = 0 + pfpiip;
                    //    }
                    //    else
                    //    {
                    //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                    //    }
                    //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                    //}

                    //getting the date difference from finstart year and current year for allowance
                    int datediffetire = 0;
                    int minval = 0;
                    if (dt_datediff.Rows.Count > 0)
                    {
                        datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                        datediffetire = Convert.ToInt32(dt_datediff.Rows[0]["DateDiffRetire"]);
                        minval = Math.Min(datediff, datediffetire);
                    }


                    List<OldAllowance> oldList = new List<OldAllowance>();
                    //foreach (DataRow dtold in dtSumAllowance.Rows)
                    //{
                    //    OldAllowance objoldlist = new OldAllowance();
                    //    objoldlist.old_Name = dtold["all_name"].ToString();
                    //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                    //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                    //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                    //    oldList.Add(objoldlist);
                    //}
                    foreach (DataRow dtold in dtSumAllowancenew.Rows)
                    {
                        OldAllowance objoldlist = new OldAllowance();
                        objoldlist.old_Name = dtold["all_name"].ToString();
                        //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                        objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                        //objoldlist.old_alw_type = dtold["all_type"].ToString();
                        oldList.Add(objoldlist);
                    }



                    List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                    //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                    //{

                    //    ActiveAllowance NewObjlist = new ActiveAllowance();
                    //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                    //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                    //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                    //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                    //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                    //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                    //    if (olditem != null)
                    //    {
                    //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                    //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                    //    }

                    //    NewActiveList.Add(NewObjlist);
                    //}
                    foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                    {

                        ActiveAllowance NewObjlist = new ActiveAllowance();
                        NewObjlist.Active_Name = dtActive["all_name"].ToString();
                        //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                        NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1new;
                        //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                        // NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                        var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                        if (olditem != null)
                        {
                            NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                        }

                        NewActiveList.Add(NewObjlist);
                    }


                    //if not in new list then add
                    //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                    //{
                    //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                    //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                    //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                    //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                    //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                    //    if (olditem == null)
                    //    {
                    //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                    //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                    //        NewActiveList.Add(NewObjlist1);
                    //    }
                    //}
                    foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                    {
                        ActiveAllowance NewObjlist1 = new ActiveAllowance();
                        NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                        //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                        //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                        var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                        if (olditem == null)
                        {
                            NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            NewActiveList.Add(NewObjlist1);
                        }
                    }
                    var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                    if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                    {
                        await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                    }
                    int NewNumIndex = 0;

                    StringBuilder sbqry = new StringBuilder();
                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());
                    decimal total_allowance = 0;
                    //foreach (var newlist in NewActiveList)
                    //{
                    //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                    //    NewNumIndex++;
                    //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                    //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                    //    sbqry.Append(newqry);
                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    //}
                    
                    foreach (var newlist in NewActiveList)
                    {
                        total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                        NewNumIndex++;
                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                        var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                            " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                            "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                            " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                        sbqry.Append(newqry);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    }



                    //List<string> lststring = new List<string>();
                    //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                    // dtPfPerks
                    //if (dtPfperks.Rows.Count > 0)
                    //{
                    //    DataRow pfPerk = dtPfperks.Rows[0];

                    //    object val = pfPerk["pf_perk"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        pf_perk = 0;
                    //    }
                    //    else
                    //    {
                    //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                    //    }

                    //}
                    //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);

                    //dtLoanPerks
                    if (dtLoanPerks.Rows.Count > 0)
                    {
                        DataRow lperk = dtLoanPerks.Rows[0];

                        object val = lperk["loan_perk"];
                        if (val == DBNull.Value)
                        {
                            loan_perk = 0;
                        }
                        else
                        {
                            loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                        }

                    }
                    //dtIncentives
                    if (dtIncentives.Rows.Count > 0)
                    {
                        DataRow ins = dtIncentives.Rows[0];

                        object val = ins["incentive"];
                        if (val == DBNull.Value)
                        {
                            incentives = 0;
                        }
                        else
                        {
                            incentives = Convert.ToDecimal(ins["incentive"]);
                        }

                    }
                    //dt172
                    if (dt172.Rows.Count > 0)
                    {
                        DataRow VAL = dt172.Rows[0];
                        object val = VAL["val172"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_2 = 0;
                        }
                        else
                        {
                            values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                            totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                        }
                    }
                    //dt173
                    if (dt173.Rows.Count > 0)
                    {
                        DataRow VAL1 = dt173.Rows[0];
                        object val = VAL1["val173"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_3 = 0;
                        }
                        else
                        {
                            values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                        }
                    }

                    if (dtRent.Rows.Count > 0)
                    {
                        DataRow rents = dtRent.Rows[0];

                        object val = rents["rentamount"];
                        if (val == DBNull.Value)
                        {
                            house_rent_allowance = 0;
                        }
                        else
                        {
                            house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                        }
                    }

                    if (house_rent_allowance > 0)
                    {
                        decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                        //salary(a)
                        decimal salary = da_percent + Convert.ToDecimal(basic);
                        //40%  of salary(b)
                        decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                        //houserentpaid - 10% of salary(c)
                        decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                        //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                        house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                        // HouseRentAllowance calculated as on 04-09-2020
                        // minimun values of (
                        // Basic+DA --40%,
                        // House Rent Paid minus Basic+DA --10% 
                        // HRA)
                    }
                    //decimal daval = Convert.ToDecimal(da);
                    //decimal hraval = Convert.ToDecimal(hra);
                    //rent amount
                    if (house_rent_allowance < 0)
                    {
                        house_rent_allowance = 0;
                    }



                    if (dtOther.Rows.Count > 0)
                    {
                        DataRow otr = dtOther.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = otr["other"];
                        if (val == DBNull.Value)
                        {
                            other = 0;
                        }
                        else
                        {
                            other = Convert.ToDecimal(otr["other"]);
                        }

                    }

                    if (dtHouse.Rows.Count > 0)
                    {
                        //foreach (DataRow dr in dtHouse.Rows)
                        //{
                        //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                        //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                        //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                        //        || dr["loan_type_mid"].ToString() == "13")
                        //    {
                        //        count++;
                        //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                        //    }

                        //}
                        DataRow dh = dtHouse.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = dh["amount"];
                        if (val == DBNull.Value)
                        {
                            houseloan_allownace = 0;
                        }
                        else
                        {
                            houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                        }

                    }
                    //if (count > 0)
                    //{

                    //    houseloan_allownace = 200000;
                    //}
                    if (dt_strpf.Rows.Count > 0)
                    {
                        pf = Convert.ToDecimal(dt_strpf.Rows[0]["pf"]);
                    }
                    if (dt_strprevlicgsli.Rows.Count > 0)
                    {
                        foreach (DataRow drpev in dt_strprevlicgsli.Rows)
                        {
                            decimal? amount = 0;
                            object val = drpev["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(drpev["amount"]);
                            }
                            string dd_name = Convert.ToString(drpev["name"].ToString());
                            if (dd_name == "LIC")
                            {
                                lic = amount;
                            }
                            else if (dd_name == "GSLI")
                            {
                                gsli = amount;
                            }
                        }
                    }

                    IList<section80C> lstCer = new List<section80C>();
                    IList<section80CCC> lstCCC = new List<section80CCC>();
                    IList<section80CCD> lstCCD = new List<section80CCD>();
                    IList<sectionOther> lstOther = new List<sectionOther>();

                    decimal pf_new = 0;
                    if (dtCD.Rows.Count > 0)
                    {
                        foreach (DataRow cer in dtCD.Rows)
                        {
                            //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                            decimal? amount = 0;

                            object val = cer["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(cer["amount"]);
                            }

                            string dd_name = Convert.ToString(cer["name"].ToString());
                            int loanid = 0;
                            int pflag = 0;
                            int countofsub = 0;
                            int precoverflag = 0;

                            string getloanid = "select id  from pr_loan_master where loan_description='" + dd_name + "'";
                            DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                            if (dtgetloanid.Rows.Count > 0)
                            {
                                loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                            }

                            string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                            string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                            DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                            DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                            if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                            {
                                countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                            }
                            if (dtchkloaneligibility.Rows.Count > 0)
                            {
                                pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                            }
                            if (dd_name == "Provident Fund")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //   amount = Convert.ToDecimal(pf + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = pf;
                                    //}

                                }
                                amount = Convert.ToDecimal(pf + (amount * months_1new));
                                pf_new = Convert.ToDecimal(amount);
                            }
                            else if (dd_name == "VPF")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //    amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = vpf_data;
                                    //}

                                }
                                amount = Convert.ToDecimal(vpf_data + (amount * months_1new));
                            }
                            //added new on 25/06/2020
                            else if (dd_name == "LIC")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //    amount = Convert.ToDecimal(lic + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = lic;
                                    //}
                                }
                                amount = Convert.ToDecimal(lic + (amount * months_1new));
                            }
                            else if (dd_name == "Housing Loan Main")
                            {
                                //amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Addl.Loan - 2D")
                            {
                                //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Loan 2B-2C")
                            {
                                //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloan2bc + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Loan 2A")
                            {
                                //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloan2a + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "GSLI")
                            {
                                amount = Convert.ToDecimal(gsli + (amount * months_1new));
                            }
                            else 
                            {
                                amount = Convert.ToDecimal((amount * months_1new));
                            }
                            //if amount is zero not adding to the list
                            if (amount == 0)
                            { continue; }
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                        }


                    }
                    else
                    {
                        lstCer.Add(new section80C
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //for special deductions
                    if (dt_tdssections.Rows.Count > 0)
                    {
                        foreach (DataRow cer1 in dt_tdssections.Rows)
                        {
                            decimal? amount1 = 0;
                            decimal? allowance_amount1 = 0;
                            amount1 = Convert.ToDecimal(cer1["gross"]);
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount1 > min_allowance)
                                {
                                    allowance_amount1 = min_allowance;
                                    min_allowance = min_allowance - allowance_amount1;
                                    max_allowance = max_allowance + allowance_amount1;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount1;
                                    allowance_amount1 = amount1;
                                    max_allowance = max_allowance + amount1;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }

                    }

                    decimal pf_perkcal = 0.5m;
                    decimal pf_perktemp = 12.5m;
                    pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                    //if (dtCCC.Rows.Count > 0)
                    //{
                    //    foreach (DataRow ccc in dtCCC.Rows)
                    //    {
                    //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                    //        decimal? allowance_amount = 0;
                    //        if (min_allowance > 0 && max_allowance <= 150000)
                    //        {
                    //            if (amount > min_allowance)
                    //            {
                    //                allowance_amount = min_allowance;
                    //                min_allowance = min_allowance - allowance_amount;
                    //                max_allowance = max_allowance + allowance_amount;
                    //            }
                    //            else
                    //            {
                    //                min_allowance = min_allowance - amount;
                    //                allowance_amount = amount;
                    //                max_allowance = max_allowance + amount;
                    //            }
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                    //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //            });
                    //        }
                    //        else
                    //        {
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                    //                allowance_amount = AddZerosAfterDecimal("0"),
                    //                ded_amount = AddZerosAfterDecimal("0")
                    //            });
                    //        }

                    //    }

                    //}
                    //else
                    //{
                    //    lstCCC.Add(new section80CCC
                    //    {
                    //        id = "",
                    //        name = "",
                    //        amount = AddZerosAfterDecimal("0"),
                    //        allowance_amount = AddZerosAfterDecimal("0"),
                    //        ded_amount = AddZerosAfterDecimal("0")
                    //    });
                    //}

                    if (dtCCD.Rows.Count > 0)
                    {
                        foreach (DataRow ccd in dtCCD.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                            {
                                if (amount > min_allowance80CCD)
                                {
                                    allowance_amount = min_allowance80CCD;
                                    min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                    max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                }
                                else
                                {
                                    min_allowance80CCD = min_allowance80CCD - amount;
                                    allowance_amount = amount;
                                    max_allowance80CCD = max_allowance80CCD + amount;
                                }
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }
                    }
                    else
                    {
                        lstCCD.Add(new section80CCD
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    if (dtEdu.Rows.Count > 0)
                    {
                        foreach (DataRow ed in dtEdu.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                            String sectionNAme = ed["section"].ToString();
                            decimal? allowance_amount = 0;
                            string id = ed["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = ed["name"].ToString();
                            if (sectionNAme == "Section80G")
                            {
                                allowance_amount = amount * section80g;
                                max_allowanceGG = max_allowanceGG + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80GGB")
                            {
                                allowance_amount = amount * section80gg;
                                max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80DDB")
                            {
                                if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                {
                                    if (amount > min_allowance80DDB)
                                    {
                                        allowance_amount = min_allowance80DDB;
                                        ded_amount = allowance_amount;
                                        min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                        max_allowance80DB = max_allowance80DB + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DDB = min_allowance80DDB - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DB = max_allowance80DB + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                            }
                            else if (sectionNAme == "Section80DD")
                            {
                                if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                {
                                    if (amount > min_allowance80DD)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80DD = min_allowance80DD - allowance_amount;
                                        max_allowance80DD = max_allowance80DD + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DD = min_allowance80DD - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DD = max_allowance80DD + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80U")
                            {
                                if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                {
                                    if (amount > min_allowance80U)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80U = min_allowance80U - allowance_amount;
                                        max_allowance80U = max_allowance80U + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80U = min_allowance80U - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80U = max_allowance80U + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80E")
                            {
                                allowance_amount = amount;
                                max_allowance = max_allowance + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            else if (sectionNAme == "Section80D_P")
                            {
                                if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                {
                                    if (amount > min_allowance80D_P)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                        max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_P = min_allowance80D_P - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_P = max_allowance80D_P + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                                //if (min_allowance80D_P > amount)
                                //{
                                //    allowance_amount = amount;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}

                                //else
                                //{
                                //    allowance_amount = min_allowance80D_P;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}
                            }
                            else if (sectionNAme == "Section80D_F")
                            {
                                if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                {
                                    if (amount > min_allowance80D_F)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                        max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_F = min_allowance80D_F - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_F = max_allowance80D_F + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                            {
                                if (sectionNAme != "Section80EE")
                                {
                                    sectionNAme = "Section80EE_HL";
                                }
                                if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                {
                                    if (amount > min_allowance80EE)
                                    {
                                        allowance_amount = min_allowance80EE;
                                        min_allowance80EE = min_allowance80EE - allowance_amount;
                                        max_allowance80ee = max_allowance80ee + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80EE = min_allowance80EE - amount;
                                        allowance_amount = amount;
                                        max_allowance80ee = max_allowance80ee + amount;
                                    }
                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;

                                }
                            }

                            else if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });

                        }

                    }

                    else
                    {
                        lstOther.Add(new sectionOther
                        {
                            id = "",
                            name = "",
                            section = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //special section24(b)
                    if (dt_tdssection24.Rows.Count > 0)
                    {
                        foreach (DataRow sec24 in dt_tdssection24.Rows)
                        {
                            decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                            String sectionNAme = sec24["section"].ToString();
                            string actName1 = "";
                            decimal? allowance_amount = 0;
                            string id = sec24["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = sec24["name"].ToString();

                            for (int i = 0; i < lstOther.Count; i++)
                            {
                                actName1 = lstOther[i].name;
                                if (actName1 == actName)
                                {
                                    lstOther.RemoveAt(i);
                                    continue;
                                }
                            }

                            if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });
                        }
                    }

                    max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                    if (dtTax.Rows.Count > 0)
                    {


                        DataRow tax = dtTax.Rows[0];

                        object val = tax["tax_deducted_at_source"];
                        if (val == DBNull.Value)
                        {
                            total_tax_till = 0;
                        }
                        else
                        {
                            total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                        }

                        tax_till = totaltaxdeductedfrm16 + total_tax_till;
                        tax_till = 0;

                    }

                    if (dtTDS.Rows.Count > 0)
                    {
                        DataRow TDS = dtTDS.Rows[0];

                        object val = TDS["tds_amount"];
                        if (val == DBNull.Value)
                        {
                            paid_by_emp = 0;
                        }
                        else
                        {
                            paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                        }
                    }

                    IList<TDSProcess> lstTDS = new List<TDSProcess>();

                    gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                    total_section = house_rent_allowance;

                    balance = gross - total_section;
                    //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                    //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                    decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                    if (stndednew >= 50000)
                    {
                        standard_deduction = PrConstants.STANDARD_DEDUCTION;
                    }
                    else
                    {
                        standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                    }
                    //standard_deduction = gross*0.04;

                    if (monthcount != 1)
                    {
                        //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);

                        //if (emp_tax > 2400)
                        //{
                        //    emp_tax = 2400;
                        //}
                        emp_tax = (200);
                    }
                    else if (monthcount == 1)
                    {
                        emp_tax = 0;
                    }
                    aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                    Income_chargable = balance - aggregate_of_4; //6

                    total_gross_income = Income_chargable + other - houseloan_allownace;

                    deductible = Convert.ToDecimal(max_allowance);
                    total_income = total_gross_income - deductible;
                    //total_income = Convert.ToDecimal(841240.01);
                    round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                    //tax_deducted_at_source is calculating as incometax value of current financial year.
                    decimal tax_deducted_at_source1 = 0;
                    if (dt_incometax.Rows.Count > 0)
                    {
                        DataRow incometax = dt_incometax.Rows[0];

                        object val = incometax["income_tax"];
                        if (val == DBNull.Value)
                        {
                            tax_deducted_at_source1 = 0;
                        }
                        else
                        {
                            tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                        }
                    }

                    if (total_income > 500000)
                    {
                        //strConvert = income.ToString();
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = 0;
                        edu_cess = income * 4 / 100;

                        tax_payable = (float)income + edu_cess;

                        tax_payable = (int)Math.Round(tax_payable);

                        //if (tax_till > tax_payable)
                        //{
                        //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                        //}
                        //else
                        //{
                        //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                        //}
                        tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                        if (tax_balance < 0)
                        {
                            tax_balance = 0;
                        }

                        //tds_per_month = tax_balance / months_1;
                        tds_per_month = 0;
                        if (Financial_md.Month != 03)
                        {
                            int x = (int)Math.Round(tds_per_month);
                            int y = (int)Math.Round(x / 100d, 0) * 100;
                            rounding_tds_per_month = y;
                        }
                        else
                        {
                            int xp = (int)Math.Round(tds_per_month);
                            int Z = (10 - xp % 10) + xp;
                            rounding_tds_per_month = Z;
                        }

                        //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                    }
                    else
                    {
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = Convert.ToDecimal(income);
                        edu_cess = 0;

                        tax_payable = 0;

                        tax_till = 0;
                        tax_balance = 0;

                        tds_per_month = 0;

                        rounding_tds_per_month = 0;
                    }
                    //string employer_name_address = PrConstants.Name;
                    //string employer_pan = PrConstants.PAN;
                    //string employer_tan = PrConstants.TAN;

                    lstTDS.Add(new TDSProcess
                    {
                        option = optn.Rows[0]["Option"].ToString(),
                        name = name,
                        per_address = per_address,
                        pan_no = pan_no,
                        emp_code = emp_code,
                        designation = designation,
                        sex = sex,
                        fm = fm,
                        employer_name_address = employer_name_address,
                        employer_pan = employer_pan,
                        employer_tan = employer_tan,
                        basic = AddZerosAfterDecimal(Convert.ToString(basic)),
                        da_percent = AddZerosAfterDecimal(Convert.ToString(da_percent)),
                        per_allowance = AddZerosAfterDecimal(Convert.ToString(per_allowance)),
                        int_ref = AddZerosAfterDecimal(Convert.ToString(int_ref)),
                        t_inc = AddZerosAfterDecimal(Convert.ToString(t_inc)),
                        fpa_allow = AddZerosAfterDecimal(Convert.ToString(fpa_allow)),
                        fpiip = AddZerosAfterDecimal(Convert.ToString(fpiip)),
                        pf_perk = AddZerosAfterDecimal(Convert.ToString(pf_perk)),
                        loan_perk = AddZerosAfterDecimal(Convert.ToString(loan_perk)),
                        incentives = AddZerosAfterDecimal(Convert.ToString(incentives)),
                        spl_allowance = AddZerosAfterDecimal(Convert.ToString(spl_allowance)),
                        spl_da = AddZerosAfterDecimal(Convert.ToString(spl_da)),
                        hra = AddZerosAfterDecimal(Convert.ToString(hra)),
                        cca = AddZerosAfterDecimal(Convert.ToString(cca)),
                        values_of_17_2 = AddZerosAfterDecimal(Convert.ToString(values_of_17_2)),
                        values_of_17_3 = AddZerosAfterDecimal(Convert.ToString(values_of_17_3)),
                        gross = AddZerosAfterDecimal(Convert.ToString(gross)), // 2 pending
                        standard_deduction = AddZerosAfterDecimal(Convert.ToString(standard_deduction)),
                        ent_allowance = AddZerosAfterDecimal(Convert.ToString(ent_allowance)),
                        emp_tax = AddZerosAfterDecimal(Convert.ToString(emp_tax)),
                        aggregate_of_4 = AddZerosAfterDecimal(Convert.ToString(aggregate_of_4)),
                        Income_chargable = AddZerosAfterDecimal(Convert.ToString(Income_chargable)),
                        other = AddZerosAfterDecimal(Convert.ToString(other)),
                        houseloan_allownace = AddZerosAfterDecimal(Convert.ToString(houseloan_allownace)),
                        total_gross_income = AddZerosAfterDecimal(Convert.ToString(total_gross_income)),
                        loan_instl_amt = AddZerosAfterDecimal(Convert.ToString(loan_instl_amt)),
                        deductible = AddZerosAfterDecimal(Convert.ToString(deductible)),
                        total_income = AddZerosAfterDecimal(Convert.ToString(total_income)),
                        income = AddZerosAfterDecimal(Convert.ToString(income)),
                        edu_cess = AddZerosAfterDecimal(Convert.ToString(edu_cess)),
                        tax_payable = AddZerosAfterDecimal(Convert.ToString(tax_payable)),
                        tax_till = AddZerosAfterDecimal(Convert.ToString(tax_till)),
                        tax_balance = AddZerosAfterDecimal(Convert.ToString(tax_balance)),
                        balance_month = Convert.ToString(months_1),
                        tds_per_month = AddZerosAfterDecimal(Convert.ToString(rounding_tds_per_month)),
                        house_rent_allowance = AddZerosAfterDecimal(Convert.ToString(house_rent_allowance)),
                        total_section = AddZerosAfterDecimal(Convert.ToString(total_section)),
                        balance = AddZerosAfterDecimal(Convert.ToString(balance)),
                        round_income = AddZerosAfterDecimal(Convert.ToString(round_income)),
                        section_87a = AddZerosAfterDecimal(Convert.ToString(section_87a)),
                        //paid_by_emp = AddZerosAfterDecimal(Convert.ToString(paid_by_emp)),
                        paid_by_emp = AddZerosAfterDecimal(Convert.ToString(tax_deducted_at_source1)),

                    }); ;
                    var tds = JsonConvert.SerializeObject(lstTDS);
                    var ccT = JsonConvert.SerializeObject(lstCer);
                    var cccT = JsonConvert.SerializeObject(lstCCC);
                    var ccdT = JsonConvert.SerializeObject(lstCCD);
                    var otherT = JsonConvert.SerializeObject(lstOther);
                    var allowanceT = JsonConvert.SerializeObject(NewActiveList);

                    var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                    var tdsData = javaScriptSerializer.DeserializeObject(tds);
                    var ccData = javaScriptSerializer.DeserializeObject(ccT);
                    var cccData = javaScriptSerializer.DeserializeObject(cccT);
                    var ccdData = javaScriptSerializer.DeserializeObject(ccdT);
                    var otherData = javaScriptSerializer.DeserializeObject(otherT);
                    var allowanceTdata = javaScriptSerializer.DeserializeObject(allowanceT);

                    var resultJson = javaScriptSerializer.Serialize(new
                    {
                        tds = tdsData,
                        cc = ccData,
                        ccc = cccData,
                        ccd = ccdData,
                        other = otherData,
                        allowance = allowanceTdata

                    });
                    //int NewNumIndex = 0;

                    //StringBuilder sbqry = new StringBuilder();
                    ////1. trans_id
                    //sbqry.Append(GenNewTransactionString());

                    int finalSub = 0;

                    if (final == true)
                    {
                        finalSub = 1;
                    }
                    else
                    {
                        finalSub = 0;
                    }

                    string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable details = await _sha.Get_Table_FromQry(selQry);
                    if (details.Rows.Count > 0)
                    {
                        NewNumIndex++;
                        DataRow finaldt = details.Rows[0];
                        string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                        sbqry.Append(tdsdelete);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                        int finalCount = Convert.ToInt32(finaldt["final"]);

                        if (finalCount == 1)
                        {
                            return "E#TDS Process#Employee Already Processed..!!";
                        }
                        else
                        {
                            NewNumIndex++;
                            string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            sbqry.Append(tdsUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                            NewNumIndex++;
                            string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            sbqry.Append(certUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));
                            

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + months_1 + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                foreach (var ccDatas in lstCer)
                                {
                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    foreach (var cccDatas in lstCCC)
                            //    {
                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }



                    }
                    else
                    {

                        try
                        {

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate1);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + months_1 + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate2);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var ccDatas in lstCer)
                                {

                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate3);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var cccDatas in lstCCC)
                            //    {

                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    NewNumIndex++;
                                    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate3);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate4);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }
                        catch (Exception e)
                        {
                            return "E#TDS Process#" + e.Message;
                        }
                    }
                    return resultJson;
                    //}
                }
                else if (optn.Rows[0]["Option"].ToString() == "1" && dtretiredate.Rows.Count == 0 && zerobasic == 0)
                {
                    decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                           .Where(x => x["constant"].ToString() == "Section80C")
                           .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                    decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80CCD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                    decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80U")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DDB")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                    decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_P")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                    decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_F")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                    decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80EE")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                    decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section24(b)")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                    decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80G")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                    decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80GGB")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                    DataTable _dtFY_FM = ds1.Tables[1];
                    _incometaxdbconstant = ds1.Tables[2];


                    //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    //string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                    //    "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                    //    "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " and spl_type='Regular' order by id desc); ";
                    string basicQry = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref," +
                        " (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance,(dd_provident_fund) pf from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + "  and spl_type='Regular' and working_days=(select month_days from pr_month_details where active=1) and er_basic>0 order by fm desc; ";
                    //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                        "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                        "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                    //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                    string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                    //allowance ==>Get and Sum all previous months allowances 
                    string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                    //allowance ==> Get all current month allowances
                    string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                    //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                    ////sum Personal Allowance
                    //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                    //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                    ////sum FPIIP
                    //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                    //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                    //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                    //sum PFPerks                                                   
                    string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                    // sum LOANPerks                                                    
                    string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                    // sum Incentive                                                    
                    string incentive = "select distinct sum(amount) as incentive from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    // sum  val 17 -2
                    string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                         "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                    // sum val 17 -3
                    string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                        "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                        " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                    //rent allowance
                    //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                    string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                    //other
                    string otherQry = "select distinct sum(amount) as other from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    //house loan
                    string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                    //section 80c
                    //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                    //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                    //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                    string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                       "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                       "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 and ef.name not in('Provident Fund','LIC','VPF','LIC','Housing Loan Main','Housing Addl.Loan - 2D','GSLI') union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                       "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) union " +
                       "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                       "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + " " +
                       //added new on 26/06/2020
                       "union all " +
                       "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount)  as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";

                    //section 80ccc
                    string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                    //section 80ccd
                    string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                        " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                    //section other section
                    string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                    //tax till
                    string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                    //other tds deductions
                    //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                    string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                        "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                        "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                    string emptax = "select sum(dd_prof_tax)+(200*(select 12-(select DATEDIFF(month, '" + startYear + "' , '" + FM + "')+1))) " +
                        "as ptax from pr_emp_payslip where fm >= '" + startYear + "' and emp_code= " + Convert.ToInt32(empCode) + "  group by emp_code order by emp_code;";
                    string chkph = "select * from pr_emp_general where emp_code= " + Convert.ToInt32(empCode) + " and phy_handicapped!=1;";

                    //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                    //VPF
                    string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm < '" + FM + "' and p.fm >= '" + startYear + "';";

                    string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                    " union all " +
                    " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' ";
                    string str_datediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff;";

                    string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm between '" + startYear + "' and  '" + endYear + "'  and emp_code=" + Convert.ToInt32(empCode) + ";";

                    string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                        " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";

                    string sumofbasicnolop = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as " +
                        " int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  from pr_emp_payslip " +
                        " where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                 " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                 " all_name!='Employee TDS'  group by all_name;";

                    string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                        " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                        " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                    string payfieldbasic = " SELECT  m.name as payfieldtype,amount,c.m_id FROM pr_emp_pay_field c JOIN pr_earn_field_master m ON c.m_id=m.id " +
                                "join pr_payslip_customization pc on c.m_id=pc.m_id WHERE emp_code=" + Convert.ToInt32(empCode) + " and pc.field_type='pay_fields' and m.type='pay_fields' and " +
                                "pc.cust_status='Yes' AND c.active=1 AND amount>0 group by m.name,amount,c.m_id  ;";
                    string strda_percent = "SELECT da_percent FROM pr_month_details WHERE fm=case when (select top 1 fm from pr_emp_payslip where " +
                        "emp_code="+ Convert.ToInt32(empCode) + " and er_basic>0 order by fm desc) is null then (select fm from pr_month_details where active=1) " +
                        "else (select top 1 fm from pr_emp_payslip where emp_code="+ Convert.ToInt32(empCode) + " and er_basic>0 order by fm desc) end ;";
                    string strdays = "select month_days as days from pr_month_details where active=1";
                    string qryConstantsnew = "SELECT constant, [value] FROM all_constants WHERE app_type='payroll' AND functionality='GenPayslip' AND active=1;";
                    string tdssections = " select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                    string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join "+
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '"+FM+"' and empcode = "+ Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                    DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                        SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                        cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry + loansprevmonth +
                        str_datediff + strincometax + nolopsbasic + sumofbasicnolop + SumAllowanceQrynew + ActiveSumAllowanceQrynew + 
                        chkph + emptax+payfieldbasic+strda_percent+strdays+ qryConstantsnew+ tdssections+ tdssection24);

                    //tables
                    var dtGeneral = ds.Tables[0];
                    var dtBasic = ds.Tables[1];
                    var dtBasicSum = ds.Tables[2];
                    var dtAllowance = ds.Tables[3];
                    var dtSumAllowance = ds.Tables[4];

                    var dtPfperks = ds.Tables[5];
                    var dtLoanPerks = ds.Tables[6];
                    var dtIncentives = ds.Tables[7];
                    var dt172 = ds.Tables[8];
                    var dt173 = ds.Tables[9];
                    var dtRent = ds.Tables[10];
                    var dtOther = ds.Tables[11];
                    var dtHouse = ds.Tables[12];

                    var dtCD = ds.Tables[13];
                    var dtCCC = ds.Tables[14];
                    var dtCCD = ds.Tables[15];
                    var dtEdu = ds.Tables[16];
                    var dtTax = ds.Tables[17];
                    var dtTDS = ds.Tables[18];
                    var dtEmpTax = ds.Tables[19];
                    var dtVpf = ds.Tables[20];
                    var dtActiveSumAllowance = ds.Tables[21];
                    var dt_prevmonthloans = ds.Tables[22];
                    var dt_datediff = ds.Tables[23];
                    var dt_incometax = ds.Tables[24];
                    var dt_nolopbasic = ds.Tables[25];
                    var dt_sumbasicnolop = ds.Tables[26];
                    var dtSumAllowancenew = ds.Tables[27];
                    var dtActiveSumAllowancenew = ds.Tables[28];
                    var dtph = ds.Tables[29];
                    var dtemployeetax = ds.Tables[30];
                    var dt_payfieldbasic = ds.Tables[31];
                    var dt_strda_percent = ds.Tables[32];
                    var dt_strdays = ds.Tables[33];
                    dt_qryconstantsnew = ds.Tables[34];
                    var dt_tdssections = ds.Tables[35];
                    var dt_tdssection24 = ds.Tables[36];
                    int loss_months = 0;
                    decimal? vpf_data = 0;
                    decimal? pf = 0;
                    decimal? lic = 0;
                    decimal? houseloanmain = 0;
                    decimal? houseAddloan_2d = 0;


                    if (dtEmpTax.Rows.Count > 0)
                    {
                        DataRow empTax = dtEmpTax.Rows[0];

                        object val = empTax["loss"];
                        if (val == DBNull.Value)
                        {
                            loss_months = 0;
                        }
                        else
                        {
                            loss_months = Convert.ToInt32(empTax["loss"]);
                        }

                    }
                    //vpf

                    if (dtVpf.Rows.Count > 0)
                    {
                        DataRow vpfData = dtVpf.Rows[0];

                        object val = vpfData["amount"];
                        if (val == DBNull.Value)
                        {
                            vpf_data = 0;
                        }
                        else
                        {
                            vpf_data = Convert.ToDecimal(vpfData["amount"]);
                        }

                    }

                    // General Data
                    if (dtGeneral.Rows.Count > 0)
                    {
                        DataRow gen = dtGeneral.Rows[0];
                        name = Convert.ToString(gen["name"]);
                        per_address = Convert.ToString(gen["per_address"]);
                        pan_no = Convert.ToString(gen["pan_no"]);
                        emp_code = Convert.ToString(gen["emp_code"]);
                        designation = Convert.ToString(gen["designation"]);
                        sex = Convert.ToString(gen["sex"]);
                        fm = fin_month;
                    }

                    //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance


                    if (dtBasic.Rows.Count > 0)
                    {

                        DataRow rbasic = dtBasic.Rows[0];

                        //basic 
                        object val = rbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            pbasic = 0;
                        }
                        else
                        {
                            pbasic = Convert.ToDecimal(rbasic["basic"]) * monthsnew;
                        }

                        //da_percent 
                        object val1 = rbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            pda_percent = 0;
                        }
                        else
                        {
                            pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * monthsnew;
                        }
                        //cca
                        object val2 = rbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            pcca = 0;
                        }
                        else
                        {
                            pcca = Convert.ToDecimal(rbasic["cca"]) * monthsnew;
                        }
                        //hra
                        object val3 = rbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            phra = 0;
                        }
                        else
                        {
                            phra = Convert.ToDecimal(rbasic["hra"]) * monthsnew;
                        }
                        //int_ref
                        object va4 = rbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            pint_ref = 0;
                        }
                        else
                        {
                            pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * monthsnew;
                        }

                        object val5 = rbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            pt_inc = 0;
                        }
                        else
                        {
                            pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * monthsnew;
                        }

                        object val6 = rbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            pspl_da = 0;
                        }
                        else
                        {
                            pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * monthsnew;
                        }

                        object val7 = rbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            pspl_allowance = 0;
                        }
                        else
                        {
                            pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * monthsnew;
                        }
                        object valpf = rbasic["pf"];
                        if (valpf == DBNull.Value)
                        {
                            pf = 0;
                        }
                        else
                        {
                            pf = Convert.ToDecimal(rbasic["pf"]) * monthsnew;
                        }

                    }



                    if (dt_prevmonthloans.Rows.Count > 0)
                    {
                        foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                        {
                            string val = dr_prelons["loantype"].ToString();
                            object amount = dr_prelons["amount"];
                            if (val == "Housing Loan Main")
                            {
                                if (amount == DBNull.Value)
                                {
                                    houseloanmain = 0;
                                }
                                else
                                {
                                    houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                }
                            }
                            else if (val == "Housing Addl.Loan - 2D")
                            {
                                if (amount == DBNull.Value)
                                {
                                    houseAddloan_2d = 0;
                                }
                                else
                                {
                                    houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                }
                            }
                        }
                    }
                    // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance


                    if (dtBasicSum.Rows.Count > 0)
                    {
                        DataRow sbasic = dtBasicSum.Rows[0];

                        //basic 
                        object val = sbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            basic = 0 + pbasic;
                        }
                        else
                        {
                            basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        }

                        //da_percent 
                        object val1 = sbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            da_percent = Convert.ToDecimal(0 + pda_percent);
                        }
                        else
                        {
                            da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        }
                        //cca
                        object val2 = sbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            cca = Convert.ToDecimal(0 + pcca);
                        }
                        else
                        {
                            cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        }
                        //hra
                        object val3 = sbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            hra = Convert.ToDecimal(0 + phra);
                        }
                        else
                        {
                            hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        }
                        //int_ref
                        object va4 = sbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            int_ref = 0 + pint_ref;
                        }
                        else
                        {
                            int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        }

                        object val5 = sbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            t_inc = 0 + pt_inc;
                        }
                        else
                        {
                            t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        }

                        object val6 = sbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            spl_da = 0 + pspl_da;
                        }
                        else
                        {
                            spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        }

                        object val7 = sbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            spl_allowance = 0 + pspl_allowance;
                        }
                        else
                        {
                            spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                        }

                        object val8 = sbasic["pf"];
                        if (val8 == DBNull.Value)
                        {
                            pf = 0;
                        }
                        else
                        {
                            pf = Convert.ToDecimal(sbasic["pf"]) + pf;
                        }



                        //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                    }

                    if (dt_payfieldbasic.Rows.Count > 0)
                    {
                        foreach (DataRow dr_paybasic in dt_payfieldbasic.Rows)
                        {
                            decimal? amount = 0;

                            object val = dr_paybasic["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(dr_paybasic["amount"]);
                            }

                            string dd_name = Convert.ToString(dr_paybasic["payfieldtype"].ToString());
                            if (dd_name == "Basic")
                            {
                                pbasic = amount;
                                basic = amount * monthsnew;
                            }
                            else if (dd_name == "Telangana Increment")
                            {
                                t_inc = amount * monthsnew;
                            }
                            else if (dd_name == "Interm Relief")
                            {
                                int_ref = amount * monthsnew;
                            }
                        }
                    }
                    int days = 0;
                    if (dt_strdays.Rows.Count > 0)
                    {
                        days = Convert.ToInt32(dt_strdays.Rows[0]["days"]);
                    }
                    decimal spl_allowancenew = 0;
                    decimal pfpercent = 12.50m;
                    if (pbasic != 0)
                    {
                        if (designation != "Managing Director")
                        {
                            hra = (CalcHRA(Convert.ToDecimal(pbasic), designation))* monthsnew;
                        }
                        da_percent = (CalcDA(Convert.ToDecimal(pbasic), dt_strda_percent))*monthsnew;
                        cca = (CalcCCA(Convert.ToDecimal(pbasic), designation, Convert.ToInt32(days), Convert.ToInt32(days)))* monthsnew;
                        spl_allowancenew = CalcSpl_Allw(Convert.ToDecimal(pbasic), designation);
                        spl_allowance = (CalcSpl_Allw(Convert.ToDecimal(pbasic), designation))* monthsnew;
                        spl_da = (CalcSplDA(Convert.ToDecimal(spl_allowancenew), dt_strda_percent))*monthsnew;
                    }
                    if(pf==0)
                    {
                        pf = ((basic + da_percent) * pfpercent) / 100;
                    }

                    //present allowances pper_allowance,pfpa_allow,pfpiip

                    //foreach (DataRow algen in dtAllowance.Rows)
                    //{


                    //    string alw_name = algen["all_name"].ToString();
                    //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                    //    if (alw_name == "Fixed Personal Allowance")
                    //    {
                    //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == "FPA-HRA Allowance")
                    //    {
                    //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == PrConstants.FPIIP)
                    //    {
                    //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                    //    }

                    //}

                    ////dtSumFixed
                    //if (dtSumFixed.Rows.Count > 0)
                    //{
                    //    DataRow sumf = dtSumFixed.Rows[0];

                    //    object val = sumf["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        per_allowance = 0 + pper_allowance;
                    //    }
                    //    else
                    //    {
                    //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                    //    }

                    //}
                    ////dtsumFPA
                    //if (dtsumFPA.Rows.Count > 0)
                    //{
                    //    DataRow sumfpa = dtsumFPA.Rows[0];

                    //    object val = sumfpa["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpa_allow = 0 + pfpa_allow;
                    //    }
                    //    else
                    //    {
                    //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                    //    }

                    //}
                    ////dtsumfpiip
                    //if (dtsumfpiip.Rows.Count > 0)
                    //{
                    //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                    //    object val = sumfpiip["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpiip = 0 + pfpiip;
                    //    }
                    //    else
                    //    {
                    //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                    //    }
                    //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                    //}
                    //getting the date difference from finstart year and current year for allowance
                    if (dt_datediff.Rows.Count > 0)
                    {
                        datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                    }

                    List<OldAllowance> oldList = new List<OldAllowance>();
                    //foreach (DataRow dtold in dtSumAllowance.Rows)
                    //{
                    //    OldAllowance objoldlist = new OldAllowance();
                    //    objoldlist.old_Name = dtold["all_name"].ToString();
                    //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                    //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                    //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                    //    oldList.Add(objoldlist);
                    //}
                    foreach (DataRow dtold in dtSumAllowancenew.Rows)
                    {
                        OldAllowance objoldlist = new OldAllowance();
                        objoldlist.old_Name = dtold["all_name"].ToString();
                        //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                        objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                        //objoldlist.old_alw_type = dtold["all_type"].ToString();
                        oldList.Add(objoldlist);
                    }



                    List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                    //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                    //{

                    //    ActiveAllowance NewObjlist = new ActiveAllowance();
                    //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                    //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                    //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString());
                    //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                    //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                    //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                    //    if (olditem != null)
                    //    {
                    //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                    //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                    //    }

                    //    NewActiveList.Add(NewObjlist);
                    //}
                    foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                    {

                        ActiveAllowance NewObjlist = new ActiveAllowance();
                        NewObjlist.Active_Name = dtActive["all_name"].ToString();
                        //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                        NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * monthsnew;
                        //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                        //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                        var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                        if (olditem != null)
                        {
                            NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                        }

                        NewActiveList.Add(NewObjlist);
                    }



                    //if not in new list then add
                    //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                    //{
                    //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                    //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                    //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                    //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                    //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                    //    if (olditem == null)
                    //    {
                    //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                    //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                    //        NewActiveList.Add(NewObjlist1);
                    //    }
                    //}
                    foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                    {
                        ActiveAllowance NewObjlist1 = new ActiveAllowance();
                        NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                        //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                        //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                        var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                        if (olditem == null)
                        {
                            NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            NewActiveList.Add(NewObjlist1);
                        }
                    }

                    var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                    if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                    {
                        await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                    }
                    int NewNumIndex = 0;

                    StringBuilder sbqry = new StringBuilder();
                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());
                    decimal total_allowance = 0;
                    //foreach (var newlist in NewActiveList)
                    //{
                    //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                    //    NewNumIndex++;
                    //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                    //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                    //    sbqry.Append(newqry);
                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    //}

                    foreach (var newlist in NewActiveList)
                    {
                        total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                        NewNumIndex++;
                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                        var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                            " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                            "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                            " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                        sbqry.Append(newqry);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    }




                    //List<string> lststring = new List<string>();
                    //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                    //// dtPfPerks
                    //if (dtPfperks.Rows.Count > 0)
                    //{
                    //    DataRow pfPerk = dtPfperks.Rows[0];

                    //    object val = pfPerk["pf_perk"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        pf_perk = 0;
                    //    }
                    //    else
                    //    {
                    //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                    //    }

                    //}
                    //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                   
                    //dtLoanPerks
                    if (dtLoanPerks.Rows.Count > 0)
                    {
                        DataRow lperk = dtLoanPerks.Rows[0];

                        object val = lperk["loan_perk"];
                        if (val == DBNull.Value)
                        {
                            loan_perk = 0;
                        }
                        else
                        {
                            loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                        }

                    }
                    //dtIncentives
                    if (dtIncentives.Rows.Count > 0)
                    {
                        DataRow ins = dtIncentives.Rows[0];

                        object val = ins["incentive"];
                        if (val == DBNull.Value)
                        {
                            incentives = 0;
                        }
                        else
                        {
                            incentives = Convert.ToDecimal(ins["incentive"]);
                        }

                    }
                    //dt172
                    if (dt172.Rows.Count > 0)
                    {
                        DataRow VAL = dt172.Rows[0];
                        object val = VAL["val172"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_2 = 0;
                        }
                        else
                        {
                            values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                            totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                        }
                    }
                    //dt173
                    if (dt173.Rows.Count > 0)
                    {
                        DataRow VAL1 = dt173.Rows[0];
                        object val = VAL1["val173"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_3 = 0;
                        }
                        else
                        {
                            values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                        }
                    }

                    if (dtRent.Rows.Count > 0)
                    {
                        DataRow rents = dtRent.Rows[0];

                        object val = rents["rentamount"];
                        if (val == DBNull.Value)
                        {
                            house_rent_allowance = 0;
                        }
                        else
                        {
                            house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                        }
                    }

                    if (house_rent_allowance > 0)
                    {
                        decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                        //salary(a)
                        decimal salary = da_percent + Convert.ToDecimal(basic);
                        //40%  of salary(b)
                        decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                        //houserentpaid - 10% of salary(c)
                        //decimal hrentpaid = Math.Abs(rentamt - (Convert.ToDecimal((0.10)) * (salary)));
                        decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                        //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                        house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                        // HouseRentAllowance calculated as on 04-09-2020
                        // minimun values of (
                        // Basic+DA --40%,
                        // House Rent Paid minus Basic+DA --10% 
                        // HRA)
                    }
                    if (house_rent_allowance < 0)
                    {
                        house_rent_allowance = 0;
                    }
                    //decimal daval = Convert.ToDecimal(da);
                    //decimal hraval = Convert.ToDecimal(hra);
                    //rent amount




                    if (dtOther.Rows.Count > 0)
                    {
                        DataRow otr = dtOther.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = otr["other"];
                        if (val == DBNull.Value)
                        {
                            other = 0;
                        }
                        else
                        {
                            other = Convert.ToDecimal(otr["other"]);
                        }

                    }

                    if (dtHouse.Rows.Count > 0)
                    {
                        //foreach (DataRow dr in dtHouse.Rows)
                        //{
                        //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                        //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                        //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                        //        || dr["loan_type_mid"].ToString() == "13")
                        //    {
                        //        count++;
                        //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                        //    }

                        //}
                        DataRow dh = dtHouse.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = dh["amount"];
                        if (val == DBNull.Value)
                        {
                            houseloan_allownace = 0;
                        }
                        else
                        {
                            houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                        }

                    }
                    //if (count > 0)
                    //{

                    //    houseloan_allownace = 200000;
                    //}

                    IList<section80C> lstCer = new List<section80C>();
                    IList<section80CCC> lstCCC = new List<section80CCC>();
                    IList<section80CCD> lstCCD = new List<section80CCD>();
                    IList<sectionOther> lstOther = new List<sectionOther>();

                    decimal pf_new = 0;
                    if (dtCD.Rows.Count > 0)
                    {
                        foreach (DataRow cer in dtCD.Rows)
                        {
                            //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                            decimal? amount = 0;

                            object val = cer["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(cer["amount"]);
                            }

                            string dd_name = Convert.ToString(cer["name"].ToString());
                            if (dd_name == "Provident Fund")
                            {
                                amount = Convert.ToDecimal(pf + (amount * months));
                                pf_new = Convert.ToDecimal(amount);
                            }
                            else if (dd_name == "VPF")
                            {
                                amount = Convert.ToDecimal(vpf_data + (amount * months));
                            }
                            else if (dd_name == "LIC")
                            {
                                amount = Convert.ToDecimal(lic + (amount * months));
                            }
                            else if (dd_name == "Housing Loan Main")
                            {
                                amount = Convert.ToDecimal(houseloanmain + (amount * months));
                            }
                            else if (dd_name == "Housing Addl.Loan - 2D")
                            {
                                amount = Convert.ToDecimal(houseAddloan_2d + (amount * months));
                            }
                            else if (dd_name == "GSLI")
                            {
                                amount = Convert.ToDecimal(gsli + (amount * months));
                            }
                            else
                            {
                                amount = Convert.ToDecimal((amount * months));
                            }
                            if (amount == 0)
                            { continue; }
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                        }


                    }
                    else
                    {
                        lstCer.Add(new section80C
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //for special deductions
                    if (dt_tdssections.Rows.Count > 0)
                    {
                        foreach (DataRow cer1 in dt_tdssections.Rows)
                        {
                            decimal? amount1 = 0;
                            decimal? allowance_amount1 = 0;
                            amount1 = Convert.ToDecimal(cer1["gross"]);
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount1 > min_allowance)
                                {
                                    allowance_amount1 = min_allowance;
                                    min_allowance = min_allowance - allowance_amount1;
                                    max_allowance = max_allowance + allowance_amount1;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount1;
                                    allowance_amount1 = amount1;
                                    max_allowance = max_allowance + amount1;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }

                    }

                    decimal pf_perkcal = 0.5m;
                    decimal pf_perktemp = 12.5m;
                    pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                    //if (dtCCC.Rows.Count > 0)
                    //{
                    //    foreach (DataRow ccc in dtCCC.Rows)
                    //    {
                    //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                    //        decimal? allowance_amount = 0;
                    //        if (min_allowance > 0 && max_allowance <= 150000)
                    //        {
                    //            if (amount > min_allowance)
                    //            {
                    //                allowance_amount = min_allowance;
                    //                min_allowance = min_allowance - allowance_amount;
                    //                max_allowance = max_allowance + allowance_amount;
                    //            }
                    //            else
                    //            {
                    //                min_allowance = min_allowance - amount;
                    //                allowance_amount = amount;
                    //                max_allowance = max_allowance + amount;
                    //            }
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                    //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //            });
                    //        }
                    //        else
                    //        {
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                    //                allowance_amount = AddZerosAfterDecimal("0"),
                    //                ded_amount = AddZerosAfterDecimal("0")
                    //            });
                    //        }

                    //    }

                    //}
                    //else
                    //{
                    //    lstCCC.Add(new section80CCC
                    //    {
                    //        id = "",
                    //        name = "",
                    //        amount = AddZerosAfterDecimal("0"),
                    //        allowance_amount = AddZerosAfterDecimal("0"),
                    //        ded_amount = AddZerosAfterDecimal("0")
                    //    });
                    //}

                    if (dtCCD.Rows.Count > 0)
                    {
                        foreach (DataRow ccd in dtCCD.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                            {
                                if (amount > min_allowance80CCD)
                                {
                                    allowance_amount = min_allowance80CCD;
                                    min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                    max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                }
                                else
                                {
                                    min_allowance80CCD = min_allowance80CCD - amount;
                                    allowance_amount = amount;
                                    max_allowance80CCD = max_allowance80CCD + amount;
                                }
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }
                    }
                    else
                    {
                        lstCCD.Add(new section80CCD
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    if (dtEdu.Rows.Count > 0)
                    {
                        foreach (DataRow ed in dtEdu.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                            String sectionNAme = ed["section"].ToString();
                            decimal? allowance_amount = 0;
                            string id = ed["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = ed["name"].ToString();
                            if (sectionNAme == "Section80G")
                            {
                                allowance_amount = amount * section80g;
                                max_allowanceGG = max_allowanceGG + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80GGB")
                            {
                                allowance_amount = amount * section80gg;
                                max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80DDB")
                            {
                                if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                {
                                    if (amount > min_allowance80DDB)
                                    {
                                        allowance_amount = min_allowance80DDB;
                                        ded_amount = allowance_amount;
                                        min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                        max_allowance80DB = max_allowance80DB + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DDB = min_allowance80DDB - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DB = max_allowance80DB + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                            }
                            else if (sectionNAme == "Section80DD")
                            {
                                if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                {
                                    if (amount > min_allowance80DD)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80DD = min_allowance80DD - allowance_amount;
                                        max_allowance80DD = max_allowance80DD + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DD = min_allowance80DD - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DD = max_allowance80DD + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80U")
                            {
                                if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                {
                                    if (amount > min_allowance80U)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80U = min_allowance80U - allowance_amount;
                                        max_allowance80U = max_allowance80U + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80U = min_allowance80U - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80U = max_allowance80U + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80E")
                            {
                                allowance_amount = amount;
                                max_allowance = max_allowance + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            else if (sectionNAme == "Section80D_P")
                            {
                                if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                {
                                    if (amount > min_allowance80D_P)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                        max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_P = min_allowance80D_P - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_P = max_allowance80D_P + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                                //if (min_allowance80D_P > amount)
                                //{
                                //    allowance_amount = amount;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}

                                //else
                                //{
                                //    allowance_amount = min_allowance80D_P;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}
                            }
                            else if (sectionNAme == "Section80D_F")
                            {
                                if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                {
                                    if (amount > min_allowance80D_F)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                        max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_F = min_allowance80D_F - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_F = max_allowance80D_F + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2"||sectionNAme== "Section80EE_HL")
                            {
                                if (sectionNAme != "Section80EE")
                                {
                                    sectionNAme = "Section80EE_HL";
                                }
                                if (min_allowance80EE > 0 && max_allowance80ee <= 300000)
                                {
                                    if (amount > min_allowance80EE)
                                    {
                                        allowance_amount = min_allowance80EE;
                                        min_allowance80EE = min_allowance80EE - allowance_amount;
                                        max_allowance80ee = max_allowance80ee + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80EE = min_allowance80EE - amount;
                                        allowance_amount = amount;
                                        max_allowance80ee = max_allowance80ee + amount;
                                    }
                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;

                                }
                            }

                            else if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });

                        }

                    }

                    else
                    {
                        lstOther.Add(new sectionOther
                        {
                            id = "",
                            name = "",
                            section = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //special section24(b)
                    if (dt_tdssection24.Rows.Count > 0)
                    {
                        foreach (DataRow sec24 in dt_tdssection24.Rows)
                        {
                            decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                            String sectionNAme = sec24["section"].ToString();
                            string actName1 = "";
                            decimal? allowance_amount = 0;
                            string id = sec24["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = sec24["name"].ToString();

                            for (int i = 0; i < lstOther.Count; i++)
                            {
                                actName1 = lstOther[i].name;
                                if (actName1 == actName)
                                {
                                    lstOther.RemoveAt(i);
                                    continue;
                                }
                            }
                            if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });
                        }
                    }

                    max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                    if (dtTax.Rows.Count > 0)
                    {


                        DataRow tax = dtTax.Rows[0];

                        object val = tax["tax_deducted_at_source"];
                        if (val == DBNull.Value)
                        {
                            total_tax_till = 0;
                        }
                        else
                        {
                            total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                        }

                        tax_till = totaltaxdeductedfrm16 + total_tax_till;
                        tax_till = 0;

                    }

                    if (dtTDS.Rows.Count > 0)
                    {
                        DataRow TDS = dtTDS.Rows[0];

                        object val = TDS["tds_amount"];
                        if (val == DBNull.Value)
                        {
                            paid_by_emp = 0;
                        }
                        else
                        {
                            paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                        }
                    }

                    IList<TDSProcess> lstTDS = new List<TDSProcess>();

                    gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                    total_section = house_rent_allowance;

                    balance = gross - total_section;

                    //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                    //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                    decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                    if (stndednew >= 50000)
                    {
                        standard_deduction = PrConstants.STANDARD_DEDUCTION;
                    }
                    else
                    {
                        standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                    }
                    //standard_deduction = gross*0.04;
                    if (dtph.Rows.Count > 0)
                    {
                        if (dtemployeetax.Rows.Count > 0)
                        {
                            DataRow etax = dtemployeetax.Rows[0];
                            object val = etax["ptax"];
                            if (val == DBNull.Value)
                            {
                                emp_tax = 0;
                            }
                            else
                            {
                                emp_tax = Convert.ToInt32(etax["ptax"]);
                            }
                        }
                        //if (dtemppayslipforfinmonth.Rows.Count == 0)
                        //{
                        //    loss_months = 0;
                        //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                        //    if (emp_tax > 2400)
                        //    {
                        //        emp_tax = 2400;
                        //    }
                        //}
                        //else
                        //{
                        //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                        //    if (emp_tax > 2400)
                        //    {
                        //        emp_tax = 2400;
                        //    }
                        //}
                    }


                    aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                    Income_chargable = balance - aggregate_of_4; //6

                    total_gross_income = Income_chargable + other - houseloan_allownace;

                    deductible = Convert.ToDecimal(max_allowance);
                    total_income = total_gross_income - deductible;
                    //total_income = Convert.ToDecimal(841240.01);
                    round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                    //tax_deducted_at_source is calculating as incometax value of current financial year.
                    decimal tax_deducted_at_source1 = 0;
                    if (dt_incometax.Rows.Count > 0)
                    {
                        DataRow incometax = dt_incometax.Rows[0];

                        object val = incometax["income_tax"];
                        if (val == DBNull.Value)
                        {
                            tax_deducted_at_source1 = 0;
                        }
                        else
                        {
                            tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                        }
                    }

                    if (total_income > 500000)
                    {
                        //strConvert = income.ToString();
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = 0;
                        edu_cess = income * 4 / 100;

                        tax_payable = (float)income + edu_cess;
                        tax_payable = (int)Math.Round(tax_payable);

                        //if (tax_till > tax_payable)
                        //{
                        //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                        //}
                        //else
                        //{
                        //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                        //}
                        tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                        if (tax_balance < 0)
                        {
                            tax_balance = 0;
                        }

                        tds_per_month = tax_balance / months;
                        if (Financial_md.Month != 03)
                        {
                            int x = (int)Math.Round(tds_per_month);
                            int y = (int)Math.Round(x / 100d, 0) * 100;
                            rounding_tds_per_month = y;
                        }
                        else
                        {
                            int xp = (int)Math.Round(tds_per_month);
                            int Z = (10 - xp % 10) + xp;
                            rounding_tds_per_month = Z;
                        }

                        //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                    }
                    else
                    {
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = Convert.ToDecimal(income);
                        edu_cess = 0;

                        tax_payable = 0;

                        tax_till = 0;
                        tax_balance = 0;

                        tds_per_month = 0;

                        rounding_tds_per_month = 0;
                    }
                    //string employer_name_address = PrConstants.Name;
                    //string employer_pan = PrConstants.PAN;
                    //string employer_tan = PrConstants.TAN;

                    lstTDS.Add(new TDSProcess
                    {
                        option = optn.Rows[0]["Option"].ToString(),
                        name = name,
                        per_address = per_address,
                        pan_no = pan_no,
                        emp_code = emp_code,
                        designation = designation,
                        sex = sex,
                        fm = fm,
                        employer_name_address = employer_name_address,
                        employer_pan = employer_pan,
                        employer_tan = employer_tan,
                        basic = AddZerosAfterDecimal(Convert.ToString(basic)),
                        da_percent = AddZerosAfterDecimal(Convert.ToString(da_percent)),
                        per_allowance = AddZerosAfterDecimal(Convert.ToString(per_allowance)),
                        int_ref = AddZerosAfterDecimal(Convert.ToString(int_ref)),
                        t_inc = AddZerosAfterDecimal(Convert.ToString(t_inc)),
                        fpa_allow = AddZerosAfterDecimal(Convert.ToString(fpa_allow)),
                        fpiip = AddZerosAfterDecimal(Convert.ToString(fpiip)),
                        pf_perk = AddZerosAfterDecimal(Convert.ToString(pf_perk)),
                        loan_perk = AddZerosAfterDecimal(Convert.ToString(loan_perk)),
                        incentives = AddZerosAfterDecimal(Convert.ToString(incentives)),
                        spl_allowance = AddZerosAfterDecimal(Convert.ToString(spl_allowance)),
                        spl_da = AddZerosAfterDecimal(Convert.ToString(spl_da)),
                        hra = AddZerosAfterDecimal(Convert.ToString(hra)),
                        cca = AddZerosAfterDecimal(Convert.ToString(cca)),
                        values_of_17_2 = AddZerosAfterDecimal(Convert.ToString(values_of_17_2)),
                        values_of_17_3 = AddZerosAfterDecimal(Convert.ToString(values_of_17_3)),
                        gross = AddZerosAfterDecimal(Convert.ToString(gross)), // 2 pending
                        standard_deduction = AddZerosAfterDecimal(Convert.ToString(standard_deduction)),
                        ent_allowance = AddZerosAfterDecimal(Convert.ToString(ent_allowance)),
                        emp_tax = AddZerosAfterDecimal(Convert.ToString(emp_tax)),
                        aggregate_of_4 = AddZerosAfterDecimal(Convert.ToString(aggregate_of_4)),
                        Income_chargable = AddZerosAfterDecimal(Convert.ToString(Income_chargable)),
                        other = AddZerosAfterDecimal(Convert.ToString(other)),
                        houseloan_allownace = AddZerosAfterDecimal(Convert.ToString(houseloan_allownace)),
                        total_gross_income = AddZerosAfterDecimal(Convert.ToString(total_gross_income)),
                        loan_instl_amt = AddZerosAfterDecimal(Convert.ToString(loan_instl_amt)),
                        deductible = AddZerosAfterDecimal(Convert.ToString(deductible)),
                        total_income = AddZerosAfterDecimal(Convert.ToString(total_income)),
                        income = AddZerosAfterDecimal(Convert.ToString(income)),
                        edu_cess = AddZerosAfterDecimal(Convert.ToString(edu_cess)),
                        tax_payable = AddZerosAfterDecimal(Convert.ToString(tax_payable)),
                        tax_till = AddZerosAfterDecimal(Convert.ToString(tax_till)),
                        tax_balance = AddZerosAfterDecimal(Convert.ToString(tax_balance)),
                        balance_month = Convert.ToString(months),
                        tds_per_month = AddZerosAfterDecimal(Convert.ToString(rounding_tds_per_month)),
                        house_rent_allowance = AddZerosAfterDecimal(Convert.ToString(house_rent_allowance)),
                        total_section = AddZerosAfterDecimal(Convert.ToString(total_section)),
                        balance = AddZerosAfterDecimal(Convert.ToString(balance)),
                        round_income = AddZerosAfterDecimal(Convert.ToString(round_income)),
                        section_87a = AddZerosAfterDecimal(Convert.ToString(section_87a)),
                        //paid_by_emp = AddZerosAfterDecimal(Convert.ToString(paid_by_emp)),
                        paid_by_emp = AddZerosAfterDecimal(Convert.ToString(tax_deducted_at_source1)),

                    }); ;
                    var tds = JsonConvert.SerializeObject(lstTDS);
                    var ccT = JsonConvert.SerializeObject(lstCer);
                    var cccT = JsonConvert.SerializeObject(lstCCC);
                    var ccdT = JsonConvert.SerializeObject(lstCCD);
                    var otherT = JsonConvert.SerializeObject(lstOther);
                    var allowanceT = JsonConvert.SerializeObject(NewActiveList);

                    var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                    var tdsData = javaScriptSerializer.DeserializeObject(tds);
                    var ccData = javaScriptSerializer.DeserializeObject(ccT);
                    var cccData = javaScriptSerializer.DeserializeObject(cccT);
                    var ccdData = javaScriptSerializer.DeserializeObject(ccdT);
                    var otherData = javaScriptSerializer.DeserializeObject(otherT);
                    var allowanceTdata = javaScriptSerializer.DeserializeObject(allowanceT);

                    var resultJson = javaScriptSerializer.Serialize(new
                    {
                        tds = tdsData,
                        cc = ccData,
                        ccc = cccData,
                        ccd = ccdData,
                        other = otherData,
                        allowance = allowanceTdata

                    });
                    //int NewNumIndex = 0;

                    //StringBuilder sbqry = new StringBuilder();
                    ////1. trans_id
                    //sbqry.Append(GenNewTransactionString());

                    int finalSub = 0;

                    if (final == true)
                    {
                        finalSub = 1;
                    }
                    else
                    {
                        finalSub = 0;
                    }

                    string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable details = await _sha.Get_Table_FromQry(selQry);
                    if (details.Rows.Count > 0)
                    {
                        NewNumIndex++;
                        DataRow finaldt = details.Rows[0];
                        string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                        sbqry.Append(tdsdelete);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                        int finalCount = Convert.ToInt32(finaldt["final"]);

                        if (finalCount == 1)
                        {
                            return "E#TDS Process#Employee Already Processed..!!";
                        }
                        else
                        {
                            NewNumIndex++;
                            string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            sbqry.Append(tdsUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                            NewNumIndex++;
                            string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            sbqry.Append(certUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));


                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                foreach (var ccDatas in lstCer)
                                {
                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    foreach (var cccDatas in lstCCC)
                            //    {
                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }



                    }
                    else
                    {

                        try
                        {

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate1);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate2);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var ccDatas in lstCer)
                                {

                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate3);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var cccDatas in lstCCC)
                            //    {

                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    NewNumIndex++;
                                    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate3);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate4);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }
                        catch (Exception e)
                        {
                            return "E#TDS Process#" + e.Message;
                        }
                    }
                    return resultJson;
                    //}
                }
                else if (optn.Rows[0]["Option"].ToString() == "1" && dtretiredate.Rows.Count == 0 && zerobasic > 0)
                {
                    decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                           .Where(x => x["constant"].ToString() == "Section80C")
                           .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                    decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80CCD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                    decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80U")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DDB")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                    decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_P")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                    decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_F")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                    decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80EE")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                    decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section24(b)")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                    decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80G")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                    decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80GGB")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                    DataTable _dtFY_FM = ds1.Tables[1];
                    _incometaxdbconstant = ds1.Tables[2];


                    //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                        "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                        "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " and spl_type='Regular' order by id desc); ";

                    //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                        "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                        "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                    //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                    string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                    //allowance ==>Get and Sum all previous months allowances 
                    string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                    //allowance ==> Get all current month allowances
                    string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                    //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                    ////sum Personal Allowance
                    //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                    //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                    ////sum FPIIP
                    //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                    //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                    //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                    //sum PFPerks                                                   
                    string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                    // sum LOANPerks                                                    
                    string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                    // sum Incentive                                                    
                    string incentive = "select distinct sum(amount) as incentive from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    // sum  val 17 -2
                    string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                         "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                    // sum val 17 -3
                    string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                        "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                        " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                    //rent allowance
                    //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                    string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                    //other
                    string otherQry = "select distinct sum(amount) as other from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    //house loan
                    string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                    //section 80c
                    //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                    //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                    //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                    string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                       "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                       "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 and ef.name not in('Provident Fund','LIC','VPF','LIC','Housing Loan Main','Housing Addl.Loan - 2D','GSLI') union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                       "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) union " +
                       "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                       "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + " " +
                       //added new on 26/06/2020
                       "union all " +
                       "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount)  as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                       "union all " +
                       "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                       "union all " +
                       "select '7' as id, 'Housing Loan 2B-2C' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2B-2C' and emp_code = " + Convert.ToInt32(empCode) + "  and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                       "union all " +
                       "select '8' as id, 'Housing Loan 2A' as name, sum(paydedu.dd_amount) as amount  from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2A' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                       " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC';";

                    //section 80ccc
                    string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                    //section 80ccd
                    string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD' " +
                        " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                    //section other section
                    string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                    //tax till
                    string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                    //other tds deductions
                    //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                    string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                        "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                        "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                    string emptax = "select sum(dd_prof_tax)+(200*(select 12-(select DATEDIFF(month, '" + startYear + "' , '" + FM + "')+1))) " +
                        "as ptax from pr_emp_payslip where fm >= '" + startYear + "' and emp_code= " + Convert.ToInt32(empCode) + "  group by emp_code order by emp_code;";
                    string chkph = "select * from pr_emp_general where emp_code= " + Convert.ToInt32(empCode) + " and phy_handicapped!=1;";

                    //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                    //VPF
                    string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm <= '" + FM + "' and p.fm >= '" + startYear + "';";

                    string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                    " union all " +
                    " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' " +
                    "union all  " +
                    "select 'Housing Loan 2B-2C',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =  " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "'  and fm>= '" + startYear + "'  and emp_code =  " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2B-2C' " +
                    "union all  " +
                    "select 'Housing Loan 2A',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + "  and payslip_mid in(select id from pr_emp_payslip where fm <  '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2A' ";

                    string str_datediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff;";

                    string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm between '" + startYear + "' and  '" + endYear + "'  and emp_code=" + Convert.ToInt32(empCode) + ";";

                    string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                        " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";

                    string sumofbasicnolop = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as " +
                        " int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  from pr_emp_payslip " +
                        " where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                 " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                 " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                    string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                        " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                        " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";
                    
                    string strpf = " select sum(dd_provident_fund) pf  from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";
                    
                    string strprevlicgsli = "select 'LIC' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'LIC' and payslip_mid " +
                                           " in(select id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "') " +
                                           "union all" +
                                           " select 'GSLI' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'GSLI' and payslip_mid " +
                                           " in(select id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "');";

                    string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='"+FM+"' and empcode="+ Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                    string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                    DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                        SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                        cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry + loansprevmonth +
                        str_datediff + strincometax + nolopsbasic + sumofbasicnolop + SumAllowanceQrynew + ActiveSumAllowanceQrynew + 
                        chkph + emptax+ strpf+ strprevlicgsli+ tdssections+ tdssection24);

                    //tables
                    var dtGeneral = ds.Tables[0];
                    var dtBasic = ds.Tables[1];
                    var dtBasicSum = ds.Tables[2];
                    var dtAllowance = ds.Tables[3];
                    var dtSumAllowance = ds.Tables[4];

                    var dtPfperks = ds.Tables[5];
                    var dtLoanPerks = ds.Tables[6];
                    var dtIncentives = ds.Tables[7];
                    var dt172 = ds.Tables[8];
                    var dt173 = ds.Tables[9];
                    var dtRent = ds.Tables[10];
                    var dtOther = ds.Tables[11];
                    var dtHouse = ds.Tables[12];

                    var dtCD = ds.Tables[13];
                    var dtCCC = ds.Tables[14];
                    var dtCCD = ds.Tables[15];
                    var dtEdu = ds.Tables[16];
                    var dtTax = ds.Tables[17];
                    var dtTDS = ds.Tables[18];
                    var dtEmpTax = ds.Tables[19];
                    var dtVpf = ds.Tables[20];
                    var dtActiveSumAllowance = ds.Tables[21];
                    var dt_prevmonthloans = ds.Tables[22];
                    var dt_datediff = ds.Tables[23];
                    var dt_incometax = ds.Tables[24];
                    var dt_nolopbasic = ds.Tables[25];
                    var dt_sumbasicnolop = ds.Tables[26];
                    var dtSumAllowancenew = ds.Tables[27];
                    var dtActiveSumAllowancenew = ds.Tables[28];
                    var dtph = ds.Tables[29];
                    var dtemployeetax = ds.Tables[30];
                    var dt_strpf = ds.Tables[31];
                    var dt_strprevlicgsli = ds.Tables[32];
                    var dt_tdssections = ds.Tables[33];
                    var dt_tdssection24 = ds.Tables[34];
                    int loss_months = 0;
                    decimal? vpf_data = 0;
                    decimal? pf = 0;
                    decimal? lic = 0;
                    decimal? houseloanmain = 0;
                    decimal? houseAddloan_2d = 0;
                    decimal? houseloan2bc = 0;
                    decimal? houseloan2a = 0;

                    if (dtEmpTax.Rows.Count > 0)
                    {
                        DataRow empTax = dtEmpTax.Rows[0];

                        object val = empTax["loss"];
                        if (val == DBNull.Value)
                        {
                            loss_months = 0;
                        }
                        else
                        {
                            loss_months = Convert.ToInt32(empTax["loss"]);
                        }

                    }
                    //vpf

                    if (dtVpf.Rows.Count > 0)
                    {
                        DataRow vpfData = dtVpf.Rows[0];

                        object val = vpfData["amount"];
                        if (val == DBNull.Value)
                        {
                            vpf_data = 0;
                        }
                        else
                        {
                            vpf_data = Convert.ToDecimal(vpfData["amount"]);
                        }

                    }

                    // General Data
                    if (dtGeneral.Rows.Count > 0)
                    {
                        DataRow gen = dtGeneral.Rows[0];
                        name = Convert.ToString(gen["name"]);
                        per_address = Convert.ToString(gen["per_address"]);
                        pan_no = Convert.ToString(gen["pan_no"]);
                        emp_code = Convert.ToString(gen["emp_code"]);
                        designation = Convert.ToString(gen["designation"]);
                        sex = Convert.ToString(gen["sex"]);
                        fm = fin_month;
                    }

                    //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    if (dt_lopdays.Rows.Count > 0)
                    {
                        if (dt_nolopbasic.Rows.Count > 0)
                        {

                            DataRow rbasic = dt_nolopbasic.Rows[0];

                            //basic 
                            object val = rbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                pbasic = 0;
                            }
                            else
                            {
                                pbasic = Convert.ToDecimal(rbasic["basic"]) * (monthsnew);
                            }

                            //da_percent 
                            object val1 = rbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                pda_percent = 0;
                            }
                            else
                            {
                                pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * (monthsnew);
                            }
                            //cca
                            object val2 = rbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                pcca = 0;
                            }
                            else
                            {
                                pcca = Convert.ToDecimal(rbasic["cca"]) * (monthsnew);
                            }
                            //hra
                            object val3 = rbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                phra = 0;
                            }
                            else
                            {
                                phra = Convert.ToDecimal(rbasic["hra"]) * (monthsnew);
                            }
                            //int_ref
                            object va4 = rbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                pint_ref = 0;
                            }
                            else
                            {
                                pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * (monthsnew);
                            }

                            object val5 = rbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                pt_inc = 0;
                            }
                            else
                            {
                                pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * (monthsnew);
                            }

                            object val6 = rbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                pspl_da = 0;
                            }
                            else
                            {
                                pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * (monthsnew);
                            }

                            object val7 = rbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                pspl_allowance = 0;
                            }
                            else
                            {
                                pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * (monthsnew);
                            }




                        }
                    }
                    else
                    {
                        if (dtBasic.Rows.Count > 0)
                        {

                            DataRow rbasic = dtBasic.Rows[0];

                            //basic 
                            object val = rbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                pbasic = 0;
                            }
                            else
                            {
                                pbasic = Convert.ToDecimal(rbasic["basic"]) * months;
                            }

                            //da_percent 
                            object val1 = rbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                pda_percent = 0;
                            }
                            else
                            {
                                pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months;
                            }
                            //cca
                            object val2 = rbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                pcca = 0;
                            }
                            else
                            {
                                pcca = Convert.ToDecimal(rbasic["cca"]) * months;
                            }
                            //hra
                            object val3 = rbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                phra = 0;
                            }
                            else
                            {
                                phra = Convert.ToDecimal(rbasic["hra"]) * months;
                            }
                            //int_ref
                            object va4 = rbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                pint_ref = 0;
                            }
                            else
                            {
                                pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months;
                            }

                            object val5 = rbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                pt_inc = 0;
                            }
                            else
                            {
                                pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months;
                            }

                            object val6 = rbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                pspl_da = 0;
                            }
                            else
                            {
                                pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months;
                            }

                            object val7 = rbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                pspl_allowance = 0;
                            }
                            else
                            {
                                pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months;
                            }

                        }
                    }


                    if (dt_prevmonthloans.Rows.Count > 0)
                    {
                        foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                        {
                            int loanid = 0;
                            int pflag = 0;
                            int pflag1 = 0;
                            int countofsub = 0;
                            int precoverflag = 0;
                            string val = dr_prelons["loantype"].ToString();
                            string getloanid = "select id  from pr_loan_master where loan_description='" + val + "'";
                            DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                             loanid =Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                            string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                            string comparequery= "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                            DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                            DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                      
                                if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"])>0)
                                {
                                    countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                    precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                }
                        
                     
                            if (dtchkloaneligibility.Rows.Count > 0)
                             {
                                pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                             }
                            object amount = dr_prelons["amount"];
                            if (countofsub!= precoverflag)
                            {
                                if (val == "Housing Loan Main")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloanmain = 0;
                                    }
                                    else
                                    {
                                        houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Addl.Loan - 2D")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseAddloan_2d = 0;
                                    }
                                    else
                                    {
                                        houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Loan 2B-2C")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloan2bc = 0;
                                    }
                                    else
                                    {
                                        houseloan2bc = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Loan 2A")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloan2a = 0;
                                    }
                                    else
                                    {
                                        houseloan2a = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                            }
                        }
                    }
                    // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    if (dt_lopdays.Rows.Count > 0)
                    {
                        if (dt_sumbasicnolop.Rows.Count > 0)
                        {
                            DataRow sbasic = dt_sumbasicnolop.Rows[0];

                            //basic 
                            object val = sbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                basic = 0 + pbasic;
                            }
                            else
                            {
                                basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            }

                            //da_percent 
                            object val1 = sbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                da_percent = Convert.ToDecimal(0 + pda_percent);
                            }
                            else
                            {
                                da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            }
                            //cca
                            object val2 = sbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                cca = Convert.ToDecimal(0 + pcca);
                            }
                            else
                            {
                                cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            }
                            //hra
                            object val3 = sbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                hra = Convert.ToDecimal(0 + phra);
                            }
                            else
                            {
                                hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            }
                            //int_ref
                            object va4 = sbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                int_ref = 0 + pint_ref;
                            }
                            else
                            {
                                int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            }

                            object val5 = sbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                t_inc = 0 + pt_inc;
                            }
                            else
                            {
                                t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            }

                            object val6 = sbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                spl_da = 0 + pspl_da;
                            }
                            else
                            {
                                spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            }

                            object val7 = sbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                spl_allowance = 0 + pspl_allowance;
                            }
                            else
                            {
                                spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                            }

                            object val8 = sbasic["pf"];
                            if (val8 == DBNull.Value)
                            {
                                pf = 0;
                            }
                            else
                            {
                                pf = Convert.ToDecimal(sbasic["pf"]);
                            }



                            //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                        }
                    }
                    else
                    {
                        if (dtBasicSum.Rows.Count > 0)
                        {
                            DataRow sbasic = dtBasicSum.Rows[0];

                            //basic 
                            object val = sbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                basic = 0 + pbasic;
                            }
                            else
                            {
                                basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            }

                            //da_percent 
                            object val1 = sbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                da_percent = Convert.ToDecimal(0 + pda_percent);
                            }
                            else
                            {
                                da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            }
                            //cca
                            object val2 = sbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                cca = Convert.ToDecimal(0 + pcca);
                            }
                            else
                            {
                                cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            }
                            //hra
                            object val3 = sbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                hra = Convert.ToDecimal(0 + phra);
                            }
                            else
                            {
                                hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            }
                            //int_ref
                            object va4 = sbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                int_ref = 0 + pint_ref;
                            }
                            else
                            {
                                int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            }

                            object val5 = sbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                t_inc = 0 + pt_inc;
                            }
                            else
                            {
                                t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            }

                            object val6 = sbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                spl_da = 0 + pspl_da;
                            }
                            else
                            {
                                spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            }

                            object val7 = sbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                spl_allowance = 0 + pspl_allowance;
                            }
                            else
                            {
                                spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                            }

                            object val8 = sbasic["pf"];
                            if (val8 == DBNull.Value)
                            {
                                pf = 0;
                            }
                            else
                            {
                                pf = Convert.ToDecimal(sbasic["pf"]);
                            }



                            //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                        }
                    }


                    //present allowances pper_allowance,pfpa_allow,pfpiip

                    //foreach (DataRow algen in dtAllowance.Rows)
                    //{


                    //    string alw_name = algen["all_name"].ToString();
                    //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                    //    if (alw_name == "Fixed Personal Allowance")
                    //    {
                    //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == "FPA-HRA Allowance")
                    //    {
                    //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == PrConstants.FPIIP)
                    //    {
                    //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                    //    }

                    //}

                    ////dtSumFixed
                    //if (dtSumFixed.Rows.Count > 0)
                    //{
                    //    DataRow sumf = dtSumFixed.Rows[0];

                    //    object val = sumf["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        per_allowance = 0 + pper_allowance;
                    //    }
                    //    else
                    //    {
                    //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                    //    }

                    //}
                    ////dtsumFPA
                    //if (dtsumFPA.Rows.Count > 0)
                    //{
                    //    DataRow sumfpa = dtsumFPA.Rows[0];

                    //    object val = sumfpa["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpa_allow = 0 + pfpa_allow;
                    //    }
                    //    else
                    //    {
                    //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                    //    }

                    //}
                    ////dtsumfpiip
                    //if (dtsumfpiip.Rows.Count > 0)
                    //{
                    //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                    //    object val = sumfpiip["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpiip = 0 + pfpiip;
                    //    }
                    //    else
                    //    {
                    //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                    //    }
                    //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                    //}
                    //getting the date difference from finstart year and current year for allowance
                    if (dt_datediff.Rows.Count > 0)
                    {
                        datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                    }

                    List<OldAllowance> oldList = new List<OldAllowance>();
                    //foreach (DataRow dtold in dtSumAllowance.Rows)
                    //{
                    //    OldAllowance objoldlist = new OldAllowance();
                    //    objoldlist.old_Name = dtold["all_name"].ToString();
                    //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                    //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                    //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                    //    oldList.Add(objoldlist);
                    //}
                    foreach (DataRow dtold in dtSumAllowancenew.Rows)
                    {
                        OldAllowance objoldlist = new OldAllowance();
                        objoldlist.old_Name = dtold["all_name"].ToString();
                        //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                        objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                        //objoldlist.old_alw_type = dtold["all_type"].ToString();
                        oldList.Add(objoldlist);
                    }



                    List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                    //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                    //{

                    //    ActiveAllowance NewObjlist = new ActiveAllowance();
                    //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                    //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                    //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString());
                    //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                    //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                    //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                    //    if (olditem != null)
                    //    {
                    //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                    //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                    //    }

                    //    NewActiveList.Add(NewObjlist);
                    //}
                    foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                    {

                        ActiveAllowance NewObjlist = new ActiveAllowance();
                        NewObjlist.Active_Name = dtActive["all_name"].ToString();
                        //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                        NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * monthsnew;
                        //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                        //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                        var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                        if (olditem != null)
                        {
                            NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                        }

                        NewActiveList.Add(NewObjlist);
                    }



                    //if not in new list then add
                    //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                    //{
                    //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                    //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                    //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                    //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                    //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                    //    if (olditem == null)
                    //    {
                    //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                    //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                    //        NewActiveList.Add(NewObjlist1);
                    //    }
                    //}
                    foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                    {
                        ActiveAllowance NewObjlist1 = new ActiveAllowance();
                        NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                        //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                        //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                        var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                        if (olditem == null)
                        {
                            NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            NewActiveList.Add(NewObjlist1);
                        }
                    }

                    var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                    if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                    {
                        await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                    }
                    int NewNumIndex = 0;

                    StringBuilder sbqry = new StringBuilder();
                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());
                    decimal total_allowance = 0;
                    //foreach (var newlist in NewActiveList)
                    //{
                    //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                    //    NewNumIndex++;
                    //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                    //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                    //    sbqry.Append(newqry);
                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    //}

                    foreach (var newlist in NewActiveList)
                    {
                        total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                        NewNumIndex++;
                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                        var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                            " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                            "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                            " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                        sbqry.Append(newqry);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    }




                    //List<string> lststring = new List<string>();
                    //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                    // dtPfPerks
                    //if (dtPfperks.Rows.Count > 0)
                    //{
                    //    DataRow pfPerk = dtPfperks.Rows[0];

                    //    object val = pfPerk["pf_perk"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        pf_perk = 0;
                    //    }
                    //    else
                    //    {
                    //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                    //    }

                    //}
                    //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                   
                    //dtLoanPerks
                    if (dtLoanPerks.Rows.Count > 0)
                    {
                        DataRow lperk = dtLoanPerks.Rows[0];

                        object val = lperk["loan_perk"];
                        if (val == DBNull.Value)
                        {
                            loan_perk = 0;
                        }
                        else
                        {
                            loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                        }

                    }
                    //dtIncentives
                    if (dtIncentives.Rows.Count > 0)
                    {
                        DataRow ins = dtIncentives.Rows[0];

                        object val = ins["incentive"];
                        if (val == DBNull.Value)
                        {
                            incentives = 0;
                        }
                        else
                        {
                            incentives = Convert.ToDecimal(ins["incentive"]);
                        }

                    }
                    //dt172
                    if (dt172.Rows.Count > 0)
                    {
                        DataRow VAL = dt172.Rows[0];
                        object val = VAL["val172"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_2 = 0;
                        }
                        else
                        {
                            values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                            totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                        }
                    }
                    //dt173
                    if (dt173.Rows.Count > 0)
                    {
                        DataRow VAL1 = dt173.Rows[0];
                        object val = VAL1["val173"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_3 = 0;
                        }
                        else
                        {
                            values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                        }
                    }

                    if (dtRent.Rows.Count > 0)
                    {
                        DataRow rents = dtRent.Rows[0];

                        object val = rents["rentamount"];
                        if (val == DBNull.Value)
                        {
                            house_rent_allowance = 0;
                        }
                        else
                        {
                            house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                        }
                    }

                    if (house_rent_allowance > 0)
                    {
                        decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                        //salary(a)
                        decimal salary = da_percent + Convert.ToDecimal(basic);
                        //40%  of salary(b)
                        decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                        //houserentpaid - 10% of salary(c)
                        //decimal hrentpaid = Math.Abs(rentamt - (Convert.ToDecimal((0.10)) * (salary)));
                        decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                        //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                        house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                        // HouseRentAllowance calculated as on 04-09-2020
                        // minimun values of (
                        // Basic+DA --40%,
                        // House Rent Paid minus Basic+DA --10% 
                        // HRA)
                    }
                    if (house_rent_allowance < 0)
                    {
                        house_rent_allowance = 0;
                    }
                    //decimal daval = Convert.ToDecimal(da);
                    //decimal hraval = Convert.ToDecimal(hra);
                    //rent amount




                    if (dtOther.Rows.Count > 0)
                    {
                        DataRow otr = dtOther.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = otr["other"];
                        if (val == DBNull.Value)
                        {
                            other = 0;
                        }
                        else
                        {
                            other = Convert.ToDecimal(otr["other"]);
                        }

                    }

                    if (dtHouse.Rows.Count > 0)
                    {
                        //foreach (DataRow dr in dtHouse.Rows)
                        //{
                        //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                        //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                        //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                        //        || dr["loan_type_mid"].ToString() == "13")
                        //    {
                        //        count++;
                        //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                        //    }

                        //}
                        DataRow dh = dtHouse.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = dh["amount"];
                        if (val == DBNull.Value)
                        {
                            houseloan_allownace = 0;
                        }
                        else
                        {
                            houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                        }

                    }
                    //if (count > 0)
                    //{

                    //    houseloan_allownace = 200000;
                    //}
                    if (dt_strpf.Rows.Count > 0)
                    {
                        pf = Convert.ToDecimal(dt_strpf.Rows[0]["pf"]);
                    }
                    if (dt_strprevlicgsli.Rows.Count > 0)
                    {
                        foreach (DataRow drpev in dt_strprevlicgsli.Rows)
                        {
                            decimal? amount = 0;
                            object val = drpev["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(drpev["amount"]);
                            }
                            string dd_name = Convert.ToString(drpev["name"].ToString());
                            if (dd_name == "LIC")
                            {
                                lic = amount;
                            }
                            else if (dd_name == "GSLI")
                            {
                                gsli = amount;
                            }
                        }
                    }
                    IList<section80C> lstCer = new List<section80C>();
                    IList<section80CCC> lstCCC = new List<section80CCC>();
                    IList<section80CCD> lstCCD = new List<section80CCD>();
                    IList<sectionOther> lstOther = new List<sectionOther>();

                    decimal pf_new = 0;
                    if (dtCD.Rows.Count > 0)
                    {
                        foreach (DataRow cer in dtCD.Rows)
                        {
                            //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                            decimal? amount = 0;

                            object val = cer["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(cer["amount"]);
                            }

                            string dd_name = Convert.ToString(cer["name"].ToString());

                            int loanid = 0;
                            int pflag = 0;
                            int countofsub = 0;
                            int precoverflag = 0;

                            string getloanid = "select id  from pr_loan_master where loan_description='" + dd_name + "'";
                            DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                            if (dtgetloanid.Rows.Count > 0)
                            {
                                loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                            }
                           
                            string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                            string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                            DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                            DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                            if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                            {
                                countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                            }
                            if (dtchkloaneligibility.Rows.Count > 0)
                            {
                                pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                            }

                            if (dd_name == "Provident Fund")
                            {
                                amount = Convert.ToDecimal(pf + (amount * monthsnew));
                                pf_new = Convert.ToDecimal(amount);
                            }
                            else if (dd_name == "VPF")
                            {
                                amount = Convert.ToDecimal(vpf_data + (amount * monthsnew));
                            }
                            else if (dd_name == "LIC")
                            {
                                amount = Convert.ToDecimal(lic + (amount * monthsnew));
                            }
                            else if (dd_name == "Housing Loan Main")
                            {
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloanmain + (amount * months));
                                }
                                else
                                {
                                    amount = 0;
                                }
                              
                            }
                            else if (dd_name == "Housing Addl.Loan - 2D")
                            {
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseAddloan_2d + (amount * months));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Loan 2B-2C")
                            {
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloan2bc + (amount * months));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Loan 2A")
                            {
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloan2a + (amount * months));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "GSLI")
                            {
                                amount = Convert.ToDecimal(gsli + (amount * monthsnew));
                            }
                            else
                            {
                                amount = Convert.ToDecimal((amount * monthsnew));
                            }
                            if (amount == 0)
                            { continue; }
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                        }


                    }
                    else
                    {
                        lstCer.Add(new section80C
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //for special deductions
                    if (dt_tdssections.Rows.Count > 0)
                    {
                        foreach (DataRow cer1 in dt_tdssections.Rows)
                        {
                            decimal? amount1 = 0;
                            decimal? allowance_amount1 = 0;
                            amount1 = Convert.ToDecimal(cer1["gross"]);
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount1 > min_allowance)
                                {
                                    allowance_amount1 = min_allowance;
                                    min_allowance = min_allowance - allowance_amount1;
                                    max_allowance = max_allowance + allowance_amount1;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount1;
                                    allowance_amount1 = amount1;
                                    max_allowance = max_allowance + amount1;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }
                        
                    }

                    decimal pf_perkcal = 0.5m;
                    decimal pf_perktemp = 12.5m;
                    pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                    //if (dtCCC.Rows.Count > 0)
                    //{
                    //    foreach (DataRow ccc in dtCCC.Rows)
                    //    {
                    //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                    //        decimal? allowance_amount = 0;
                    //        if (min_allowance > 0 && max_allowance <= 150000)
                    //        {
                    //            if (amount > min_allowance)
                    //            {
                    //                allowance_amount = min_allowance;
                    //                min_allowance = min_allowance - allowance_amount;
                    //                max_allowance = max_allowance + allowance_amount;
                    //            }
                    //            else
                    //            {
                    //                min_allowance = min_allowance - amount;
                    //                allowance_amount = amount;
                    //                max_allowance = max_allowance + amount;
                    //            }
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                    //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //            });
                    //        }
                    //        else
                    //        {
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                    //                allowance_amount = AddZerosAfterDecimal("0"),
                    //                ded_amount = AddZerosAfterDecimal("0")
                    //            });
                    //        }

                    //    }

                    //}
                    //else
                    //{
                    //    lstCCC.Add(new section80CCC
                    //    {
                    //        id = "",
                    //        name = "",
                    //        amount = AddZerosAfterDecimal("0"),
                    //        allowance_amount = AddZerosAfterDecimal("0"),
                    //        ded_amount = AddZerosAfterDecimal("0")
                    //    });
                    //}

                    if (dtCCD.Rows.Count > 0)
                    {
                        foreach (DataRow ccd in dtCCD.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                            {
                                if (amount > min_allowance80CCD)
                                {
                                    allowance_amount = min_allowance80CCD;
                                    min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                    max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                }
                                else
                                {
                                    min_allowance80CCD = min_allowance80CCD - amount;
                                    allowance_amount = amount;
                                    max_allowance80CCD = max_allowance80CCD + amount;
                                }
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }
                    }
                    else
                    {
                        lstCCD.Add(new section80CCD
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    if (dtEdu.Rows.Count > 0)
                    {
                        foreach (DataRow ed in dtEdu.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                            String sectionNAme = ed["section"].ToString();
                            decimal? allowance_amount = 0;
                            string id = ed["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = ed["name"].ToString();
                            if (sectionNAme == "Section80G")
                            {
                                allowance_amount = amount * section80g;
                                max_allowanceGG = max_allowanceGG + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80GGB")
                            {
                                allowance_amount = amount * section80gg;
                                max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80DDB")
                            {
                                if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                {
                                    if (amount > min_allowance80DDB)
                                    {
                                        allowance_amount = min_allowance80DDB;
                                        ded_amount = allowance_amount;
                                        min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                        max_allowance80DB = max_allowance80DB + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DDB = min_allowance80DDB - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DB = max_allowance80DB + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                            }
                            else if (sectionNAme == "Section80DD")
                            {
                                if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                {
                                    if (amount > min_allowance80DD)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80DD = min_allowance80DD - allowance_amount;
                                        max_allowance80DD = max_allowance80DD + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DD = min_allowance80DD - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DD = max_allowance80DD + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80U")
                            {
                                if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                {
                                    if (amount > min_allowance80U)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80U = min_allowance80U - allowance_amount;
                                        max_allowance80U = max_allowance80U + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80U = min_allowance80U - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80U = max_allowance80U + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80E")
                            {
                                allowance_amount = amount;
                                max_allowance = max_allowance + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            else if (sectionNAme == "Section80D_P")
                            {
                                if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                {
                                    if (amount > min_allowance80D_P)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                        max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_P = min_allowance80D_P - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_P = max_allowance80D_P + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                                //if (min_allowance80D_P > amount)
                                //{
                                //    allowance_amount = amount;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}

                                //else
                                //{
                                //    allowance_amount = min_allowance80D_P;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}
                            }
                            else if (sectionNAme == "Section80D_F")
                            {
                                if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                {
                                    if (amount > min_allowance80D_F)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                        max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_F = min_allowance80D_F - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_F = max_allowance80D_F + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2"||sectionNAme=="Section80EE"||sectionNAme== "Section80EE_HL")
                            {
                                if (sectionNAme != "Section80EE")
                                {
                                    sectionNAme = "Section80EE_HL";
                                }
                                if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                {
                                    if (amount > min_allowance80EE)
                                    {
                                        allowance_amount = min_allowance80EE;
                                        min_allowance80EE = min_allowance80EE - allowance_amount;
                                        max_allowance80ee = max_allowance80ee + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80EE = min_allowance80EE - amount;
                                        allowance_amount = amount;
                                        max_allowance80ee = max_allowance80ee + amount;
                                    }
                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;

                                }
                            }

                            else if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });

                        }

                    }

                    else
                    {
                        lstOther.Add(new sectionOther
                        {
                            id = "",
                            name = "",
                            section = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //special section24(b)
                    if (dt_tdssection24.Rows.Count > 0)
                    {
                        foreach (DataRow sec24 in dt_tdssection24.Rows)
                        {
                            decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                            String sectionNAme = sec24["section"].ToString();
                            string actName1 = "";
                            decimal? allowance_amount = 0;
                            string id = sec24["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = sec24["name"].ToString();

                            for(int i=0;i<lstOther.Count;i++)
                            {
                                actName1 = lstOther[i].name;
                                if(actName1==actName)
                                {
                                    lstOther.RemoveAt(i);
                                    continue;
                                }
                            }
                            if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }

                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });
                        }
                    }

                    max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                    if (dtTax.Rows.Count > 0)
                    {


                        DataRow tax = dtTax.Rows[0];

                        object val = tax["tax_deducted_at_source"];
                        if (val == DBNull.Value)
                        {
                            total_tax_till = 0;
                        }
                        else
                        {
                            total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                        }

                        tax_till = totaltaxdeductedfrm16 + total_tax_till;
                        tax_till = 0;

                    }

                    if (dtTDS.Rows.Count > 0)
                    {
                        DataRow TDS = dtTDS.Rows[0];

                        object val = TDS["tds_amount"];
                        if (val == DBNull.Value)
                        {
                            paid_by_emp = 0;
                        }
                        else
                        {
                            paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                        }
                    }

                    IList<TDSProcess> lstTDS = new List<TDSProcess>();

                    gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                    total_section = house_rent_allowance;

                    balance = gross - total_section;

                    //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                    //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                    decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                    if (stndednew >= 50000)
                    {
                        standard_deduction = PrConstants.STANDARD_DEDUCTION;
                    }
                    else
                    {
                        standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                    }
                    //standard_deduction = gross*0.04;
                    if (dtph.Rows.Count > 0)
                    {
                        if (dtemployeetax.Rows.Count > 0)
                        {
                            DataRow etax = dtemployeetax.Rows[0];
                            object val = etax["ptax"];
                            if (val == DBNull.Value)
                            {
                                emp_tax = 0;
                            }
                            else
                            {
                                emp_tax = Convert.ToInt32(etax["ptax"]);
                            }
                        }
                        //if (dtemppayslipforfinmonth.Rows.Count == 0)
                        //{
                        //    loss_months = 0;
                        //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                        //    if (emp_tax > 2400)
                        //    {
                        //        emp_tax = 2400;
                        //    }
                        //}
                        //else
                        //{
                        //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                        //    if (emp_tax > 2400)
                        //    {
                        //        emp_tax = 2400;
                        //    }
                        //}
                    }


                    aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                    Income_chargable = balance - aggregate_of_4; //6

                    total_gross_income = Income_chargable + other - houseloan_allownace;

                    deductible = Convert.ToDecimal(max_allowance);
                    total_income = total_gross_income - deductible;
                    //total_income = Convert.ToDecimal(841240.01);
                    round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                    //tax_deducted_at_source is calculating as incometax value of current financial year.
                    decimal tax_deducted_at_source1 = 0;
                    if (dt_incometax.Rows.Count > 0)
                    {
                        DataRow incometax = dt_incometax.Rows[0];

                        object val = incometax["income_tax"];
                        if (val == DBNull.Value)
                        {
                            tax_deducted_at_source1 = 0;
                        }
                        else
                        {
                            tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                        }
                    }

                    if (total_income > 500000)
                    {
                        //strConvert = income.ToString();
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = 0;
                        edu_cess = income * 4 / 100;

                        tax_payable = (float)income + edu_cess;
                        tax_payable = (int)Math.Round(tax_payable);

                        //if (tax_till > tax_payable)
                        //{
                        //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                        //}
                        //else
                        //{
                        //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                        //}
                        tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                        if (tax_balance < 0)
                        {
                            tax_balance = 0;
                        }
                         tot_months = months - 1;
                        if (tot_months > 0)
                        {
                            tds_per_month = tax_balance / tot_months;
                        }
                        else
                        {
                            tds_per_month = tax_balance;// tot_months;
                        }
                        if (Financial_md.Month != 03)
                        {
                            int x = (int)Math.Round(tds_per_month);
                            int y = (int)Math.Round(x / 100d, 0) * 100;
                            rounding_tds_per_month = y;
                        }
                        else
                        {
                            int xp = (int)Math.Round(tds_per_month);
                            int Z = (10 - xp % 10) + xp;
                            rounding_tds_per_month = Z;
                        }

                        //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                    }
                    else
                    {
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = Convert.ToDecimal(income);
                        edu_cess = 0;

                        tax_payable = 0;

                        tax_till = 0;
                        tax_balance = 0;

                        tds_per_month = 0;

                        rounding_tds_per_month = 0;
                    }
                    //string employer_name_address = PrConstants.Name;
                    //string employer_pan = PrConstants.PAN;
                    //string employer_tan = PrConstants.TAN;

                    lstTDS.Add(new TDSProcess
                    {
                        option = optn.Rows[0]["Option"].ToString(),
                        name = name,
                        per_address = per_address,
                        pan_no = pan_no,
                        emp_code = emp_code,
                        designation = designation,
                        sex = sex,
                        fm = fm,
                        employer_name_address = employer_name_address,
                        employer_pan = employer_pan,
                        employer_tan = employer_tan,
                        basic = AddZerosAfterDecimal(Convert.ToString(basic)),
                        da_percent = AddZerosAfterDecimal(Convert.ToString(da_percent)),
                        per_allowance = AddZerosAfterDecimal(Convert.ToString(per_allowance)),
                        int_ref = AddZerosAfterDecimal(Convert.ToString(int_ref)),
                        t_inc = AddZerosAfterDecimal(Convert.ToString(t_inc)),
                        fpa_allow = AddZerosAfterDecimal(Convert.ToString(fpa_allow)),
                        fpiip = AddZerosAfterDecimal(Convert.ToString(fpiip)),
                        pf_perk = AddZerosAfterDecimal(Convert.ToString(pf_perk)),
                        loan_perk = AddZerosAfterDecimal(Convert.ToString(loan_perk)),
                        incentives = AddZerosAfterDecimal(Convert.ToString(incentives)),
                        spl_allowance = AddZerosAfterDecimal(Convert.ToString(spl_allowance)),
                        spl_da = AddZerosAfterDecimal(Convert.ToString(spl_da)),
                        hra = AddZerosAfterDecimal(Convert.ToString(hra)),
                        cca = AddZerosAfterDecimal(Convert.ToString(cca)),
                        values_of_17_2 = AddZerosAfterDecimal(Convert.ToString(values_of_17_2)),
                        values_of_17_3 = AddZerosAfterDecimal(Convert.ToString(values_of_17_3)),
                        gross = AddZerosAfterDecimal(Convert.ToString(gross)), // 2 pending
                        standard_deduction = AddZerosAfterDecimal(Convert.ToString(standard_deduction)),
                        ent_allowance = AddZerosAfterDecimal(Convert.ToString(ent_allowance)),
                        emp_tax = AddZerosAfterDecimal(Convert.ToString(emp_tax)),
                        aggregate_of_4 = AddZerosAfterDecimal(Convert.ToString(aggregate_of_4)),
                        Income_chargable = AddZerosAfterDecimal(Convert.ToString(Income_chargable)),
                        other = AddZerosAfterDecimal(Convert.ToString(other)),
                        houseloan_allownace = AddZerosAfterDecimal(Convert.ToString(houseloan_allownace)),
                        total_gross_income = AddZerosAfterDecimal(Convert.ToString(total_gross_income)),
                        loan_instl_amt = AddZerosAfterDecimal(Convert.ToString(loan_instl_amt)),
                        deductible = AddZerosAfterDecimal(Convert.ToString(deductible)),
                        total_income = AddZerosAfterDecimal(Convert.ToString(total_income)),
                        income = AddZerosAfterDecimal(Convert.ToString(income)),
                        edu_cess = AddZerosAfterDecimal(Convert.ToString(edu_cess)),
                        tax_payable = AddZerosAfterDecimal(Convert.ToString(tax_payable)),
                        tax_till = AddZerosAfterDecimal(Convert.ToString(tax_till)),
                        tax_balance = AddZerosAfterDecimal(Convert.ToString(tax_balance)),
                        balance_month = Convert.ToString(tot_months),
                        tds_per_month = AddZerosAfterDecimal(Convert.ToString(rounding_tds_per_month)),
                        house_rent_allowance = AddZerosAfterDecimal(Convert.ToString(house_rent_allowance)),
                        total_section = AddZerosAfterDecimal(Convert.ToString(total_section)),
                        balance = AddZerosAfterDecimal(Convert.ToString(balance)),
                        round_income = AddZerosAfterDecimal(Convert.ToString(round_income)),
                        section_87a = AddZerosAfterDecimal(Convert.ToString(section_87a)),
                        //paid_by_emp = AddZerosAfterDecimal(Convert.ToString(paid_by_emp)),
                        paid_by_emp = AddZerosAfterDecimal(Convert.ToString(tax_deducted_at_source1)),

                    }); ;
                    var tds = JsonConvert.SerializeObject(lstTDS);
                    var ccT = JsonConvert.SerializeObject(lstCer);
                    var cccT = JsonConvert.SerializeObject(lstCCC);
                    var ccdT = JsonConvert.SerializeObject(lstCCD);
                    var otherT = JsonConvert.SerializeObject(lstOther);
                    var allowanceT = JsonConvert.SerializeObject(NewActiveList);

                    var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                    var tdsData = javaScriptSerializer.DeserializeObject(tds);
                    var ccData = javaScriptSerializer.DeserializeObject(ccT);
                    var cccData = javaScriptSerializer.DeserializeObject(cccT);
                    var ccdData = javaScriptSerializer.DeserializeObject(ccdT);
                    var otherData = javaScriptSerializer.DeserializeObject(otherT);
                    var allowanceTdata = javaScriptSerializer.DeserializeObject(allowanceT);

                    var resultJson = javaScriptSerializer.Serialize(new
                    {
                        tds = tdsData,
                        cc = ccData,
                        ccc = cccData,
                        ccd = ccdData,
                        other = otherData,
                        allowance = allowanceTdata

                    });
                    //int NewNumIndex = 0;

                    //StringBuilder sbqry = new StringBuilder();
                    ////1. trans_id
                    //sbqry.Append(GenNewTransactionString());

                    int finalSub = 0;

                    if (final == true)
                    {
                        finalSub = 1;
                    }
                    else
                    {
                        finalSub = 0;
                    }

                    string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable details = await _sha.Get_Table_FromQry(selQry);
                    if (details.Rows.Count > 0)
                    {
                        NewNumIndex++;
                        DataRow finaldt = details.Rows[0];
                        string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                        sbqry.Append(tdsdelete);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                        int finalCount = Convert.ToInt32(finaldt["final"]);

                        if (finalCount == 1)
                        {
                            return "E#TDS Process#Employee Already Processed..!!";
                        }
                        else
                        {
                            NewNumIndex++;
                            string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            sbqry.Append(tdsUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                            NewNumIndex++;
                            string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            sbqry.Append(certUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));


                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                foreach (var ccDatas in lstCer)
                                {
                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    foreach (var cccDatas in lstCCC)
                            //    {
                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstOther != null)
                            //{
                            //    foreach (var otherDatas in lstOther)
                            //    {
                            //        if (otherDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_perdeductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_perdeductions ([id],[fy],[fm],[empid],[empcode],[m_id],[m_type]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_perdeductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }



                    }
                    else
                    {

                        try
                        {

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate1);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate2);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var ccDatas in lstCer)
                                {

                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate3);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var cccDatas in lstCCC)
                            //    {

                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    NewNumIndex++;
                                    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate3);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate4);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }
                        catch (Exception e)
                        {
                            return "E#TDS Process#" + e.Message;
                        }
                    }
                    return resultJson;
                    //}
                }
                else if (optn.Rows[0]["Option"].ToString() == "2" && dtretiredate.Rows.Count == 0 && zerobasic > 0)
                {
                    decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                           .Where(x => x["constant"].ToString() == "Section80C")
                           .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                    decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80CCD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                    decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80U")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DDB")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                    decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_P")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                    decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_F")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                    decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80EE")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                    decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section24(b)")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                    decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80G")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                    decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80GGB")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                    DataTable _dtFY_FM = ds1.Tables[1];
                    _incometaxdbconstant = ds1.Tables[2];


                    //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                        "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                        "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + "and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and spl_type='Regular' and fy = " + iFY + " order by id desc); ";

                    //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                        "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                        "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                    //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                    string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                    //allowance ==>Get and Sum all previous months allowances 
                    string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                    //allowance ==> Get all current month allowances
                    string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                    //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                    ////sum Personal Allowance
                    //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                    //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                    ////sum FPIIP
                    //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                    //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                    //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                    //sum PFPerks                                                   
                    string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                    // sum LOANPerks                                                    
                    string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                    // sum Incentive                                                    
                    string incentive = "select distinct sum(amount) as incentive from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    // sum  val 17 -2
                    string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                         "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                    // sum val 17 -3
                    string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                        "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                        " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                    //rent allowance
                    //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                    string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                    //other
                    string otherQry = "select distinct sum(amount) as other from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    //house loan
                    string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                    //section 80c
                    //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                    //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                    //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                    string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                       "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                       "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                       "from pr_emp_payslip where active = 1 and emp_code = " + Convert.ToInt32(empCode) + " union " +
                       "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                       "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + "";

                    //section 80ccc
                    string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                    //section 80ccd
                    string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                        " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                    //section other section
                    string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                    //tax till
                    string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                    //other tds deductions
                    //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                    string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                        "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                        "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                    //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                    //VPF
                    string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm < '" + FM + "' and p.fm >= '" + startYear + "';";

                    string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff;";

                    string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm between " + startYear + "' and '" + endYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                    string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                        " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";
                    string sumofbasicnolop = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as " +
                        " int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  from pr_emp_payslip " +
                        " where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";
                    string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                    " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                    " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                    string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                        " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                        " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                    DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                        SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                        cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                        strdatediff + strincometax + nolopsbasic + sumofbasicnolop + SumAllowanceQrynew + ActiveSumAllowanceQrynew);

                    //tables
                    var dtGeneral = ds.Tables[0];
                    var dtBasic = ds.Tables[1];
                    var dtBasicSum = ds.Tables[2];
                    var dtAllowance = ds.Tables[3];
                    var dtSumAllowance = ds.Tables[4];

                    var dtPfperks = ds.Tables[5];
                    var dtLoanPerks = ds.Tables[6];
                    var dtIncentives = ds.Tables[7];
                    var dt172 = ds.Tables[8];
                    var dt173 = ds.Tables[9];
                    var dtRent = ds.Tables[10];
                    var dtOther = ds.Tables[11];
                    var dtHouse = ds.Tables[12];

                    var dtCD = ds.Tables[13];
                    var dtCCC = ds.Tables[14];
                    var dtCCD = ds.Tables[15];
                    var dtEdu = ds.Tables[16];
                    var dtTax = ds.Tables[17];
                    var dtTDS = ds.Tables[18];
                    var dtEmpTax = ds.Tables[19];
                    var dtVpf = ds.Tables[20];
                    var dtActiveSumAllowance = ds.Tables[21];
                    var dt_datediff = ds.Tables[22];
                    var dt_incometax = ds.Tables[23];
                    var dt_nolopbasic = ds.Tables[24];
                    var dt_sumbasicnolop = ds.Tables[25];
                    var dtSumAllowancenew = ds.Tables[26];
                    var dtActiveSumAllowancenew = ds.Tables[27];

                    int loss_months = 0;
                    decimal? vpf_data = 0;
                    decimal? pf = 0;

                    if (dtEmpTax.Rows.Count > 0)
                    {
                        DataRow empTax = dtEmpTax.Rows[0];

                        object val = empTax["loss"];
                        if (val == DBNull.Value)
                        {
                            loss_months = 0;
                        }
                        else
                        {
                            loss_months = Convert.ToInt32(empTax["loss"]);
                        }

                    }
                    //vpf

                    if (dtVpf.Rows.Count > 0)
                    {
                        DataRow vpfData = dtVpf.Rows[0];

                        object val = vpfData["amount"];
                        if (val == DBNull.Value)
                        {
                            vpf_data = 0;
                        }
                        else
                        {
                            vpf_data = Convert.ToDecimal(vpfData["amount"]);
                        }

                    }

                    // General Data
                    if (dtGeneral.Rows.Count > 0)
                    {
                        DataRow gen = dtGeneral.Rows[0];
                        name = Convert.ToString(gen["name"]);
                        per_address = Convert.ToString(gen["per_address"]);
                        pan_no = Convert.ToString(gen["pan_no"]);
                        emp_code = Convert.ToString(gen["emp_code"]);
                        designation = Convert.ToString(gen["designation"]);
                        sex = Convert.ToString(gen["sex"]);
                        fm = fin_month;
                    }

                    //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    if (dt_lopdays.Rows.Count > 0)
                    {
                        if (dt_nolopbasic.Rows.Count > 0)
                        {

                            DataRow rbasic = dt_nolopbasic.Rows[0];

                            //basic 
                            object val = rbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                pbasic = 0;
                            }
                            else
                            {
                                pbasic = Convert.ToDecimal(rbasic["basic"]) * (monthsnew);
                            }

                            //da_percent 
                            object val1 = rbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                pda_percent = 0;
                            }
                            else
                            {
                                pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * (monthsnew);
                            }
                            //cca
                            object val2 = rbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                pcca = 0;
                            }
                            else
                            {
                                pcca = Convert.ToDecimal(rbasic["cca"]) * (monthsnew);
                            }
                            //hra
                            object val3 = rbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                phra = 0;
                            }
                            else
                            {
                                phra = Convert.ToDecimal(rbasic["hra"]) * (monthsnew);
                            }
                            //int_ref
                            object va4 = rbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                pint_ref = 0;
                            }
                            else
                            {
                                pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * (monthsnew);
                            }

                            object val5 = rbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                pt_inc = 0;
                            }
                            else
                            {
                                pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * (monthsnew);
                            }

                            object val6 = rbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                pspl_da = 0;
                            }
                            else
                            {
                                pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * (monthsnew);
                            }

                            object val7 = rbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                pspl_allowance = 0;
                            }
                            else
                            {
                                pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * (monthsnew);
                            }




                        }
                    }
                    else
                    {
                        if (dtBasic.Rows.Count > 0)
                        {

                            DataRow rbasic = dtBasic.Rows[0];

                            //basic 
                            object val = rbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                pbasic = 0;
                            }
                            else
                            {
                                pbasic = Convert.ToDecimal(rbasic["basic"]) * months;
                            }

                            //da_percent 
                            object val1 = rbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                pda_percent = 0;
                            }
                            else
                            {
                                pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months;
                            }
                            //cca
                            object val2 = rbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                pcca = 0;
                            }
                            else
                            {
                                pcca = Convert.ToDecimal(rbasic["cca"]) * months;
                            }
                            //hra
                            object val3 = rbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                phra = 0;
                            }
                            else
                            {
                                phra = Convert.ToDecimal(rbasic["hra"]) * months;
                            }
                            //int_ref
                            object va4 = rbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                pint_ref = 0;
                            }
                            else
                            {
                                pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months;
                            }

                            object val5 = rbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                pt_inc = 0;
                            }
                            else
                            {
                                pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months;
                            }

                            object val6 = rbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                pspl_da = 0;
                            }
                            else
                            {
                                pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months;
                            }

                            object val7 = rbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                pspl_allowance = 0;
                            }
                            else
                            {
                                pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months;
                            }




                        }
                    }
                    // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    if (dt_lopdays.Rows.Count > 0)
                    {
                        if (dt_sumbasicnolop.Rows.Count > 0)
                        {
                            DataRow sbasic = dt_sumbasicnolop.Rows[0];

                            //basic 
                            object val = sbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                basic = 0 + pbasic;
                            }
                            else
                            {
                                basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            }

                            //da_percent 
                            object val1 = sbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                da_percent = Convert.ToDecimal(0 + pda_percent);
                            }
                            else
                            {
                                da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            }
                            //cca
                            object val2 = sbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                cca = Convert.ToDecimal(0 + pcca);
                            }
                            else
                            {
                                cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            }
                            //hra
                            object val3 = sbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                hra = Convert.ToDecimal(0 + phra);
                            }
                            else
                            {
                                hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            }
                            //int_ref
                            object va4 = sbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                int_ref = 0 + pint_ref;
                            }
                            else
                            {
                                int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            }

                            object val5 = sbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                t_inc = 0 + pt_inc;
                            }
                            else
                            {
                                t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            }

                            object val6 = sbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                spl_da = 0 + pspl_da;
                            }
                            else
                            {
                                spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            }

                            object val7 = sbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                spl_allowance = 0 + pspl_allowance;
                            }
                            else
                            {
                                spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                            }

                            object val8 = sbasic["pf"];
                            if (val8 == DBNull.Value)
                            {
                                pf = 0;
                            }
                            else
                            {
                                pf = Convert.ToDecimal(sbasic["pf"]);
                            }



                            //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                        }
                    }
                    else
                    {
                        if (dtBasicSum.Rows.Count > 0)
                        {
                            DataRow sbasic = dtBasicSum.Rows[0];

                            //basic 
                            object val = sbasic["basic"];
                            if (val == DBNull.Value)
                            {
                                basic = 0 + pbasic;
                            }
                            else
                            {
                                basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            }

                            //da_percent 
                            object val1 = sbasic["da_percent"];
                            if (val1 == DBNull.Value)
                            {
                                da_percent = Convert.ToDecimal(0 + pda_percent);
                            }
                            else
                            {
                                da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            }
                            //cca
                            object val2 = sbasic["cca"];
                            if (val2 == DBNull.Value)
                            {
                                cca = Convert.ToDecimal(0 + pcca);
                            }
                            else
                            {
                                cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            }
                            //hra
                            object val3 = sbasic["hra"];
                            if (val3 == DBNull.Value)
                            {
                                hra = Convert.ToDecimal(0 + phra);
                            }
                            else
                            {
                                hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            }
                            //int_ref
                            object va4 = sbasic["int_ref"];
                            if (va4 == DBNull.Value)
                            {
                                int_ref = 0 + pint_ref;
                            }
                            else
                            {
                                int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            }

                            object val5 = sbasic["t_inc"];
                            if (val5 == DBNull.Value)
                            {
                                t_inc = 0 + pt_inc;
                            }
                            else
                            {
                                t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            }

                            object val6 = sbasic["spl_da"];
                            if (val6 == DBNull.Value)
                            {
                                spl_da = 0 + pspl_da;
                            }
                            else
                            {
                                spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            }

                            object val7 = sbasic["spl_allowance"];
                            if (val7 == DBNull.Value)
                            {
                                spl_allowance = 0 + pspl_allowance;
                            }
                            else
                            {
                                spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                            }

                            object val8 = sbasic["pf"];
                            if (val8 == DBNull.Value)
                            {
                                pf = 0;
                            }
                            else
                            {
                                pf = Convert.ToDecimal(sbasic["pf"]);
                            }



                            //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                            //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                            //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                            //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                            //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                            //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                            //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                            //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                        }
                    }


                    //present allowances pper_allowance,pfpa_allow,pfpiip

                    //foreach (DataRow algen in dtAllowance.Rows)
                    //{


                    //    string alw_name = algen["all_name"].ToString();
                    //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                    //    if (alw_name == "Fixed Personal Allowance")
                    //    {
                    //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == "FPA-HRA Allowance")
                    //    {
                    //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == PrConstants.FPIIP)
                    //    {
                    //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                    //    }

                    //}

                    ////dtSumFixed
                    //if (dtSumFixed.Rows.Count > 0)
                    //{
                    //    DataRow sumf = dtSumFixed.Rows[0];

                    //    object val = sumf["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        per_allowance = 0 + pper_allowance;
                    //    }
                    //    else
                    //    {
                    //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                    //    }

                    //}
                    ////dtsumFPA
                    //if (dtsumFPA.Rows.Count > 0)
                    //{
                    //    DataRow sumfpa = dtsumFPA.Rows[0];

                    //    object val = sumfpa["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpa_allow = 0 + pfpa_allow;
                    //    }
                    //    else
                    //    {
                    //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                    //    }

                    //}
                    ////dtsumfpiip
                    //if (dtsumfpiip.Rows.Count > 0)
                    //{
                    //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                    //    object val = sumfpiip["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpiip = 0 + pfpiip;
                    //    }
                    //    else
                    //    {
                    //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                    //    }
                    //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                    //}

                    //getting the date difference from finstart year and current year for allowance
                    if (dt_datediff.Rows.Count > 0)
                    {
                        datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                    }

                    List<OldAllowance> oldList = new List<OldAllowance>();
                    //foreach (DataRow dtold in dtSumAllowance.Rows)
                    //{
                    //    OldAllowance objoldlist = new OldAllowance();
                    //    objoldlist.old_Name = dtold["all_name"].ToString();
                    //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                    //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                    //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                    //    oldList.Add(objoldlist);
                    //}
                    foreach (DataRow dtold in dtSumAllowancenew.Rows)
                    {
                        OldAllowance objoldlist = new OldAllowance();
                        objoldlist.old_Name = dtold["all_name"].ToString();
                        //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                        objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                        //objoldlist.old_alw_type = dtold["all_type"].ToString();
                        oldList.Add(objoldlist);
                    }



                    List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                    //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                    //{

                    //    ActiveAllowance NewObjlist = new ActiveAllowance();
                    //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                    //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                    //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                    //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                    //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                    //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                    //    if (olditem != null)
                    //    {
                    //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                    //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                    //    }

                    //    NewActiveList.Add(NewObjlist);
                    //}
                    foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                    {

                        ActiveAllowance NewObjlist = new ActiveAllowance();
                        NewObjlist.Active_Name = dtActive["all_name"].ToString();
                        //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                        NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * monthsnew;
                        //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                        //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                        var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                        if (olditem != null)
                        {
                            NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                        }

                        NewActiveList.Add(NewObjlist);
                    }



                    //if not in new list then add
                    //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                    //{
                    //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                    //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                    //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                    //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                    //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                    //    if (olditem == null)
                    //    {
                    //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                    //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                    //        NewActiveList.Add(NewObjlist1);
                    //    }
                    //}
                    foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                    {
                        ActiveAllowance NewObjlist1 = new ActiveAllowance();
                        NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                        //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                        //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                        var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                        if (olditem == null)
                        {
                            NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            NewActiveList.Add(NewObjlist1);
                        }
                    }

                    var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                    if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                    {
                        await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                    }
                    int NewNumIndex = 0;

                    StringBuilder sbqry = new StringBuilder();
                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());
                    decimal total_allowance = 0;
                    //foreach (var newlist in NewActiveList)
                    //{
                    //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                    //    NewNumIndex++;
                    //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                    //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                    //    sbqry.Append(newqry);
                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    //}
                    foreach (var newlist in NewActiveList)
                    {
                        total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                        NewNumIndex++;
                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                        var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                            " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                            "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                            " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                        sbqry.Append(newqry);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    }



                    //List<string> lststring = new List<string>();
                    //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                    // dtPfPerks
                    //if (dtPfperks.Rows.Count > 0)
                    //{
                    //    DataRow pfPerk = dtPfperks.Rows[0];

                    //    object val = pfPerk["pf_perk"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        pf_perk = 0;
                    //    }
                    //    else
                    //    {
                    //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                    //    }

                    //}
                    //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                   
                    //dtLoanPerks
                    if (dtLoanPerks.Rows.Count > 0)
                    {
                        DataRow lperk = dtLoanPerks.Rows[0];

                        object val = lperk["loan_perk"];
                        if (val == DBNull.Value)
                        {
                            loan_perk = 0;
                        }
                        else
                        {
                            loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                        }

                    }
                    //dtIncentives
                    if (dtIncentives.Rows.Count > 0)
                    {
                        DataRow ins = dtIncentives.Rows[0];

                        object val = ins["incentive"];
                        if (val == DBNull.Value)
                        {
                            incentives = 0;
                        }
                        else
                        {
                            incentives = Convert.ToDecimal(ins["incentive"]);
                        }

                    }
                    //dt172
                    if (dt172.Rows.Count > 0)
                    {
                        DataRow VAL = dt172.Rows[0];
                        object val = VAL["val172"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_2 = 0;
                        }
                        else
                        {
                            values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                            totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                        }
                    }
                    //dt173
                    if (dt173.Rows.Count > 0)
                    {
                        DataRow VAL1 = dt173.Rows[0];
                        object val = VAL1["val173"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_3 = 0;
                        }
                        else
                        {
                            values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                        }
                    }

                    if (dtRent.Rows.Count > 0)
                    {
                        //DataRow rents = dtRent.Rows[0];

                        //object val = rents["rentamount"];
                        //if (val == DBNull.Value)
                        //{
                        //    house_rent_allowance = 0;
                        //}
                        //else
                        //{
                        //    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                        //}
                    }

                    if (house_rent_allowance > 0)
                    {
                        decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                        //salary(a)
                        decimal salary = da_percent + Convert.ToDecimal(basic);
                        //40%  of salary(b)
                        decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                        //houserentpaid - 10% of salary(c)
                        decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                        //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                        house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                        // HouseRentAllowance calculated as on 04-09-2020
                        // minimun values of (
                        // Basic+DA --40%,
                        // House Rent Paid minus Basic+DA --10% 
                        // HRA)
                    }
                    //decimal daval = Convert.ToDecimal(da);
                    //decimal hraval = Convert.ToDecimal(hra);
                    //rent amount

                    if (house_rent_allowance < 0)
                    {
                        house_rent_allowance = 0;
                    }


                    if (dtOther.Rows.Count > 0)
                    {
                        DataRow otr = dtOther.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = otr["other"];
                        if (val == DBNull.Value)
                        {
                            other = 0;
                        }
                        else
                        {
                            other = Convert.ToDecimal(otr["other"]);
                        }

                    }

                    if (dtHouse.Rows.Count > 0)
                    {
                        //foreach (DataRow dr in dtHouse.Rows)
                        //{
                        //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                        //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                        //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                        //        || dr["loan_type_mid"].ToString() == "13")
                        //    {
                        //        count++;
                        //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                        //    }

                        //}
                        //DataRow dh = dtHouse.Rows[0];

                        ////other = Convert.ToDecimal(otr["other"]);

                        //object val = dh["amount"];
                        //if (val == DBNull.Value)
                        //{
                        //    houseloan_allownace = 0;
                        //}
                        //else
                        //{
                        //    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                        //}

                    }
                    //if (count > 0)
                    //{

                    //    houseloan_allownace = 200000;
                    //}
                    ////Sowjanya
                    //IList<section80C> lstCer = new List<section80C>();
                    //IList<section80CCC> lstCCC = new List<section80CCC>();
                    //IList<section80CCD> lstCCD = new List<section80CCD>();
                    //IList<sectionOther> lstOther = new List<sectionOther>();

                    decimal pf_new = 0;
                    if (dtCD.Rows.Count > 0)
                    {
                        foreach (DataRow cer in dtCD.Rows)
                        {
                            //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                            decimal? amount = 0;

                            object val = cer["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(cer["amount"]);
                            }

                            string dd_name = Convert.ToString(cer["name"].ToString());
                            if (dd_name == "Provident Fund")
                            {
                                amount = Convert.ToDecimal(pf + (amount * months));
                                pf_new = Convert.ToDecimal(amount);
                            }
                            else if (dd_name == "VPF")
                            {
                                amount = Convert.ToDecimal(vpf_data + (amount * months));
                            }
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                //lstCer.Add(new section80C
                                //{
                                //    id = cer["id"].ToString(),
                                //    name = cer["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //});
                            }
                            else
                            {
                                //lstCer.Add(new section80C
                                //{
                                //    id = cer["id"].ToString(),
                                //    name = cer["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                        }


                    }
                    else
                    {
                        //lstCer.Add(new section80C
                        //{
                        //    id = "",
                        //    name = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }
                    decimal pf_perkcal = 0.5m;
                    decimal pf_perktemp = 12.5m;
                    pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                    if (dtCCC.Rows.Count > 0)
                    {
                        foreach (DataRow ccc in dtCCC.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                //lstCCC.Add(new section80CCC
                                //{
                                //    id = ccc["id"].ToString(),
                                //    name = ccc["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //});
                            }
                            else
                            {
                                //lstCCC.Add(new section80CCC
                                //{
                                //    id = ccc["id"].ToString(),
                                //    name = ccc["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                        }

                    }
                    else
                    {
                        ///sowjanya
                        //lstCCC.Add(new section80CCC
                        //{
                        //    id = "",
                        //    name = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }

                    if (dtCCD.Rows.Count > 0)
                    {
                        foreach (DataRow ccd in dtCCD.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                            {
                                if (amount > min_allowance80CCD)
                                {
                                    allowance_amount = min_allowance80CCD;
                                    min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                    max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                }
                                else
                                {
                                    min_allowance80CCD = min_allowance80CCD - amount;
                                    allowance_amount = amount;
                                    max_allowance80CCD = max_allowance80CCD + amount;
                                }
                                //sowjanya
                                //lstCCD.Add(new section80CCD
                                //{
                                //    id = ccd["id"].ToString(),
                                //    name = ccd["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //});
                            }
                            else
                            {
                                //sowjanya
                                //lstCCD.Add(new section80CCD
                                //{
                                //    id = ccd["id"].ToString(),
                                //    name = ccd["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }
                        }
                    }
                    else
                    {
                        //sowjanya
                        //lstCCD.Add(new section80CCD
                        //{
                        //    id = "",
                        //    name = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }

                    if (dtEdu.Rows.Count > 0)
                    {
                        foreach (DataRow ed in dtEdu.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                            String sectionNAme = ed["section"].ToString();
                            decimal? allowance_amount = 0;
                            string id = ed["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = ed["name"].ToString();
                            if (sectionNAme == "Section80G")
                            {
                                allowance_amount = amount * section80g;
                                max_allowanceGG = max_allowanceGG + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80GGB")
                            {
                                allowance_amount = amount * section80gg;
                                max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80DDB")
                            {
                                if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                {
                                    if (amount > min_allowance80DDB)
                                    {
                                        allowance_amount = min_allowance80DDB;
                                        ded_amount = allowance_amount;
                                        min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                        max_allowance80DB = max_allowance80DB + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DDB = min_allowance80DDB - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DB = max_allowance80DB + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                            }
                            else if (sectionNAme == "Section80DD")
                            {
                                if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                {
                                    if (amount > min_allowance80DD)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80DD = min_allowance80DD - allowance_amount;
                                        max_allowance80DD = max_allowance80DD + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DD = min_allowance80DD - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DD = max_allowance80DD + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80U")
                            {
                                if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                {
                                    if (amount > min_allowance80U)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80U = min_allowance80U - allowance_amount;
                                        max_allowance80U = max_allowance80U + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80U = min_allowance80U - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80U = max_allowance80U + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80E")
                            {
                                allowance_amount = amount;
                                max_allowance = max_allowance + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            else if (sectionNAme == "Section80D_P")
                            {
                                if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                {
                                    if (amount > min_allowance80D_P)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                        max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_P = min_allowance80D_P - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_P = max_allowance80D_P + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                                //if (min_allowance80D_P > amount)
                                //{
                                //    allowance_amount = amount;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}

                                //else
                                //{
                                //    allowance_amount = min_allowance80D_P;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}
                            }
                            else if (sectionNAme == "Section80D_F")
                            {
                                if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                {
                                    if (amount > min_allowance80D_F)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                        max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_F = min_allowance80D_F - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_F = max_allowance80D_F + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                            {
                                if (sectionNAme != "Section80EE")
                                {
                                    sectionNAme = "Section80EE_HL";
                                }
                                if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                {
                                    if (amount > min_allowance80EE)
                                    {
                                        allowance_amount = min_allowance80EE;
                                        min_allowance80EE = min_allowance80EE - allowance_amount;
                                        max_allowance80ee = max_allowance80ee + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80EE = min_allowance80EE - amount;
                                        allowance_amount = amount;
                                        max_allowance80ee = max_allowance80ee + amount;
                                    }
                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;

                                }
                            }

                            else if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            //lstOther.Add(new sectionOther
                            //{
                            //    id = id,
                            //    name = actName,
                            //    section = sectionNAme,
                            //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                            //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            //});

                        }

                    }

                    else
                    {
                        //lstOther.Add(new sectionOther
                        //{
                        //    id = "",
                        //    name = "",
                        //    section = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }
                    max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                    if (dtTax.Rows.Count > 0)
                    {


                        DataRow tax = dtTax.Rows[0];

                        object val = tax["tax_deducted_at_source"];
                        if (val == DBNull.Value)
                        {
                            total_tax_till = 0;
                        }
                        else
                        {
                            total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                        }

                        tax_till = totaltaxdeductedfrm16 + total_tax_till;
                        tax_till = 0; // for all employees this tax is 0

                    }

                    if (dtTDS.Rows.Count > 0)
                    {
                        DataRow TDS = dtTDS.Rows[0];

                        object val = TDS["tds_amount"];
                        if (val == DBNull.Value)
                        {
                            paid_by_emp = 0;
                        }
                        else
                        {
                            paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                        }
                    }

                    IList<TDSProcess> lstTDS = new List<TDSProcess>();

                    gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                    total_section = house_rent_allowance;

                    balance = gross - total_section;
                    //standard_deduction = PrConstants.STANDARD_DEDUCTION;
                    //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                    //if (emp_tax > 2400)
                    //{
                    //    emp_tax = 2400;
                    //}
                    //aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                    Income_chargable = balance; //- aggregate_of_4; //6

                    total_gross_income = Income_chargable + other;// - houseloan_allownace;

                    //deductible = Convert.ToDecimal(max_allowance);
                    total_income = total_gross_income;// - deductible;
                    //total_income = Convert.ToDecimal(841240.01);
                    round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                    //tax_deducted_at_source is calculating as incometax value of current financial year.
                    decimal tax_deducted_at_source1 = 0;
                    if (dt_incometax.Rows.Count > 0)
                    {
                        DataRow incometax = dt_incometax.Rows[0];

                        object val = incometax["income_tax"];
                        if (val == DBNull.Value)
                        {
                            tax_deducted_at_source1 = 0;
                        }
                        else
                        {
                            tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                        }
                    }

                    if (total_income > 500000)
                    {
                        //strConvert = income.ToString();
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = 0;
                        edu_cess = income * 4 / 100;

                        tax_payable = (float)income + edu_cess;
                        tax_payable = (int)Math.Round(tax_payable);


                        //if (tax_till > tax_payable)
                        //{
                        //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                        //}
                        //else
                        //{
                        //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                        //}
                        tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                        if (tax_balance < 0)
                        {
                            tax_balance = 0;
                        }
                        tot_months = months - 1;
                        tds_per_month = tax_balance / tot_months;
                        if (Financial_md.Month != 03)
                        {
                            int x = (int)Math.Round(tds_per_month);
                            int y = (int)Math.Round(x / 100d, 0) * 100;
                            rounding_tds_per_month = y;
                        }
                        else
                        {
                            int xp = (int)Math.Round(tds_per_month);
                            int Z = (10 - xp % 10) + xp;
                            rounding_tds_per_month = Z;
                        }

                        //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                    }
                    else
                    {
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = Convert.ToDecimal(income);
                        edu_cess = 0;

                        tax_payable = 0;

                        tax_till = 0;
                        tax_balance = 0;

                        tds_per_month = 0;

                        rounding_tds_per_month = 0;
                    }
                    //string employer_name_address = PrConstants.Name;
                    //string employer_pan = PrConstants.PAN;
                    //string employer_tan = PrConstants.TAN;

                    lstTDS.Add(new TDSProcess
                    {
                        option = optn.Rows[0]["Option"].ToString(),
                        name = name,
                        per_address = per_address,
                        pan_no = pan_no,
                        emp_code = emp_code,
                        designation = designation,
                        sex = sex,
                        fm = fm,
                        employer_name_address = employer_name_address,
                        employer_pan = employer_pan,
                        employer_tan = employer_tan,
                        basic = AddZerosAfterDecimal(Convert.ToString(basic)),
                        da_percent = AddZerosAfterDecimal(Convert.ToString(da_percent)),
                        per_allowance = AddZerosAfterDecimal(Convert.ToString(per_allowance)),
                        int_ref = AddZerosAfterDecimal(Convert.ToString(int_ref)),
                        t_inc = AddZerosAfterDecimal(Convert.ToString(t_inc)),
                        fpa_allow = AddZerosAfterDecimal(Convert.ToString(fpa_allow)),
                        fpiip = AddZerosAfterDecimal(Convert.ToString(fpiip)),
                        pf_perk = AddZerosAfterDecimal(Convert.ToString(pf_perk)),
                        loan_perk = AddZerosAfterDecimal(Convert.ToString(loan_perk)),
                        incentives = AddZerosAfterDecimal(Convert.ToString(incentives)),
                        spl_allowance = AddZerosAfterDecimal(Convert.ToString(spl_allowance)),
                        spl_da = AddZerosAfterDecimal(Convert.ToString(spl_da)),
                        hra = AddZerosAfterDecimal(Convert.ToString(hra)),
                        cca = AddZerosAfterDecimal(Convert.ToString(cca)),
                        values_of_17_2 = AddZerosAfterDecimal(Convert.ToString(values_of_17_2)),
                        values_of_17_3 = AddZerosAfterDecimal(Convert.ToString(values_of_17_3)),
                        gross = AddZerosAfterDecimal(Convert.ToString(gross)), // 2 pending
                        //standard_deduction = AddZerosAfterDecimal(Convert.ToString(standard_deduction)),
                        ent_allowance = AddZerosAfterDecimal(Convert.ToString(ent_allowance)),
                        //emp_tax = AddZerosAfterDecimal(Convert.ToString(emp_tax)),
                        //aggregate_of_4 = AddZerosAfterDecimal(Convert.ToString(aggregate_of_4)),
                        Income_chargable = AddZerosAfterDecimal(Convert.ToString(Income_chargable)),
                        other = AddZerosAfterDecimal(Convert.ToString(other)),
                        //houseloan_allownace = AddZerosAfterDecimal(Convert.ToString(houseloan_allownace)),
                        total_gross_income = AddZerosAfterDecimal(Convert.ToString(total_gross_income)),
                        loan_instl_amt = AddZerosAfterDecimal(Convert.ToString(loan_instl_amt)),
                        //deductible = AddZerosAfterDecimal(Convert.ToString(deductible)),
                        total_income = AddZerosAfterDecimal(Convert.ToString(total_income)),
                        income = AddZerosAfterDecimal(Convert.ToString(income)),
                        edu_cess = AddZerosAfterDecimal(Convert.ToString(edu_cess)),
                        tax_payable = AddZerosAfterDecimal(Convert.ToString(tax_payable)),
                        tax_till = AddZerosAfterDecimal(Convert.ToString(tax_till)),
                        tax_balance = AddZerosAfterDecimal(Convert.ToString(tax_balance)),
                        balance_month = Convert.ToString(months),
                        tds_per_month = AddZerosAfterDecimal(Convert.ToString(rounding_tds_per_month)),
                        house_rent_allowance = AddZerosAfterDecimal(Convert.ToString(house_rent_allowance)),
                        total_section = AddZerosAfterDecimal(Convert.ToString(total_section)),
                        //balance = AddZerosAfterDecimal(Convert.ToString(balance)),
                        round_income = AddZerosAfterDecimal(Convert.ToString(round_income)),
                        section_87a = AddZerosAfterDecimal(Convert.ToString(section_87a)),
                        //paid_by_emp = AddZerosAfterDecimal(Convert.ToString(paid_by_emp)),
                        paid_by_emp = AddZerosAfterDecimal(Convert.ToString(tax_deducted_at_source1)),

                    }); ;
                    var tds = JsonConvert.SerializeObject(lstTDS);
                    ////sowjanya
                    //var ccT = JsonConvert.SerializeObject(lstCer);
                    //var cccT = JsonConvert.SerializeObject(lstCCC);
                    //var ccdT = JsonConvert.SerializeObject(lstCCD);
                    //var otherT = JsonConvert.SerializeObject(lstOther);
                    var allowanceT = JsonConvert.SerializeObject(NewActiveList);

                    var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                    var tdsData = javaScriptSerializer.DeserializeObject(tds);
                    ////sowjanya
                    //var ccData = javaScriptSerializer.DeserializeObject(ccT);
                    //var cccData = javaScriptSerializer.DeserializeObject(cccT);
                    //var ccdData = javaScriptSerializer.DeserializeObject(ccdT);
                    //var otherData = javaScriptSerializer.DeserializeObject(otherT);
                    var allowanceTdata = javaScriptSerializer.DeserializeObject(allowanceT);

                    var resultJson = javaScriptSerializer.Serialize(new
                    {
                        tds = tdsData,
                        //cc = ccData,
                        //ccc = cccData,
                        //ccd = ccdData,
                        //other = otherData,
                        allowance = allowanceTdata

                    });
                    //int NewNumIndex = 0;

                    //StringBuilder sbqry = new StringBuilder();
                    ////1. trans_id
                    //sbqry.Append(GenNewTransactionString());

                    int finalSub = 0;

                    if (final == true)
                    {
                        finalSub = 1;
                    }
                    else
                    {
                        finalSub = 0;
                    }

                    string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable details = await _sha.Get_Table_FromQry(selQry);
                    if (details.Rows.Count > 0)
                    {
                        NewNumIndex++;
                        DataRow finaldt = details.Rows[0];
                        string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                        sbqry.Append(tdsdelete);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                        int finalCount = Convert.ToInt32(finaldt["final"]);

                        if (finalCount == 1)
                        {
                            return "E#TDS Process#Employee Already Processed..!!";
                        }
                        else
                        {
                            NewNumIndex++;
                            string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            sbqry.Append(tdsUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                            NewNumIndex++;
                            string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            sbqry.Append(certUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));


                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }
                            ////sowjanya
                            //if (lstCer != null)
                            //{
                            //    foreach (var ccDatas in lstCer)
                            //    {
                            //        if (ccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCC != null)
                            //{
                            //    foreach (var cccDatas in lstCCC)
                            //    {
                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCD != null)
                            //{
                            //    foreach (var ccdDatas in lstCCD)
                            //    {
                            //        if (ccdDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstOther != null)
                            //{
                            //    foreach (var otherDatas in lstOther)
                            //    {
                            //        if (otherDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }



                    }
                    else
                    {

                        try
                        {

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate1);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            //if (lstCer != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate2);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var ccDatas in lstCer)
                            //    {

                            //        if (ccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCC != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate3);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var cccDatas in lstCCC)
                            //    {

                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCD != null)
                            //{
                            //    foreach (var ccdDatas in lstCCD)
                            //    {
                            //        NewNumIndex++;
                            //        string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //        sbqry.Append(tdsUpdate3);
                            //        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //        if (ccdDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstOther != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate4);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var otherDatas in lstOther)
                            //    {
                            //        if (otherDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }
                        catch (Exception e)
                        {
                            return "E#TDS Process#" + e.Message;
                        }
                    }
                    return resultJson;
                    //}
                }

                else if (optn.Rows[0]["Option"].ToString() == "1" && dtretiredate.Rows.Count > 0 && zerobasic > 0)
                {
                    decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                           .Where(x => x["constant"].ToString() == "Section80C")
                           .Select(x => x["value"].ToString()).FirstOrDefault()); //150000
                    
                    decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80CCD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                    decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80U")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DDB")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                    decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_P")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                    decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_F")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                    decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80EE")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                    decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section24(b)")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                    decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80G")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                    decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80GGB")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                    DataTable _dtFY_FM = ds1.Tables[1];
                    _incometaxdbconstant = ds1.Tables[2];


                    //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                        "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                        "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " " +
                        "and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm = '" + FM + "' and spl_type='Regular'); ";

                    //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                        "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                        "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";

                    //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                    string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                    //allowance ==>Get and Sum all previous months allowances 
                    string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                    //allowance ==> Get all current month allowances
                    string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                    //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                    ////sum Personal Allowance
                    //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                    //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                    ////sum FPIIP
                    //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                    //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                    //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                    //sum PFPerks                                                   
                    string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                    // sum LOANPerks                                                    
                    string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                    // sum Incentive                                                    
                    string incentive = "select distinct sum(amount) as incentive from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    // sum  val 17 -2
                    string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                         "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                    // sum val 17 -3
                    string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                        "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                        " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                    //rent allowance
                    //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                    string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                    //other
                    string otherQry = "select distinct sum(amount) as other from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    //house loan
                    string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                    //section 80c
                    //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                    //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                    //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                    string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                       "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                       "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                       "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and active=1  union all " +
                       " select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                       "paydedu where paydedu.dd_name = 'VPF Deduction' and emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in (select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                       " union all " +
                        "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                        "union all " +
                       "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                       "union all " +
                       "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                       "union all " +
                       "select '7' as id, 'Housing Loan 2B-2C' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2B-2C' and emp_code = " + Convert.ToInt32(empCode) + "  and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                       "union all " +
                       "select '8' as id, 'Housing Loan 2A' as name, sum(paydedu.dd_amount) as amount  from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2A' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                       " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC';";

                    //section 80ccc
                    string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                    //section 80ccd
                    string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                        " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                    //section other section
                    string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                    //tax till
                    string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                    //other tds deductions
                    //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                    string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                        "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                        "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                    //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                    //VPF
                    string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm <= '" + FM + "' and p.fm >= '" + startYear + "';";
                    string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                 " union all " +
                 " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' " +
                 "union all  " +
                 "select 'Housing Loan 2B-2C',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =  " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "'  and fm>= '" + startYear + "'  and emp_code =  " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2B-2C' " +
                 "union all  " +
                 "select 'Housing Loan 2A',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + "  and payslip_mid in(select id from pr_emp_payslip where fm <  '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2A' ";

                    string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff, (SELECT DATEDIFF(month,'" + startYear + "',Retirementdate) from Employees where EmpId=" + Convert.ToInt32(empCode) + ") as DateDiffRetire;";

                    string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                    string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                        " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";
                    string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                       " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                       " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                    string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                        " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                        " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                    string strpf = " select sum(dd_provident_fund) pf  from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";
                    string strprevlicgsli = "select 'LIC' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'LIC' and payslip_mid " +
                                           " in(select id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "') " +
                                           "union all" +
                                           " select 'GSLI' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'GSLI' and payslip_mid " +
                                           " in(select id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "');";
                    string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                    string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                    DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                        SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                        cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                        loansprevmonth + strdatediff + strincometax + nolopsbasic + SumAllowanceQrynew + ActiveSumAllowanceQrynew+strpf+strprevlicgsli+ tdssections+ tdssection24);

                    //tables
                    var dtGeneral = ds.Tables[0];
                    var dtBasic = ds.Tables[1];
                    var dtBasicSum = ds.Tables[2];
                    var dtAllowance = ds.Tables[3];
                    var dtSumAllowance = ds.Tables[4];

                    var dtPfperks = ds.Tables[5];
                    var dtLoanPerks = ds.Tables[6];
                    var dtIncentives = ds.Tables[7];
                    var dt172 = ds.Tables[8];
                    var dt173 = ds.Tables[9];
                    var dtRent = ds.Tables[10];
                    var dtOther = ds.Tables[11];
                    var dtHouse = ds.Tables[12];

                    var dtCD = ds.Tables[13];
                    var dtCCC = ds.Tables[14];
                    var dtCCD = ds.Tables[15];
                    var dtEdu = ds.Tables[16];
                    var dtTax = ds.Tables[17];
                    var dtTDS = ds.Tables[18];
                    var dtEmpTax = ds.Tables[19];
                    var dtVpf = ds.Tables[20];
                    var dtActiveSumAllowance = ds.Tables[21];
                    var dt_prevmonthloans = ds.Tables[22];
                    var dt_datediff = ds.Tables[23];
                    var dt_incometax = ds.Tables[24];
                    var dt_nolopbasic = ds.Tables[25];
                    var dtSumAllowancenew = ds.Tables[26];
                    var dtActiveSumAllowancenew = ds.Tables[27];
                    var dt_strpf = ds.Tables[28];
                    var dt_strprevlicgsli = ds.Tables[29];
                    var dt_tdssections = ds.Tables[30];
                    var dt_tdssection24 = ds.Tables[31];
                    int loss_months = 0;
                    decimal? vpf_data = 0;
                    decimal? pf = 0;
                    decimal? lic = 0;
                    decimal? houseloanmain = 0;
                    decimal? houseAddloan_2d = 0;
                    decimal? houseloan2bc = 0;
                    decimal? houseloan2a = 0;

                    if (dtEmpTax.Rows.Count > 0)
                    {
                        DataRow empTax = dtEmpTax.Rows[0];

                        object val = empTax["loss"];
                        if (val == DBNull.Value)
                        {
                            loss_months = 0;
                        }
                        else
                        {
                            loss_months = Convert.ToInt32(empTax["loss"]);
                        }

                    }
                    //vpf

                    if (dtVpf.Rows.Count > 0)
                    {
                        DataRow vpfData = dtVpf.Rows[0];

                        object val = vpfData["amount"];
                        if (val == DBNull.Value)
                        {
                            vpf_data = 0;
                        }
                        else
                        {
                            vpf_data = Convert.ToDecimal(vpfData["amount"]);
                        }

                    }

                    // General Data
                    if (dtGeneral.Rows.Count > 0)
                    {
                        DataRow gen = dtGeneral.Rows[0];
                        name = Convert.ToString(gen["name"]);
                        per_address = Convert.ToString(gen["per_address"]);
                        pan_no = Convert.ToString(gen["pan_no"]);
                        emp_code = Convert.ToString(gen["emp_code"]);
                        designation = Convert.ToString(gen["designation"]);
                        sex = Convert.ToString(gen["sex"]);
                        fm = fin_month;
                    }


                    //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                    if (dtBasic.Rows.Count > 0)
                    {

                        DataRow rbasic = dtBasic.Rows[0];

                        //basic 
                        object val = rbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            pbasic = 0;
                        }
                        else
                        {
                            pbasic = Convert.ToDecimal(rbasic["basic"]) * months_1new;
                        }

                        //da_percent 
                        object val1 = rbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            pda_percent = 0;
                        }
                        else
                        {
                            pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months_1new;
                        }
                        //cca
                        object val2 = rbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            pcca = 0;
                        }
                        else
                        {
                            pcca = Convert.ToDecimal(rbasic["cca"]) * months_1new;
                        }
                        //hra
                        object val3 = rbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            phra = 0;
                        }
                        else
                        {
                            phra = Convert.ToDecimal(rbasic["hra"]) * months_1new;
                        }
                        //int_ref
                        object va4 = rbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            pint_ref = 0;
                        }
                        else
                        {
                            pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months_1new;
                        }

                        object val5 = rbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            pt_inc = 0;
                        }
                        else
                        {
                            pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months_1new;
                        }

                        object val6 = rbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            pspl_da = 0;
                        }
                        else
                        {
                            pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months_1new;
                        }

                        object val7 = rbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            pspl_allowance = 0;
                        }
                        else
                        {
                            pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months_1new;
                        }



                    }


                    if (dt_prevmonthloans.Rows.Count > 0)
                    {
                        foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                        {
                            int loanid = 0;
                            int pflag = 0;
                            int pflag1 = 0;
                            int countofsub = 0;
                            int precoverflag = 0;
                            string val = dr_prelons["loantype"].ToString();
                            string getloanid = "select id  from pr_loan_master where loan_description='" + val + "'";
                            DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                            loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                            string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                            string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                            DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                            DataTable dtcompare = sh.Get_Table_FromQry(comparequery);

                            if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                            {
                                countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                            }


                            if (dtchkloaneligibility.Rows.Count > 0)
                            {
                                pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                            }
                            object amount = dr_prelons["amount"];
                            if (countofsub != precoverflag)
                            {
                                if (val == "Housing Loan Main")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloanmain = 0;
                                    }
                                    else
                                    {
                                        houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Addl.Loan - 2D")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseAddloan_2d = 0;
                                    }
                                    else
                                    {
                                        houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Loan 2B-2C")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloan2bc = 0;
                                    }
                                    else
                                    {
                                        houseloan2bc = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                                else if (val == "Housing Loan 2A")
                                {
                                    if (amount == DBNull.Value)
                                    {
                                        houseloan2a = 0;
                                    }
                                    else
                                    {
                                        houseloan2a = Convert.ToDecimal(dr_prelons["amount"]);
                                    }
                                }
                            }
                        }
                    }
                    // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance



                    if (dtBasicSum.Rows.Count > 0)
                    {
                        DataRow sbasic = dtBasicSum.Rows[0];

                        //basic 
                        object val = sbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            basic = 0 + pbasic;
                        }
                        else
                        {
                            basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        }

                        //da_percent 
                        object val1 = sbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            da_percent = Convert.ToDecimal(0 + pda_percent);
                        }
                        else
                        {
                            da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        }
                        //cca
                        object val2 = sbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            cca = Convert.ToDecimal(0 + pcca);
                        }
                        else
                        {
                            cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        }
                        //hra
                        object val3 = sbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            hra = Convert.ToDecimal(0 + phra);
                        }
                        else
                        {
                            hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        }
                        //int_ref
                        object va4 = sbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            int_ref = 0 + pint_ref;
                        }
                        else
                        {
                            int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        }

                        object val5 = sbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            t_inc = 0 + pt_inc;
                        }
                        else
                        {
                            t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        }

                        object val6 = sbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            spl_da = 0 + pspl_da;
                        }
                        else
                        {
                            spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        }

                        object val7 = sbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            spl_allowance = 0 + pspl_allowance;
                        }
                        else
                        {
                            spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                        }

                        object val8 = sbasic["pf"];
                        if (val8 == DBNull.Value)
                        {
                            pf = 0;
                        }
                        else
                        {
                            pf = Convert.ToDecimal(sbasic["pf"]);
                        }



                        //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                    }

                    //present allowances pper_allowance,pfpa_allow,pfpiip

                    //foreach (DataRow algen in dtAllowance.Rows)
                    //{


                    //    string alw_name = algen["all_name"].ToString();
                    //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                    //    if (alw_name == "Fixed Personal Allowance")
                    //    {
                    //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == "FPA-HRA Allowance")
                    //    {
                    //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == PrConstants.FPIIP)
                    //    {
                    //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                    //    }

                    //}

                    ////dtSumFixed
                    //if (dtSumFixed.Rows.Count > 0)
                    //{
                    //    DataRow sumf = dtSumFixed.Rows[0];

                    //    object val = sumf["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        per_allowance = 0 + pper_allowance;
                    //    }
                    //    else
                    //    {
                    //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                    //    }

                    //}
                    ////dtsumFPA
                    //if (dtsumFPA.Rows.Count > 0)
                    //{
                    //    DataRow sumfpa = dtsumFPA.Rows[0];

                    //    object val = sumfpa["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpa_allow = 0 + pfpa_allow;
                    //    }
                    //    else
                    //    {
                    //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                    //    }

                    //}
                    ////dtsumfpiip
                    //if (dtsumfpiip.Rows.Count > 0)
                    //{
                    //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                    //    object val = sumfpiip["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpiip = 0 + pfpiip;
                    //    }
                    //    else
                    //    {
                    //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                    //    }
                    //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                    //}

                    //getting the date difference from finstart year and current year for allowance
                    int datediffetire = 0;
                    int minval = 0;
                    if (dt_datediff.Rows.Count > 0)
                    {
                        datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                        datediffetire = Convert.ToInt32(dt_datediff.Rows[0]["DateDiffRetire"]);
                        minval = Math.Min(datediff, datediffetire);
                    }


                    List<OldAllowance> oldList = new List<OldAllowance>();
                    //foreach (DataRow dtold in dtSumAllowance.Rows)
                    //{
                    //    OldAllowance objoldlist = new OldAllowance();
                    //    objoldlist.old_Name = dtold["all_name"].ToString();
                    //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                    //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                    //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                    //    oldList.Add(objoldlist);
                    //}
                    foreach (DataRow dtold in dtSumAllowancenew.Rows)
                    {
                        OldAllowance objoldlist = new OldAllowance();
                        objoldlist.old_Name = dtold["all_name"].ToString();
                        //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                        objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                        //objoldlist.old_alw_type = dtold["all_type"].ToString();
                        oldList.Add(objoldlist);
                    }



                    List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                    //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                    //{

                    //    ActiveAllowance NewObjlist = new ActiveAllowance();
                    //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                    //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                    //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                    //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                    //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                    //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                    //    if (olditem != null)
                    //    {
                    //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                    //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                    //    }

                    //    NewActiveList.Add(NewObjlist);
                    //}
                    foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                    {

                        ActiveAllowance NewObjlist = new ActiveAllowance();
                        NewObjlist.Active_Name = dtActive["all_name"].ToString();
                        //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                        NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1new;
                        //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                        // NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                        var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                        if (olditem != null)
                        {
                            NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                        }

                        NewActiveList.Add(NewObjlist);
                    }


                    //if not in new list then add
                    //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                    //{
                    //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                    //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                    //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                    //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                    //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                    //    if (olditem == null)
                    //    {
                    //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                    //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                    //        NewActiveList.Add(NewObjlist1);
                    //    }
                    //}
                    foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                    {
                        ActiveAllowance NewObjlist1 = new ActiveAllowance();
                        NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                        //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                        //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                        var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                        if (olditem == null)
                        {
                            NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            NewActiveList.Add(NewObjlist1);
                        }
                    }
                    var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                    if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                    {
                        await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                    }
                    int NewNumIndex = 0;

                    StringBuilder sbqry = new StringBuilder();
                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());
                    decimal total_allowance = 0;
                    //foreach (var newlist in NewActiveList)
                    //{
                    //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                    //    NewNumIndex++;
                    //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                    //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                    //    sbqry.Append(newqry);
                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    //}

                    foreach (var newlist in NewActiveList)
                    {
                        total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                        NewNumIndex++;
                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                        var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                            " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                            "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                            " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                        sbqry.Append(newqry);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    }



                    //List<string> lststring = new List<string>();
                    //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                    // dtPfPerks
                    //if (dtPfperks.Rows.Count > 0)
                    //{
                    //    DataRow pfPerk = dtPfperks.Rows[0];

                    //    object val = pfPerk["pf_perk"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        pf_perk = 0;
                    //    }
                    //    else
                    //    {
                    //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                    //    }

                    //}
                    //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                    
                    //dtLoanPerks
                    if (dtLoanPerks.Rows.Count > 0)
                    {
                        DataRow lperk = dtLoanPerks.Rows[0];

                        object val = lperk["loan_perk"];
                        if (val == DBNull.Value)
                        {
                            loan_perk = 0;
                        }
                        else
                        {
                            loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                        }

                    }
                    //dtIncentives
                    if (dtIncentives.Rows.Count > 0)
                    {
                        DataRow ins = dtIncentives.Rows[0];

                        object val = ins["incentive"];
                        if (val == DBNull.Value)
                        {
                            incentives = 0;
                        }
                        else
                        {
                            incentives = Convert.ToDecimal(ins["incentive"]);
                        }

                    }
                    //dt172
                    if (dt172.Rows.Count > 0)
                    {
                        DataRow VAL = dt172.Rows[0];
                        object val = VAL["val172"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_2 = 0;
                        }
                        else
                        {
                            values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                            totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                        }
                    }
                    //dt173
                    if (dt173.Rows.Count > 0)
                    {
                        DataRow VAL1 = dt173.Rows[0];
                        object val = VAL1["val173"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_3 = 0;
                        }
                        else
                        {
                            values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                        }
                    }

                    if (dtRent.Rows.Count > 0)
                    {
                        DataRow rents = dtRent.Rows[0];

                        object val = rents["rentamount"];
                        if (val == DBNull.Value)
                        {
                            house_rent_allowance = 0;
                        }
                        else
                        {
                            house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                        }
                    }

                    if (house_rent_allowance > 0)
                    {
                        decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                        //salary(a)
                        decimal salary = da_percent + Convert.ToDecimal(basic);
                        //40%  of salary(b)
                        decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                        //houserentpaid - 10% of salary(c)
                        decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                        //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                        house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                        // HouseRentAllowance calculated as on 04-09-2020
                        // minimun values of (
                        // Basic+DA --40%,
                        // House Rent Paid minus Basic+DA --10% 
                        // HRA)
                    }
                    //decimal daval = Convert.ToDecimal(da);
                    //decimal hraval = Convert.ToDecimal(hra);
                    //rent amount
                    if (house_rent_allowance < 0)
                    {
                        house_rent_allowance = 0;
                    }



                    if (dtOther.Rows.Count > 0)
                    {
                        DataRow otr = dtOther.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = otr["other"];
                        if (val == DBNull.Value)
                        {
                            other = 0;
                        }
                        else
                        {
                            other = Convert.ToDecimal(otr["other"]);
                        }

                    }

                    if (dtHouse.Rows.Count > 0)
                    {
                        //foreach (DataRow dr in dtHouse.Rows)
                        //{
                        //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                        //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                        //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                        //        || dr["loan_type_mid"].ToString() == "13")
                        //    {
                        //        count++;
                        //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                        //    }

                        //}
                        DataRow dh = dtHouse.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = dh["amount"];
                        if (val == DBNull.Value)
                        {
                            houseloan_allownace = 0;
                        }
                        else
                        {
                            houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                        }

                    }
                    //if (count > 0)
                    //{

                    //    houseloan_allownace = 200000;
                    //}
                    if (dt_strpf.Rows.Count > 0)
                    {
                        pf = Convert.ToDecimal(dt_strpf.Rows[0]["pf"]);
                    }
                    if (dt_strprevlicgsli.Rows.Count > 0)
                    {
                        foreach (DataRow drpev in dt_strprevlicgsli.Rows)
                        {
                            decimal? amount = 0;
                            object val = drpev["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(drpev["amount"]);
                            }
                            string dd_name = Convert.ToString(drpev["name"].ToString());
                            if (dd_name == "LIC")
                            {
                                lic = amount;
                            }
                            else if (dd_name == "GSLI")
                            {
                                gsli = amount;
                            }
                        }
                    }

                    IList<section80C> lstCer = new List<section80C>();
                    IList<section80CCC> lstCCC = new List<section80CCC>();
                    IList<section80CCD> lstCCD = new List<section80CCD>();
                    IList<sectionOther> lstOther = new List<sectionOther>();

                    decimal pf_new = 0;
                    if (dtCD.Rows.Count > 0)
                    {
                        foreach (DataRow cer in dtCD.Rows)
                        {
                            //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                            decimal? amount = 0;

                            object val = cer["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(cer["amount"]);
                            }

                            string dd_name = Convert.ToString(cer["name"].ToString());
                            int loanid = 0;
                            int pflag = 0;
                            int countofsub = 0;
                            int precoverflag = 0;

                            string getloanid = "select id  from pr_loan_master where loan_description='" + dd_name + "'";
                            DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                            if (dtgetloanid.Rows.Count > 0)
                            {
                                loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                            }

                            string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                            string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                            DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                            DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                            if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                            {
                                countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                            }
                            if (dtchkloaneligibility.Rows.Count > 0)
                            {
                                pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                            }
                            if (dd_name == "Provident Fund")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //   amount = Convert.ToDecimal(pf + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = pf;
                                    //}

                                }
                                amount = Convert.ToDecimal(pf + (amount * months_1new));
                                pf_new = Convert.ToDecimal(amount);
                            }
                            else if (dd_name == "VPF")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //    amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = vpf_data;
                                    //}

                                }
                                amount = Convert.ToDecimal(vpf_data + (amount * months_1new));
                            }
                            //added new on 25/06/2020
                            else if (dd_name == "LIC")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //    amount = Convert.ToDecimal(lic + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = lic;
                                    //}
                                }
                                amount = Convert.ToDecimal(lic + (amount * months_1new));
                            }
                            else if (dd_name == "Housing Loan Main")
                            {
                                //amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Addl.Loan - 2D")
                            {
                                //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Loan 2B-2C")
                            {
                                //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloan2bc + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "Housing Loan 2A")
                            {
                                //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                if (countofsub != precoverflag)
                                {
                                    amount = Convert.ToDecimal(houseloan2a + (amount * months_1new));
                                }
                                else
                                {
                                    amount = 0;
                                }
                            }
                            else if (dd_name == "GSLI")
                            {
                                amount = Convert.ToDecimal(gsli + (amount * months_1new));
                            }
                            else
                            {
                                amount = Convert.ToDecimal(amount * months_1new);
                            }
                            //if amount is zero not adding to the list
                            if (amount == 0)
                            { continue; }
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer["id"].ToString(),
                                    name = cer["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                        }


                    }
                    else
                    {
                        lstCer.Add(new section80C
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //for special deductions
                    if (dt_tdssections.Rows.Count > 0)
                    {
                        foreach (DataRow cer1 in dt_tdssections.Rows)
                        {
                            decimal? amount1 = 0;
                            decimal? allowance_amount1 = 0;
                            amount1 = Convert.ToDecimal(cer1["gross"]);
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount1 > min_allowance)
                                {
                                    allowance_amount1 = min_allowance;
                                    min_allowance = min_allowance - allowance_amount1;
                                    max_allowance = max_allowance + allowance_amount1;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount1;
                                    allowance_amount1 = amount1;
                                    max_allowance = max_allowance + amount1;
                                }
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                });
                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = cer1["id"].ToString(),
                                    name = cer1["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }

                    }

                    decimal pf_perkcal = 0.5m;
                    decimal pf_perktemp = 12.5m;
                    pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                    //if (dtCCC.Rows.Count > 0)
                    //{
                    //    foreach (DataRow ccc in dtCCC.Rows)
                    //    {
                    //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                    //        decimal? allowance_amount = 0;
                    //        if (min_allowance > 0 && max_allowance <= 150000)
                    //        {
                    //            if (amount > min_allowance)
                    //            {
                    //                allowance_amount = min_allowance;
                    //                min_allowance = min_allowance - allowance_amount;
                    //                max_allowance = max_allowance + allowance_amount;
                    //            }
                    //            else
                    //            {
                    //                min_allowance = min_allowance - amount;
                    //                allowance_amount = amount;
                    //                max_allowance = max_allowance + amount;
                    //            }
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                    //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                    //            });
                    //        }
                    //        else
                    //        {
                    //            lstCCC.Add(new section80CCC
                    //            {
                    //                id = ccc["id"].ToString(),
                    //                name = ccc["name"].ToString(),
                    //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                    //                allowance_amount = AddZerosAfterDecimal("0"),
                    //                ded_amount = AddZerosAfterDecimal("0")
                    //            });
                    //        }

                    //    }

                    //}
                    //else
                    //{
                    //    lstCCC.Add(new section80CCC
                    //    {
                    //        id = "",
                    //        name = "",
                    //        amount = AddZerosAfterDecimal("0"),
                    //        allowance_amount = AddZerosAfterDecimal("0"),
                    //        ded_amount = AddZerosAfterDecimal("0")
                    //    });
                    //}

                    if (dtCCD.Rows.Count > 0)
                    {
                        foreach (DataRow ccd in dtCCD.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                            {
                                if (amount > min_allowance80CCD)
                                {
                                    allowance_amount = min_allowance80CCD;
                                    min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                    max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                }
                                else
                                {
                                    min_allowance80CCD = min_allowance80CCD - amount;
                                    allowance_amount = amount;
                                    max_allowance80CCD = max_allowance80CCD + amount;
                                }
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                });
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = ccd["id"].ToString(),
                                    name = ccd["name"].ToString(),
                                    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }
                        }
                    }
                    else
                    {
                        lstCCD.Add(new section80CCD
                        {
                            id = "",
                            name = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    if (dtEdu.Rows.Count > 0)
                    {
                        foreach (DataRow ed in dtEdu.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                            String sectionNAme = ed["section"].ToString();
                            decimal? allowance_amount = 0;
                            string id = ed["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = ed["name"].ToString();
                            if (sectionNAme == "Section80G")
                            {
                                allowance_amount = amount * section80g;
                                max_allowanceGG = max_allowanceGG + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80GGB")
                            {
                                allowance_amount = amount * section80gg;
                                max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80DDB")
                            {
                                if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                {
                                    if (amount > min_allowance80DDB)
                                    {
                                        allowance_amount = min_allowance80DDB;
                                        ded_amount = allowance_amount;
                                        min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                        max_allowance80DB = max_allowance80DB + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DDB = min_allowance80DDB - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DB = max_allowance80DB + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                            }
                            else if (sectionNAme == "Section80DD")
                            {
                                if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                {
                                    if (amount > min_allowance80DD)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80DD = min_allowance80DD - allowance_amount;
                                        max_allowance80DD = max_allowance80DD + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DD = min_allowance80DD - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DD = max_allowance80DD + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80U")
                            {
                                if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                {
                                    if (amount > min_allowance80U)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80U = min_allowance80U - allowance_amount;
                                        max_allowance80U = max_allowance80U + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80U = min_allowance80U - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80U = max_allowance80U + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80E")
                            {
                                allowance_amount = amount;
                                max_allowance = max_allowance + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            else if (sectionNAme == "Section80D_P")
                            {
                                if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                {
                                    if (amount > min_allowance80D_P)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                        max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_P = min_allowance80D_P - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_P = max_allowance80D_P + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                                //if (min_allowance80D_P > amount)
                                //{
                                //    allowance_amount = amount;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}

                                //else
                                //{
                                //    allowance_amount = min_allowance80D_P;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}
                            }
                            else if (sectionNAme == "Section80D_F")
                            {
                                if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                {
                                    if (amount > min_allowance80D_F)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                        max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_F = min_allowance80D_F - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_F = max_allowance80D_F + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                            {
                                if (sectionNAme != "Section80EE")
                                {
                                    sectionNAme = "Section80EE_HL";
                                }
                                if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                {
                                    if (amount > min_allowance80EE)
                                    {
                                        allowance_amount = min_allowance80EE;
                                        min_allowance80EE = min_allowance80EE - allowance_amount;
                                        max_allowance80ee = max_allowance80ee + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80EE = min_allowance80EE - amount;
                                        allowance_amount = amount;
                                        max_allowance80ee = max_allowance80ee + amount;
                                    }
                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;

                                }
                            }

                            else if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });

                        }

                    }

                    else
                    {
                        lstOther.Add(new sectionOther
                        {
                            id = "",
                            name = "",
                            section = "",
                            amount = AddZerosAfterDecimal("0"),
                            allowance_amount = AddZerosAfterDecimal("0"),
                            ded_amount = AddZerosAfterDecimal("0")
                        });
                    }

                    //special section24(b)
                    if (dt_tdssection24.Rows.Count > 0)
                    {
                        foreach (DataRow sec24 in dt_tdssection24.Rows)
                        {
                            decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                            String sectionNAme = sec24["section"].ToString();
                            string actName1 = "";
                            decimal? allowance_amount = 0;
                            string id = sec24["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = sec24["name"].ToString();

                            for (int i = 0; i < lstOther.Count; i++)
                            {
                                actName1 = lstOther[i].name;
                                if (actName1 == actName)
                                {
                                    lstOther.RemoveAt(i);
                                    continue;
                                }
                            }

                            if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance24b;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            lstOther.Add(new sectionOther
                            {
                                id = id,
                                name = actName,
                                section = sectionNAme,
                                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            });
                        }
                    }

                    max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                    if (dtTax.Rows.Count > 0)
                    {


                        DataRow tax = dtTax.Rows[0];

                        object val = tax["tax_deducted_at_source"];
                        if (val == DBNull.Value)
                        {
                            total_tax_till = 0;
                        }
                        else
                        {
                            total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                        }

                        tax_till = totaltaxdeductedfrm16 + total_tax_till;
                        tax_till = 0;

                    }

                    if (dtTDS.Rows.Count > 0)
                    {
                        DataRow TDS = dtTDS.Rows[0];

                        object val = TDS["tds_amount"];
                        if (val == DBNull.Value)
                        {
                            paid_by_emp = 0;
                        }
                        else
                        {
                            paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                        }
                    }

                    IList<TDSProcess> lstTDS = new List<TDSProcess>();

                    gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                    total_section = house_rent_allowance;

                    balance = gross - total_section;
                    //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                    //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                    decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                    if (stndednew >= 50000)
                    {
                        standard_deduction = PrConstants.STANDARD_DEDUCTION;
                    }
                    else
                    {
                        standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                    }
                    //standard_deduction = gross*0.04;

                    if (monthcount != 1)
                    {
                        //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);

                        //if (emp_tax > 2400)
                        //{
                        //    emp_tax = 2400;
                        //}
                        emp_tax = (200 * monthcount);
                    }
                    else if (monthcount == 1)
                    {
                        emp_tax = 0;
                    }
                    aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                    Income_chargable = balance - aggregate_of_4; //6

                    total_gross_income = Income_chargable + other - houseloan_allownace;

                    deductible = Convert.ToDecimal(max_allowance);
                    total_income = total_gross_income - deductible;
                    //total_income = Convert.ToDecimal(841240.01);
                    round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                    //tax_deducted_at_source is calculating as incometax value of current financial year.
                    decimal tax_deducted_at_source1 = 0;
                    if (dt_incometax.Rows.Count > 0)
                    {
                        DataRow incometax = dt_incometax.Rows[0];

                        object val = incometax["income_tax"];
                        if (val == DBNull.Value)
                        {
                            tax_deducted_at_source1 = 0;
                        }
                        else
                        {
                            tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                        }
                    }

                    if (total_income > 500000)
                    {
                        //strConvert = income.ToString();
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = 0;
                        edu_cess = income * 4 / 100;

                        tax_payable = (float)income + edu_cess;

                        tax_payable = (int)Math.Round(tax_payable);

                        //if (tax_till > tax_payable)
                        //{
                        //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                        //}
                        //else
                        //{
                        //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                        //}
                        tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                        if (tax_balance < 0)
                        {
                            tax_balance = 0;
                        }
                         tot_months = months_1 - 1;
                        if (tot_months > 0)
                        {
                            tds_per_month = tax_balance / tot_months; //months_1;
                        }
                        else
                        {
                            tds_per_month = tax_balance;// tot_months; //months_1;
                        }
                        if (Financial_md.Month != 03)
                        {
                            int x = (int)Math.Round(tds_per_month);
                            int y = (int)Math.Round(x / 100d, 0) * 100;
                            rounding_tds_per_month = y;
                        }
                        else
                        {
                            int xp = (int)Math.Round(tds_per_month);
                            int Z = (10 - xp % 10) + xp;
                            rounding_tds_per_month = Z;
                        }

                        //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                    }
                    else
                    {
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = Convert.ToDecimal(income);
                        edu_cess = 0;

                        tax_payable = 0;

                        tax_till = 0;
                        tax_balance = 0;

                        tds_per_month = 0;

                        rounding_tds_per_month = 0;
                    }
                    //string employer_name_address = PrConstants.Name;
                    //string employer_pan = PrConstants.PAN;
                    //string employer_tan = PrConstants.TAN;
                    int retmonthcount = DateTime.Compare(Convert.ToDateTime(strretdate), Convert.ToDateTime(fm));
                    if (retmonthcount <= 0)
                    {
                        months_1 = 0;
                    }
                    lstTDS.Add(new TDSProcess
                    {
                        option = optn.Rows[0]["Option"].ToString(),
                        name = name,
                        per_address = per_address,
                        pan_no = pan_no,
                        emp_code = emp_code,
                        designation = designation,
                        sex = sex,
                        fm = fm,
                        employer_name_address = employer_name_address,
                        employer_pan = employer_pan,
                        employer_tan = employer_tan,
                        basic = AddZerosAfterDecimal(Convert.ToString(basic)),
                        da_percent = AddZerosAfterDecimal(Convert.ToString(da_percent)),
                        per_allowance = AddZerosAfterDecimal(Convert.ToString(per_allowance)),
                        int_ref = AddZerosAfterDecimal(Convert.ToString(int_ref)),
                        t_inc = AddZerosAfterDecimal(Convert.ToString(t_inc)),
                        fpa_allow = AddZerosAfterDecimal(Convert.ToString(fpa_allow)),
                        fpiip = AddZerosAfterDecimal(Convert.ToString(fpiip)),
                        pf_perk = AddZerosAfterDecimal(Convert.ToString(pf_perk)),
                        loan_perk = AddZerosAfterDecimal(Convert.ToString(loan_perk)),
                        incentives = AddZerosAfterDecimal(Convert.ToString(incentives)),
                        spl_allowance = AddZerosAfterDecimal(Convert.ToString(spl_allowance)),
                        spl_da = AddZerosAfterDecimal(Convert.ToString(spl_da)),
                        hra = AddZerosAfterDecimal(Convert.ToString(hra)),
                        cca = AddZerosAfterDecimal(Convert.ToString(cca)),
                        values_of_17_2 = AddZerosAfterDecimal(Convert.ToString(values_of_17_2)),
                        values_of_17_3 = AddZerosAfterDecimal(Convert.ToString(values_of_17_3)),
                        gross = AddZerosAfterDecimal(Convert.ToString(gross)), // 2 pending
                        standard_deduction = AddZerosAfterDecimal(Convert.ToString(standard_deduction)),
                        ent_allowance = AddZerosAfterDecimal(Convert.ToString(ent_allowance)),
                        emp_tax = AddZerosAfterDecimal(Convert.ToString(emp_tax)),
                        aggregate_of_4 = AddZerosAfterDecimal(Convert.ToString(aggregate_of_4)),
                        Income_chargable = AddZerosAfterDecimal(Convert.ToString(Income_chargable)),
                        other = AddZerosAfterDecimal(Convert.ToString(other)),
                        houseloan_allownace = AddZerosAfterDecimal(Convert.ToString(houseloan_allownace)),
                        total_gross_income = AddZerosAfterDecimal(Convert.ToString(total_gross_income)),
                        loan_instl_amt = AddZerosAfterDecimal(Convert.ToString(loan_instl_amt)),
                        deductible = AddZerosAfterDecimal(Convert.ToString(deductible)),
                        total_income = AddZerosAfterDecimal(Convert.ToString(total_income)),
                        income = AddZerosAfterDecimal(Convert.ToString(income)),
                        edu_cess = AddZerosAfterDecimal(Convert.ToString(edu_cess)),
                        tax_payable = AddZerosAfterDecimal(Convert.ToString(tax_payable)),
                        tax_till = AddZerosAfterDecimal(Convert.ToString(tax_till)),
                        tax_balance = AddZerosAfterDecimal(Convert.ToString(tax_balance)),
                        balance_month = Convert.ToString(tot_months),//months_1),
                        tds_per_month = AddZerosAfterDecimal(Convert.ToString(rounding_tds_per_month)),
                        house_rent_allowance = AddZerosAfterDecimal(Convert.ToString(house_rent_allowance)),
                        total_section = AddZerosAfterDecimal(Convert.ToString(total_section)),
                        balance = AddZerosAfterDecimal(Convert.ToString(balance)),
                        round_income = AddZerosAfterDecimal(Convert.ToString(round_income)),
                        section_87a = AddZerosAfterDecimal(Convert.ToString(section_87a)),
                        //paid_by_emp = AddZerosAfterDecimal(Convert.ToString(paid_by_emp)),
                        paid_by_emp = AddZerosAfterDecimal(Convert.ToString(tax_deducted_at_source1)),

                    }); ;
                    var tds = JsonConvert.SerializeObject(lstTDS);
                    var ccT = JsonConvert.SerializeObject(lstCer);
                    var cccT = JsonConvert.SerializeObject(lstCCC);
                    var ccdT = JsonConvert.SerializeObject(lstCCD);
                    var otherT = JsonConvert.SerializeObject(lstOther);
                    var allowanceT = JsonConvert.SerializeObject(NewActiveList);

                    var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                    var tdsData = javaScriptSerializer.DeserializeObject(tds);
                    var ccData = javaScriptSerializer.DeserializeObject(ccT);
                    var cccData = javaScriptSerializer.DeserializeObject(cccT);
                    var ccdData = javaScriptSerializer.DeserializeObject(ccdT);
                    var otherData = javaScriptSerializer.DeserializeObject(otherT);
                    var allowanceTdata = javaScriptSerializer.DeserializeObject(allowanceT);

                    var resultJson = javaScriptSerializer.Serialize(new
                    {
                        tds = tdsData,
                        cc = ccData,
                        ccc = cccData,
                        ccd = ccdData,
                        other = otherData,
                        allowance = allowanceTdata

                    });
                    //int NewNumIndex = 0;

                    //StringBuilder sbqry = new StringBuilder();
                    ////1. trans_id
                    //sbqry.Append(GenNewTransactionString());

                    int finalSub = 0;

                    if (final == true)
                    {
                        finalSub = 1;
                    }
                    else
                    {
                        finalSub = 0;
                    }

                    string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable details = await _sha.Get_Table_FromQry(selQry);
                    if (details.Rows.Count > 0)
                    {
                        NewNumIndex++;
                        DataRow finaldt = details.Rows[0];
                        string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                        sbqry.Append(tdsdelete);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                        int finalCount = Convert.ToInt32(finaldt["final"]);

                        if (finalCount == 1)
                        {
                            return "E#TDS Process#Employee Already Processed..!!";
                        }
                        else
                        {
                            NewNumIndex++;
                            string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            sbqry.Append(tdsUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                            NewNumIndex++;
                            string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            sbqry.Append(certUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                foreach (var ccDatas in lstCer)
                                {
                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    foreach (var cccDatas in lstCCC)
                            //    {
                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }



                    }
                    else
                    {

                        try
                        {

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate1);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            if (lstCer != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate2);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var ccDatas in lstCer)
                                {

                                    if (ccDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            //if (lstCCC != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate3);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var cccDatas in lstCCC)
                            //    {

                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (lstCCD != null)
                            {
                                foreach (var ccdDatas in lstCCD)
                                {
                                    NewNumIndex++;
                                    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate3);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    if (ccdDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (lstOther != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate4);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                foreach (var otherDatas in lstOther)
                                {
                                    if (otherDatas.id != "")
                                    {
                                        NewNumIndex++;
                                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                        string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                            "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                            "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                        sbqry.Append(bioQry);

                                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    }

                                }
                            }
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }
                        catch (Exception e)
                        {
                            return "E#TDS Process#" + e.Message;
                        }
                    }
                    return resultJson;
                    //}
                }
                else if (optn.Rows[0]["Option"].ToString() == "2" && dtretiredate.Rows.Count > 0 && zerobasic > 0)
                {
                    decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                           .Where(x => x["constant"].ToString() == "Section80C")
                           .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                    decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80CCD")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                    decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80U")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                    decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80DDB")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                    decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_P")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                    decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80D_F")
                  .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                    decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section80EE")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                    decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                  .Where(x => x["constant"].ToString() == "Section24(b)")
                  .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                    decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80G")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                    decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                 .Where(x => x["constant"].ToString() == "Section80GGB")
                 .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                    DataTable _dtFY_FM = ds1.Tables[1];
                    _incometaxdbconstant = ds1.Tables[2];


                    //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                        "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                        "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + "and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " and spl_type='Regular' order by id desc); ";

                    //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                    string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                        "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                        "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                    //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                    string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                    //allowance ==>Get and Sum all previous months allowances 
                    string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                    //allowance ==> Get all current month allowances
                    string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                    //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ');";

                    ////sum Personal Allowance
                    //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                    //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                    ////sum FPIIP
                    //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                    //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                    //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                    //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                    //sum PFPerks                                                   
                    string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                    // sum LOANPerks                                                    
                    string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                    // sum Incentive                                                    
                    string incentive = "select distinct sum(amount) as incentive from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    // sum  val 17 -2
                    string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                         "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                    // sum val 17 -3
                    string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                        "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                        " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                        "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                    //rent allowance
                    //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                    string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                    //other
                    string otherQry = "select distinct sum(amount) as other from " +
                                "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                    //house loan
                    string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                    //section 80c
                    //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                    //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                    //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                    string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                       "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                       "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 and ef.name not in('Provident Fund','LIC','VPF','LIC','Housing Loan Main','Housing Addl.Loan - 2D','GSLI') union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                       "from pr_emp_payslip where active = 1 and emp_code = " + Convert.ToInt32(empCode) + " union " +
                       "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                       "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode);

                    //section 80ccc
                    string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                    //section 80ccd
                    string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                        " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                    //section other section
                    string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                    //tax till
                    string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                    //other tds deductions
                    //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                    string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                        "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                    string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                        "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                    //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                    //VPF
                    string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm < '" + FM + "' and p.fm >= '" + startYear + "';";

                    string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff, (SELECT DATEDIFF(month,'" + startYear + "',Retirementdate) from Employees where EmpId=" + Convert.ToInt32(empCode) + ") as DateDiffRetire;";

                    string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                    string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                    " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                    " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                    string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                        " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                        " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                    DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                        SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                        cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                        strdatediff + strincometax + SumAllowanceQrynew + ActiveSumAllowanceQrynew);

                    //tables
                    var dtGeneral = ds.Tables[0];
                    var dtBasic = ds.Tables[1];
                    var dtBasicSum = ds.Tables[2];
                    var dtAllowance = ds.Tables[3];
                    var dtSumAllowance = ds.Tables[4];

                    var dtPfperks = ds.Tables[5];
                    var dtLoanPerks = ds.Tables[6];
                    var dtIncentives = ds.Tables[7];
                    var dt172 = ds.Tables[8];
                    var dt173 = ds.Tables[9];
                    var dtRent = ds.Tables[10];
                    var dtOther = ds.Tables[11];
                    var dtHouse = ds.Tables[12];

                    var dtCD = ds.Tables[13];
                    var dtCCC = ds.Tables[14];
                    var dtCCD = ds.Tables[15];
                    var dtEdu = ds.Tables[16];
                    var dtTax = ds.Tables[17];
                    var dtTDS = ds.Tables[18];
                    var dtEmpTax = ds.Tables[19];
                    var dtVpf = ds.Tables[20];
                    var dtActiveSumAllowance = ds.Tables[21];
                    var dt_datediff = ds.Tables[22];
                    var dt_incometax = ds.Tables[23];
                    var dtSumAllowancenew = ds.Tables[24];
                    var dtActiveSumAllowancenew = ds.Tables[25];

                    int loss_months = 0;
                    decimal? vpf_data = 0;
                    decimal? pf = 0;

                    if (dtEmpTax.Rows.Count > 0)
                    {
                        DataRow empTax = dtEmpTax.Rows[0];

                        object val = empTax["loss"];
                        if (val == DBNull.Value)
                        {
                            loss_months = 0;
                        }
                        else
                        {
                            loss_months = Convert.ToInt32(empTax["loss"]);
                        }

                    }
                    //vpf

                    if (dtVpf.Rows.Count > 0)
                    {
                        DataRow vpfData = dtVpf.Rows[0];

                        object val = vpfData["amount"];
                        if (val == DBNull.Value)
                        {
                            vpf_data = 0;
                        }
                        else
                        {
                            vpf_data = Convert.ToDecimal(vpfData["amount"]);
                        }

                    }

                    // General Data
                    if (dtGeneral.Rows.Count > 0)
                    {
                        DataRow gen = dtGeneral.Rows[0];
                        name = Convert.ToString(gen["name"]);
                        per_address = Convert.ToString(gen["per_address"]);
                        pan_no = Convert.ToString(gen["pan_no"]);
                        emp_code = Convert.ToString(gen["emp_code"]);
                        designation = Convert.ToString(gen["designation"]);
                        sex = Convert.ToString(gen["sex"]);
                        fm = fin_month;
                    }

                    //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                    if (dtBasic.Rows.Count > 0)
                    {

                        DataRow rbasic = dtBasic.Rows[0];

                        //basic 
                        object val = rbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            pbasic = 0;
                        }
                        else
                        {
                            pbasic = Convert.ToDecimal(rbasic["basic"]) * months_1;
                        }

                        //da_percent 
                        object val1 = rbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            pda_percent = 0;
                        }
                        else
                        {
                            pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months_1;
                        }
                        //cca
                        object val2 = rbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            pcca = 0;
                        }
                        else
                        {
                            pcca = Convert.ToDecimal(rbasic["cca"]) * months_1;
                        }
                        //hra
                        object val3 = rbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            phra = 0;
                        }
                        else
                        {
                            phra = Convert.ToDecimal(rbasic["hra"]) * months_1;
                        }
                        //int_ref
                        object va4 = rbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            pint_ref = 0;
                        }
                        else
                        {
                            pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months_1;
                        }

                        object val5 = rbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            pt_inc = 0;
                        }
                        else
                        {
                            pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months_1;
                        }

                        object val6 = rbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            pspl_da = 0;
                        }
                        else
                        {
                            pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months_1;
                        }

                        object val7 = rbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            pspl_allowance = 0;
                        }
                        else
                        {
                            pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months_1;
                        }




                    }

                    // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                    if (dtBasicSum.Rows.Count > 0)
                    {
                        DataRow sbasic = dtBasicSum.Rows[0];

                        //basic 
                        object val = sbasic["basic"];
                        if (val == DBNull.Value)
                        {
                            basic = 0 + pbasic;
                        }
                        else
                        {
                            basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        }

                        //da_percent 
                        object val1 = sbasic["da_percent"];
                        if (val1 == DBNull.Value)
                        {
                            da_percent = Convert.ToDecimal(0 + pda_percent);
                        }
                        else
                        {
                            da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        }
                        //cca
                        object val2 = sbasic["cca"];
                        if (val2 == DBNull.Value)
                        {
                            cca = Convert.ToDecimal(0 + pcca);
                        }
                        else
                        {
                            cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        }
                        //hra
                        object val3 = sbasic["hra"];
                        if (val3 == DBNull.Value)
                        {
                            hra = Convert.ToDecimal(0 + phra);
                        }
                        else
                        {
                            hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        }
                        //int_ref
                        object va4 = sbasic["int_ref"];
                        if (va4 == DBNull.Value)
                        {
                            int_ref = 0 + pint_ref;
                        }
                        else
                        {
                            int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        }

                        object val5 = sbasic["t_inc"];
                        if (val5 == DBNull.Value)
                        {
                            t_inc = 0 + pt_inc;
                        }
                        else
                        {
                            t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        }

                        object val6 = sbasic["spl_da"];
                        if (val6 == DBNull.Value)
                        {
                            spl_da = 0 + pspl_da;
                        }
                        else
                        {
                            spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        }

                        object val7 = sbasic["spl_allowance"];
                        if (val7 == DBNull.Value)
                        {
                            spl_allowance = 0 + pspl_allowance;
                        }
                        else
                        {
                            spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                        }

                        object val8 = sbasic["pf"];
                        if (val8 == DBNull.Value)
                        {
                            pf = 0;
                        }
                        else
                        {
                            pf = Convert.ToDecimal(sbasic["pf"]);
                        }



                        //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                        //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                        //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                        //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                        //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                        //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                        //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                        //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                    }

                    //present allowances pper_allowance,pfpa_allow,pfpiip

                    //foreach (DataRow algen in dtAllowance.Rows)
                    //{


                    //    string alw_name = algen["all_name"].ToString();
                    //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                    //    if (alw_name == "Fixed Personal Allowance")
                    //    {
                    //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == "FPA-HRA Allowance")
                    //    {
                    //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                    //    }
                    //    else if (alw_name == PrConstants.FPIIP)
                    //    {
                    //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                    //    }

                    //}

                    ////dtSumFixed
                    //if (dtSumFixed.Rows.Count > 0)
                    //{
                    //    DataRow sumf = dtSumFixed.Rows[0];

                    //    object val = sumf["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        per_allowance = 0 + pper_allowance;
                    //    }
                    //    else
                    //    {
                    //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                    //    }

                    //}
                    ////dtsumFPA
                    //if (dtsumFPA.Rows.Count > 0)
                    //{
                    //    DataRow sumfpa = dtsumFPA.Rows[0];

                    //    object val = sumfpa["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpa_allow = 0 + pfpa_allow;
                    //    }
                    //    else
                    //    {
                    //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                    //    }

                    //}
                    ////dtsumfpiip
                    //if (dtsumfpiip.Rows.Count > 0)
                    //{
                    //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                    //    object val = sumfpiip["all_amount"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        fpiip = 0 + pfpiip;
                    //    }
                    //    else
                    //    {
                    //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                    //    }
                    //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                    //}

                    //getting the date difference from finstart year and current year for allowance
                    int datediffetire = 0;
                    int minval = 0;
                    if (dt_datediff.Rows.Count > 0)
                    {
                        datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                        datediffetire = Convert.ToInt32(dt_datediff.Rows[0]["DateDiffRetire"]);
                        minval = Math.Min(datediff, datediffetire);
                    }


                    List<OldAllowance> oldList = new List<OldAllowance>();
                    //foreach (DataRow dtold in dtSumAllowance.Rows)
                    //{
                    //    OldAllowance objoldlist = new OldAllowance();
                    //    objoldlist.old_Name = dtold["all_name"].ToString();
                    //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                    //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                    //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                    //    oldList.Add(objoldlist);
                    //}
                    foreach (DataRow dtold in dtSumAllowancenew.Rows)
                    {
                        OldAllowance objoldlist = new OldAllowance();
                        objoldlist.old_Name = dtold["all_name"].ToString();
                        //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                        objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                        //objoldlist.old_alw_type = dtold["all_type"].ToString();
                        oldList.Add(objoldlist);
                    }


                    List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                    //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                    //{

                    //    ActiveAllowance NewObjlist = new ActiveAllowance();
                    //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                    //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                    //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                    //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                    //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                    //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                    //    if (olditem != null)
                    //    {
                    //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                    //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                    //    }

                    //    NewActiveList.Add(NewObjlist);
                    //}
                    foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                    {

                        ActiveAllowance NewObjlist = new ActiveAllowance();
                        NewObjlist.Active_Name = dtActive["all_name"].ToString();
                        //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                        NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1new;
                        //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                        //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                        var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                        if (olditem != null)
                        {
                            NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                        }

                        NewActiveList.Add(NewObjlist);
                    }


                    //if not in new list then add
                    //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                    //{
                    //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                    //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                    //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                    //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                    //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                    //    if (olditem == null)
                    //    {
                    //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                    //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                    //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                    //        NewActiveList.Add(NewObjlist1);
                    //    }
                    //}
                    foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                    {
                        ActiveAllowance NewObjlist1 = new ActiveAllowance();
                        NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                        //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                        //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                        var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                        if (olditem == null)
                        {
                            NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            NewActiveList.Add(NewObjlist1);
                        }
                    }
                    var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                    if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                    {
                        await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                    }
                    int NewNumIndex = 0;

                    StringBuilder sbqry = new StringBuilder();
                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());
                    decimal total_allowance = 0;
                    //foreach (var newlist in NewActiveList)
                    //{
                    //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                    //    NewNumIndex++;
                    //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                    //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                    //    sbqry.Append(newqry);
                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    //}
                    foreach (var newlist in NewActiveList)
                    {
                        total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                        NewNumIndex++;
                        sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                        var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                            " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                            "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                            " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                        sbqry.Append(newqry);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                    }



                    //List<string> lststring = new List<string>();
                    //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                    // dtPfPerks
                    //if (dtPfperks.Rows.Count > 0)
                    //{
                    //    DataRow pfPerk = dtPfperks.Rows[0];

                    //    object val = pfPerk["pf_perk"];
                    //    if (val == DBNull.Value)
                    //    {
                    //        pf_perk = 0;
                    //    }
                    //    else
                    //    {
                    //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                    //    }

                    //}
                    //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                    
                    //dtLoanPerks
                    if (dtLoanPerks.Rows.Count > 0)
                    {
                        DataRow lperk = dtLoanPerks.Rows[0];

                        object val = lperk["loan_perk"];
                        if (val == DBNull.Value)
                        {
                            loan_perk = 0;
                        }
                        else
                        {
                            loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                        }

                    }
                    //dtIncentives
                    if (dtIncentives.Rows.Count > 0)
                    {
                        DataRow ins = dtIncentives.Rows[0];

                        object val = ins["incentive"];
                        if (val == DBNull.Value)
                        {
                            incentives = 0;
                        }
                        else
                        {
                            incentives = Convert.ToDecimal(ins["incentive"]);
                        }

                    }
                    //dt172
                    if (dt172.Rows.Count > 0)
                    {
                        DataRow VAL = dt172.Rows[0];
                        object val = VAL["val172"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_2 = 0;
                        }
                        else
                        {
                            values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                            totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                        }
                    }
                    //dt173
                    if (dt173.Rows.Count > 0)
                    {
                        DataRow VAL1 = dt173.Rows[0];
                        object val = VAL1["val173"];
                        if (val == DBNull.Value)
                        {
                            values_of_17_3 = 0;
                        }
                        else
                        {
                            values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                        }
                    }

                    if (dtRent.Rows.Count > 0)
                    {
                        //DataRow rents = dtRent.Rows[0];

                        //object val = rents["rentamount"];
                        //if (val == DBNull.Value)
                        //{
                        //    house_rent_allowance = 0;
                        //}
                        //else
                        //{
                        //    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                        //}
                    }

                    if (house_rent_allowance > 0)
                    {
                        decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                        //salary(a)
                        decimal salary = da_percent + Convert.ToDecimal(basic);
                        //40%  of salary(b)
                        decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                        //houserentpaid - 10% of salary(c)
                        decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                        //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                        house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                        // HouseRentAllowance calculated as on 04-09-2020
                        // minimun values of (
                        // Basic+DA --40%,
                        // House Rent Paid minus Basic+DA --10% 
                        // HRA)
                    }
                    //decimal daval = Convert.ToDecimal(da);
                    //decimal hraval = Convert.ToDecimal(hra);
                    //rent amount
                    if (house_rent_allowance < 0)
                    {
                        house_rent_allowance = 0;
                    }



                    if (dtOther.Rows.Count > 0)
                    {
                        DataRow otr = dtOther.Rows[0];

                        //other = Convert.ToDecimal(otr["other"]);

                        object val = otr["other"];
                        if (val == DBNull.Value)
                        {
                            other = 0;
                        }
                        else
                        {
                            other = Convert.ToDecimal(otr["other"]);
                        }

                    }

                    if (dtHouse.Rows.Count > 0)
                    {
                        //foreach (DataRow dr in dtHouse.Rows)
                        //{
                        //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                        //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                        //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                        //        || dr["loan_type_mid"].ToString() == "13")
                        //    {
                        //        count++;
                        //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                        //    }

                        //}
                        //DataRow dh = dtHouse.Rows[0];

                        ////other = Convert.ToDecimal(otr["other"]);

                        //object val = dh["amount"];
                        //if (val == DBNull.Value)
                        //{
                        //    houseloan_allownace = 0;
                        //}
                        //else
                        //{
                        //    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                        //}

                    }
                    //if (count > 0)
                    //{

                    //    houseloan_allownace = 200000;
                    //}

                    //IList<section80C> lstCer = new List<section80C>();
                    //IList<section80CCC> lstCCC = new List<section80CCC>();
                    //IList<section80CCD> lstCCD = new List<section80CCD>();
                    //IList<sectionOther> lstOther = new List<sectionOther>();

                    decimal pf_new = 0;
                    if (dtCD.Rows.Count > 0)
                    {
                        foreach (DataRow cer in dtCD.Rows)
                        {
                            //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                            decimal? amount = 0;

                            object val = cer["amount"];
                            if (val == DBNull.Value)
                            {
                                amount = 0;
                            }
                            else
                            {
                                amount = Convert.ToDecimal(cer["amount"]);
                            }

                            string dd_name = Convert.ToString(cer["name"].ToString());
                            if (dd_name == "Provident Fund")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    // amount = Convert.ToDecimal(pf + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = pf;
                                    //}

                                }
                                amount = Convert.ToDecimal(pf + (amount * months_1));
                                pf_new = Convert.ToDecimal(amount);
                            }
                            else if (dd_name == "VPF")
                            {
                                if (monthcount != 1)
                                {
                                    //if (months_1 != 2)
                                    //{
                                    //   amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                    //}
                                    //else if (months_1 == 2)
                                    //{
                                    //    amount = vpf_data;
                                    //}

                                }
                                amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                            }
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                //lstCer.Add(new section80C
                                //{
                                //    id = cer["id"].ToString(),
                                //    name = cer["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //});
                            }
                            else
                            {
                                //lstCer.Add(new section80C
                                //{
                                //    id = cer["id"].ToString(),
                                //    name = cer["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                        }


                    }
                    else
                    {
                        //lstCer.Add(new section80C
                        //{
                        //    id = "",
                        //    name = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }
                    decimal pf_perkcal = 0.5m;
                    decimal pf_perktemp = 12.5m;
                    pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                    if (dtCCC.Rows.Count > 0)
                    {
                        foreach (DataRow ccc in dtCCC.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance > 0 && max_allowance <= 150000)
                            {
                                if (amount > min_allowance)
                                {
                                    allowance_amount = min_allowance;
                                    min_allowance = min_allowance - allowance_amount;
                                    max_allowance = max_allowance + allowance_amount;
                                }
                                else
                                {
                                    min_allowance = min_allowance - amount;
                                    allowance_amount = amount;
                                    max_allowance = max_allowance + amount;
                                }
                                //lstCCC.Add(new section80CCC
                                //{
                                //    id = ccc["id"].ToString(),
                                //    name = ccc["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //});
                            }
                            else
                            {
                                //lstCCC.Add(new section80CCC
                                //{
                                //    id = ccc["id"].ToString(),
                                //    name = ccc["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                        }

                    }
                    else
                    {
                        ///sowjanya
                        //lstCCC.Add(new section80CCC
                        //{
                        //    id = "",
                        //    name = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }

                    if (dtCCD.Rows.Count > 0)
                    {
                        foreach (DataRow ccd in dtCCD.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                            decimal? allowance_amount = 0;
                            if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                            {
                                if (amount > min_allowance80CCD)
                                {
                                    allowance_amount = min_allowance80CCD;
                                    min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                    max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                }
                                else
                                {
                                    min_allowance80CCD = min_allowance80CCD - amount;
                                    allowance_amount = amount;
                                    max_allowance80CCD = max_allowance80CCD + amount;
                                }
                                //sowjanya
                                //lstCCD.Add(new section80CCD
                                //{
                                //    id = ccd["id"].ToString(),
                                //    name = ccd["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                //});
                            }
                            else
                            {
                                //sowjanya
                                //lstCCD.Add(new section80CCD
                                //{
                                //    id = ccd["id"].ToString(),
                                //    name = ccd["name"].ToString(),
                                //    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }
                        }
                    }
                    else
                    {
                        //sowjanya
                        //lstCCD.Add(new section80CCD
                        //{
                        //    id = "",
                        //    name = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }

                    if (dtEdu.Rows.Count > 0)
                    {
                        foreach (DataRow ed in dtEdu.Rows)
                        {
                            decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                            String sectionNAme = ed["section"].ToString();
                            decimal? allowance_amount = 0;
                            string id = ed["id"].ToString();
                            decimal? ded_amount = 0;
                            string actName = ed["name"].ToString();
                            if (sectionNAme == "Section80G")
                            {
                                allowance_amount = amount * section80g;
                                max_allowanceGG = max_allowanceGG + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80GGB")
                            {
                                allowance_amount = amount * section80gg;
                                max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                ded_amount = allowance_amount;

                            }
                            else if (sectionNAme == "Section80DDB")
                            {
                                if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                {
                                    if (amount > min_allowance80DDB)
                                    {
                                        allowance_amount = min_allowance80DDB;
                                        ded_amount = allowance_amount;
                                        min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                        max_allowance80DB = max_allowance80DB + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DDB = min_allowance80DDB - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DB = max_allowance80DB + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                            }
                            else if (sectionNAme == "Section80DD")
                            {
                                if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                {
                                    if (amount > min_allowance80DD)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80DD = min_allowance80DD - allowance_amount;
                                        max_allowance80DD = max_allowance80DD + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80DD = min_allowance80DD - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80DD = max_allowance80DD + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80U")
                            {
                                if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                {
                                    if (amount > min_allowance80U)
                                    {
                                        allowance_amount = min_allowance80DD;
                                        ded_amount = allowance_amount;
                                        min_allowance80U = min_allowance80U - allowance_amount;
                                        max_allowance80U = max_allowance80U + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80U = min_allowance80U - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80U = max_allowance80U + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80E")
                            {
                                allowance_amount = amount;
                                max_allowance = max_allowance + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            else if (sectionNAme == "Section80D_P")
                            {
                                if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                {
                                    if (amount > min_allowance80D_P)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                        max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_P = min_allowance80D_P - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_P = max_allowance80D_P + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }
                                //if (min_allowance80D_P > amount)
                                //{
                                //    allowance_amount = amount;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}

                                //else
                                //{
                                //    allowance_amount = min_allowance80D_P;
                                //    max_allowance = max_allowance + allowance_amount;
                                //    ded_amount = allowance_amount;
                                //}
                            }
                            else if (sectionNAme == "Section80D_F")
                            {
                                if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                {
                                    if (amount > min_allowance80D_F)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                        max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80D_F = min_allowance80D_F - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance80D_F = max_allowance80D_F + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                            {
                                if (sectionNAme != "Section80EE")
                                {
                                    sectionNAme = "Section80EE_HL";
                                }
                                if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                {
                                    if (amount > min_allowance80EE)
                                    {
                                        allowance_amount = min_allowance80EE;
                                        min_allowance80EE = min_allowance80EE - allowance_amount;
                                        max_allowance80ee = max_allowance80ee + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance80EE = min_allowance80EE - amount;
                                        allowance_amount = amount;
                                        max_allowance80ee = max_allowance80ee + amount;
                                    }
                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;

                                }
                            }

                            else if (sectionNAme == "Section24(b)")
                            {

                                if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                {
                                    if (amount > min_allowance24b)
                                    {
                                        allowance_amount = min_allowance80D_P;
                                        ded_amount = allowance_amount;
                                        min_allowance24b = min_allowance24b - allowance_amount;
                                        max_allowance24B = max_allowance24B + allowance_amount;
                                    }
                                    else
                                    {
                                        min_allowance24b = min_allowance24b - amount;
                                        ded_amount = allowance_amount;
                                        allowance_amount = amount;
                                        max_allowance24B = max_allowance24B + amount;
                                    }

                                }
                                else
                                {
                                    allowance_amount = 0;
                                    ded_amount = 0;
                                }

                            }
                            else
                            {
                                allowance_amount = amount;
                                max_allowance_other = max_allowance_other + allowance_amount;
                                ded_amount = allowance_amount;
                            }
                            //lstOther.Add(new sectionOther
                            //{
                            //    id = id,
                            //    name = actName,
                            //    section = sectionNAme,
                            //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                            //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                            //});

                        }

                    }

                    else
                    {
                        //lstOther.Add(new sectionOther
                        //{
                        //    id = "",
                        //    name = "",
                        //    section = "",
                        //    amount = AddZerosAfterDecimal("0"),
                        //    allowance_amount = AddZerosAfterDecimal("0"),
                        //    ded_amount = AddZerosAfterDecimal("0")
                        //});
                    }
                    max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                    if (dtTax.Rows.Count > 0)
                    {


                        DataRow tax = dtTax.Rows[0];

                        object val = tax["tax_deducted_at_source"];
                        if (val == DBNull.Value)
                        {
                            total_tax_till = 0;
                        }
                        else
                        {
                            total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                        }

                        tax_till = totaltaxdeductedfrm16 + total_tax_till;
                        tax_till = 0; // for all employees this tax is 0

                    }

                    if (dtTDS.Rows.Count > 0)
                    {
                        DataRow TDS = dtTDS.Rows[0];

                        object val = TDS["tds_amount"];
                        if (val == DBNull.Value)
                        {
                            paid_by_emp = 0;
                        }
                        else
                        {
                            paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                        }
                    }

                    IList<TDSProcess> lstTDS = new List<TDSProcess>();

                    gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                    total_section = house_rent_allowance;

                    balance = gross - total_section;
                    //standard_deduction = PrConstants.STANDARD_DEDUCTION;
                    //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                    //if (emp_tax > 2400)
                    //{
                    //    emp_tax = 2400;
                    //}
                    //aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                    Income_chargable = balance; //- aggregate_of_4; //6

                    total_gross_income = Income_chargable + other;// - houseloan_allownace;

                    //deductible = Convert.ToDecimal(max_allowance);
                    total_income = total_gross_income;// - deductible;
                    //total_income = Convert.ToDecimal(841240.01);
                    round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                    //tax_deducted_at_source is calculating as incometax value of current financial year.
                    decimal tax_deducted_at_source1 = 0;
                    if (dt_incometax.Rows.Count > 0)
                    {
                        DataRow incometax = dt_incometax.Rows[0];

                        object val = incometax["income_tax"];
                        if (val == DBNull.Value)
                        {
                            tax_deducted_at_source1 = 0;
                        }
                        else
                        {
                            tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                        }
                    }

                    if (total_income > 500000)
                    {
                        //strConvert = income.ToString();
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = 0;
                        edu_cess = income * 4 / 100;

                        tax_payable = (float)income + edu_cess;

                        tax_payable = (int)Math.Round(tax_payable);

                        //if (tax_till > tax_payable)
                        //{
                        //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                        //}
                        //else
                        //{
                        //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                        //}
                        tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                        if (tax_balance < 0)
                        {
                            tax_balance = 0;
                        }

                        tds_per_month = tax_balance / months_1;
                        if (Financial_md.Month != 03)
                        {
                            int x = (int)Math.Round(tds_per_month);
                            int y = (int)Math.Round(x / 100d, 0) * 100;
                            rounding_tds_per_month = y;
                        }
                        else
                        {
                            int xp = (int)Math.Round(tds_per_month);
                            int Z = (10 - xp % 10) + xp;
                            rounding_tds_per_month = Z;
                        }

                        //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                    }
                    else
                    {
                        income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                        //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                        section_87a = Convert.ToDecimal(income);
                        edu_cess = 0;

                        tax_payable = 0;

                        tax_till = 0;
                        tax_balance = 0;

                        tds_per_month = 0;

                        rounding_tds_per_month = 0;
                    }
                    //string employer_name_address = PrConstants.Name;
                    //string employer_pan = PrConstants.PAN;
                    //string employer_tan = PrConstants.TAN;

                    lstTDS.Add(new TDSProcess
                    {
                        option = optn.Rows[0]["Option"].ToString(),
                        name = name,
                        per_address = per_address,
                        pan_no = pan_no,
                        emp_code = emp_code,
                        designation = designation,
                        sex = sex,
                        fm = fm,
                        employer_name_address = employer_name_address,
                        employer_pan = employer_pan,
                        employer_tan = employer_tan,
                        basic = AddZerosAfterDecimal(Convert.ToString(basic)),
                        da_percent = AddZerosAfterDecimal(Convert.ToString(da_percent)),
                        per_allowance = AddZerosAfterDecimal(Convert.ToString(per_allowance)),
                        int_ref = AddZerosAfterDecimal(Convert.ToString(int_ref)),
                        t_inc = AddZerosAfterDecimal(Convert.ToString(t_inc)),
                        fpa_allow = AddZerosAfterDecimal(Convert.ToString(fpa_allow)),
                        fpiip = AddZerosAfterDecimal(Convert.ToString(fpiip)),
                        pf_perk = AddZerosAfterDecimal(Convert.ToString(pf_perk)),
                        loan_perk = AddZerosAfterDecimal(Convert.ToString(loan_perk)),
                        incentives = AddZerosAfterDecimal(Convert.ToString(incentives)),
                        spl_allowance = AddZerosAfterDecimal(Convert.ToString(spl_allowance)),
                        spl_da = AddZerosAfterDecimal(Convert.ToString(spl_da)),
                        hra = AddZerosAfterDecimal(Convert.ToString(hra)),
                        cca = AddZerosAfterDecimal(Convert.ToString(cca)),
                        values_of_17_2 = AddZerosAfterDecimal(Convert.ToString(values_of_17_2)),
                        values_of_17_3 = AddZerosAfterDecimal(Convert.ToString(values_of_17_3)),
                        gross = AddZerosAfterDecimal(Convert.ToString(gross)), // 2 pending
                        //standard_deduction = AddZerosAfterDecimal(Convert.ToString(standard_deduction)),
                        ent_allowance = AddZerosAfterDecimal(Convert.ToString(ent_allowance)),
                        //emp_tax = AddZerosAfterDecimal(Convert.ToString(emp_tax)),
                        //aggregate_of_4 = AddZerosAfterDecimal(Convert.ToString(aggregate_of_4)),
                        Income_chargable = AddZerosAfterDecimal(Convert.ToString(Income_chargable)),
                        other = AddZerosAfterDecimal(Convert.ToString(other)),
                        //houseloan_allownace = AddZerosAfterDecimal(Convert.ToString(houseloan_allownace)),
                        total_gross_income = AddZerosAfterDecimal(Convert.ToString(total_gross_income)),
                        loan_instl_amt = AddZerosAfterDecimal(Convert.ToString(loan_instl_amt)),
                        //deductible = AddZerosAfterDecimal(Convert.ToString(deductible)),
                        total_income = AddZerosAfterDecimal(Convert.ToString(total_income)),
                        income = AddZerosAfterDecimal(Convert.ToString(income)),
                        edu_cess = AddZerosAfterDecimal(Convert.ToString(edu_cess)),
                        tax_payable = AddZerosAfterDecimal(Convert.ToString(tax_payable)),
                        tax_till = AddZerosAfterDecimal(Convert.ToString(tax_till)),
                        tax_balance = AddZerosAfterDecimal(Convert.ToString(tax_balance)),
                        balance_month = Convert.ToString(months_1),
                        tds_per_month = AddZerosAfterDecimal(Convert.ToString(rounding_tds_per_month)),
                        house_rent_allowance = AddZerosAfterDecimal(Convert.ToString(house_rent_allowance)),
                        total_section = AddZerosAfterDecimal(Convert.ToString(total_section)),
                        //balance = AddZerosAfterDecimal(Convert.ToString(balance)),
                        round_income = AddZerosAfterDecimal(Convert.ToString(round_income)),
                        section_87a = AddZerosAfterDecimal(Convert.ToString(section_87a)),
                        //paid_by_emp = AddZerosAfterDecimal(Convert.ToString(paid_by_emp)),
                        paid_by_emp = AddZerosAfterDecimal(Convert.ToString(tax_deducted_at_source1)),

                    }); ;
                    var tds = JsonConvert.SerializeObject(lstTDS);
                    ////sowjanya
                    //var ccT = JsonConvert.SerializeObject(lstCer);
                    //var cccT = JsonConvert.SerializeObject(lstCCC);
                    //var ccdT = JsonConvert.SerializeObject(lstCCD);
                    //var otherT = JsonConvert.SerializeObject(lstOther);
                    var allowanceT = JsonConvert.SerializeObject(NewActiveList);

                    var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer();
                    var tdsData = javaScriptSerializer.DeserializeObject(tds);
                    ////sowjanya
                    //var ccData = javaScriptSerializer.DeserializeObject(ccT);
                    //var cccData = javaScriptSerializer.DeserializeObject(cccT);
                    //var ccdData = javaScriptSerializer.DeserializeObject(ccdT);
                    //var otherData = javaScriptSerializer.DeserializeObject(otherT);
                    var allowanceTdata = javaScriptSerializer.DeserializeObject(allowanceT);

                    var resultJson = javaScriptSerializer.Serialize(new
                    {
                        tds = tdsData,
                        //cc = ccData,
                        //ccc = cccData,
                        //ccd = ccdData,
                        //other = otherData,
                        allowance = allowanceTdata

                    });
                    //int NewNumIndex = 0;

                    //StringBuilder sbqry = new StringBuilder();
                    ////1. trans_id
                    //sbqry.Append(GenNewTransactionString());

                    int finalSub = 0;

                    if (final == true)
                    {
                        finalSub = 1;
                    }
                    else
                    {
                        finalSub = 0;
                    }

                    string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable details = await _sha.Get_Table_FromQry(selQry);
                    if (details.Rows.Count > 0)
                    {
                        NewNumIndex++;
                        DataRow finaldt = details.Rows[0];
                        string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                        sbqry.Append(tdsdelete);
                        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                        int finalCount = Convert.ToInt32(finaldt["final"]);

                        if (finalCount == 1)
                        {
                            return "E#TDS Process#Employee Already Processed..!!";
                        }
                        else
                        {
                            NewNumIndex++;
                            string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            sbqry.Append(tdsUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                            NewNumIndex++;
                            string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            sbqry.Append(certUpdate);
                            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));


                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + months_1 + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }
                            ////sowjanya
                            //if (lstCer != null)
                            //{
                            //    foreach (var ccDatas in lstCer)
                            //    {
                            //        if (ccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCC != null)
                            //{
                            //    foreach (var cccDatas in lstCCC)
                            //    {
                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCD != null)
                            //{
                            //    foreach (var ccdDatas in lstCCD)
                            //    {
                            //        if (ccdDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstOther != null)
                            //{
                            //    foreach (var otherDatas in lstOther)
                            //    {
                            //        if (otherDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }



                    }
                    else
                    {

                        try
                        {

                            if (tdsData != null)
                            {
                                NewNumIndex++;
                                string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate1);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                    "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                    "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                    "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                    "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                    "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                    "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                    "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                    "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                    "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                        " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                        "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                        "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                        "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                        "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                        "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                        "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                        "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                        "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                        "" + tax_till + "," + tax_balance + "," + months_1 + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                sbqry.Append(qry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                            }

                            //if (lstCer != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate2);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var ccDatas in lstCer)
                            //    {

                            //        if (ccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCC != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate3);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var cccDatas in lstCCC)
                            //    {

                            //        if (cccDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstCCD != null)
                            //{
                            //    foreach (var ccdDatas in lstCCD)
                            //    {
                            //        NewNumIndex++;
                            //        string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //        sbqry.Append(tdsUpdate3);
                            //        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //        if (ccdDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            //if (lstOther != null)
                            //{
                            //    NewNumIndex++;
                            //    string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                            //    sbqry.Append(tdsUpdate4);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                            //    foreach (var otherDatas in lstOther)
                            //    {
                            //        if (otherDatas.id != "")
                            //        {
                            //            NewNumIndex++;
                            //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                            //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                            //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                            //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                            //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                            //            sbqry.Append(bioQry);

                            //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                            //        }

                            //    }
                            //}
                            if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                            {
                                //return "I#TDS Process#TDS Processed Successfully..!!";
                            }
                            else
                            {
                                //return "E#TDS Process#Error While TDS Process..!!";
                            }
                        }
                        catch (Exception e)
                        {
                            return "E#TDS Process#" + e.Message;
                        }
                    }
                    return resultJson;
                    //}
                }

            }

            return "E#TDS Process#Letters Are Not Allowed,Please Enter Valid Employee Code ";

        }
        public async Task<string> tdsProcessForAllNew(TDSForAll values)
        {
            string SMessage = "", SSMessage = "";
            DateTime Financial_md = (_LoginCredential.FinancialMonthDate);
            int iFY = _LoginCredential.FY;
            int dtFM = _LoginCredential.FM;
            bool final = values.final;
            bool flag = values.flag;
            int FY = _LoginCredential.FY;
            int rounding_tds_per_month = 0;
            //string fmonth = _LoginCredential.f
            string FM = _LoginCredential.FinancialMonthDate.ToString("yyyy-MM-dd");
            string fin_month = _LoginCredential.FinancialMonthDate.ToString("dd-MM-yyyy");
            //string Env_Fm_Fy = commBus.Fyp_Fy();
            DateTime str = Convert.ToDateTime(FM);
            string checkMonth = str.ToString("MM");
            string checkYear = str.ToString("yyyy");
            int fin_year = FY - 1;
            string startYear = fin_year + "-04-01";
            string endYear = FY + "-03-31";
            try
            {

                int finalSub = 0;


                if (final == true)
                {
                    finalSub = 1;
                }
                else
                {
                    finalSub = 0;
                }
                string empCode = "";
                int NewNumIndex = 0;

                StringBuilder sbqry = new StringBuilder();
                //1. trans_id

                ////1. trans_id
                //sbqry.Append(GenNewTransactionString());

                //string genQry = "select distinct(emp_code) from pr_emp_payslip where active=1;";
                string genQry = "select distinct emp_code from(select distinct e.empid as emp_code from employees e join " +
                    "pr_emp_payslip p on e.empid=p.emp_code where (e.RetirementDate " +
                    "between '" + startYear + "' and '" + endYear + "') and p.er_basic is not null union all select distinct(emp_code) as emp_code from " +
                    "pr_emp_payslip where active = 1 union all select emp_code from pr_emp_payslip where (er_basic>0 or er_basic=0) and fm between " +
                    "'" + startYear + "' and '" + FM + "') as a  order by emp_code; ";
                //  string genQry = "select distinct emp_code from(select empid as emp_code from employees where RetirementDate " +
                //"between '" + startYear + "' and '" + endYear + "' and  EmpId=562 union all select distinct(emp_code) as emp_code from " +
                //"pr_emp_payslip where active = 1 and emp_code=562) as a; ";
                DataTable dt = await _sha.Get_Table_FromQry(genQry);
                List<int> empcodes = new List<int>();
                foreach (DataRow code in dt.Rows)
                {
                    empCode = Convert.ToString(code["emp_code"]);

                    //1. trans_id
                    sbqry.Append(GenNewTransactionString());

                    string checkQry = "select id from pr_emp_tds_process where active=1 and final =1 " +
                        "and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                    DataTable checkTable = await _sha.Get_Table_FromQry(checkQry);
                    if (checkTable.Rows.Count > 0)
                    {
                        //return "E#TDS Process#Employee TDS Updated For This Month For " + empCode;
                    }
                    else
                    {

                        string name = "";
                        string per_address = "";
                        string pan_no = "";
                        string emp_code = "";
                        string designation = "";
                        string sex = "";
                        string fm = "";
                        string employer_name_address = PrConstants.Name;
                        string employer_pan = PrConstants.PAN;
                        string employer_tan = PrConstants.TAN;


                        float totaltaxdeductedfrm16 = 0;
                        float standard_deduction = 0;

                        decimal stndedpercent = 0.04m; // added new on 25/06/2020

                        float ent_allowance = 0;
                        float emp_tax = 0;
                        decimal? other = 0;
                        int? count = 0;
                        decimal? houseloan_allownace = 0;
                        decimal? loan_instl_amt = 0;
                        decimal? aggregate_of_4 = 0;
                        decimal? Income_chargable = 0;
                        decimal? total_gross_income = 0;
                        decimal? deductible = 0;
                        decimal? total_income = 0;
                        float income = 0;
                        float tds_per_month = 0;
                        float edu_cess = 0;
                        float tax_payable = 0;
                        float tax_till = 0;
                        float total_tax_till = 0;
                        float tax_balance = 0;

                        //decimal? house_rent_allowance = 0;
                        //decimal? total_section = 0;

                        //decimal? min_allowance = PrConstants.SECTION_C;
                        //decimal? min_allowance80DD = PrConstants.SECTION_80DD;
                        //decimal? min_allowance80CCD = PrConstants.SECTION_80CCD;
                        //decimal? min_allowance80U = PrConstants.SECTION_80U;
                        //decimal? min_allowance80DDB = PrConstants.SECTION_80DDB;
                        //decimal? min_allowance80D_P = PrConstants.SECTION_80D_P;
                        //decimal? min_allowance80D_F = PrConstants.SECTION_80D_F;
                        //decimal? min_allowance80EE = PrConstants.SECTION_80EE;
                        //decimal? min_allowance24b = PrConstants.SECTION_24b;
                        decimal? max_allowance = 0;
                        decimal? max_allowanceGG = 0;
                        decimal? max_allowanceGGB = 0;
                        decimal? max_allowance80CCD = 0;
                        decimal? max_allowance80ee = 0;
                        decimal? max_allowance80DB = 0;
                        decimal? max_allowance80DD = 0;
                        decimal? max_allowance80U = 0;
                        decimal? max_allowance80D_P = 0;
                        decimal? max_allowance80D_F = 0;
                        decimal? max_allowance24B = 0;
                        decimal? max_allowance_other = 0;
                        decimal? min_allowance_other = PrConstants.OTHER_SECTION;
                        decimal? round_income = 0;
                        decimal? section_87a = 0;
                        //decimal? da = 0;

                        decimal? paid_by_emp = 0;

                        int months = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(endYear).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(endYear).Month) + 1;
                        int monthsnew = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(endYear).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(endYear).Month);
                        //general
                        string general = "select CONCAT(emp.FirstName,' ',emp.LastName) as name, " +
                                    "per_address, gen.pan_no,gen.emp_code, d.Description as designation,gen.sex " +
                                    "from pr_emp_general gen left outer join Employees emp on gen.emp_code = emp.EmpId " +
                                    " JOIN Designations d ON d.Id=emp.CurrentDesignation " +
                                    "where gen.emp_code = " + Convert.ToInt32(empCode) + ";";

                        decimal? basic = 0;
                        decimal da_percent = 0;

                        decimal? per_allowance = 0;
                        decimal? fpa_allow = 0;
                        decimal? fpiip = 0;

                        decimal? int_ref = 0;
                        decimal? t_inc = 0;

                        decimal? pf_perk = 0;
                        decimal? loan_perk = 0;
                        decimal? incentives = 0;
                        decimal? spl_allowance = 0;
                        decimal? spl_da = 0;
                        decimal hra = 0;
                        decimal cca = 0;
                        decimal? values_of_17_2 = 0;
                        decimal? values_of_17_3 = 0;

                        //present month
                        decimal? pbasic = 0;
                        decimal? pda_percent = 0;
                        decimal? pcca = 0;
                        decimal? phra = 0;
                        decimal? pint_ref = 0;
                        decimal? pt_inc = 0;
                        decimal? pspl_da = 0;
                        decimal? pspl_allowance = 0;
                        decimal? pper_allowance = 0;
                        decimal? pfpa_allow = 0;
                        decimal? pfpiip = 0;
                        decimal? gross = 0;

                        decimal? house_rent_allowance = 0;
                        decimal? total_section = 0;
                        decimal? balance = 0;
                        decimal? gsli = 0;
                        int datediff = 1;
                        int tot_months = 0;

                        string qryConstants = "SELECT constant, [value] FROM all_constants WHERE app_type='payroll' AND active=1 and fy=" + iFY + ";";

                        string qryIncometaxConstants = "SELECT constant, [value] FROM all_constants WHERE app_type='payroll' AND functionality='IncomeTax' AND active=1 and fy=" + iFY + ";";
                        string qryFy_FM = "SELECT fy,format(fm,'yyyy-MM-dd') as fm FROM pr_month_details WHERE active=1;";
                        string option = "select [Option]  from pr_tax_option_emp_wise where EmpId=" + empCode + "";
                        string empretiredate = "SELECT EmpId, RetirementDate from Employees where RetirementDate >= '" + startYear + "' and RetirementDate<= '" + endYear + "' and EmpId=" + empCode + " ";
                        //to check payslip generated for financial month
                        string emppayslipforfinmon = "select Id from pr_emp_payslip where spl_type in ('Regular', 'StopSalary','Suspended') and emp_code=" + empCode + " and fm='" + FM + "'";
                        string strlop_days = "select lop from pr_emp_payslip where fm='" + FM + "'  and lop>0 and emp_code=" + Convert.ToInt32(empCode) + ";";
                        string str_zerobasicforcurrfunyear = "select case when sum(er_basic) is null then 0 else sum(er_basic) end as Basic from pr_emp_payslip where fm>='" + startYear + "' and fm<='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + ";";

                        int months_1 = 0;
                        int months_1new = 0;
                        int monthcount = 0;
                        string strretdate = "";
                        DataSet ds1 = await _sha.Get_MultiTables_FromQry(qryConstants + qryFy_FM + qryIncometaxConstants + option +
                            empretiredate + emppayslipforfinmon + strlop_days + str_zerobasicforcurrfunyear);

                        DataTable optn = ds1.Tables[3];
                        DataTable dtretiredate = ds1.Tables[4];
                        DataTable dtemppayslipforfinmonth = ds1.Tables[5];
                        DataTable dt_lopdays = ds1.Tables[6];
                        DataTable dt_zerobasic = ds1.Tables[7];
                        DateTime dretdattime = Convert.ToDateTime(startYear);
                        DateTime d_retdate1 = Convert.ToDateTime(startYear);

                        if (dtretiredate.Rows.Count > 0)
                        {
                            DateTime dretdate = Convert.ToDateTime(dtretiredate.Rows[0]["RetirementDate"]);
                            strretdate = dretdate.ToString("yyyy-MM-dd");
                            months_1 = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(strretdate).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(strretdate).Month) + 1;
                            months_1new = Math.Abs(((Convert.ToDateTime(FM).Year - Convert.ToDateTime(strretdate).Year) * 12) + Convert.ToDateTime(FM).Month - Convert.ToDateTime(strretdate).Month);
                            monthcount = Math.Abs(((Convert.ToDateTime(d_retdate1).Year - Convert.ToDateTime(strretdate).Year) * 12) + Convert.ToDateTime(d_retdate1).Month - Convert.ToDateTime(strretdate).Month) + 1;
                            if (monthcount == 1)
                            {
                                months_1 = 1;
                            }
                        }
                        if (months_1new < 0)
                        {
                            months_1new = 0;
                        }
                        int zerobasic = 0;
                        if (dt_zerobasic.Rows.Count > 0)
                        {
                            zerobasic = Convert.ToInt32(dt_zerobasic.Rows[0]["Basic"]);
                        }
                        _dtConstants = ds1.Tables[0];
                        if (empCode=="686")
                        {
                            decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                                   .Where(x => x["constant"].ToString() == "Section80C")
                                   .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                            decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80CCD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                            decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80U")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DDB")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                            decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_P")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                            decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_F")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                            decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80EE")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section24(b)")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80G")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                            decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80GGB")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                            DataTable _dtFY_FM = ds1.Tables[1];
                            _incometaxdbconstant = ds1.Tables[2];


                            //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                                "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                                "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " and " +
                                "id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm = '" + FM + "' and spl_type='Regular'); ";

                            //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                                "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                                "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";

                            //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                            string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                            //allowance ==>Get and Sum all previous months allowances 
                            string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                            //allowance ==> Get all current month allowances
                            string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                            //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                            ////sum Personal Allowance
                            //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                            //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                            ////sum FPIIP
                            //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                            //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                            //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                            //sum PFPerks                                                   
                            string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                            // sum LOANPerks                                                    
                            string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                            // sum Incentive                                                    
                            string incentive = "select distinct sum(amount) as incentive from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            // sum  val 17 -2
                            string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                                 "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                            // sum val 17 -3
                            string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                                "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                                " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                            //rent allowance
                            //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                            string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                            //other
                            string otherQry = "select distinct sum(amount) as other from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                        "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            //house loan
                            string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                            //section 80c
                            //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                            //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                            //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                            string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                               "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                               "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                               "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and active=1 union all " +
                               " select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                               "paydedu where paydedu.dd_name = 'VPF Deduction' and emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in (select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                               " union all " +
                                "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                                "union all " +
                               "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                                "union all " +
                                "select '7' as id, 'Housing Loan 2B-2C' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2B-2C' and emp_code = " + Convert.ToInt32(empCode) + "  and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                                "union all " +
                                "select '8' as id, 'Housing Loan 2A' as name, sum(paydedu.dd_amount) as amount  from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2A' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                                " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";


                            //section 80ccc
                            string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                            //section 80ccd
                            string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                                " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                            //section other section
                            string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                            //tax till
                            string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            //other tds deductions
                            //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                            string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                                "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                            string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                                "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";
                            string chkph = "select * from pr_emp_general where emp_code= " + Convert.ToInt32(empCode) + " and phy_handicapped!=1;";
                            //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                            //VPF
                            string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm <= '" + FM + "' and p.fm >= '" + startYear + "';";
                            string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                            " union all " +
                            " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' " +
                            "union all  " +
                            "select 'Housing Loan 2B-2C',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =  " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "'  and fm>= '" + startYear + "'  and emp_code =  " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2B-2C' " +
                            "union all  " +
                            "select 'Housing Loan 2A',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + "  and payslip_mid in(select id from pr_emp_payslip where fm <  '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2A' ";

                            string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff, (SELECT DATEDIFF(month,'" + startYear + "',Retirementdate) from Employees where EmpId=" + Convert.ToInt32(empCode) + ") as DateDiffRetire;";

                            string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                            string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                                     " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                                      " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                            string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                                " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                                " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                            string strpf = " select sum(dd_provident_fund) pf  from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";
                            string strprevlicgsli = "select 'LIC' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'LIC' and payslip_mid " +
                                                   " in(select id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "') " +
                                                   "union all" +
                                                   " select 'GSLI' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'GSLI' and payslip_mid " +
                                                   " in(select id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "');";
                            string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                            string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                            DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                                SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                                cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                                loansprevmonth + strdatediff + strincometax + SumAllowanceQrynew + ActiveSumAllowanceQrynew + chkph + strpf + strprevlicgsli+ tdssections+ tdssection24);

                            //tables
                            var dtGeneral = ds.Tables[0];
                            var dtBasic = ds.Tables[1];
                            var dtBasicSum = ds.Tables[2];
                            var dtAllowance = ds.Tables[3];
                            var dtSumAllowance = ds.Tables[4];

                            var dtPfperks = ds.Tables[5];
                            var dtLoanPerks = ds.Tables[6];
                            var dtIncentives = ds.Tables[7];
                            var dt172 = ds.Tables[8];
                            var dt173 = ds.Tables[9];
                            var dtRent = ds.Tables[10];
                            var dtOther = ds.Tables[11];
                            var dtHouse = ds.Tables[12];

                            var dtCD = ds.Tables[13];
                            var dtCCC = ds.Tables[14];
                            var dtCCD = ds.Tables[15];
                            var dtEdu = ds.Tables[16];
                            var dtTax = ds.Tables[17];
                            var dtTDS = ds.Tables[18];
                            var dtEmpTax = ds.Tables[19];
                            var dtVpf = ds.Tables[20];
                            var dtActiveSumAllowance = ds.Tables[21];
                            var dt_prevmonthloans = ds.Tables[22];
                            var dt_datediff = ds.Tables[23];
                            var dt_incometax = ds.Tables[24];
                            var dtSumAllowancenew = ds.Tables[25];
                            var dtActiveSumAllowancenew = ds.Tables[26];
                            var dtph = ds.Tables[27];
                            var dt_strpf = ds.Tables[28];
                            var dt_strprevlicgsli = ds.Tables[29];
                            var dt_tdssections = ds.Tables[30];
                            var dt_tdssection24 = ds.Tables[31];

                            int loss_months = 0;
                            decimal? vpf_data = 0;
                            decimal? pf = 0;
                            decimal? lic = 0;
                            decimal? houseloanmain = 0;
                            decimal? houseAddloan_2d = 0;
                            decimal? houseloan2bc = 0;
                            decimal? houseloan2a = 0;

                            if (dtEmpTax.Rows.Count > 0)
                            {
                                DataRow empTax = dtEmpTax.Rows[0];

                                object val = empTax["loss"];
                                if (val == DBNull.Value)
                                {
                                    loss_months = 0;
                                }
                                else
                                {
                                    loss_months = Convert.ToInt32(empTax["loss"]);
                                }

                            }
                            //vpf

                            if (dtVpf.Rows.Count > 0)
                            {
                                DataRow vpfData = dtVpf.Rows[0];

                                object val = vpfData["amount"];
                                if (val == DBNull.Value)
                                {
                                    vpf_data = 0;
                                }
                                else
                                {
                                    vpf_data = Convert.ToDecimal(vpfData["amount"]);
                                }

                            }

                            // General Data
                            if (dtGeneral.Rows.Count > 0)
                            {
                                DataRow gen = dtGeneral.Rows[0];
                                name = Convert.ToString(gen["name"]);
                                per_address = Convert.ToString(gen["per_address"]);
                                pan_no = Convert.ToString(gen["pan_no"]);
                                emp_code = Convert.ToString(gen["emp_code"]);
                                designation = Convert.ToString(gen["designation"]);
                                sex = Convert.ToString(gen["sex"]);
                                fm = fin_month;
                            }
                            if (dt_prevmonthloans.Rows.Count > 0)
                            {
                                foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                                {
                                    int loanid = 0;
                                    int pflag = 0;
                                    int pflag1 = 0;
                                    int countofsub = 0;
                                    int precoverflag = 0;
                                    string val = dr_prelons["loantype"].ToString();
                                    string getloanid = "select id  from pr_loan_master where loan_description='" + val + "'";
                                    DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                                    loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                                    string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                        "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                                    string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                        "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                                    DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                                    DataTable dtcompare = sh.Get_Table_FromQry(comparequery);

                                    if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                                    {
                                        countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                        precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                    }


                                    if (dtchkloaneligibility.Rows.Count > 0)
                                    {
                                        pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                                    }
                                    object amount = dr_prelons["amount"];
                                    if (countofsub != precoverflag)
                                    {
                                        if (val == "Housing Loan Main")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloanmain = 0;
                                            }
                                            else
                                            {
                                                houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Addl.Loan - 2D")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseAddloan_2d = 0;
                                            }
                                            else
                                            {
                                                houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Loan 2B-2C")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloan2bc = 0;
                                            }
                                            else
                                            {
                                                houseloan2bc = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Loan 2A")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloan2a = 0;
                                            }
                                            else
                                            {
                                                houseloan2a = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                    }
                                }
                            }

                            //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                            if (dtBasic.Rows.Count > 0)
                            {

                                DataRow rbasic = dtBasic.Rows[0];

                                //basic 
                                object val = rbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    pbasic = 0;
                                }
                                else
                                {
                                    pbasic = Convert.ToDecimal(rbasic["basic"]) * months_1new;
                                }

                                //da_percent 
                                object val1 = rbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    pda_percent = 0;
                                }
                                else
                                {
                                    pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months_1new;
                                }
                                //cca
                                object val2 = rbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    pcca = 0;
                                }
                                else
                                {
                                    pcca = Convert.ToDecimal(rbasic["cca"]) * months_1new;
                                }
                                //hra
                                object val3 = rbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    phra = 0;
                                }
                                else
                                {
                                    phra = Convert.ToDecimal(rbasic["hra"]) * months_1new;
                                }
                                //int_ref
                                object va4 = rbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    pint_ref = 0;
                                }
                                else
                                {
                                    pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months_1new;
                                }

                                object val5 = rbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    pt_inc = 0;
                                }
                                else
                                {
                                    pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months_1new;
                                }

                                object val6 = rbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    pspl_da = 0;
                                }
                                else
                                {
                                    pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months_1new;
                                }

                                object val7 = rbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    pspl_allowance = 0;
                                }
                                else
                                {
                                    pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months_1new;
                                }



                            }

                            // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance



                            if (dtBasicSum.Rows.Count > 0)
                            {
                                DataRow sbasic = dtBasicSum.Rows[0];

                                //basic 
                                object val = sbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    basic = 0 + pbasic;
                                }
                                else
                                {
                                    basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                }

                                //da_percent 
                                object val1 = sbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    da_percent = Convert.ToDecimal(0 + pda_percent);
                                }
                                else
                                {
                                    da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                }
                                //cca
                                object val2 = sbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    cca = Convert.ToDecimal(0 + pcca);
                                }
                                else
                                {
                                    cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                }
                                //hra
                                object val3 = sbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    hra = Convert.ToDecimal(0 + phra);
                                }
                                else
                                {
                                    hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                }
                                //int_ref
                                object va4 = sbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    int_ref = 0 + pint_ref;
                                }
                                else
                                {
                                    int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                }

                                object val5 = sbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    t_inc = 0 + pt_inc;
                                }
                                else
                                {
                                    t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                }

                                object val6 = sbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    spl_da = 0 + pspl_da;
                                }
                                else
                                {
                                    spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                }

                                object val7 = sbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    spl_allowance = 0 + pspl_allowance;
                                }
                                else
                                {
                                    spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                }

                                object val8 = sbasic["pf"];
                                if (val8 == DBNull.Value)
                                {
                                    pf = 0;
                                }
                                else
                                {
                                    pf = Convert.ToDecimal(sbasic["pf"]);
                                }



                                //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                            }

                            //present allowances pper_allowance,pfpa_allow,pfpiip

                            //foreach (DataRow algen in dtAllowance.Rows)
                            //{


                            //    string alw_name = algen["all_name"].ToString();
                            //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                            //    if (alw_name == "Fixed Personal Allowance")
                            //    {
                            //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == "FPA-HRA Allowance")
                            //    {
                            //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == PrConstants.FPIIP)
                            //    {
                            //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                            //    }

                            //}

                            ////dtSumFixed
                            //if (dtSumFixed.Rows.Count > 0)
                            //{
                            //    DataRow sumf = dtSumFixed.Rows[0];

                            //    object val = sumf["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        per_allowance = 0 + pper_allowance;
                            //    }
                            //    else
                            //    {
                            //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                            //    }

                            //}
                            ////dtsumFPA
                            //if (dtsumFPA.Rows.Count > 0)
                            //{
                            //    DataRow sumfpa = dtsumFPA.Rows[0];

                            //    object val = sumfpa["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpa_allow = 0 + pfpa_allow;
                            //    }
                            //    else
                            //    {
                            //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                            //    }

                            //}
                            ////dtsumfpiip
                            //if (dtsumfpiip.Rows.Count > 0)
                            //{
                            //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                            //    object val = sumfpiip["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpiip = 0 + pfpiip;
                            //    }
                            //    else
                            //    {
                            //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                            //    }
                            //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                            //}

                            //getting the date difference from finstart year and current year for allowance
                            int datediffetire = 0;
                            int minval = 0;
                            if (dt_datediff.Rows.Count > 0)
                            {
                                datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                                datediffetire = Convert.ToInt32(dt_datediff.Rows[0]["DateDiffRetire"]);
                                minval = Math.Min(datediff, datediffetire);
                            }

                            List<OldAllowance> oldList = new List<OldAllowance>();
                            //foreach (DataRow dtold in dtSumAllowance.Rows)
                            //{
                            //    OldAllowance objoldlist = new OldAllowance();
                            //    objoldlist.old_Name = dtold["all_name"].ToString();
                            //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                            //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                            //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                            //    oldList.Add(objoldlist);
                            //}
                            foreach (DataRow dtold in dtSumAllowancenew.Rows)
                            {
                                OldAllowance objoldlist = new OldAllowance();
                                objoldlist.old_Name = dtold["all_name"].ToString();
                                //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                                objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                                //objoldlist.old_alw_type = dtold["all_type"].ToString();
                                oldList.Add(objoldlist);
                            }


                            List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                            //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                            //{

                            //    ActiveAllowance NewObjlist = new ActiveAllowance();
                            //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                            //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                            //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                            //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                            //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                            //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                            //    if (olditem != null)
                            //    {
                            //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                            //    }

                            //    NewActiveList.Add(NewObjlist);
                            //}
                            foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                            {

                                ActiveAllowance NewObjlist = new ActiveAllowance();
                                NewObjlist.Active_Name = dtActive["all_name"].ToString();
                                //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                                NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1new;
                                //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                                //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                                var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                                if (olditem != null)
                                {
                                    NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                                    NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                                }

                                NewActiveList.Add(NewObjlist);
                            }


                            //if not in new list then add
                            //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            //{
                            //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                            //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                            //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                            //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                            //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                            //    if (olditem == null)
                            //    {
                            //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            //        NewActiveList.Add(NewObjlist1);
                            //    }
                            //}
                            foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            {
                                ActiveAllowance NewObjlist1 = new ActiveAllowance();
                                NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                                //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                                //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                                var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                                if (olditem == null)
                                {
                                    NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                                    NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                                    NewActiveList.Add(NewObjlist1);
                                }
                            }
                            var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                            if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                            {
                                await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                            }
                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            //1. trans_id
                            //sbqry.Append(GenNewTransactionString());
                            decimal total_allowance = 0;
                            //foreach (var newlist in NewActiveList)
                            //{
                            //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                            //    NewNumIndex++;
                            //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                            //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                            //    sbqry.Append(newqry);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            //}
                            foreach (var newlist in NewActiveList)
                            {
                                total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                                var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                                    " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                                    "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                                    " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                                sbqry.Append(newqry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            }



                            //List<string> lststring = new List<string>();
                            //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                            //// dtPfPerks
                            //if (dtPfperks.Rows.Count > 0)
                            //{
                            //    DataRow pfPerk = dtPfperks.Rows[0];

                            //    object val = pfPerk["pf_perk"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        pf_perk = 0;
                            //    }
                            //    else
                            //    {
                            //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                            //    }

                            //}
                            //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);

                            //dtLoanPerks
                            if (dtLoanPerks.Rows.Count > 0)
                            {
                                DataRow lperk = dtLoanPerks.Rows[0];

                                object val = lperk["loan_perk"];
                                if (val == DBNull.Value)
                                {
                                    loan_perk = 0;
                                }
                                else
                                {
                                    loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                                }

                            }
                            //dtIncentives
                            if (dtIncentives.Rows.Count > 0)
                            {
                                DataRow ins = dtIncentives.Rows[0];

                                object val = ins["incentive"];
                                if (val == DBNull.Value)
                                {
                                    incentives = 0;
                                }
                                else
                                {
                                    incentives = Convert.ToDecimal(ins["incentive"]);
                                }

                            }
                            //dt172
                            if (dt172.Rows.Count > 0)
                            {
                                DataRow VAL = dt172.Rows[0];
                                object val = VAL["val172"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_2 = 0;
                                }
                                else
                                {
                                    values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                                    totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                                }
                            }
                            //dt173
                            if (dt173.Rows.Count > 0)
                            {
                                DataRow VAL1 = dt173.Rows[0];
                                object val = VAL1["val173"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_3 = 0;
                                }
                                else
                                {
                                    values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                                }
                            }

                            if (dtRent.Rows.Count > 0)
                            {
                                DataRow rents = dtRent.Rows[0];

                                object val = rents["rentamount"];
                                if (val == DBNull.Value)
                                {
                                    house_rent_allowance = 0;
                                }
                                else
                                {
                                    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                                }
                            }

                            if (house_rent_allowance > 0)
                            {
                                decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                                //salary(a)
                                decimal salary = da_percent + Convert.ToDecimal(basic);
                                //40%  of salary(b)
                                decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                                //houserentpaid - 10% of salary(c)
                                decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                                //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                                house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                                // HouseRentAllowance calculated as on 04-09-2020
                                // minimun values of (
                                // Basic+DA --40%,
                                // House Rent Paid minus Basic+DA --10% 
                                // HRA)
                            }
                            //decimal daval = Convert.ToDecimal(da);
                            //decimal hraval = Convert.ToDecimal(hra);
                            //rent amount
                            if (house_rent_allowance < 0)
                            {
                                house_rent_allowance = 0;
                            }



                            if (dtOther.Rows.Count > 0)
                            {
                                DataRow otr = dtOther.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = otr["other"];
                                if (val == DBNull.Value)
                                {
                                    other = 0;
                                }
                                else
                                {
                                    other = Convert.ToDecimal(otr["other"]);
                                }

                            }

                            if (dtHouse.Rows.Count > 0)
                            {
                                //foreach (DataRow dr in dtHouse.Rows)
                                //{
                                //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                                //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                                //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                                //        || dr["loan_type_mid"].ToString() == "13")
                                //    {
                                //        count++;
                                //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                                //    }

                                //}
                                DataRow dh = dtHouse.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = dh["amount"];
                                if (val == DBNull.Value)
                                {
                                    houseloan_allownace = 0;
                                }
                                else
                                {
                                    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                                }

                            }
                            //if (count > 0)
                            //{

                            //    houseloan_allownace = 200000;
                            //}
                            if (dt_strpf.Rows.Count > 0)
                            {
                                pf = Convert.ToDecimal(dt_strpf.Rows[0]["pf"]);
                            }
                            if (dt_strprevlicgsli.Rows.Count > 0)
                            {
                                foreach (DataRow drpev in dt_strprevlicgsli.Rows)
                                {
                                    decimal? amount = 0;
                                    object val = drpev["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(drpev["amount"]);
                                    }
                                    string dd_name = Convert.ToString(drpev["name"].ToString());
                                    if (dd_name == "LIC")
                                    {
                                        lic = amount;
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        gsli = amount;
                                    }
                                }
                            }

                            IList<section80C> lstCer = new List<section80C>();
                            IList<section80CCC> lstCCC = new List<section80CCC>();
                            IList<section80CCD> lstCCD = new List<section80CCD>();
                            IList<sectionOther> lstOther = new List<sectionOther>();

                            decimal pf_new = 0;
                            if (dtCD.Rows.Count > 0)
                            {
                                foreach (DataRow cer in dtCD.Rows)
                                {
                                    //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                                    decimal? amount = 0;

                                    object val = cer["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(cer["amount"]);
                                    }

                                    string dd_name = Convert.ToString(cer["name"].ToString());
                                    int loanid = 0;
                                    int pflag = 0;
                                    int countofsub = 0;
                                    int precoverflag = 0;

                                    string getloanid = "select id  from pr_loan_master where loan_description='" + dd_name + "'";
                                    DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                                    if (dtgetloanid.Rows.Count > 0)
                                    {
                                        loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                                    }

                                    string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                        "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                                    string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                        "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                                    DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                                    DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                                    if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                                    {
                                        countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                        precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                    }
                                    if (dtchkloaneligibility.Rows.Count > 0)
                                    {
                                        pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                                    }

                                    if (dd_name == "Provident Fund")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //  amount = Convert.ToDecimal(pf + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = pf;
                                            //}

                                        }
                                        amount = Convert.ToDecimal(pf + (amount * months_1new));
                                        pf_new = Convert.ToDecimal(amount);
                                    }
                                    else if (dd_name == "VPF")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //    amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = vpf_data;
                                            //}

                                        }
                                        amount = Convert.ToDecimal(vpf_data + (amount * months_1new));
                                    }

                                    else if (dd_name == "LIC")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //    amount = Convert.ToDecimal(lic + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = lic;
                                            //}
                                        }
                                        amount = Convert.ToDecimal(lic + (amount * months_1new));
                                    }
                                    else if (dd_name == "Housing Loan Main")
                                    {
                                        //amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Addl.Loan - 2D")
                                    {
                                        //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Loan 2B-2C")
                                    {
                                        //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloan2bc + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Loan 2A")
                                    {
                                        //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloan2a + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        amount = Convert.ToDecimal(gsli + (amount * months_1new));
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal((amount * months_1new));
                                    }
                                    //if amount is zero not adding to the list
                                    if (amount == 0)
                                    { continue; }
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }

                                }


                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //for special deductions
                            if (dt_tdssections.Rows.Count > 0)
                            {
                                foreach (DataRow cer1 in dt_tdssections.Rows)
                                {
                                    decimal? amount1 = 0;
                                    decimal? allowance_amount1 = 0;
                                    amount1 = Convert.ToDecimal(cer1["gross"]);
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount1 > min_allowance)
                                        {
                                            allowance_amount1 = min_allowance;
                                            min_allowance = min_allowance - allowance_amount1;
                                            max_allowance = max_allowance + allowance_amount1;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount1;
                                            allowance_amount1 = amount1;
                                            max_allowance = max_allowance + amount1;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }

                            }

                            decimal pf_perkcal = 0.5m;
                            decimal pf_perktemp = 12.5m;
                            pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                            //if (dtCCC.Rows.Count > 0)
                            //{
                            //    foreach (DataRow ccc in dtCCC.Rows)
                            //    {
                            //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                            //        decimal? allowance_amount = 0;
                            //        if (min_allowance > 0 && max_allowance <= 150000)
                            //        {
                            //            if (amount > min_allowance)
                            //            {
                            //                allowance_amount = min_allowance;
                            //                min_allowance = min_allowance - allowance_amount;
                            //                max_allowance = max_allowance + allowance_amount;
                            //            }
                            //            else
                            //            {
                            //                min_allowance = min_allowance - amount;
                            //                allowance_amount = amount;
                            //                max_allowance = max_allowance + amount;
                            //            }
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                            //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //            });
                            //        }
                            //        else
                            //        {
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                            //                allowance_amount = AddZerosAfterDecimal("0"),
                            //                ded_amount = AddZerosAfterDecimal("0")
                            //            });
                            //        }

                            //    }

                            //}
                            //else
                            //{
                            //    lstCCC.Add(new section80CCC
                            //    {
                            //        id = "",
                            //        name = "",
                            //        amount = AddZerosAfterDecimal("0"),
                            //        allowance_amount = AddZerosAfterDecimal("0"),
                            //        ded_amount = AddZerosAfterDecimal("0")
                            //    });
                            //}

                            if (dtCCD.Rows.Count > 0)
                            {
                                foreach (DataRow ccd in dtCCD.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                                    {
                                        if (amount > min_allowance80CCD)
                                        {
                                            allowance_amount = min_allowance80CCD;
                                            min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                            max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance80CCD = min_allowance80CCD - amount;
                                            allowance_amount = amount;
                                            max_allowance80CCD = max_allowance80CCD + amount;
                                        }
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            if (dtEdu.Rows.Count > 0)
                            {
                                foreach (DataRow ed in dtEdu.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                                    String sectionNAme = ed["section"].ToString();
                                    decimal? allowance_amount = 0;
                                    string id = ed["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = ed["name"].ToString();
                                    if (sectionNAme == "Section80G")
                                    {
                                        allowance_amount = amount * section80g;
                                        max_allowanceGG = max_allowanceGG + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80GGB")
                                    {
                                        allowance_amount = amount * section80gg;
                                        max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80DDB")
                                    {
                                        if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                        {
                                            if (amount > min_allowance80DDB)
                                            {
                                                allowance_amount = min_allowance80DDB;
                                                ded_amount = allowance_amount;
                                                min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                                max_allowance80DB = max_allowance80DB + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DDB = min_allowance80DDB - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DB = max_allowance80DB + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                    }
                                    else if (sectionNAme == "Section80DD")
                                    {
                                        if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                        {
                                            if (amount > min_allowance80DD)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80DD = min_allowance80DD - allowance_amount;
                                                max_allowance80DD = max_allowance80DD + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DD = min_allowance80DD - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DD = max_allowance80DD + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80U")
                                    {
                                        if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                        {
                                            if (amount > min_allowance80U)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80U = min_allowance80U - allowance_amount;
                                                max_allowance80U = max_allowance80U + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80U = min_allowance80U - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80U = max_allowance80U + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80E")
                                    {
                                        allowance_amount = amount;
                                        max_allowance = max_allowance + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    else if (sectionNAme == "Section80D_P")
                                    {
                                        if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                        {
                                            if (amount > min_allowance80D_P)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                                max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_P = min_allowance80D_P - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_P = max_allowance80D_P + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                        //if (min_allowance80D_P > amount)
                                        //{
                                        //    allowance_amount = amount;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}

                                        //else
                                        //{
                                        //    allowance_amount = min_allowance80D_P;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}
                                    }
                                    else if (sectionNAme == "Section80D_F")
                                    {
                                        if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                        {
                                            if (amount > min_allowance80D_F)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                                max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_F = min_allowance80D_F - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_F = max_allowance80D_F + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                                    {
                                        if (sectionNAme != "Section80EE")
                                        {
                                            sectionNAme = "Section80EE_HL";
                                        }
                                        if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                        {
                                            if (amount > min_allowance80EE)
                                            {
                                                allowance_amount = min_allowance80EE;
                                                min_allowance80EE = min_allowance80EE - allowance_amount;
                                                max_allowance80ee = max_allowance80ee + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80EE = min_allowance80EE - amount;
                                                allowance_amount = amount;
                                                max_allowance80ee = max_allowance80ee + amount;
                                            }
                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;

                                        }
                                    }

                                    else if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });

                                }

                            }

                            else
                            {
                                lstOther.Add(new sectionOther
                                {
                                    id = "",
                                    name = "",
                                    section = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //special section24(b)
                            if (dt_tdssection24.Rows.Count > 0)
                            {
                                foreach (DataRow sec24 in dt_tdssection24.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                                    String sectionNAme = sec24["section"].ToString();
                                    string actName1 = "";
                                    decimal? allowance_amount = 0;
                                    string id = sec24["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = sec24["name"].ToString();

                                    for (int i = 0; i < lstOther.Count; i++)
                                    {
                                        actName1 = lstOther[i].name;
                                        if (actName1 == actName)
                                        {
                                            lstOther.RemoveAt(i);
                                            continue;
                                        }
                                    }

                                    if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });
                                }
                            }

                            max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                            if (dtTax.Rows.Count > 0)
                            {


                                DataRow tax = dtTax.Rows[0];

                                object val = tax["tax_deducted_at_source"];
                                if (val == DBNull.Value)
                                {
                                    total_tax_till = 0;
                                }
                                else
                                {
                                    total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                                }

                                tax_till = totaltaxdeductedfrm16 + total_tax_till;
                                tax_till = 0;

                            }

                            if (dtTDS.Rows.Count > 0)
                            {
                                DataRow TDS = dtTDS.Rows[0];

                                object val = TDS["tds_amount"];
                                if (val == DBNull.Value)
                                {
                                    paid_by_emp = 0;
                                }
                                else
                                {
                                    paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                                }
                            }

                            IList<TDSProcess> lstTDS = new List<TDSProcess>();

                            gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                            total_section = house_rent_allowance;

                            balance = gross - total_section;
                            //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                            //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                            decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                            if (stndednew >= 50000)
                            {
                                standard_deduction = PrConstants.STANDARD_DEDUCTION;
                            }
                            else
                            {
                                standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                            }
                            //standard_deduction = gross*0.04;
                            if (dtph.Rows.Count > 0)
                            {
                                if (monthcount != 1)
                                {
                                    //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);

                                    //if (emp_tax > 2400)
                                    //{
                                    //    emp_tax = 2400;
                                    //}
                                    emp_tax = (200);
                                }
                                else if (monthcount == 1)
                                {
                                    emp_tax = 0;
                                }
                            }

                            aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                            Income_chargable = balance - aggregate_of_4; //6

                            total_gross_income = Income_chargable + other - houseloan_allownace;

                            deductible = Convert.ToDecimal(max_allowance);
                            total_income = total_gross_income - deductible;
                            //total_income = Convert.ToDecimal(841240.01);
                            round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));
                            //tax_deducted_at_source is calculating as incometax value of current financial year.
                            decimal tax_deducted_at_source1 = 0;
                            if (dt_incometax.Rows.Count > 0)
                            {
                                DataRow incometax = dt_incometax.Rows[0];

                                object val = incometax["income_tax"];
                                if (val == DBNull.Value)
                                {
                                    tax_deducted_at_source1 = 0;
                                }
                                else
                                {
                                    tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                                }
                            }
                            if (total_income > 500000)
                            {
                                //strConvert = income.ToString();
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = 0;
                                edu_cess = income * 4 / 100;

                                tax_payable = (float)income + edu_cess;
                                tax_payable = (int)Math.Round(tax_payable);


                                //if (tax_till > tax_payable)
                                //{
                                //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                                //}
                                //else
                                //{
                                //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                                //}
                                tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                                if (tax_balance < 0)
                                {
                                    tax_balance = 0;
                                }

                                //tds_per_month = tax_balance / months_1;
                                tds_per_month = 0;
                                if (Financial_md.Month != 03)
                                {
                                    int x = (int)Math.Round(tds_per_month);
                                    int y = (int)Math.Round(x / 100d, 0) * 100;
                                    rounding_tds_per_month = y;
                                }
                                else
                                {
                                    int xp = (int)Math.Round(tds_per_month);
                                    int Z = (10 - xp % 10) + xp;
                                    rounding_tds_per_month = Z;
                                }

                                //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                            }
                            else
                            {
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = Convert.ToDecimal(income);
                                edu_cess = 0;

                                tax_payable = 0;

                                tax_till = 0;
                                tax_balance = 0;

                                tds_per_month = 0;

                                rounding_tds_per_month = 0;
                            }
                            //string employer_name_address = PrConstants.Name;
                            //string employer_pan = PrConstants.PAN;
                            //string employer_tan = PrConstants.TAN;



                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            ////1. trans_id
                            //sbqry.Append(GenNewTransactionString());

                            //int finalSub = 0;

                            if (final == true)
                            {
                                finalSub = 1;
                            }
                            else
                            {
                                finalSub = 0;
                            }

                            string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                            DataTable details = await _sha.Get_Table_FromQry(selQry);
                            if (details.Rows.Count > 0)
                            {
                                NewNumIndex++;
                                DataRow finaldt = details.Rows[0];
                                string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                sbqry.Append(tdsdelete);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                int finalCount = Convert.ToInt32(finaldt["final"]);

                                if (finalCount == 1)
                                {
                                    return "E#TDS Process#Employee Already Processed..!!";
                                }
                                else
                                {
                                    NewNumIndex++;
                                    string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                                    sbqry.Append(tdsUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));



                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        foreach (var ccDatas in lstCer)
                                        {
                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        foreach (var cccDatas in lstCCC)
                                        {
                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }



                            }
                            else
                            {

                                try
                                {


                                    NewNumIndex++;
                                    string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate1);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate2);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var ccDatas in lstCer)
                                        {

                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate3);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var cccDatas in lstCCC)
                                        {

                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            //NewNumIndex++;
                                            //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                            //sbqry.Append(tdsUpdate3);
                                            //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate4);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }
                                catch (Exception e)
                                {
                                    return "E#TDS Process#" + e.Message;
                                }
                            }
                        }
                        else if (optn.Rows[0]["Option"].ToString() == "1" && dtretiredate.Rows.Count == 0 && zerobasic == 0)
                        {
                            decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                                   .Where(x => x["constant"].ToString() == "Section80C")
                                   .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                            decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80CCD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                            decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80U")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DDB")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                            decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_P")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                            decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_F")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                            decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80EE")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section24(b)")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                            decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80G")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                            decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80GGB")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                            DataTable _dtFY_FM = ds1.Tables[1];
                            _incometaxdbconstant = ds1.Tables[2];


                            //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            //string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                            //    "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                            //    "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " and spl_type='Regular' order by id desc); ";
                            string basicQry = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref," +
                            " (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance,(dd_provident_fund) pf from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + "  and spl_type='Regular' and working_days=(select month_days from pr_month_details where active=1) and er_basic>0 order by fm desc; ";

                            //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                                "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                                "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                            //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                            string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                            //allowance ==>Get and Sum all previous months allowances 
                            string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                            //allowance ==> Get all current month allowances
                            string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                            //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                            ////sum Personal Allowance
                            //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                            //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                            ////sum FPIIP
                            //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                            //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                            //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                            //sum PFPerks                                                   
                            string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                            // sum LOANPerks                                                    
                            string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                            // sum Incentive                                                    
                            string incentive = "select distinct sum(amount) as incentive from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            // sum  val 17 -2
                            string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                                 "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                            // sum val 17 -3
                            string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                                "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                                " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                            //rent allowance
                            //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                            string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                            //other
                            string otherQry = "select distinct sum(amount) as other from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                        "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            //house loan
                            string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                            //section 80c
                            //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                            //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                            //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                            string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                               "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                               "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 and ef.name not in('Provident Fund','LIC','VPF','LIC','Housing Loan Main','Housing Addl.Loan - 2D','GSLI') union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                               "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) union " +
                               "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                               "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + " " +

                               "union all " +
                               "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount)  as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC';";

                            //section 80ccc
                            string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                            //section 80ccd
                            string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                                " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                            //section other section
                            string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                            //tax till
                            string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            //other tds deductions
                            //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                            string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                                "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                            string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                                "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";
                            string chkph = "select * from pr_emp_general where emp_code= " + Convert.ToInt32(empCode) + " and phy_handicapped!=1;";

                            string emptax = "select sum(dd_prof_tax)+(200*(select 12-(select DATEDIFF(month, '" + startYear + "' , '" + FM + "')+1))) " +
                                "as ptax from pr_emp_payslip where fm >= '" + startYear + "' and emp_code= " + Convert.ToInt32(empCode) + "  group by emp_code order by emp_code;";
                            //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                            //VPF
                            string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm < '" + FM + "' and p.fm >= '" + startYear + "';";

                            string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                   " union all " +
                   " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' ";

                            string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff;";

                            string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                            string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                                " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";
                            string sumofbasicnolop = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as " +
                        " int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  from pr_emp_payslip " +
                        " where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";
                            string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                                " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                                " all_name not in('Employee TDS' ,'CCA')  group by all_name;";
                            string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                                " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                                " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";
                            string payfieldbasic = "SELECT  m.name as payfieldtype,amount,c.m_id FROM pr_emp_pay_field c JOIN pr_earn_field_master m ON c.m_id=m.id " +
                                "join pr_payslip_customization pc on c.m_id=pc.m_id WHERE emp_code=" + Convert.ToInt32(empCode) + " and pc.field_type='pay_fields' and m.type='pay_fields' and " +
                                "pc.cust_status='Yes' AND c.active=1 AND amount>0 group by m.name,amount,c.m_id  ;";
                            string strda_percent = "SELECT da_percent FROM pr_month_details WHERE fm=case when (select top 1 fm from pr_emp_payslip where " +
                                "emp_code="+ Convert.ToInt32(empCode) + " and er_basic>0 order by fm desc) is null then (select fm from pr_month_details where active=1) else " +
                                "(select top 1 fm from pr_emp_payslip where emp_code="+ Convert.ToInt32(empCode) + " and er_basic>0 order by fm desc) end ;";
                            string strdays = "select month_days as days from pr_month_details where active=1";
                            string qryConstantsnew = "SELECT constant, [value] FROM all_constants WHERE app_type='payroll' AND functionality='GenPayslip' AND active=1;";
                            string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                            string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                            DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                                SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                                cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                                loansprevmonth + strdatediff + strincometax + nolopsbasic + sumofbasicnolop + SumAllowanceQrynew + 
                                ActiveSumAllowanceQrynew + chkph + emptax+payfieldbasic+ strda_percent+strdays+ qryConstantsnew+ tdssections+ tdssection24);

                            //tables
                            var dtGeneral = ds.Tables[0];
                            var dtBasic = ds.Tables[1];
                            var dtBasicSum = ds.Tables[2];
                            var dtAllowance = ds.Tables[3];
                            var dtSumAllowance = ds.Tables[4];

                            var dtPfperks = ds.Tables[5];
                            var dtLoanPerks = ds.Tables[6];
                            var dtIncentives = ds.Tables[7];
                            var dt172 = ds.Tables[8];
                            var dt173 = ds.Tables[9];
                            var dtRent = ds.Tables[10];
                            var dtOther = ds.Tables[11];
                            var dtHouse = ds.Tables[12];

                            var dtCD = ds.Tables[13];
                            var dtCCC = ds.Tables[14];
                            var dtCCD = ds.Tables[15];
                            var dtEdu = ds.Tables[16];
                            var dtTax = ds.Tables[17];
                            var dtTDS = ds.Tables[18];
                            var dtEmpTax = ds.Tables[19];
                            var dtVpf = ds.Tables[20];
                            var dtActiveSumAllowance = ds.Tables[21];
                            var dt_prevmonthloans = ds.Tables[22];
                            var dt_datediff = ds.Tables[23];
                            var dt_incometax = ds.Tables[24];
                            var dt_nolopbasic = ds.Tables[25];
                            var dt_sumbasicnolop = ds.Tables[26];
                            var dtSumAllowancenew = ds.Tables[27];
                            var dtActiveSumAllowancenew = ds.Tables[28];
                            var dtph = ds.Tables[29];
                            var dtemployeetax = ds.Tables[30];
                            var dt_payfieldbasic = ds.Tables[31];
                            var dt_strda_percent = ds.Tables[32];
                            var dt_strdays = ds.Tables[33];
                            dt_qryconstantsnew = ds.Tables[34];
                            var dt_tdssections = ds.Tables[35];
                            var dt_tdssection24 = ds.Tables[36];
                            int loss_months = 0;
                            decimal? vpf_data = 0;
                            decimal? pf = 0;
                            decimal? lic = 0;
                            decimal? houseloanmain = 0;
                            decimal? houseAddloan_2d = 0;


                            if (dtEmpTax.Rows.Count > 0)
                            {
                                DataRow empTax = dtEmpTax.Rows[0];

                                object val = empTax["loss"];
                                if (val == DBNull.Value)
                                {
                                    loss_months = 0;
                                }
                                else
                                {
                                    loss_months = Convert.ToInt32(empTax["loss"]);
                                }

                            }
                            //vpf

                            if (dtVpf.Rows.Count > 0)
                            {
                                DataRow vpfData = dtVpf.Rows[0];

                                object val = vpfData["amount"];
                                if (val == DBNull.Value)
                                {
                                    vpf_data = 0;
                                }
                                else
                                {
                                    vpf_data = Convert.ToDecimal(vpfData["amount"]);
                                }

                            }

                            // General Data
                            if (dtGeneral.Rows.Count > 0)
                            {
                                DataRow gen = dtGeneral.Rows[0];
                                name = Convert.ToString(gen["name"]);
                                per_address = Convert.ToString(gen["per_address"]);
                                pan_no = Convert.ToString(gen["pan_no"]);
                                emp_code = Convert.ToString(gen["emp_code"]);
                                designation = Convert.ToString(gen["designation"]);
                                sex = Convert.ToString(gen["sex"]);
                                fm = fin_month;
                            }

                            if (dt_prevmonthloans.Rows.Count > 0)
                            {
                                foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                                {
                                    string val = dr_prelons["loantype"].ToString();
                                    object amount = dr_prelons["amount"];
                                    if (val == "Housing Loan Main")
                                    {
                                        if (amount == DBNull.Value)
                                        {
                                            houseloanmain = 0;
                                        }
                                        else
                                        {
                                            houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                        }
                                    }
                                    else if (val == "Housing Addl.Loan - 2D")
                                    {
                                        if (amount == DBNull.Value)
                                        {
                                            houseAddloan_2d = 0;
                                        }
                                        else
                                        {
                                            houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                        }
                                    }
                                }
                            }
                            //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance


                            if (dtBasic.Rows.Count > 0)
                            {

                                DataRow rbasic = dtBasic.Rows[0];

                                //basic 
                                object val = rbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    pbasic = 0;
                                }
                                else
                                {
                                    pbasic = Convert.ToDecimal(rbasic["basic"]) * monthsnew;
                                }

                                //da_percent 
                                object val1 = rbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    pda_percent = 0;
                                }
                                else
                                {
                                    pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * monthsnew;
                                }
                                //cca
                                object val2 = rbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    pcca = 0;
                                }
                                else
                                {
                                    pcca = Convert.ToDecimal(rbasic["cca"]) * monthsnew;
                                }
                                //hra
                                object val3 = rbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    phra = 0;
                                }
                                else
                                {
                                    phra = Convert.ToDecimal(rbasic["hra"]) * monthsnew;
                                }
                                //int_ref
                                object va4 = rbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    pint_ref = 0;
                                }
                                else
                                {
                                    pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * monthsnew;
                                }

                                object val5 = rbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    pt_inc = 0;
                                }
                                else
                                {
                                    pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * monthsnew;
                                }

                                object val6 = rbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    pspl_da = 0;
                                }
                                else
                                {
                                    pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * monthsnew;
                                }

                                object val7 = rbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    pspl_allowance = 0;
                                }
                                else
                                {
                                    pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * monthsnew;
                                }
                                object valpf = rbasic["pf"];
                                if (valpf == DBNull.Value)
                                {
                                    pf = 0;
                                }
                                else
                                {
                                    pf = Convert.ToDecimal(rbasic["pf"]) * monthsnew;
                                }



                            }

                            // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance


                            if (dtBasicSum.Rows.Count > 0)
                            {
                                DataRow sbasic = dtBasicSum.Rows[0];

                                //basic 
                                object val = sbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    basic = 0 + pbasic;
                                }
                                else
                                {
                                    basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                }

                                //da_percent 
                                object val1 = sbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    da_percent = Convert.ToDecimal(0 + pda_percent);
                                }
                                else
                                {
                                    da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                }
                                //cca
                                object val2 = sbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    cca = Convert.ToDecimal(0 + pcca);
                                }
                                else
                                {
                                    cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                }
                                //hra
                                object val3 = sbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    hra = Convert.ToDecimal(0 + phra);
                                }
                                else
                                {
                                    hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                }
                                //int_ref
                                object va4 = sbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    int_ref = 0 + pint_ref;
                                }
                                else
                                {
                                    int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                }

                                object val5 = sbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    t_inc = 0 + pt_inc;
                                }
                                else
                                {
                                    t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                }

                                object val6 = sbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    spl_da = 0 + pspl_da;
                                }
                                else
                                {
                                    spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                }

                                object val7 = sbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    spl_allowance = 0 + pspl_allowance;
                                }
                                else
                                {
                                    spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                }

                                object val8 = sbasic["pf"];
                                if (val8 == DBNull.Value)
                                {
                                    pf = 0;
                                }
                                else
                                {
                                    pf = Convert.ToDecimal(sbasic["pf"]) + pf;
                                }



                                //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                            }
                            if(dt_payfieldbasic.Rows.Count>0)
                            {
                                foreach(DataRow dr_paybasic in dt_payfieldbasic.Rows)
                                {
                                    decimal? amount = 0;

                                    object val = dr_paybasic["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(dr_paybasic["amount"]);
                                    }

                                    string dd_name = Convert.ToString(dr_paybasic["payfieldtype"].ToString());
                                    if (dd_name == "Basic")
                                    {
                                        pbasic = amount;
                                        basic = amount * monthsnew;
                                    }
                                    else if(dd_name== "Telangana Increment")
                                    {
                                        t_inc = amount * monthsnew;
                                    }
                                    else if (dd_name == "Interm Relief")
                                    {
                                        int_ref = amount * monthsnew;
                                    }
                                }
                            }
                            int days = 0;
                            if(dt_strdays.Rows.Count>0)
                            {
                                days = Convert.ToInt32(dt_strdays.Rows[0]["days"]);
                            }
                            decimal spl_allowancenew = 0;
                            decimal pfpercent = 12.50m;
                            if (pbasic != 0)
                            {
                                if (designation != "Managing Director")
                                {
                                    hra = (CalcHRA(Convert.ToDecimal(pbasic), designation)) * monthsnew;
                                }
                                da_percent = (CalcDA(Convert.ToDecimal(pbasic), dt_strda_percent)) * monthsnew;
                                cca = (CalcCCA(Convert.ToDecimal(pbasic), designation, Convert.ToInt32(days), Convert.ToInt32(days))) * monthsnew;
                                spl_allowancenew = CalcSpl_Allw(Convert.ToDecimal(pbasic), designation);
                                spl_allowance = (CalcSpl_Allw(Convert.ToDecimal(pbasic), designation)) * monthsnew;
                                spl_da = (CalcSplDA(Convert.ToDecimal(spl_allowancenew), dt_strda_percent)) * monthsnew;
                            }
                            if (pf == 0)
                            {
                                pf = ((basic + da_percent) * pfpercent) / 100;
                            }
                            //present allowances pper_allowance,pfpa_allow,pfpiip

                            //foreach (DataRow algen in dtAllowance.Rows)
                            //{


                            //    string alw_name = algen["all_name"].ToString();
                            //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                            //    if (alw_name == "Fixed Personal Allowance")
                            //    {
                            //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == "FPA-HRA Allowance")
                            //    {
                            //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == PrConstants.FPIIP)
                            //    {
                            //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                            //    }

                            //}

                            ////dtSumFixed
                            //if (dtSumFixed.Rows.Count > 0)
                            //{
                            //    DataRow sumf = dtSumFixed.Rows[0];

                            //    object val = sumf["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        per_allowance = 0 + pper_allowance;
                            //    }
                            //    else
                            //    {
                            //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                            //    }

                            //}
                            ////dtsumFPA
                            //if (dtsumFPA.Rows.Count > 0)
                            //{
                            //    DataRow sumfpa = dtsumFPA.Rows[0];

                            //    object val = sumfpa["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpa_allow = 0 + pfpa_allow;
                            //    }
                            //    else
                            //    {
                            //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                            //    }

                            //}
                            ////dtsumfpiip
                            //if (dtsumfpiip.Rows.Count > 0)
                            //{
                            //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                            //    object val = sumfpiip["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpiip = 0 + pfpiip;
                            //    }
                            //    else
                            //    {
                            //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                            //    }
                            //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                            //}

                            //getting the date difference from finstart year and current year for allowance
                            if (dt_datediff.Rows.Count > 0)
                            {
                                datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                            }

                            List<OldAllowance> oldList = new List<OldAllowance>();
                            //foreach (DataRow dtold in dtSumAllowance.Rows)
                            //{
                            //    OldAllowance objoldlist = new OldAllowance();
                            //    objoldlist.old_Name = dtold["all_name"].ToString();
                            //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                            //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                            //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                            //    oldList.Add(objoldlist);
                            //}
                            foreach (DataRow dtold in dtSumAllowancenew.Rows)
                            {
                                OldAllowance objoldlist = new OldAllowance();
                                objoldlist.old_Name = dtold["all_name"].ToString();
                                //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                                objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                                //objoldlist.old_alw_type = dtold["all_type"].ToString();
                                oldList.Add(objoldlist);
                            }


                            List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                            //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                            //{

                            //    ActiveAllowance NewObjlist = new ActiveAllowance();
                            //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                            //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                            //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                            //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                            //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                            //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                            //    if (olditem != null)
                            //    {
                            //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                            //    }

                            //    NewActiveList.Add(NewObjlist);
                            //}
                            foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                            {

                                ActiveAllowance NewObjlist = new ActiveAllowance();
                                NewObjlist.Active_Name = dtActive["all_name"].ToString();
                                //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                                NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * monthsnew;
                                //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                                //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                                var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                                if (olditem != null)
                                {
                                    NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                                    NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                                }

                                NewActiveList.Add(NewObjlist);
                            }


                            //if not in new list then add
                            //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            //{
                            //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                            //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                            //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                            //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                            //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                            //    if (olditem == null)
                            //    {
                            //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            //        NewActiveList.Add(NewObjlist1);
                            //    }
                            //}
                            foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                            {
                                ActiveAllowance NewObjlist1 = new ActiveAllowance();
                                NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                                // NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                                //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                                var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                                if (olditem == null)
                                {
                                    NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                                    NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                                    NewActiveList.Add(NewObjlist1);
                                }
                            }
                            var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                            if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                            {
                                await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                            }
                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            //1. trans_id
                            //sbqry.Append(GenNewTransactionString());
                            decimal total_allowance = 0;
                            //foreach (var newlist in NewActiveList)
                            //{
                            //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                            //    NewNumIndex++;
                            //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                            //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                            //    sbqry.Append(newqry);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            //}
                            foreach (var newlist in NewActiveList)
                            {
                                total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                                var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                                    " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                                    "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                                    " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                                sbqry.Append(newqry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            }



                            //List<string> lststring = new List<string>();
                            //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                            //// dtPfPerks
                            //if (dtPfperks.Rows.Count > 0)
                            //{
                            //    DataRow pfPerk = dtPfperks.Rows[0];

                            //    object val = pfPerk["pf_perk"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        pf_perk = 0;
                            //    }
                            //    else
                            //    {
                            //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                            //    }

                            //}
                            //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                            
                            //dtLoanPerks
                            if (dtLoanPerks.Rows.Count > 0)
                            {
                                DataRow lperk = dtLoanPerks.Rows[0];

                                object val = lperk["loan_perk"];
                                if (val == DBNull.Value)
                                {
                                    loan_perk = 0;
                                }
                                else
                                {
                                    loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                                }

                            }
                            //dtIncentives
                            if (dtIncentives.Rows.Count > 0)
                            {
                                DataRow ins = dtIncentives.Rows[0];

                                object val = ins["incentive"];
                                if (val == DBNull.Value)
                                {
                                    incentives = 0;
                                }
                                else
                                {
                                    incentives = Convert.ToDecimal(ins["incentive"]);
                                }

                            }
                            //dt172
                            if (dt172.Rows.Count > 0)
                            {
                                DataRow VAL = dt172.Rows[0];
                                object val = VAL["val172"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_2 = 0;
                                }
                                else
                                {
                                    values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                                    totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                                }
                            }
                            //dt173
                            if (dt173.Rows.Count > 0)
                            {
                                DataRow VAL1 = dt173.Rows[0];
                                object val = VAL1["val173"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_3 = 0;
                                }
                                else
                                {
                                    values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                                }
                            }

                            if (dtRent.Rows.Count > 0)
                            {
                                DataRow rents = dtRent.Rows[0];

                                object val = rents["rentamount"];
                                if (val == DBNull.Value)
                                {
                                    house_rent_allowance = 0;
                                }
                                else
                                {
                                    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                                }
                            }

                            if (house_rent_allowance > 0)
                            {
                                decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                                //salary(a)
                                decimal salary = da_percent + Convert.ToDecimal(basic);
                                //40%  of salary(b)
                                decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                                //houserentpaid - 10% of salary(c)
                                decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                                //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                                house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                                // HouseRentAllowance calculated as on 04-09-2020
                                // minimun values of (
                                // Basic+DA --40%,
                                // House Rent Paid minus Basic+DA --10% 
                                // HRA)
                            }
                            //decimal daval = Convert.ToDecimal(da);
                            //decimal hraval = Convert.ToDecimal(hra);
                            //rent amount
                            if (house_rent_allowance < 0)
                            {
                                house_rent_allowance = 0;
                            }



                            if (dtOther.Rows.Count > 0)
                            {
                                DataRow otr = dtOther.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = otr["other"];
                                if (val == DBNull.Value)
                                {
                                    other = 0;
                                }
                                else
                                {
                                    other = Convert.ToDecimal(otr["other"]);
                                }

                            }

                            if (dtHouse.Rows.Count > 0)
                            {
                                //foreach (DataRow dr in dtHouse.Rows)
                                //{
                                //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                                //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                                //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                                //        || dr["loan_type_mid"].ToString() == "13")
                                //    {
                                //        count++;
                                //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                                //    }

                                //}
                                DataRow dh = dtHouse.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = dh["amount"];
                                if (val == DBNull.Value)
                                {
                                    houseloan_allownace = 0;
                                }
                                else
                                {
                                    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                                }

                            }
                            //if (count > 0)
                            //{

                            //    houseloan_allownace = 200000;
                            //}

                            IList<section80C> lstCer = new List<section80C>();
                            IList<section80CCC> lstCCC = new List<section80CCC>();
                            IList<section80CCD> lstCCD = new List<section80CCD>();
                            IList<sectionOther> lstOther = new List<sectionOther>();

                            decimal pf_new = 0;
                            if (dtCD.Rows.Count > 0)
                            {
                                foreach (DataRow cer in dtCD.Rows)
                                {
                                    //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                                    decimal? amount = 0;

                                    object val = cer["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(cer["amount"]);
                                    }

                                    string dd_name = Convert.ToString(cer["name"].ToString());
                                    if (dd_name == "Provident Fund")
                                    {
                                        amount = Convert.ToDecimal(pf + (amount * months));
                                        pf_new = Convert.ToDecimal(amount);
                                    }
                                    else if (dd_name == "VPF")
                                    {
                                        amount = Convert.ToDecimal(vpf_data + (amount * months));
                                    }
                                    else if (dd_name == "LIC")
                                    {
                                        amount = Convert.ToDecimal(lic + (amount * months));
                                    }
                                    else if (dd_name == "Housing Loan Main")
                                    {
                                        amount = Convert.ToDecimal(houseloanmain + (amount * months));
                                    }
                                    else if (dd_name == "Housing Addl.Loan - 2D")
                                    {
                                        amount = Convert.ToDecimal(houseAddloan_2d + (amount * months));
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        amount = Convert.ToDecimal(gsli + (amount * months));
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal((amount * months));
                                    }
                                    if (amount == 0)
                                    { continue; }
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }

                                }


                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //for special deductions
                            if (dt_tdssections.Rows.Count > 0)
                            {
                                foreach (DataRow cer1 in dt_tdssections.Rows)
                                {
                                    decimal? amount1 = 0;
                                    decimal? allowance_amount1 = 0;
                                    amount1 = Convert.ToDecimal(cer1["gross"]);
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount1 > min_allowance)
                                        {
                                            allowance_amount1 = min_allowance;
                                            min_allowance = min_allowance - allowance_amount1;
                                            max_allowance = max_allowance + allowance_amount1;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount1;
                                            allowance_amount1 = amount1;
                                            max_allowance = max_allowance + amount1;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }

                            }

                            decimal pf_perkcal = 0.5m;
                            decimal pf_perktemp = 12.5m;
                            pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                            //if (dtCCC.Rows.Count > 0)
                            //{
                            //    foreach (DataRow ccc in dtCCC.Rows)
                            //    {
                            //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                            //        decimal? allowance_amount = 0;
                            //        if (min_allowance > 0 && max_allowance <= 150000)
                            //        {
                            //            if (amount > min_allowance)
                            //            {
                            //                allowance_amount = min_allowance;
                            //                min_allowance = min_allowance - allowance_amount;
                            //                max_allowance = max_allowance + allowance_amount;
                            //            }
                            //            else
                            //            {
                            //                min_allowance = min_allowance - amount;
                            //                allowance_amount = amount;
                            //                max_allowance = max_allowance + amount;
                            //            }
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                            //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //            });
                            //        }
                            //        else
                            //        {
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                            //                allowance_amount = AddZerosAfterDecimal("0"),
                            //                ded_amount = AddZerosAfterDecimal("0")
                            //            });
                            //        }

                            //    }

                            //}
                            //else
                            //{
                            //    lstCCC.Add(new section80CCC
                            //    {
                            //        id = "",
                            //        name = "",
                            //        amount = AddZerosAfterDecimal("0"),
                            //        allowance_amount = AddZerosAfterDecimal("0"),
                            //        ded_amount = AddZerosAfterDecimal("0")
                            //    });
                            //}

                            if (dtCCD.Rows.Count > 0)
                            {
                                foreach (DataRow ccd in dtCCD.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                                    {
                                        if (amount > min_allowance80CCD)
                                        {
                                            allowance_amount = min_allowance80CCD;
                                            min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                            max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance80CCD = min_allowance80CCD - amount;
                                            allowance_amount = amount;
                                            max_allowance80CCD = max_allowance80CCD + amount;
                                        }
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            if (dtEdu.Rows.Count > 0)
                            {
                                foreach (DataRow ed in dtEdu.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                                    String sectionNAme = ed["section"].ToString();
                                    decimal? allowance_amount = 0;
                                    string id = ed["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = ed["name"].ToString();
                                    if (sectionNAme == "Section80G")
                                    {
                                        allowance_amount = amount * section80g;
                                        max_allowanceGG = max_allowanceGG + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80GGB")
                                    {
                                        allowance_amount = amount * section80gg;
                                        max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80DDB")
                                    {
                                        if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                        {
                                            if (amount > min_allowance80DDB)
                                            {
                                                allowance_amount = min_allowance80DDB;
                                                ded_amount = allowance_amount;
                                                min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                                max_allowance80DB = max_allowance80DB + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DDB = min_allowance80DDB - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DB = max_allowance80DB + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                    }
                                    else if (sectionNAme == "Section80DD")
                                    {
                                        if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                        {
                                            if (amount > min_allowance80DD)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80DD = min_allowance80DD - allowance_amount;
                                                max_allowance80DD = max_allowance80DD + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DD = min_allowance80DD - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DD = max_allowance80DD + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80U")
                                    {
                                        if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                        {
                                            if (amount > min_allowance80U)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80U = min_allowance80U - allowance_amount;
                                                max_allowance80U = max_allowance80U + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80U = min_allowance80U - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80U = max_allowance80U + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80E")
                                    {
                                        allowance_amount = amount;
                                        max_allowance = max_allowance + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    else if (sectionNAme == "Section80D_P")
                                    {
                                        if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                        {
                                            if (amount > min_allowance80D_P)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                                max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_P = min_allowance80D_P - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_P = max_allowance80D_P + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                        //if (min_allowance80D_P > amount)
                                        //{
                                        //    allowance_amount = amount;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}

                                        //else
                                        //{
                                        //    allowance_amount = min_allowance80D_P;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}
                                    }
                                    else if (sectionNAme == "Section80D_F")
                                    {
                                        if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                        {
                                            if (amount > min_allowance80D_F)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                                max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_F = min_allowance80D_F - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_F = max_allowance80D_F + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                                    {
                                        if (sectionNAme != "Section80EE")
                                        {
                                            sectionNAme = "Section80EE_HL";
                                        }
                                        if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                        {
                                            if (amount > min_allowance80EE)
                                            {
                                                allowance_amount = min_allowance80EE;
                                                min_allowance80EE = min_allowance80EE - allowance_amount;
                                                max_allowance80ee = max_allowance80ee + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80EE = min_allowance80EE - amount;
                                                allowance_amount = amount;
                                                max_allowance80ee = max_allowance80ee + amount;
                                            }
                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;

                                        }
                                    }

                                    else if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });

                                }

                            }

                            else
                            {
                                lstOther.Add(new sectionOther
                                {
                                    id = "",
                                    name = "",
                                    section = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //special section24(b)
                            if (dt_tdssection24.Rows.Count > 0)
                            {
                                foreach (DataRow sec24 in dt_tdssection24.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                                    String sectionNAme = sec24["section"].ToString();
                                    string actName1 = "";
                                    decimal? allowance_amount = 0;
                                    string id = sec24["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = sec24["name"].ToString();

                                    for (int i = 0; i < lstOther.Count; i++)
                                    {
                                        actName1 = lstOther[i].name;
                                        if (actName1 == actName)
                                        {
                                            lstOther.RemoveAt(i);
                                            continue;
                                        }
                                    }

                                    if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });
                                }
                            }

                            max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                            if (dtTax.Rows.Count > 0)
                            {


                                DataRow tax = dtTax.Rows[0];

                                object val = tax["tax_deducted_at_source"];
                                if (val == DBNull.Value)
                                {
                                    total_tax_till = 0;
                                }
                                else
                                {
                                    total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                                }

                                tax_till = totaltaxdeductedfrm16 + total_tax_till;
                                tax_till = 0;

                            }

                            if (dtTDS.Rows.Count > 0)
                            {
                                DataRow TDS = dtTDS.Rows[0];

                                object val = TDS["tds_amount"];
                                if (val == DBNull.Value)
                                {
                                    paid_by_emp = 0;
                                }
                                else
                                {
                                    paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                                }
                            }

                            IList<TDSProcess> lstTDS = new List<TDSProcess>();

                            gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                            total_section = house_rent_allowance;

                            balance = gross - total_section;

                            //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                            //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                            decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                            if (stndednew >= 50000)
                            {
                                standard_deduction = PrConstants.STANDARD_DEDUCTION;
                            }
                            else
                            {
                                standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                            }
                            //standard_deduction = gross*0.04;
                            if (dtph.Rows.Count > 0)
                            {
                                if (dtemployeetax.Rows.Count > 0)
                                {
                                    DataRow etax = dtemployeetax.Rows[0];
                                    object val = etax["ptax"];
                                    if (val == DBNull.Value)
                                    {
                                        emp_tax = 0;
                                    }
                                    else
                                    {
                                        emp_tax = Convert.ToInt32(etax["ptax"]);
                                    }
                                }

                                //if (dtemppayslipforfinmonth.Rows.Count == 0)
                                //{
                                //    loss_months = 0;
                                //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                                //    if (emp_tax > 2400)
                                //    {
                                //        emp_tax = 2400;
                                //    }
                                //}
                                //else
                                //{
                                //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                                //    if (emp_tax > 2400)
                                //    {
                                //        emp_tax = 2400;
                                //    }
                                //}
                            }


                            aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                            Income_chargable = balance - aggregate_of_4; //6

                            total_gross_income = Income_chargable + other - houseloan_allownace;

                            deductible = Convert.ToDecimal(max_allowance);
                            total_income = total_gross_income - deductible;
                            //total_income = Convert.ToDecimal(841240.01);
                            round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                            //tax_deducted_at_source is calculating as incometax value of current financial year.
                            decimal tax_deducted_at_source1 = 0;
                            if (dt_incometax.Rows.Count > 0)
                            {
                                DataRow incometax = dt_incometax.Rows[0];

                                object val = incometax["income_tax"];
                                if (val == DBNull.Value)
                                {
                                    tax_deducted_at_source1 = 0;
                                }
                                else
                                {
                                    tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                                }
                            }

                            if (total_income > 500000)
                            {
                                //strConvert = income.ToString();
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = 0;
                                edu_cess = income * 4 / 100;

                                tax_payable = (float)income + edu_cess;
                                tax_payable = (int)Math.Round(tax_payable);


                                //if (tax_till > tax_payable)
                                //{
                                //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                                //}
                                //else
                                //{
                                //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                                //}
                                tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                                if (tax_balance < 0)
                                {
                                    tax_balance = 0;
                                }
                                 
                                tds_per_month = tax_balance / months;
                                if (Financial_md.Month != 03)
                                {
                                    int x = (int)Math.Round(tds_per_month);
                                    int y = (int)Math.Round(x / 100d, 0) * 100;
                                    rounding_tds_per_month = y;
                                }
                                else
                                {
                                    int xp = (int)Math.Round(tds_per_month);
                                    int Z = (10 - xp % 10) + xp;
                                    rounding_tds_per_month = Z;
                                }

                                //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                            }
                            else
                            {
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = Convert.ToDecimal(income);
                                edu_cess = 0;

                                tax_payable = 0;

                                tax_till = 0;
                                tax_balance = 0;

                                tds_per_month = 0;

                                rounding_tds_per_month = 0;
                            }
                            //string employer_name_address = PrConstants.Name;
                            //string employer_pan = PrConstants.PAN;
                            //string employer_tan = PrConstants.TAN;


                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            ////1. trans_id
                            //sbqry.Append(GenNewTransactionString());

                            //int finalSub = 0;

                            if (final == true)
                            {
                                finalSub = 1;
                            }
                            else
                            {
                                finalSub = 0;
                            }

                            string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                            DataTable details = await _sha.Get_Table_FromQry(selQry);
                            if (details.Rows.Count > 0)
                            {
                                NewNumIndex++;
                                DataRow finaldt = details.Rows[0];
                                string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                sbqry.Append(tdsdelete);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                int finalCount = Convert.ToInt32(finaldt["final"]);

                                if (finalCount == 1)
                                {
                                    return "E#TDS Process#Employee Already Processed..!!";
                                }
                                else
                                {
                                    NewNumIndex++;
                                    string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                                    sbqry.Append(tdsUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));



                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        foreach (var ccDatas in lstCer)
                                        {
                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        foreach (var cccDatas in lstCCC)
                                        {
                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }



                            }
                            else
                            {

                                try
                                {


                                    NewNumIndex++;
                                    string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate1);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate2);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var ccDatas in lstCer)
                                        {

                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate3);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var cccDatas in lstCCC)
                                        {

                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            //NewNumIndex++;
                                            //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                            //sbqry.Append(tdsUpdate3);
                                            //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate4);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }
                                catch (Exception e)
                                {
                                    return "E#TDS Process#" + e.Message;
                                }
                            }
                            //}
                        }
                        else if (optn.Rows[0]["Option"].ToString() == "1" && dtretiredate.Rows.Count == 0 && zerobasic > 0)
                        {
                            decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                                   .Where(x => x["constant"].ToString() == "Section80C")
                                   .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                            decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80CCD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                            decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80U")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DDB")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                            decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_P")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                            decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_F")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                            decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80EE")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section24(b)")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                            decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80G")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                            decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80GGB")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                            DataTable _dtFY_FM = ds1.Tables[1];
                            _incometaxdbconstant = ds1.Tables[2];


                            //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                                "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                                "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " and spl_type='Regular' order by id desc); ";

                            //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                                "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                                "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                            //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                            string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                            //allowance ==>Get and Sum all previous months allowances 
                            string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                            //allowance ==> Get all current month allowances
                            string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                            //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                            ////sum Personal Allowance
                            //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                            //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                            ////sum FPIIP
                            //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                            //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                            //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                            //sum PFPerks                                                   
                            string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                            // sum LOANPerks                                                    
                            string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                            // sum Incentive                                                    
                            string incentive = "select distinct sum(amount) as incentive from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            // sum  val 17 -2
                            string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                                 "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                            // sum val 17 -3
                            string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                                "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                                " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                            //rent allowance
                            //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                            string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                            //other
                            string otherQry = "select distinct sum(amount) as other from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                        "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            //house loan
                            string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                            //section 80c
                            //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                            //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                            //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                            string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                               "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                               "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 and ef.name not in('Provident Fund','LIC','VPF','LIC','Housing Loan Main','Housing Addl.Loan - 2D','GSLI') union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                               "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) union " +
                               "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                               "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + " " +

                               "union all " +
                               "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount)  as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                               "union all " +
                               "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                                "union all " +
                                "select '7' as id, 'Housing Loan 2B-2C' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2B-2C' and emp_code = " + Convert.ToInt32(empCode) + "  and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                                "union all " +
                                "select '8' as id, 'Housing Loan 2A' as name, sum(paydedu.dd_amount) as amount  from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2A' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                                " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC';";

                            //section 80ccc
                            string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                            //section 80ccd
                            string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                                " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                            //section other section
                            string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                            //tax till
                            string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            //other tds deductions
                            //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                            string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                                "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                            string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                                "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";
                            string chkph = "select * from pr_emp_general where emp_code= " + Convert.ToInt32(empCode) + " and phy_handicapped!=1";

                            string emptax = "select sum(dd_prof_tax)+(200*(select 12-(select DATEDIFF(month, '" + startYear + "' , '" + FM + "')+1))) " +
                                "as ptax from pr_emp_payslip where fm >= '" + startYear + "' and emp_code= " + Convert.ToInt32(empCode) + "  group by emp_code order by emp_code;";
                            //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                            //VPF
                            string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm <= '" + FM + "' and p.fm >= '" + startYear + "';";

                            string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                            " union all " +
                            " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' " +
                            "union all  " +
                            "select 'Housing Loan 2B-2C',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =  " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "'  and fm>= '" + startYear + "'  and emp_code =  " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2B-2C' " +
                            "union all  " +
                            "select 'Housing Loan 2A',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + "  and payslip_mid in(select id from pr_emp_payslip where fm <  '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2A' ";

                            string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff;";

                            string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                            string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                                " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";
                            string sumofbasicnolop = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as " +
                        " int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  from pr_emp_payslip " +
                        " where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";
                            string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                                " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                                " all_name not in('Employee TDS' ,'CCA')  group by all_name;";
                            string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                                " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                                " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                            string strpf = " select sum(dd_provident_fund) pf  from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";

                            string strprevlicgsli = "select 'LIC' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'LIC' and payslip_mid " +
                                                   " in(select id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "') " +
                                                   "union all" +
                                                   " select 'GSLI' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'GSLI' and payslip_mid " +
                                                   " in(select id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "');";
                            string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                            string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                            DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                                SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                                cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                                loansprevmonth + strdatediff + strincometax + nolopsbasic + sumofbasicnolop + SumAllowanceQrynew + ActiveSumAllowanceQrynew + 
                                chkph + emptax+strpf+ strprevlicgsli+ tdssections+ tdssection24);

                            //tables
                            var dtGeneral = ds.Tables[0];
                            var dtBasic = ds.Tables[1];
                            var dtBasicSum = ds.Tables[2];
                            var dtAllowance = ds.Tables[3];
                            var dtSumAllowance = ds.Tables[4];

                            var dtPfperks = ds.Tables[5];
                            var dtLoanPerks = ds.Tables[6];
                            var dtIncentives = ds.Tables[7];
                            var dt172 = ds.Tables[8];
                            var dt173 = ds.Tables[9];
                            var dtRent = ds.Tables[10];
                            var dtOther = ds.Tables[11];
                            var dtHouse = ds.Tables[12];

                            var dtCD = ds.Tables[13];
                            var dtCCC = ds.Tables[14];
                            var dtCCD = ds.Tables[15];
                            var dtEdu = ds.Tables[16];
                            var dtTax = ds.Tables[17];
                            var dtTDS = ds.Tables[18];
                            var dtEmpTax = ds.Tables[19];
                            var dtVpf = ds.Tables[20];
                            var dtActiveSumAllowance = ds.Tables[21];
                            var dt_prevmonthloans = ds.Tables[22];
                            var dt_datediff = ds.Tables[23];
                            var dt_incometax = ds.Tables[24];
                            var dt_nolopbasic = ds.Tables[25];
                            var dt_sumbasicnolop = ds.Tables[26];
                            var dtSumAllowancenew = ds.Tables[27];
                            var dtActiveSumAllowancenew = ds.Tables[28];
                            var dtph = ds.Tables[29];
                            var dtemployeetax = ds.Tables[30];
                            var dt_strpf = ds.Tables[31];
                            var dt_strprevlicgsli = ds.Tables[32];
                            var dt_tdssections = ds.Tables[33];
                            var dt_tdssection24 = ds.Tables[34];
                            int loss_months = 0;
                            decimal? vpf_data = 0;
                            decimal? pf = 0;
                            decimal? lic = 0;
                            decimal? houseloanmain = 0;
                            decimal? houseAddloan_2d = 0;
                            decimal? houseloan2bc = 0;
                            decimal? houseloan2a = 0;

                            if (dtEmpTax.Rows.Count > 0)
                            {
                                DataRow empTax = dtEmpTax.Rows[0];

                                object val = empTax["loss"];
                                if (val == DBNull.Value)
                                {
                                    loss_months = 0;
                                }
                                else
                                {
                                    loss_months = Convert.ToInt32(empTax["loss"]);
                                }

                            }
                            //vpf

                            if (dtVpf.Rows.Count > 0)
                            {
                                DataRow vpfData = dtVpf.Rows[0];

                                object val = vpfData["amount"];
                                if (val == DBNull.Value)
                                {
                                    vpf_data = 0;
                                }
                                else
                                {
                                    vpf_data = Convert.ToDecimal(vpfData["amount"]);
                                }

                            }

                            // General Data
                            if (dtGeneral.Rows.Count > 0)
                            {
                                DataRow gen = dtGeneral.Rows[0];
                                name = Convert.ToString(gen["name"]);
                                per_address = Convert.ToString(gen["per_address"]);
                                pan_no = Convert.ToString(gen["pan_no"]);
                                emp_code = Convert.ToString(gen["emp_code"]);
                                designation = Convert.ToString(gen["designation"]);
                                sex = Convert.ToString(gen["sex"]);
                                fm = fin_month;
                            }

                            if (dt_prevmonthloans.Rows.Count > 0)
                            {
                                foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                                {
                                    int loanid = 0;
                                    int pflag = 0;
                                    int pflag1 = 0;
                                    int countofsub = 0;
                                    int precoverflag = 0;
                                    string val = dr_prelons["loantype"].ToString();
                                    string getloanid = "select id  from pr_loan_master where loan_description='" + val + "'";
                                    DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                                    loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                                    string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                        "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                                    string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                        "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                                    DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                                    DataTable dtcompare = sh.Get_Table_FromQry(comparequery);

                                    if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                                    {
                                        countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                        precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                    }


                                    if (dtchkloaneligibility.Rows.Count > 0)
                                    {
                                        pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                                    }
                                    object amount = dr_prelons["amount"];
                                    if (countofsub != precoverflag)
                                    {
                                        if (val == "Housing Loan Main")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloanmain = 0;
                                            }
                                            else
                                            {
                                                houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Addl.Loan - 2D")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseAddloan_2d = 0;
                                            }
                                            else
                                            {
                                                houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Loan 2B-2C")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloan2bc = 0;
                                            }
                                            else
                                            {
                                                houseloan2bc = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Loan 2A")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloan2a = 0;
                                            }
                                            else
                                            {
                                                houseloan2a = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                    }
                                }
                            }
                            //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            if (dt_lopdays.Rows.Count > 0)
                            {
                                if (dt_nolopbasic.Rows.Count > 0)
                                {

                                    DataRow rbasic = dt_nolopbasic.Rows[0];

                                    //basic 
                                    object val = rbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        pbasic = 0;
                                    }
                                    else
                                    {
                                        pbasic = Convert.ToDecimal(rbasic["basic"]) * (monthsnew);
                                    }

                                    //da_percent 
                                    object val1 = rbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        pda_percent = 0;
                                    }
                                    else
                                    {
                                        pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * (monthsnew);
                                    }
                                    //cca
                                    object val2 = rbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        pcca = 0;
                                    }
                                    else
                                    {
                                        pcca = Convert.ToDecimal(rbasic["cca"]) * (monthsnew);
                                    }
                                    //hra
                                    object val3 = rbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        phra = 0;
                                    }
                                    else
                                    {
                                        phra = Convert.ToDecimal(rbasic["hra"]) * (monthsnew);
                                    }
                                    //int_ref
                                    object va4 = rbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        pint_ref = 0;
                                    }
                                    else
                                    {
                                        pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * (monthsnew);
                                    }

                                    object val5 = rbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        pt_inc = 0;
                                    }
                                    else
                                    {
                                        pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * (monthsnew);
                                    }

                                    object val6 = rbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        pspl_da = 0;
                                    }
                                    else
                                    {
                                        pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * (monthsnew);
                                    }

                                    object val7 = rbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        pspl_allowance = 0;
                                    }
                                    else
                                    {
                                        pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * (monthsnew);
                                    }




                                }
                            }
                            else
                            {
                                if (dtBasic.Rows.Count > 0)
                                {

                                    DataRow rbasic = dtBasic.Rows[0];

                                    //basic 
                                    object val = rbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        pbasic = 0;
                                    }
                                    else
                                    {
                                        pbasic = Convert.ToDecimal(rbasic["basic"]) * months;
                                    }

                                    //da_percent 
                                    object val1 = rbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        pda_percent = 0;
                                    }
                                    else
                                    {
                                        pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months;
                                    }
                                    //cca
                                    object val2 = rbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        pcca = 0;
                                    }
                                    else
                                    {
                                        pcca = Convert.ToDecimal(rbasic["cca"]) * months;
                                    }
                                    //hra
                                    object val3 = rbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        phra = 0;
                                    }
                                    else
                                    {
                                        phra = Convert.ToDecimal(rbasic["hra"]) * months;
                                    }
                                    //int_ref
                                    object va4 = rbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        pint_ref = 0;
                                    }
                                    else
                                    {
                                        pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months;
                                    }

                                    object val5 = rbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        pt_inc = 0;
                                    }
                                    else
                                    {
                                        pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months;
                                    }

                                    object val6 = rbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        pspl_da = 0;
                                    }
                                    else
                                    {
                                        pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months;
                                    }

                                    object val7 = rbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        pspl_allowance = 0;
                                    }
                                    else
                                    {
                                        pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months;
                                    }




                                }
                            }
                            // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            if (dt_lopdays.Rows.Count > 0)
                            {
                                if (dt_sumbasicnolop.Rows.Count > 0)
                                {
                                    DataRow sbasic = dt_sumbasicnolop.Rows[0];

                                    //basic 
                                    object val = sbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        basic = 0 + pbasic;
                                    }
                                    else
                                    {
                                        basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    }

                                    //da_percent 
                                    object val1 = sbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        da_percent = Convert.ToDecimal(0 + pda_percent);
                                    }
                                    else
                                    {
                                        da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    }
                                    //cca
                                    object val2 = sbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        cca = Convert.ToDecimal(0 + pcca);
                                    }
                                    else
                                    {
                                        cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    }
                                    //hra
                                    object val3 = sbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        hra = Convert.ToDecimal(0 + phra);
                                    }
                                    else
                                    {
                                        hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    }
                                    //int_ref
                                    object va4 = sbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        int_ref = 0 + pint_ref;
                                    }
                                    else
                                    {
                                        int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    }

                                    object val5 = sbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        t_inc = 0 + pt_inc;
                                    }
                                    else
                                    {
                                        t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    }

                                    object val6 = sbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        spl_da = 0 + pspl_da;
                                    }
                                    else
                                    {
                                        spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    }

                                    object val7 = sbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        spl_allowance = 0 + pspl_allowance;
                                    }
                                    else
                                    {
                                        spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                    }

                                    object val8 = sbasic["pf"];
                                    if (val8 == DBNull.Value)
                                    {
                                        pf = 0;
                                    }
                                    else
                                    {
                                        pf = Convert.ToDecimal(sbasic["pf"]);
                                    }



                                    //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                                }
                            }
                            else
                            {
                                if (dtBasicSum.Rows.Count > 0)
                                {
                                    DataRow sbasic = dtBasicSum.Rows[0];

                                    //basic 
                                    object val = sbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        basic = 0 + pbasic;
                                    }
                                    else
                                    {
                                        basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    }

                                    //da_percent 
                                    object val1 = sbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        da_percent = Convert.ToDecimal(0 + pda_percent);
                                    }
                                    else
                                    {
                                        da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    }
                                    //cca
                                    object val2 = sbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        cca = Convert.ToDecimal(0 + pcca);
                                    }
                                    else
                                    {
                                        cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    }
                                    //hra
                                    object val3 = sbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        hra = Convert.ToDecimal(0 + phra);
                                    }
                                    else
                                    {
                                        hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    }
                                    //int_ref
                                    object va4 = sbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        int_ref = 0 + pint_ref;
                                    }
                                    else
                                    {
                                        int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    }

                                    object val5 = sbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        t_inc = 0 + pt_inc;
                                    }
                                    else
                                    {
                                        t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    }

                                    object val6 = sbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        spl_da = 0 + pspl_da;
                                    }
                                    else
                                    {
                                        spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    }

                                    object val7 = sbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        spl_allowance = 0 + pspl_allowance;
                                    }
                                    else
                                    {
                                        spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                    }

                                    object val8 = sbasic["pf"];
                                    if (val8 == DBNull.Value)
                                    {
                                        pf = 0;
                                    }
                                    else
                                    {
                                        pf = Convert.ToDecimal(sbasic["pf"]);
                                    }



                                    //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                                }
                            }


                            //present allowances pper_allowance,pfpa_allow,pfpiip

                            //foreach (DataRow algen in dtAllowance.Rows)
                            //{


                            //    string alw_name = algen["all_name"].ToString();
                            //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                            //    if (alw_name == "Fixed Personal Allowance")
                            //    {
                            //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == "FPA-HRA Allowance")
                            //    {
                            //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == PrConstants.FPIIP)
                            //    {
                            //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                            //    }

                            //}

                            ////dtSumFixed
                            //if (dtSumFixed.Rows.Count > 0)
                            //{
                            //    DataRow sumf = dtSumFixed.Rows[0];

                            //    object val = sumf["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        per_allowance = 0 + pper_allowance;
                            //    }
                            //    else
                            //    {
                            //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                            //    }

                            //}
                            ////dtsumFPA
                            //if (dtsumFPA.Rows.Count > 0)
                            //{
                            //    DataRow sumfpa = dtsumFPA.Rows[0];

                            //    object val = sumfpa["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpa_allow = 0 + pfpa_allow;
                            //    }
                            //    else
                            //    {
                            //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                            //    }

                            //}
                            ////dtsumfpiip
                            //if (dtsumfpiip.Rows.Count > 0)
                            //{
                            //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                            //    object val = sumfpiip["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpiip = 0 + pfpiip;
                            //    }
                            //    else
                            //    {
                            //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                            //    }
                            //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                            //}

                            //getting the date difference from finstart year and current year for allowance
                            if (dt_datediff.Rows.Count > 0)
                            {
                                datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                            }

                            List<OldAllowance> oldList = new List<OldAllowance>();
                            //foreach (DataRow dtold in dtSumAllowance.Rows)
                            //{
                            //    OldAllowance objoldlist = new OldAllowance();
                            //    objoldlist.old_Name = dtold["all_name"].ToString();
                            //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                            //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                            //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                            //    oldList.Add(objoldlist);
                            //}
                            foreach (DataRow dtold in dtSumAllowancenew.Rows)
                            {
                                OldAllowance objoldlist = new OldAllowance();
                                objoldlist.old_Name = dtold["all_name"].ToString();
                                //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                                objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                                //objoldlist.old_alw_type = dtold["all_type"].ToString();
                                oldList.Add(objoldlist);
                            }


                            List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                            //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                            //{

                            //    ActiveAllowance NewObjlist = new ActiveAllowance();
                            //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                            //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                            //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                            //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                            //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                            //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                            //    if (olditem != null)
                            //    {
                            //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                            //    }

                            //    NewActiveList.Add(NewObjlist);
                            //}
                            foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                            {

                                ActiveAllowance NewObjlist = new ActiveAllowance();
                                NewObjlist.Active_Name = dtActive["all_name"].ToString();
                                //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                                NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * monthsnew;
                                //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                                //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                                var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                                if (olditem != null)
                                {
                                    NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                                    NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                                }

                                NewActiveList.Add(NewObjlist);
                            }


                            //if not in new list then add
                            //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            //{
                            //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                            //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                            //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                            //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                            //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                            //    if (olditem == null)
                            //    {
                            //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            //        NewActiveList.Add(NewObjlist1);
                            //    }
                            //}
                            foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                            {
                                ActiveAllowance NewObjlist1 = new ActiveAllowance();
                                NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                                // NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                                //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                                var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                                if (olditem == null)
                                {
                                    NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                                    NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                                    NewActiveList.Add(NewObjlist1);
                                }
                            }
                            var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                            if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                            {
                                await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                            }
                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            //1. trans_id
                            //sbqry.Append(GenNewTransactionString());
                            decimal total_allowance = 0;
                            //foreach (var newlist in NewActiveList)
                            //{
                            //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                            //    NewNumIndex++;
                            //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                            //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                            //    sbqry.Append(newqry);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            //}
                            foreach (var newlist in NewActiveList)
                            {
                                total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                                var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                                    " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                                    "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                                    " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                                sbqry.Append(newqry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            }



                            //List<string> lststring = new List<string>();
                            //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                            //// dtPfPerks
                            //if (dtPfperks.Rows.Count > 0)
                            //{
                            //    DataRow pfPerk = dtPfperks.Rows[0];

                            //    object val = pfPerk["pf_perk"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        pf_perk = 0;
                            //    }
                            //    else
                            //    {
                            //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                            //    }

                            //}
                            //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                            
                            //dtLoanPerks
                            if (dtLoanPerks.Rows.Count > 0)
                            {
                                DataRow lperk = dtLoanPerks.Rows[0];

                                object val = lperk["loan_perk"];
                                if (val == DBNull.Value)
                                {
                                    loan_perk = 0;
                                }
                                else
                                {
                                    loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                                }

                            }
                            //dtIncentives
                            if (dtIncentives.Rows.Count > 0)
                            {
                                DataRow ins = dtIncentives.Rows[0];

                                object val = ins["incentive"];
                                if (val == DBNull.Value)
                                {
                                    incentives = 0;
                                }
                                else
                                {
                                    incentives = Convert.ToDecimal(ins["incentive"]);
                                }

                            }
                            //dt172
                            if (dt172.Rows.Count > 0)
                            {
                                DataRow VAL = dt172.Rows[0];
                                object val = VAL["val172"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_2 = 0;
                                }
                                else
                                {
                                    values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                                    totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                                }
                            }
                            //dt173
                            if (dt173.Rows.Count > 0)
                            {
                                DataRow VAL1 = dt173.Rows[0];
                                object val = VAL1["val173"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_3 = 0;
                                }
                                else
                                {
                                    values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                                }
                            }

                            if (dtRent.Rows.Count > 0)
                            {
                                DataRow rents = dtRent.Rows[0];

                                object val = rents["rentamount"];
                                if (val == DBNull.Value)
                                {
                                    house_rent_allowance = 0;
                                }
                                else
                                {
                                    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                                }
                            }

                            if (house_rent_allowance > 0)
                            {
                                decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                                //salary(a)
                                decimal salary = da_percent + Convert.ToDecimal(basic);
                                //40%  of salary(b)
                                decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                                //houserentpaid - 10% of salary(c)
                                decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                                //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                                house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                                // HouseRentAllowance calculated as on 04-09-2020
                                // minimun values of (
                                // Basic+DA --40%,
                                // House Rent Paid minus Basic+DA --10% 
                                // HRA)
                            }
                            //decimal daval = Convert.ToDecimal(da);
                            //decimal hraval = Convert.ToDecimal(hra);
                            //rent amount
                            if (house_rent_allowance < 0)
                            {
                                house_rent_allowance = 0;
                            }



                            if (dtOther.Rows.Count > 0)
                            {
                                DataRow otr = dtOther.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = otr["other"];
                                if (val == DBNull.Value)
                                {
                                    other = 0;
                                }
                                else
                                {
                                    other = Convert.ToDecimal(otr["other"]);
                                }

                            }

                            if (dtHouse.Rows.Count > 0)
                            {
                                //foreach (DataRow dr in dtHouse.Rows)
                                //{
                                //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                                //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                                //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                                //        || dr["loan_type_mid"].ToString() == "13")
                                //    {
                                //        count++;
                                //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                                //    }

                                //}
                                DataRow dh = dtHouse.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = dh["amount"];
                                if (val == DBNull.Value)
                                {
                                    houseloan_allownace = 0;
                                }
                                else
                                {
                                    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                                }

                            }
                            //if (count > 0)
                            //{

                            //    houseloan_allownace = 200000;
                            //}
                            if (dt_strpf.Rows.Count > 0)
                            {
                                pf = Convert.ToDecimal(dt_strpf.Rows[0]["pf"]);
                            }
                            if (dt_strprevlicgsli.Rows.Count > 0)
                            {
                                foreach (DataRow drpev in dt_strprevlicgsli.Rows)
                                {
                                    decimal? amount = 0;
                                    object val = drpev["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(drpev["amount"]);
                                    }
                                    string dd_name = Convert.ToString(drpev["name"].ToString());
                                    if (dd_name == "LIC")
                                    {
                                        lic = amount;
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        gsli = amount;
                                    }
                                }
                            }
                            IList<section80C> lstCer = new List<section80C>();
                            IList<section80CCC> lstCCC = new List<section80CCC>();
                            IList<section80CCD> lstCCD = new List<section80CCD>();
                            IList<sectionOther> lstOther = new List<sectionOther>();

                            decimal pf_new = 0;
                            if (dtCD.Rows.Count > 0)
                            {
                                foreach (DataRow cer in dtCD.Rows)
                                {
                                    //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                                    decimal? amount = 0;

                                    object val = cer["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(cer["amount"]);
                                    }

                                    string dd_name = Convert.ToString(cer["name"].ToString());

                                    int loanid = 0;
                                    int pflag = 0;
                                    int countofsub = 0;
                                    int precoverflag = 0;

                                    string getloanid = "select id  from pr_loan_master where loan_description='" + dd_name + "'";
                                    DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                                    if (dtgetloanid.Rows.Count > 0)
                                    {
                                        loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                                    }

                                    string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                        "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                                    string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                        "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                                    DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                                    DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                                    if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                                    {
                                        countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                        precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                    }
                                    if (dtchkloaneligibility.Rows.Count > 0)
                                    {
                                        pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                                    }

                                    if (dd_name == "Provident Fund")
                                    {
                                        amount = Convert.ToDecimal(pf + (amount * monthsnew));
                                        pf_new = Convert.ToDecimal(amount);
                                    }
                                    else if (dd_name == "VPF")
                                    {
                                        amount = Convert.ToDecimal(vpf_data + (amount * monthsnew));
                                    }
                                    else if (dd_name == "LIC")
                                    {
                                        amount = Convert.ToDecimal(lic + (amount * monthsnew));
                                    }
                                    else if (dd_name == "Housing Loan Main")
                                    {
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloanmain + (amount * months));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }

                                    }
                                    else if (dd_name == "Housing Addl.Loan - 2D")
                                    {
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseAddloan_2d + (amount * months));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Loan 2B-2C")
                                    {
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloan2bc + (amount * months));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Loan 2A")
                                    {
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloan2a + (amount * months));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        amount = Convert.ToDecimal(gsli + (amount * monthsnew));
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal((amount * monthsnew));
                                    }
                                    if (amount == 0)
                                    { continue; }
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }

                                }


                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //for special deductions
                            if (dt_tdssections.Rows.Count > 0)
                            {
                                foreach (DataRow cer1 in dt_tdssections.Rows)
                                {
                                    decimal? amount1 = 0;
                                    decimal? allowance_amount1 = 0;
                                    amount1 = Convert.ToDecimal(cer1["gross"]);
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount1 > min_allowance)
                                        {
                                            allowance_amount1 = min_allowance;
                                            min_allowance = min_allowance - allowance_amount1;
                                            max_allowance = max_allowance + allowance_amount1;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount1;
                                            allowance_amount1 = amount1;
                                            max_allowance = max_allowance + amount1;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }

                            }

                            decimal pf_perkcal = 0.5m;
                            decimal pf_perktemp = 12.5m;
                            pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                            //if (dtCCC.Rows.Count > 0)
                            //{
                            //    foreach (DataRow ccc in dtCCC.Rows)
                            //    {
                            //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                            //        decimal? allowance_amount = 0;
                            //        if (min_allowance > 0 && max_allowance <= 150000)
                            //        {
                            //            if (amount > min_allowance)
                            //            {
                            //                allowance_amount = min_allowance;
                            //                min_allowance = min_allowance - allowance_amount;
                            //                max_allowance = max_allowance + allowance_amount;
                            //            }
                            //            else
                            //            {
                            //                min_allowance = min_allowance - amount;
                            //                allowance_amount = amount;
                            //                max_allowance = max_allowance + amount;
                            //            }
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                            //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //            });
                            //        }
                            //        else
                            //        {
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                            //                allowance_amount = AddZerosAfterDecimal("0"),
                            //                ded_amount = AddZerosAfterDecimal("0")
                            //            });
                            //        }

                            //    }

                            //}
                            //else
                            //{
                            //    lstCCC.Add(new section80CCC
                            //    {
                            //        id = "",
                            //        name = "",
                            //        amount = AddZerosAfterDecimal("0"),
                            //        allowance_amount = AddZerosAfterDecimal("0"),
                            //        ded_amount = AddZerosAfterDecimal("0")
                            //    });
                            //}

                            if (dtCCD.Rows.Count > 0)
                            {
                                foreach (DataRow ccd in dtCCD.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                                    {
                                        if (amount > min_allowance80CCD)
                                        {
                                            allowance_amount = min_allowance80CCD;
                                            min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                            max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance80CCD = min_allowance80CCD - amount;
                                            allowance_amount = amount;
                                            max_allowance80CCD = max_allowance80CCD + amount;
                                        }
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            if (dtEdu.Rows.Count > 0)
                            {
                                foreach (DataRow ed in dtEdu.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                                    String sectionNAme = ed["section"].ToString();
                                    decimal? allowance_amount = 0;
                                    string id = ed["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = ed["name"].ToString();
                                    if (sectionNAme == "Section80G")
                                    {
                                        allowance_amount = amount * section80g;
                                        max_allowanceGG = max_allowanceGG + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80GGB")
                                    {
                                        allowance_amount = amount * section80gg;
                                        max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80DDB")
                                    {
                                        if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                        {
                                            if (amount > min_allowance80DDB)
                                            {
                                                allowance_amount = min_allowance80DDB;
                                                ded_amount = allowance_amount;
                                                min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                                max_allowance80DB = max_allowance80DB + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DDB = min_allowance80DDB - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DB = max_allowance80DB + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                    }
                                    else if (sectionNAme == "Section80DD")
                                    {
                                        if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                        {
                                            if (amount > min_allowance80DD)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80DD = min_allowance80DD - allowance_amount;
                                                max_allowance80DD = max_allowance80DD + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DD = min_allowance80DD - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DD = max_allowance80DD + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80U")
                                    {
                                        if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                        {
                                            if (amount > min_allowance80U)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80U = min_allowance80U - allowance_amount;
                                                max_allowance80U = max_allowance80U + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80U = min_allowance80U - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80U = max_allowance80U + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80E")
                                    {
                                        allowance_amount = amount;
                                        max_allowance = max_allowance + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    else if (sectionNAme == "Section80D_P")
                                    {
                                        if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                        {
                                            if (amount > min_allowance80D_P)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                                max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_P = min_allowance80D_P - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_P = max_allowance80D_P + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                        //if (min_allowance80D_P > amount)
                                        //{
                                        //    allowance_amount = amount;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}

                                        //else
                                        //{
                                        //    allowance_amount = min_allowance80D_P;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}
                                    }
                                    else if (sectionNAme == "Section80D_F")
                                    {
                                        if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                        {
                                            if (amount > min_allowance80D_F)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                                max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_F = min_allowance80D_F - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_F = max_allowance80D_F + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                                    {
                                        if (sectionNAme != "Section80EE")
                                        {
                                            sectionNAme = "Section80EE_HL";
                                        }
                                        if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                        {
                                            if (amount > min_allowance80EE)
                                            {
                                                allowance_amount = min_allowance80EE;
                                                min_allowance80EE = min_allowance80EE - allowance_amount;
                                                max_allowance80ee = max_allowance80ee + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80EE = min_allowance80EE - amount;
                                                allowance_amount = amount;
                                                max_allowance80ee = max_allowance80ee + amount;
                                            }
                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;

                                        }
                                    }

                                    else if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });

                                }

                            }

                            else
                            {
                                lstOther.Add(new sectionOther
                                {
                                    id = "",
                                    name = "",
                                    section = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //special section24(b)
                            if (dt_tdssection24.Rows.Count > 0)
                            {
                                foreach (DataRow sec24 in dt_tdssection24.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                                    String sectionNAme = sec24["section"].ToString();
                                    string actName1 = "";
                                    decimal? allowance_amount = 0;
                                    string id = sec24["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = sec24["name"].ToString();

                                    for (int i = 0; i < lstOther.Count; i++)
                                    {
                                        actName1 = lstOther[i].name;
                                        if (actName1 == actName)
                                        {
                                            lstOther.RemoveAt(i);
                                            continue;
                                        }
                                    }

                                    if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });
                                }
                            }

                            max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                            if (dtTax.Rows.Count > 0)
                            {


                                DataRow tax = dtTax.Rows[0];

                                object val = tax["tax_deducted_at_source"];
                                if (val == DBNull.Value)
                                {
                                    total_tax_till = 0;
                                }
                                else
                                {
                                    total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                                }

                                tax_till = totaltaxdeductedfrm16 + total_tax_till;
                                tax_till = 0;

                            }

                            if (dtTDS.Rows.Count > 0)
                            {
                                DataRow TDS = dtTDS.Rows[0];

                                object val = TDS["tds_amount"];
                                if (val == DBNull.Value)
                                {
                                    paid_by_emp = 0;
                                }
                                else
                                {
                                    paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                                }
                            }

                            IList<TDSProcess> lstTDS = new List<TDSProcess>();

                            gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                            total_section = house_rent_allowance;

                            balance = gross - total_section;

                            //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                            //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                            decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                            if (stndednew >= 50000)
                            {
                                standard_deduction = PrConstants.STANDARD_DEDUCTION;
                            }
                            else
                            {
                                standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                            }
                            //standard_deduction = gross*0.04;
                            if (dtph.Rows.Count > 0)
                            {
                                if (dtemployeetax.Rows.Count > 0)
                                {
                                    DataRow etax = dtemployeetax.Rows[0];
                                    object val = etax["ptax"];
                                    if (val == DBNull.Value)
                                    {
                                        emp_tax = 0;
                                    }
                                    else
                                    {
                                        emp_tax = Convert.ToInt32(etax["ptax"]);
                                    }
                                }

                                //if (dtemppayslipforfinmonth.Rows.Count == 0)
                                //{
                                //    loss_months = 0;
                                //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                                //    if (emp_tax > 2400)
                                //    {
                                //        emp_tax = 2400;
                                //    }
                                //}
                                //else
                                //{
                                //    emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                                //    if (emp_tax > 2400)
                                //    {
                                //        emp_tax = 2400;
                                //    }
                                //}
                            }


                            aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                            Income_chargable = balance - aggregate_of_4; //6

                            total_gross_income = Income_chargable + other - houseloan_allownace;

                            deductible = Convert.ToDecimal(max_allowance);
                            total_income = total_gross_income - deductible;
                            //total_income = Convert.ToDecimal(841240.01);
                            round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                            //tax_deducted_at_source is calculating as incometax value of current financial year.
                            decimal tax_deducted_at_source1 = 0;
                            if (dt_incometax.Rows.Count > 0)
                            {
                                DataRow incometax = dt_incometax.Rows[0];

                                object val = incometax["income_tax"];
                                if (val == DBNull.Value)
                                {
                                    tax_deducted_at_source1 = 0;
                                }
                                else
                                {
                                    tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                                }
                            }

                            if (total_income > 500000)
                            {
                                //strConvert = income.ToString();
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = 0;
                                edu_cess = income * 4 / 100;

                                tax_payable = (float)income + edu_cess;
                                tax_payable = (int)Math.Round(tax_payable);


                                //if (tax_till > tax_payable)
                                //{
                                //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                                //}
                                //else
                                //{
                                //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                                //}
                                tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                                if (tax_balance < 0)
                                {
                                    tax_balance = 0;
                                }
                                tot_months = months - 1;
                                if (tot_months > 0)
                                {
                                    tds_per_month = tax_balance / tot_months;
                                }
                                else
                                {
                                    tds_per_month = tax_balance;// tot_months;
                                }
                                //tds_per_month = tax_balance / months;
                                if (Financial_md.Month != 03)
                                {
                                    int x = (int)Math.Round(tds_per_month);
                                    int y = (int)Math.Round(x / 100d, 0) * 100;
                                    rounding_tds_per_month = y;
                                }
                                else
                                {
                                    int xp = (int)Math.Round(tds_per_month);
                                    int Z = (10 - xp % 10) + xp;
                                    rounding_tds_per_month = Z;
                                }

                                //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                            }
                            else
                            {
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = Convert.ToDecimal(income);
                                edu_cess = 0;

                                tax_payable = 0;

                                tax_till = 0;
                                tax_balance = 0;

                                tds_per_month = 0;

                                rounding_tds_per_month = 0;
                            }
                            //string employer_name_address = PrConstants.Name;
                            //string employer_pan = PrConstants.PAN;
                            //string employer_tan = PrConstants.TAN;


                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            ////1. trans_id
                            //sbqry.Append(GenNewTransactionString());

                            //int finalSub = 0;

                            if (final == true)
                            {
                                finalSub = 1;
                            }
                            else
                            {
                                finalSub = 0;
                            }

                            string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                            DataTable details = await _sha.Get_Table_FromQry(selQry);
                            if (details.Rows.Count > 0)
                            {
                                NewNumIndex++;
                                DataRow finaldt = details.Rows[0];
                                string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                sbqry.Append(tdsdelete);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                int finalCount = Convert.ToInt32(finaldt["final"]);

                                if (finalCount == 1)
                                {
                                    return "E#TDS Process#Employee Already Processed..!!";
                                }
                                else
                                {
                                    NewNumIndex++;
                                    string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                                    sbqry.Append(tdsUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));



                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        foreach (var ccDatas in lstCer)
                                        {
                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        foreach (var cccDatas in lstCCC)
                                        {
                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }



                            }
                            else
                            {

                                try
                                {


                                    NewNumIndex++;
                                    string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate1);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate2);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var ccDatas in lstCer)
                                        {

                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate3);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var cccDatas in lstCCC)
                                        {

                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            //NewNumIndex++;
                                            //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                            //sbqry.Append(tdsUpdate3);
                                            //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate4);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }
                                catch (Exception e)
                                {
                                    return "E#TDS Process#" + e.Message;
                                }
                            }
                            //}
                        }
                        else if (optn.Rows[0]["Option"].ToString() == "2" && dtretiredate.Rows.Count == 0 && zerobasic > 0)
                        {
                            decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                                   .Where(x => x["constant"].ToString() == "Section80C")
                                   .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                            decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80CCD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                            decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80U")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DDB")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                            decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_P")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                            decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_F")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                            decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80EE")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section24(b)")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                            decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80G")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                            decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80GGB")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                            DataTable _dtFY_FM = ds1.Tables[1];
                            _incometaxdbconstant = ds1.Tables[2];


                            //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                                "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                                "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + "and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and spl_type='Regular' and fy = " + iFY + " order by id desc); ";

                            //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                                "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                                "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                            //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                            string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                            //allowance ==>Get and Sum all previous months allowances 
                            string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                            //allowance ==> Get all current month allowances
                            string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                            //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                            ////sum Personal Allowance
                            //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                            //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                            ////sum FPIIP
                            //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                            //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                            //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                            //sum PFPerks                                                   
                            string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                            // sum LOANPerks                                                    
                            string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                            // sum Incentive                                                    
                            string incentive = "select distinct sum(amount) as incentive from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            // sum  val 17 -2
                            string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                                 "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                            // sum val 17 -3
                            string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                                "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                                " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                            //rent allowance
                            //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                            string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                            //other
                            string otherQry = "select distinct sum(amount) as other from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                        "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            //house loan
                            string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                            //section 80c
                            //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                            //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                            //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                            string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                               "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                               "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                               "from pr_emp_payslip where active = 1 and emp_code = " + Convert.ToInt32(empCode) + " union " +
                               "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                               "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + "";

                            //section 80ccc
                            string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                            //section 80ccd
                            string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                                " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                            //section other section
                            string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                            //tax till
                            string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            //other tds deductions
                            //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                            string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                                "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                            string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                                "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                            //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                            //VPF
                            string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm < '" + FM + "' and p.fm >= '" + startYear + "';";

                            string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff;";

                            string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                            string nolopsbasic = "select top 1 (er_basic) as basic,(er_da) as da_percent,(er_cca) as cca,(er_hra) as hra,(er_interim_relief) as int_ref, (er_telangana_inc) as t_inc,(spl_da) as spl_da, (spl_allw) as spl_allowance from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy=" + iFY + " " +
                                " and lop=0 and working_days=(select month_days from pr_month_details where fm='" + FM + "');";

                            string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                      " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                      " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                            string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                                " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                                " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                            DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                                SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                                cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                                strdatediff + strincometax + nolopsbasic + SumAllowanceQrynew + ActiveSumAllowanceQrynew);

                            //tables
                            var dtGeneral = ds.Tables[0];
                            var dtBasic = ds.Tables[1];
                            var dtBasicSum = ds.Tables[2];
                            var dtAllowance = ds.Tables[3];
                            var dtSumAllowance = ds.Tables[4];

                            var dtPfperks = ds.Tables[5];
                            var dtLoanPerks = ds.Tables[6];
                            var dtIncentives = ds.Tables[7];
                            var dt172 = ds.Tables[8];
                            var dt173 = ds.Tables[9];
                            var dtRent = ds.Tables[10];
                            var dtOther = ds.Tables[11];
                            var dtHouse = ds.Tables[12];

                            var dtCD = ds.Tables[13];
                            var dtCCC = ds.Tables[14];
                            var dtCCD = ds.Tables[15];
                            var dtEdu = ds.Tables[16];
                            var dtTax = ds.Tables[17];
                            var dtTDS = ds.Tables[18];
                            var dtEmpTax = ds.Tables[19];
                            var dtVpf = ds.Tables[20];
                            var dtActiveSumAllowance = ds.Tables[21];
                            var dt_datediff = ds.Tables[22];
                            var dt_incometax = ds.Tables[23];
                            var dt_nolopbasic = ds.Tables[24];
                            var dt_sumbasicnolop = ds.Tables[25];
                            var dtSumAllowancenew = ds.Tables[26];
                            var dtActiveSumAllowancenew = ds.Tables[27];

                            int loss_months = 0;
                            decimal? vpf_data = 0;
                            decimal? pf = 0;

                            if (dtEmpTax.Rows.Count > 0)
                            {
                                DataRow empTax = dtEmpTax.Rows[0];

                                object val = empTax["loss"];
                                if (val == DBNull.Value)
                                {
                                    loss_months = 0;
                                }
                                else
                                {
                                    loss_months = Convert.ToInt32(empTax["loss"]);
                                }

                            }
                            //vpf

                            if (dtVpf.Rows.Count > 0)
                            {
                                DataRow vpfData = dtVpf.Rows[0];

                                object val = vpfData["amount"];
                                if (val == DBNull.Value)
                                {
                                    vpf_data = 0;
                                }
                                else
                                {
                                    vpf_data = Convert.ToDecimal(vpfData["amount"]);
                                }

                            }

                            // General Data
                            if (dtGeneral.Rows.Count > 0)
                            {
                                DataRow gen = dtGeneral.Rows[0];
                                name = Convert.ToString(gen["name"]);
                                per_address = Convert.ToString(gen["per_address"]);
                                pan_no = Convert.ToString(gen["pan_no"]);
                                emp_code = Convert.ToString(gen["emp_code"]);
                                designation = Convert.ToString(gen["designation"]);
                                sex = Convert.ToString(gen["sex"]);
                                fm = fin_month;
                            }

                            //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            if (dt_lopdays.Rows.Count > 0)
                            {
                                if (dt_nolopbasic.Rows.Count > 0)
                                {

                                    DataRow rbasic = dt_nolopbasic.Rows[0];

                                    //basic 
                                    object val = rbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        pbasic = 0;
                                    }
                                    else
                                    {
                                        pbasic = Convert.ToDecimal(rbasic["basic"]) * (monthsnew);
                                    }

                                    //da_percent 
                                    object val1 = rbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        pda_percent = 0;
                                    }
                                    else
                                    {
                                        pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * (monthsnew);
                                    }
                                    //cca
                                    object val2 = rbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        pcca = 0;
                                    }
                                    else
                                    {
                                        pcca = Convert.ToDecimal(rbasic["cca"]) * (monthsnew);
                                    }
                                    //hra
                                    object val3 = rbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        phra = 0;
                                    }
                                    else
                                    {
                                        phra = Convert.ToDecimal(rbasic["hra"]) * (monthsnew);
                                    }
                                    //int_ref
                                    object va4 = rbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        pint_ref = 0;
                                    }
                                    else
                                    {
                                        pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * (monthsnew);
                                    }

                                    object val5 = rbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        pt_inc = 0;
                                    }
                                    else
                                    {
                                        pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * (monthsnew);
                                    }

                                    object val6 = rbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        pspl_da = 0;
                                    }
                                    else
                                    {
                                        pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * (monthsnew);
                                    }

                                    object val7 = rbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        pspl_allowance = 0;
                                    }
                                    else
                                    {
                                        pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * (monthsnew);
                                    }




                                }
                            }
                            else
                            {
                                if (dtBasic.Rows.Count > 0)
                                {

                                    DataRow rbasic = dtBasic.Rows[0];

                                    //basic 
                                    object val = rbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        pbasic = 0;
                                    }
                                    else
                                    {
                                        pbasic = Convert.ToDecimal(rbasic["basic"]) * months;
                                    }

                                    //da_percent 
                                    object val1 = rbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        pda_percent = 0;
                                    }
                                    else
                                    {
                                        pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months;
                                    }
                                    //cca
                                    object val2 = rbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        pcca = 0;
                                    }
                                    else
                                    {
                                        pcca = Convert.ToDecimal(rbasic["cca"]) * months;
                                    }
                                    //hra
                                    object val3 = rbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        phra = 0;
                                    }
                                    else
                                    {
                                        phra = Convert.ToDecimal(rbasic["hra"]) * months;
                                    }
                                    //int_ref
                                    object va4 = rbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        pint_ref = 0;
                                    }
                                    else
                                    {
                                        pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months;
                                    }

                                    object val5 = rbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        pt_inc = 0;
                                    }
                                    else
                                    {
                                        pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months;
                                    }

                                    object val6 = rbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        pspl_da = 0;
                                    }
                                    else
                                    {
                                        pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months;
                                    }

                                    object val7 = rbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        pspl_allowance = 0;
                                    }
                                    else
                                    {
                                        pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months;
                                    }




                                }
                            }
                            // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            if (dt_lopdays.Rows.Count > 0)
                            {
                                if (dt_sumbasicnolop.Rows.Count > 0)
                                {
                                    DataRow sbasic = dt_sumbasicnolop.Rows[0];

                                    //basic 
                                    object val = sbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        basic = 0 + pbasic;
                                    }
                                    else
                                    {
                                        basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    }

                                    //da_percent 
                                    object val1 = sbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        da_percent = Convert.ToDecimal(0 + pda_percent);
                                    }
                                    else
                                    {
                                        da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    }
                                    //cca
                                    object val2 = sbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        cca = Convert.ToDecimal(0 + pcca);
                                    }
                                    else
                                    {
                                        cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    }
                                    //hra
                                    object val3 = sbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        hra = Convert.ToDecimal(0 + phra);
                                    }
                                    else
                                    {
                                        hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    }
                                    //int_ref
                                    object va4 = sbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        int_ref = 0 + pint_ref;
                                    }
                                    else
                                    {
                                        int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    }

                                    object val5 = sbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        t_inc = 0 + pt_inc;
                                    }
                                    else
                                    {
                                        t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    }

                                    object val6 = sbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        spl_da = 0 + pspl_da;
                                    }
                                    else
                                    {
                                        spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    }

                                    object val7 = sbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        spl_allowance = 0 + pspl_allowance;
                                    }
                                    else
                                    {
                                        spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                    }

                                    object val8 = sbasic["pf"];
                                    if (val8 == DBNull.Value)
                                    {
                                        pf = 0;
                                    }
                                    else
                                    {
                                        pf = Convert.ToDecimal(sbasic["pf"]);
                                    }



                                    //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                                }
                            }
                            else
                            {
                                if (dtBasicSum.Rows.Count > 0)
                                {
                                    DataRow sbasic = dtBasicSum.Rows[0];

                                    //basic 
                                    object val = sbasic["basic"];
                                    if (val == DBNull.Value)
                                    {
                                        basic = 0 + pbasic;
                                    }
                                    else
                                    {
                                        basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    }

                                    //da_percent 
                                    object val1 = sbasic["da_percent"];
                                    if (val1 == DBNull.Value)
                                    {
                                        da_percent = Convert.ToDecimal(0 + pda_percent);
                                    }
                                    else
                                    {
                                        da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    }
                                    //cca
                                    object val2 = sbasic["cca"];
                                    if (val2 == DBNull.Value)
                                    {
                                        cca = Convert.ToDecimal(0 + pcca);
                                    }
                                    else
                                    {
                                        cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    }
                                    //hra
                                    object val3 = sbasic["hra"];
                                    if (val3 == DBNull.Value)
                                    {
                                        hra = Convert.ToDecimal(0 + phra);
                                    }
                                    else
                                    {
                                        hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    }
                                    //int_ref
                                    object va4 = sbasic["int_ref"];
                                    if (va4 == DBNull.Value)
                                    {
                                        int_ref = 0 + pint_ref;
                                    }
                                    else
                                    {
                                        int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    }

                                    object val5 = sbasic["t_inc"];
                                    if (val5 == DBNull.Value)
                                    {
                                        t_inc = 0 + pt_inc;
                                    }
                                    else
                                    {
                                        t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    }

                                    object val6 = sbasic["spl_da"];
                                    if (val6 == DBNull.Value)
                                    {
                                        spl_da = 0 + pspl_da;
                                    }
                                    else
                                    {
                                        spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    }

                                    object val7 = sbasic["spl_allowance"];
                                    if (val7 == DBNull.Value)
                                    {
                                        spl_allowance = 0 + pspl_allowance;
                                    }
                                    else
                                    {
                                        spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                    }

                                    object val8 = sbasic["pf"];
                                    if (val8 == DBNull.Value)
                                    {
                                        pf = 0;
                                    }
                                    else
                                    {
                                        pf = Convert.ToDecimal(sbasic["pf"]);
                                    }



                                    //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                    //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                    //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                    //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                    //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                    //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                    //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                    //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                                }
                            }


                            //present allowances pper_allowance,pfpa_allow,pfpiip

                            //foreach (DataRow algen in dtAllowance.Rows)
                            //{


                            //    string alw_name = algen["all_name"].ToString();
                            //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                            //    if (alw_name == "Fixed Personal Allowance")
                            //    {
                            //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == "FPA-HRA Allowance")
                            //    {
                            //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == PrConstants.FPIIP)
                            //    {
                            //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                            //    }

                            //}

                            ////dtSumFixed
                            //if (dtSumFixed.Rows.Count > 0)
                            //{
                            //    DataRow sumf = dtSumFixed.Rows[0];

                            //    object val = sumf["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        per_allowance = 0 + pper_allowance;
                            //    }
                            //    else
                            //    {
                            //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                            //    }

                            //}
                            ////dtsumFPA
                            //if (dtsumFPA.Rows.Count > 0)
                            //{
                            //    DataRow sumfpa = dtsumFPA.Rows[0];

                            //    object val = sumfpa["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpa_allow = 0 + pfpa_allow;
                            //    }
                            //    else
                            //    {
                            //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                            //    }

                            //}
                            ////dtsumfpiip
                            //if (dtsumfpiip.Rows.Count > 0)
                            //{
                            //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                            //    object val = sumfpiip["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpiip = 0 + pfpiip;
                            //    }
                            //    else
                            //    {
                            //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                            //    }
                            //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                            //}

                            //getting the date difference from finstart year and current year for allowance
                            if (dt_datediff.Rows.Count > 0)
                            {
                                datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                            }

                            List<OldAllowance> oldList = new List<OldAllowance>();
                            //foreach (DataRow dtold in dtSumAllowance.Rows)
                            //{
                            //    OldAllowance objoldlist = new OldAllowance();
                            //    objoldlist.old_Name = dtold["all_name"].ToString();
                            //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                            //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                            //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                            //    oldList.Add(objoldlist);
                            //}
                            foreach (DataRow dtold in dtSumAllowancenew.Rows)
                            {
                                OldAllowance objoldlist = new OldAllowance();
                                objoldlist.old_Name = dtold["all_name"].ToString();
                                //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                                objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                                //objoldlist.old_alw_type = dtold["all_type"].ToString();
                                oldList.Add(objoldlist);
                            }


                            List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                            //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                            //{

                            //    ActiveAllowance NewObjlist = new ActiveAllowance();
                            //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                            //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                            //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                            //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                            //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                            //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                            //    if (olditem != null)
                            //    {
                            //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                            //    }

                            //    NewActiveList.Add(NewObjlist);
                            //}
                            foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                            {

                                ActiveAllowance NewObjlist = new ActiveAllowance();
                                NewObjlist.Active_Name = dtActive["all_name"].ToString();
                                //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months;
                                NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * monthsnew;
                                //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                                //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                                var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                                if (olditem != null)
                                {
                                    NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                                    NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                                }

                                NewActiveList.Add(NewObjlist);
                            }


                            //if not in new list then add
                            //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            //{
                            //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                            //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                            //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                            //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                            //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                            //    if (olditem == null)
                            //    {
                            //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            //        NewActiveList.Add(NewObjlist1);
                            //    }
                            //}
                            foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                            {
                                ActiveAllowance NewObjlist1 = new ActiveAllowance();
                                NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                                //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                                //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                                var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                                if (olditem == null)
                                {
                                    NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                                    NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                                    NewActiveList.Add(NewObjlist1);
                                }
                            }
                            var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                            if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                            {
                                await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                            }
                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            //1. trans_id
                            //sbqry.Append(GenNewTransactionString());
                            decimal total_allowance = 0;
                            //foreach (var newlist in NewActiveList)
                            //{
                            //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                            //    NewNumIndex++;
                            //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                            //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                            //    sbqry.Append(newqry);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            //}
                            foreach (var newlist in NewActiveList)
                            {
                                total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                                var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                                    " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                                    "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                                    " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                                sbqry.Append(newqry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            }



                            //List<string> lststring = new List<string>();
                            //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                            //// dtPfPerks
                            //if (dtPfperks.Rows.Count > 0)
                            //{
                            //    DataRow pfPerk = dtPfperks.Rows[0];

                            //    object val = pfPerk["pf_perk"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        pf_perk = 0;
                            //    }
                            //    else
                            //    {
                            //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                            //    }

                            //}
                            //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                            
                            //dtLoanPerks
                            if (dtLoanPerks.Rows.Count > 0)
                            {
                                DataRow lperk = dtLoanPerks.Rows[0];

                                object val = lperk["loan_perk"];
                                if (val == DBNull.Value)
                                {
                                    loan_perk = 0;
                                }
                                else
                                {
                                    loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                                }

                            }
                            //dtIncentives
                            if (dtIncentives.Rows.Count > 0)
                            {
                                DataRow ins = dtIncentives.Rows[0];

                                object val = ins["incentive"];
                                if (val == DBNull.Value)
                                {
                                    incentives = 0;
                                }
                                else
                                {
                                    incentives = Convert.ToDecimal(ins["incentive"]);
                                }

                            }
                            //dt172
                            if (dt172.Rows.Count > 0)
                            {
                                DataRow VAL = dt172.Rows[0];
                                object val = VAL["val172"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_2 = 0;
                                }
                                else
                                {
                                    values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                                    totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                                }
                            }
                            //dt173
                            if (dt173.Rows.Count > 0)
                            {
                                DataRow VAL1 = dt173.Rows[0];
                                object val = VAL1["val173"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_3 = 0;
                                }
                                else
                                {
                                    values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                                }
                            }

                            if (dtRent.Rows.Count > 0)
                            {
                                //DataRow rents = dtRent.Rows[0];

                                //object val = rents["rentamount"];
                                //if (val == DBNull.Value)
                                //{
                                //    house_rent_allowance = 0;
                                //}
                                //else
                                //{
                                //    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                                //}
                            }

                            if (house_rent_allowance > 0)
                            {
                                decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                                //salary(a)
                                decimal salary = da_percent + Convert.ToDecimal(basic);
                                //40%  of salary(b)
                                decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                                //houserentpaid - 10% of salary(c)
                                decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                                //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                                house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                                // HouseRentAllowance calculated as on 04-09-2020
                                // minimun values of (
                                // Basic+DA --40%,
                                // House Rent Paid minus Basic+DA --10% 
                                // HRA)
                            }
                            //decimal daval = Convert.ToDecimal(da);
                            //decimal hraval = Convert.ToDecimal(hra);
                            //rent amount
                            if (house_rent_allowance < 0)
                            {
                                house_rent_allowance = 0;
                            }



                            if (dtOther.Rows.Count > 0)
                            {
                                DataRow otr = dtOther.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = otr["other"];
                                if (val == DBNull.Value)
                                {
                                    other = 0;
                                }
                                else
                                {
                                    other = Convert.ToDecimal(otr["other"]);
                                }

                            }

                            if (dtHouse.Rows.Count > 0)
                            {
                                //foreach (DataRow dr in dtHouse.Rows)
                                //{
                                //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                                //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                                //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                                //        || dr["loan_type_mid"].ToString() == "13")
                                //    {
                                //        count++;
                                //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                                //    }

                                //}
                                //DataRow dh = dtHouse.Rows[0];

                                ////other = Convert.ToDecimal(otr["other"]);

                                //object val = dh["amount"];
                                //if (val == DBNull.Value)
                                //{
                                //    houseloan_allownace = 0;
                                //}
                                //else
                                //{
                                //    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                                //}

                            }
                            //if (count > 0)
                            //{

                            //    houseloan_allownace = 200000;
                            //}

                            //IList<section80C> lstCer = new List<section80C>();
                            //IList<section80CCC> lstCCC = new List<section80CCC>();
                            //IList<section80CCD> lstCCD = new List<section80CCD>();
                            //IList<sectionOther> lstOther = new List<sectionOther>();

                            decimal pf_new = 0;
                            if (dtCD.Rows.Count > 0)
                            {
                                foreach (DataRow cer in dtCD.Rows)
                                {
                                    //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                                    decimal? amount = 0;

                                    object val = cer["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(cer["amount"]);
                                    }

                                    string dd_name = Convert.ToString(cer["name"].ToString());
                                    if (dd_name == "Provident Fund")
                                    {
                                        amount = Convert.ToDecimal(pf + (amount * months));
                                        pf_new = Convert.ToDecimal(amount);
                                    }
                                    else if (dd_name == "VPF")
                                    {
                                        amount = Convert.ToDecimal(vpf_data + (amount * months));
                                    }
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        //lstCer.Add(new section80C
                                        //{
                                        //    id = cer["id"].ToString(),
                                        //    name = cer["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //});
                                    }
                                    else
                                    {
                                        //lstCer.Add(new section80C
                                        //{
                                        //    id = cer["id"].ToString(),
                                        //    name = cer["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal("0"),
                                        //    ded_amount = AddZerosAfterDecimal("0")
                                        //});
                                    }

                                }


                            }
                            else
                            {
                                //lstCer.Add(new section80C
                                //{
                                //    id = "",
                                //    name = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }
                            decimal pf_perkcal = 0.5m;
                            decimal pf_perktemp = 12.5m;
                            pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                            if (dtCCC.Rows.Count > 0)
                            {
                                foreach (DataRow ccc in dtCCC.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        //lstCCC.Add(new section80CCC
                                        //{
                                        //    id = ccc["id"].ToString(),
                                        //    name = ccc["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //});
                                    }
                                    else
                                    {
                                        //lstCCC.Add(new section80CCC
                                        //{
                                        //    id = ccc["id"].ToString(),
                                        //    name = ccc["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                                        //    allowance_amount = AddZerosAfterDecimal("0"),
                                        //    ded_amount = AddZerosAfterDecimal("0")
                                        //});
                                    }

                                }

                            }
                            else
                            {

                                //lstCCC.Add(new section80CCC
                                //{
                                //    id = "",
                                //    name = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                            if (dtCCD.Rows.Count > 0)
                            {
                                foreach (DataRow ccd in dtCCD.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                                    {
                                        if (amount > min_allowance80CCD)
                                        {
                                            allowance_amount = min_allowance80CCD;
                                            min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                            max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance80CCD = min_allowance80CCD - amount;
                                            allowance_amount = amount;
                                            max_allowance80CCD = max_allowance80CCD + amount;
                                        }

                                        //lstCCD.Add(new section80CCD
                                        //{
                                        //    id = ccd["id"].ToString(),
                                        //    name = ccd["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //});
                                    }
                                    else
                                    {

                                        //lstCCD.Add(new section80CCD
                                        //{
                                        //    id = ccd["id"].ToString(),
                                        //    name = ccd["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                        //    allowance_amount = AddZerosAfterDecimal("0"),
                                        //    ded_amount = AddZerosAfterDecimal("0")
                                        //});
                                    }
                                }
                            }
                            else
                            {

                                //lstCCD.Add(new section80CCD
                                //{
                                //    id = "",
                                //    name = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                            if (dtEdu.Rows.Count > 0)
                            {
                                foreach (DataRow ed in dtEdu.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                                    String sectionNAme = ed["section"].ToString();
                                    decimal? allowance_amount = 0;
                                    string id = ed["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = ed["name"].ToString();
                                    if (sectionNAme == "Section80G")
                                    {
                                        allowance_amount = amount * section80g;
                                        max_allowanceGG = max_allowanceGG + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80GGB")
                                    {
                                        allowance_amount = amount * section80gg;
                                        max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80DDB")
                                    {
                                        if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                        {
                                            if (amount > min_allowance80DDB)
                                            {
                                                allowance_amount = min_allowance80DDB;
                                                ded_amount = allowance_amount;
                                                min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                                max_allowance80DB = max_allowance80DB + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DDB = min_allowance80DDB - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DB = max_allowance80DB + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                    }
                                    else if (sectionNAme == "Section80DD")
                                    {
                                        if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                        {
                                            if (amount > min_allowance80DD)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80DD = min_allowance80DD - allowance_amount;
                                                max_allowance80DD = max_allowance80DD + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DD = min_allowance80DD - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DD = max_allowance80DD + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80U")
                                    {
                                        if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                        {
                                            if (amount > min_allowance80U)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80U = min_allowance80U - allowance_amount;
                                                max_allowance80U = max_allowance80U + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80U = min_allowance80U - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80U = max_allowance80U + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80E")
                                    {
                                        allowance_amount = amount;
                                        max_allowance = max_allowance + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    else if (sectionNAme == "Section80D_P")
                                    {
                                        if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                        {
                                            if (amount > min_allowance80D_P)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                                max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_P = min_allowance80D_P - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_P = max_allowance80D_P + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                        //if (min_allowance80D_P > amount)
                                        //{
                                        //    allowance_amount = amount;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}

                                        //else
                                        //{
                                        //    allowance_amount = min_allowance80D_P;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}
                                    }
                                    else if (sectionNAme == "Section80D_F")
                                    {
                                        if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                        {
                                            if (amount > min_allowance80D_F)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                                max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_F = min_allowance80D_F - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_F = max_allowance80D_F + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"||sectionNAme == "Section80EE_HL")
                                    {
                                        if (sectionNAme != "Section80EE")
                                        {
                                            sectionNAme = "Section80EE_HL";
                                        }
                                        if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                        {
                                            if (amount > min_allowance80EE)
                                            {
                                                allowance_amount = min_allowance80EE;
                                                min_allowance80EE = min_allowance80EE - allowance_amount;
                                                max_allowance80ee = max_allowance80ee + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80EE = min_allowance80EE - amount;
                                                allowance_amount = amount;
                                                max_allowance80ee = max_allowance80ee + amount;
                                            }
                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;

                                        }
                                    }

                                    else if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    //lstOther.Add(new sectionOther
                                    //{
                                    //    id = id,
                                    //    name = actName,
                                    //    section = sectionNAme,
                                    //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    //});

                                }

                            }

                            else
                            {
                                //lstOther.Add(new sectionOther
                                //{
                                //    id = "",
                                //    name = "",
                                //    section = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }
                            max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                            if (dtTax.Rows.Count > 0)
                            {


                                DataRow tax = dtTax.Rows[0];

                                object val = tax["tax_deducted_at_source"];
                                if (val == DBNull.Value)
                                {
                                    total_tax_till = 0;
                                }
                                else
                                {
                                    total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                                }

                                tax_till = totaltaxdeductedfrm16 + total_tax_till;
                                tax_till = 0; // for all employees this tax is 0

                            }

                            if (dtTDS.Rows.Count > 0)
                            {
                                DataRow TDS = dtTDS.Rows[0];

                                object val = TDS["tds_amount"];
                                if (val == DBNull.Value)
                                {
                                    paid_by_emp = 0;
                                }
                                else
                                {
                                    paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                                }
                            }

                            IList<TDSProcess> lstTDS = new List<TDSProcess>();

                            gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                            total_section = house_rent_allowance;

                            balance = gross - total_section;
                            //standard_deduction = PrConstants.STANDARD_DEDUCTION;
                            //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                            //if (emp_tax > 2400)
                            //{
                            //    emp_tax = 2400;
                            //}
                            //aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                            Income_chargable = balance;// - aggregate_of_4; //6

                            total_gross_income = Income_chargable + other - houseloan_allownace;

                            deductible = Convert.ToDecimal(max_allowance);
                            total_income = total_gross_income - deductible;
                            //total_income = Convert.ToDecimal(841240.01);
                            round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));

                            //tax_deducted_at_source is calculating as incometax value of current financial year.
                            decimal tax_deducted_at_source1 = 0;
                            if (dt_incometax.Rows.Count > 0)
                            {
                                DataRow incometax = dt_incometax.Rows[0];

                                object val = incometax["income_tax"];
                                if (val == DBNull.Value)
                                {
                                    tax_deducted_at_source1 = 0;
                                }
                                else
                                {
                                    tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                                }
                            }

                            if (total_income > 500000)
                            {
                                //strConvert = income.ToString();
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = 0;
                                edu_cess = income * 4 / 100;

                                tax_payable = (float)income + edu_cess;
                                tax_payable = (int)Math.Round(tax_payable);


                                //if (tax_till > tax_payable)
                                //{
                                //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                                //}
                                //else
                                //{
                                //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                                //}
                                tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                                if (tax_balance < 0)
                                {
                                    tax_balance = 0;
                                }

                                tds_per_month = tax_balance / months;
                                if (Financial_md.Month != 03)
                                {
                                    int x = (int)Math.Round(tds_per_month);
                                    int y = (int)Math.Round(x / 100d, 0) * 100;
                                    rounding_tds_per_month = y;
                                }
                                else
                                {
                                    int xp = (int)Math.Round(tds_per_month);
                                    int Z = (10 - xp % 10) + xp;
                                    rounding_tds_per_month = Z;
                                }

                                //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                            }
                            else
                            {
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = Convert.ToDecimal(income);
                                edu_cess = 0;

                                tax_payable = 0;

                                tax_till = 0;
                                tax_balance = 0;

                                tds_per_month = 0;

                                rounding_tds_per_month = 0;
                            }
                            //string employer_name_address = PrConstants.Name;
                            //string employer_pan = PrConstants.PAN;
                            //string employer_tan = PrConstants.TAN;

                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            ////1. trans_id
                            //sbqry.Append(GenNewTransactionString());

                            //int finalSub = 0;

                            if (final == true)
                            {
                                finalSub = 1;
                            }
                            else
                            {
                                finalSub = 0;
                            }

                            string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                            DataTable details = await _sha.Get_Table_FromQry(selQry);
                            if (details.Rows.Count > 0)
                            {
                                NewNumIndex++;
                                DataRow finaldt = details.Rows[0];
                                string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                sbqry.Append(tdsdelete);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                int finalCount = Convert.ToInt32(finaldt["final"]);

                                if (finalCount == 1)
                                {
                                    return "E#TDS Process#Employee Already Processed..!!";
                                }
                                else
                                {
                                    NewNumIndex++;
                                    string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                                    sbqry.Append(tdsUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));


                                    //if (tdsData != null)
                                    //{
                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //}

                                    //if (lstCer != null)
                                    //{
                                    //    foreach (var ccDatas in lstCer)
                                    //    {
                                    //        if (ccDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstCCC != null)
                                    //{
                                    //    foreach (var cccDatas in lstCCC)
                                    //    {
                                    //        if (cccDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstCCD != null)
                                    //{
                                    //    foreach (var ccdDatas in lstCCD)
                                    //    {
                                    //        if (ccdDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstOther != null)
                                    //{
                                    //    foreach (var otherDatas in lstOther)
                                    //    {
                                    //        if (otherDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                                    //{
                                    //    //return "I#TDS Process#TDS Processed Successfully..!!";
                                    //}
                                    //else
                                    //{
                                    //    //return "E#TDS Process#Error While TDS Process..!!";
                                    //}
                                }



                            }
                            else
                            {

                                try
                                {

                                    //if (tdsData != null)
                                    //{
                                    NewNumIndex++;
                                    string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate1);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //}

                                    //if (lstCer != null)
                                    //{
                                    //    NewNumIndex++;
                                    //    string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //    sbqry.Append(tdsUpdate2);
                                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    //    foreach (var ccDatas in lstCer)
                                    //    {

                                    //        if (ccDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstCCC != null)
                                    //{
                                    //    NewNumIndex++;
                                    //    string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //    sbqry.Append(tdsUpdate3);
                                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    //    foreach (var cccDatas in lstCCC)
                                    //    {

                                    //        if (cccDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstCCD != null)
                                    //{
                                    //    foreach (var ccdDatas in lstCCD)
                                    //    {
                                    //        NewNumIndex++;
                                    //        string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //        sbqry.Append(tdsUpdate3);
                                    //        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    //        if (ccdDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstOther != null)
                                    //{
                                    //    NewNumIndex++;
                                    //    string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //    sbqry.Append(tdsUpdate4);
                                    //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    //    foreach (var otherDatas in lstOther)
                                    //    {
                                    //        if (otherDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                                    //{
                                    //    //return "I#TDS Process#TDS Processed Successfully..!!";
                                    //}
                                    //else
                                    //{
                                    //    //return "E#TDS Process#Error While TDS Process..!!";
                                    //}
                                }
                                catch (Exception e)
                                {
                                    return "E#TDS Process#" + e.Message;
                                }
                            }
                            //}
                        }
                        else if (optn.Rows[0]["Option"].ToString() == "1" && dtretiredate.Rows.Count > 0 && zerobasic > 0)
                        {
                            decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                                   .Where(x => x["constant"].ToString() == "Section80C")
                                   .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                            decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80CCD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                            decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80U")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DDB")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                            decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_P")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                            decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_F")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                            decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80EE")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section24(b)")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80G")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                            decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80GGB")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                            DataTable _dtFY_FM = ds1.Tables[1];
                            _incometaxdbconstant = ds1.Tables[2];


                            //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                                "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                                "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + " and fy = " + iFY + " and " +
                                "id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm = '" + FM + "' and spl_type='Regular'); ";

                            //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                                "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                                "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";

                            //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                            string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                            //allowance ==>Get and Sum all previous months allowances 
                            string SumAllowanceQry = "select distinct c.all_mid,c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount!=0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid;";

                            //allowance ==> Get all current month allowances
                            string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                            //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                            ////sum Personal Allowance
                            //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                            //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                            ////sum FPIIP
                            //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                            //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                            //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                            //sum PFPerks                                                   
                            string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                            // sum LOANPerks                                                    
                            string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                            // sum Incentive                                                    
                            string incentive = "select distinct sum(amount) as incentive from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            // sum  val 17 -2
                            string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                                 "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                            // sum val 17 -3
                            string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                                "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                                " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                            //rent allowance
                            //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                            string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                            //other
                            string otherQry = "select distinct sum(amount) as other from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                        "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            //house loan
                            string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                            //section 80c
                            //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                            //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                            //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                            string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                               "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                               "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                               "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and active=1 union all " +
                               " select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                               "paydedu where paydedu.dd_name = 'VPF Deduction' and emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in (select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                               " union all " +
                                "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " and active=1 order by id desc) " +
                                "union all " +
                               "select '4' as id, 'Housing Loan Main' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan Main' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '5' as id, 'Housing Addl.Loan - 2D' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Addl.Loan - 2D' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                               "union all " +
                               "select '6' as id, 'GSLI' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'GSLI' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy =" + iFY + " order by id desc) " +
                                "union all " +
                                "select '7' as id, 'Housing Loan 2B-2C' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2B-2C' and emp_code = " + Convert.ToInt32(empCode) + "  and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                                "union all " +
                                "select '8' as id, 'Housing Loan 2A' as name, sum(paydedu.dd_amount) as amount  from pr_emp_payslip_deductions paydedu where paydedu.dd_name = 'Housing Loan 2A' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " order by id desc) " +
                                " union all " +
                       " select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                        "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                        "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC';";

                            //section 80ccc
                            string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                            //section 80ccd
                            string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                                " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                            //section other section
                            string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                            //tax till
                            string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            //other tds deductions
                            //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                            string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                                "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                            string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                                "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";
                            string chkph = "select * from pr_emp_general where emp_code= " + Convert.ToInt32(empCode) + " and phy_handicapped!=1;";
                            //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                            //VPF
                            string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm <= '" + FM + "' and p.fm >= '" + startYear + "';";
                            string loansprevmonth = "select 'Housing Loan Main'as loantype,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =" + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm<'" + FM + "' and fm>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ") and dd_name ='Housing Loan Main' " +
                            " union all " +
                            " select 'Housing Addl.Loan - 2D',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Addl.Loan - 2D' " +
                            "union all  " +
                            "select 'Housing Loan 2B-2C',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code =  " + Convert.ToInt32(empCode) + " and payslip_mid in(select id from pr_emp_payslip where fm < '" + FM + "'  and fm>= '" + startYear + "'  and emp_code =  " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2B-2C' " +
                            "union all  " +
                            "select 'Housing Loan 2A',sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + "  and payslip_mid in(select id from pr_emp_payslip where fm <  '" + FM + "' and fm>= '" + startYear + "' and emp_code = " + Convert.ToInt32(empCode) + ") and dd_name = 'Housing Loan 2A' ";

                            string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff, (SELECT DATEDIFF(month,'" + startYear + "',Retirementdate) from Employees where EmpId=" + Convert.ToInt32(empCode) + ") as DateDiffRetire;";

                            string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                            string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                                     " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                                      " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                            string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                                " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                                " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                            string strpf = " select sum(dd_provident_fund) pf  from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'; ";
                            string strprevlicgsli = "select 'LIC' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'LIC' and payslip_mid " +
                                                   " in(select id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "') " +
                                                   "union all" +
                                                   " select 'GSLI' as name,sum(dd_amount) as amount from pr_emp_payslip_deductions where emp_code = " + Convert.ToInt32(empCode) + " and dd_name = 'GSLI' and payslip_mid " +
                                                   " in(select id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm>= '" + startYear + "' and fm<= '" + FM + "');";
                            string tdssections = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross from pr_emp_tds_section_deductions tdssec join " +
                        " pr_deduction_field_master ef on ef.id=tdssec.m_id where tdssec.fm='" + FM + "' and empcode=" + Convert.ToInt32(empCode) + " and tdssec.m_id not " +
                        " in(1,2,3,4,5,6,7,8) and tdssec.section_type='Section80C' and tdssec.gross!=0;";
                            string tdssection24 = "select distinct ef.name,tdssec.empcode,ef.id,tdssec.fm,tdssec.gross,tdssec.section_type as section from pr_emp_tds_section_deductions tdssec join " +
                        "pr_deduction_field_master ef on ef.id = tdssec.m_id where tdssec.fm = '" + FM + "' and empcode = " + Convert.ToInt32(empCode) + " and tdssec.section_type = 'Section24(b)' and tdssec.gross != 0;";

                            DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                                SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                                cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                                loansprevmonth + strdatediff + strincometax + SumAllowanceQrynew + ActiveSumAllowanceQrynew + chkph+strpf+strprevlicgsli+ tdssections+ tdssection24);

                            //tables
                            var dtGeneral = ds.Tables[0];
                            var dtBasic = ds.Tables[1];
                            var dtBasicSum = ds.Tables[2];
                            var dtAllowance = ds.Tables[3];
                            var dtSumAllowance = ds.Tables[4];

                            var dtPfperks = ds.Tables[5];
                            var dtLoanPerks = ds.Tables[6];
                            var dtIncentives = ds.Tables[7];
                            var dt172 = ds.Tables[8];
                            var dt173 = ds.Tables[9];
                            var dtRent = ds.Tables[10];
                            var dtOther = ds.Tables[11];
                            var dtHouse = ds.Tables[12];

                            var dtCD = ds.Tables[13];
                            var dtCCC = ds.Tables[14];
                            var dtCCD = ds.Tables[15];
                            var dtEdu = ds.Tables[16];
                            var dtTax = ds.Tables[17];
                            var dtTDS = ds.Tables[18];
                            var dtEmpTax = ds.Tables[19];
                            var dtVpf = ds.Tables[20];
                            var dtActiveSumAllowance = ds.Tables[21];
                            var dt_prevmonthloans = ds.Tables[22];
                            var dt_datediff = ds.Tables[23];
                            var dt_incometax = ds.Tables[24];
                            var dtSumAllowancenew = ds.Tables[25];
                            var dtActiveSumAllowancenew = ds.Tables[26];
                            var dtph = ds.Tables[27];
                            var dt_strpf = ds.Tables[28];
                            var dt_strprevlicgsli = ds.Tables[29];
                            var dt_tdssections = ds.Tables[30];
                            var dt_tdssection24 = ds.Tables[31];

                            int loss_months = 0;
                            decimal? vpf_data = 0;
                            decimal? pf = 0;
                            decimal? lic = 0;
                            decimal? houseloanmain = 0;
                            decimal? houseAddloan_2d = 0;
                            decimal? houseloan2bc = 0;
                            decimal? houseloan2a = 0;

                            if (dtEmpTax.Rows.Count > 0)
                            {
                                DataRow empTax = dtEmpTax.Rows[0];

                                object val = empTax["loss"];
                                if (val == DBNull.Value)
                                {
                                    loss_months = 0;
                                }
                                else
                                {
                                    loss_months = Convert.ToInt32(empTax["loss"]);
                                }

                            }
                            //vpf

                            if (dtVpf.Rows.Count > 0)
                            {
                                DataRow vpfData = dtVpf.Rows[0];

                                object val = vpfData["amount"];
                                if (val == DBNull.Value)
                                {
                                    vpf_data = 0;
                                }
                                else
                                {
                                    vpf_data = Convert.ToDecimal(vpfData["amount"]);
                                }

                            }

                            // General Data
                            if (dtGeneral.Rows.Count > 0)
                            {
                                DataRow gen = dtGeneral.Rows[0];
                                name = Convert.ToString(gen["name"]);
                                per_address = Convert.ToString(gen["per_address"]);
                                pan_no = Convert.ToString(gen["pan_no"]);
                                emp_code = Convert.ToString(gen["emp_code"]);
                                designation = Convert.ToString(gen["designation"]);
                                sex = Convert.ToString(gen["sex"]);
                                fm = fin_month;
                            }
                            if (dt_prevmonthloans.Rows.Count > 0)
                            {
                                foreach (DataRow dr_prelons in dt_prevmonthloans.Rows)
                                {
                                    int loanid = 0;
                                    int pflag = 0;
                                    int pflag1 = 0;
                                    int countofsub = 0;
                                    int precoverflag = 0;
                                    string val = dr_prelons["loantype"].ToString();
                                    string getloanid = "select id  from pr_loan_master where loan_description='" + val + "'";
                                    DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                                    loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                                    string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                        "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                                    string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                        "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                                    DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                                    DataTable dtcompare = sh.Get_Table_FromQry(comparequery);

                                    if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                                    {
                                        countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                        precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                    }


                                    if (dtchkloaneligibility.Rows.Count > 0)
                                    {
                                        pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                                    }
                                    object amount = dr_prelons["amount"];
                                    if (countofsub != precoverflag)
                                    {
                                        if (val == "Housing Loan Main")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloanmain = 0;
                                            }
                                            else
                                            {
                                                houseloanmain = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Addl.Loan - 2D")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseAddloan_2d = 0;
                                            }
                                            else
                                            {
                                                houseAddloan_2d = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Loan 2B-2C")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloan2bc = 0;
                                            }
                                            else
                                            {
                                                houseloan2bc = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                        else if (val == "Housing Loan 2A")
                                        {
                                            if (amount == DBNull.Value)
                                            {
                                                houseloan2a = 0;
                                            }
                                            else
                                            {
                                                houseloan2a = Convert.ToDecimal(dr_prelons["amount"]);
                                            }
                                        }
                                    }
                                }
                            }

                            //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                            if (dtBasic.Rows.Count > 0)
                            {

                                DataRow rbasic = dtBasic.Rows[0];

                                //basic 
                                object val = rbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    pbasic = 0;
                                }
                                else
                                {
                                    pbasic = Convert.ToDecimal(rbasic["basic"]) * months_1new;
                                }

                                //da_percent 
                                object val1 = rbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    pda_percent = 0;
                                }
                                else
                                {
                                    pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months_1new;
                                }
                                //cca
                                object val2 = rbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    pcca = 0;
                                }
                                else
                                {
                                    pcca = Convert.ToDecimal(rbasic["cca"]) * months_1new;
                                }
                                //hra
                                object val3 = rbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    phra = 0;
                                }
                                else
                                {
                                    phra = Convert.ToDecimal(rbasic["hra"]) * months_1new;
                                }
                                //int_ref
                                object va4 = rbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    pint_ref = 0;
                                }
                                else
                                {
                                    pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months_1new;
                                }

                                object val5 = rbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    pt_inc = 0;
                                }
                                else
                                {
                                    pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months_1new;
                                }

                                object val6 = rbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    pspl_da = 0;
                                }
                                else
                                {
                                    pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months_1new;
                                }

                                object val7 = rbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    pspl_allowance = 0;
                                }
                                else
                                {
                                    pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months_1new;
                                }



                            }

                            // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance



                            if (dtBasicSum.Rows.Count > 0)
                            {
                                DataRow sbasic = dtBasicSum.Rows[0];

                                //basic 
                                object val = sbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    basic = 0 + pbasic;
                                }
                                else
                                {
                                    basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                }

                                //da_percent 
                                object val1 = sbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    da_percent = Convert.ToDecimal(0 + pda_percent);
                                }
                                else
                                {
                                    da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                }
                                //cca
                                object val2 = sbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    cca = Convert.ToDecimal(0 + pcca);
                                }
                                else
                                {
                                    cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                }
                                //hra
                                object val3 = sbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    hra = Convert.ToDecimal(0 + phra);
                                }
                                else
                                {
                                    hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                }
                                //int_ref
                                object va4 = sbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    int_ref = 0 + pint_ref;
                                }
                                else
                                {
                                    int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                }

                                object val5 = sbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    t_inc = 0 + pt_inc;
                                }
                                else
                                {
                                    t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                }

                                object val6 = sbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    spl_da = 0 + pspl_da;
                                }
                                else
                                {
                                    spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                }

                                object val7 = sbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    spl_allowance = 0 + pspl_allowance;
                                }
                                else
                                {
                                    spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                }

                                object val8 = sbasic["pf"];
                                if (val8 == DBNull.Value)
                                {
                                    pf = 0;
                                }
                                else
                                {
                                    pf = Convert.ToDecimal(sbasic["pf"]);
                                }



                                //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                            }

                            //present allowances pper_allowance,pfpa_allow,pfpiip

                            //foreach (DataRow algen in dtAllowance.Rows)
                            //{


                            //    string alw_name = algen["all_name"].ToString();
                            //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                            //    if (alw_name == "Fixed Personal Allowance")
                            //    {
                            //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == "FPA-HRA Allowance")
                            //    {
                            //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == PrConstants.FPIIP)
                            //    {
                            //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                            //    }

                            //}

                            ////dtSumFixed
                            //if (dtSumFixed.Rows.Count > 0)
                            //{
                            //    DataRow sumf = dtSumFixed.Rows[0];

                            //    object val = sumf["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        per_allowance = 0 + pper_allowance;
                            //    }
                            //    else
                            //    {
                            //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                            //    }

                            //}
                            ////dtsumFPA
                            //if (dtsumFPA.Rows.Count > 0)
                            //{
                            //    DataRow sumfpa = dtsumFPA.Rows[0];

                            //    object val = sumfpa["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpa_allow = 0 + pfpa_allow;
                            //    }
                            //    else
                            //    {
                            //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                            //    }

                            //}
                            ////dtsumfpiip
                            //if (dtsumfpiip.Rows.Count > 0)
                            //{
                            //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                            //    object val = sumfpiip["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpiip = 0 + pfpiip;
                            //    }
                            //    else
                            //    {
                            //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                            //    }
                            //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                            //}

                            //getting the date difference from finstart year and current year for allowance
                            int datediffetire = 0;
                            int minval = 0;
                            if (dt_datediff.Rows.Count > 0)
                            {
                                datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                                datediffetire = Convert.ToInt32(dt_datediff.Rows[0]["DateDiffRetire"]);
                                minval = Math.Min(datediff, datediffetire);
                            }

                            List<OldAllowance> oldList = new List<OldAllowance>();
                            //foreach (DataRow dtold in dtSumAllowance.Rows)
                            //{
                            //    OldAllowance objoldlist = new OldAllowance();
                            //    objoldlist.old_Name = dtold["all_name"].ToString();
                            //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                            //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                            //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                            //    oldList.Add(objoldlist);
                            //}
                            foreach (DataRow dtold in dtSumAllowancenew.Rows)
                            {
                                OldAllowance objoldlist = new OldAllowance();
                                objoldlist.old_Name = dtold["all_name"].ToString();
                                //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                                objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                                //objoldlist.old_alw_type = dtold["all_type"].ToString();
                                oldList.Add(objoldlist);
                            }


                            List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                            //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                            //{

                            //    ActiveAllowance NewObjlist = new ActiveAllowance();
                            //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                            //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                            //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                            //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                            //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                            //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                            //    if (olditem != null)
                            //    {
                            //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                            //    }

                            //    NewActiveList.Add(NewObjlist);
                            //}
                            foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                            {

                                ActiveAllowance NewObjlist = new ActiveAllowance();
                                NewObjlist.Active_Name = dtActive["all_name"].ToString();
                                //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                                NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1new;
                                //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                                //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                                var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                                if (olditem != null)
                                {
                                    NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                                    NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                                }

                                NewActiveList.Add(NewObjlist);
                            }


                            //if not in new list then add
                            //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            //{
                            //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                            //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                            //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                            //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                            //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                            //    if (olditem == null)
                            //    {
                            //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            //        NewActiveList.Add(NewObjlist1);
                            //    }
                            //}
                            foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            {
                                ActiveAllowance NewObjlist1 = new ActiveAllowance();
                                NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                                //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                                //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                                var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                                if (olditem == null)
                                {
                                    NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                                    NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                                    NewActiveList.Add(NewObjlist1);
                                }
                            }
                            var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                            if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                            {
                                await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                            }
                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            //1. trans_id
                            //sbqry.Append(GenNewTransactionString());
                            decimal total_allowance = 0;
                            //foreach (var newlist in NewActiveList)
                            //{
                            //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                            //    NewNumIndex++;
                            //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                            //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                            //    sbqry.Append(newqry);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            //}
                            foreach (var newlist in NewActiveList)
                            {
                                total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                                var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                                    " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                                    "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                                    " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                                sbqry.Append(newqry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            }



                            //List<string> lststring = new List<string>();
                            //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                            //// dtPfPerks
                            //if (dtPfperks.Rows.Count > 0)
                            //{
                            //    DataRow pfPerk = dtPfperks.Rows[0];

                            //    object val = pfPerk["pf_perk"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        pf_perk = 0;
                            //    }
                            //    else
                            //    {
                            //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                            //    }

                            //}
                            //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                           
                            //dtLoanPerks
                            if (dtLoanPerks.Rows.Count > 0)
                            {
                                DataRow lperk = dtLoanPerks.Rows[0];

                                object val = lperk["loan_perk"];
                                if (val == DBNull.Value)
                                {
                                    loan_perk = 0;
                                }
                                else
                                {
                                    loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                                }

                            }
                            //dtIncentives
                            if (dtIncentives.Rows.Count > 0)
                            {
                                DataRow ins = dtIncentives.Rows[0];

                                object val = ins["incentive"];
                                if (val == DBNull.Value)
                                {
                                    incentives = 0;
                                }
                                else
                                {
                                    incentives = Convert.ToDecimal(ins["incentive"]);
                                }

                            }
                            //dt172
                            if (dt172.Rows.Count > 0)
                            {
                                DataRow VAL = dt172.Rows[0];
                                object val = VAL["val172"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_2 = 0;
                                }
                                else
                                {
                                    values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                                    totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                                }
                            }
                            //dt173
                            if (dt173.Rows.Count > 0)
                            {
                                DataRow VAL1 = dt173.Rows[0];
                                object val = VAL1["val173"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_3 = 0;
                                }
                                else
                                {
                                    values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                                }
                            }

                            if (dtRent.Rows.Count > 0)
                            {
                                DataRow rents = dtRent.Rows[0];

                                object val = rents["rentamount"];
                                if (val == DBNull.Value)
                                {
                                    house_rent_allowance = 0;
                                }
                                else
                                {
                                    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                                }
                            }

                            if (house_rent_allowance > 0)
                            {
                                decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                                //salary(a)
                                decimal salary = da_percent + Convert.ToDecimal(basic);
                                //40%  of salary(b)
                                decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                                //houserentpaid - 10% of salary(c)
                                decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                                //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                                house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                                // HouseRentAllowance calculated as on 04-09-2020
                                // minimun values of (
                                // Basic+DA --40%,
                                // House Rent Paid minus Basic+DA --10% 
                                // HRA)
                            }
                            //decimal daval = Convert.ToDecimal(da);
                            //decimal hraval = Convert.ToDecimal(hra);
                            //rent amount
                            if (house_rent_allowance < 0)
                            {
                                house_rent_allowance = 0;
                            }



                            if (dtOther.Rows.Count > 0)
                            {
                                DataRow otr = dtOther.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = otr["other"];
                                if (val == DBNull.Value)
                                {
                                    other = 0;
                                }
                                else
                                {
                                    other = Convert.ToDecimal(otr["other"]);
                                }

                            }

                            if (dtHouse.Rows.Count > 0)
                            {
                                //foreach (DataRow dr in dtHouse.Rows)
                                //{
                                //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                                //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                                //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                                //        || dr["loan_type_mid"].ToString() == "13")
                                //    {
                                //        count++;
                                //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                                //    }

                                //}
                                DataRow dh = dtHouse.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = dh["amount"];
                                if (val == DBNull.Value)
                                {
                                    houseloan_allownace = 0;
                                }
                                else
                                {
                                    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                                }

                            }
                            //if (count > 0)
                            //{

                            //    houseloan_allownace = 200000;
                            //}
                            if (dt_strpf.Rows.Count > 0)
                            {
                                pf = Convert.ToDecimal(dt_strpf.Rows[0]["pf"]);
                            }
                            if (dt_strprevlicgsli.Rows.Count > 0)
                            {
                                foreach (DataRow drpev in dt_strprevlicgsli.Rows)
                                {
                                    decimal? amount = 0;
                                    object val = drpev["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(drpev["amount"]);
                                    }
                                    string dd_name = Convert.ToString(drpev["name"].ToString());
                                    if (dd_name == "LIC")
                                    {
                                        lic = amount;
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        gsli = amount;
                                    }
                                }
                            }

                            IList<section80C> lstCer = new List<section80C>();
                            IList<section80CCC> lstCCC = new List<section80CCC>();
                            IList<section80CCD> lstCCD = new List<section80CCD>();
                            IList<sectionOther> lstOther = new List<sectionOther>();

                            decimal pf_new = 0;
                            if (dtCD.Rows.Count > 0)
                            {
                                foreach (DataRow cer in dtCD.Rows)
                                {
                                    //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                                    decimal? amount = 0;

                                    object val = cer["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(cer["amount"]);
                                    }

                                    string dd_name = Convert.ToString(cer["name"].ToString());
                                    int loanid = 0;
                                    int pflag = 0;
                                    int countofsub = 0;
                                    int precoverflag = 0;

                                    string getloanid = "select id  from pr_loan_master where loan_description='" + dd_name + "'";
                                    DataTable dtgetloanid = sh.Get_Table_FromQry(getloanid);
                                    if (dtgetloanid.Rows.Count > 0)
                                    {
                                        loanid = Convert.ToInt32(dtgetloanid.Rows[0]["id"]);
                                    }

                                    string chkloaneligibility = "select principal_recovered_flag, interest_recovered_flag from pr_emp_adv_loans l " +
                                        "join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code =  " + Convert.ToInt32(empCode) + " and loan_type_mid = " + loanid + "";

                                    string comparequery = "select count(principal_recovered_flag)as countofsub ,sum(cast(principal_recovered_flag as int))as precoverflag " +
                                        "from pr_emp_adv_loans l join pr_emp_adv_loans_child ch on l.id = ch.emp_adv_loans_mid where emp_code = " + Convert.ToInt32(empCode) + "  and loan_type_mid = " + loanid + "";
                                    DataTable dtchkloaneligibility = sh.Get_Table_FromQry(chkloaneligibility);
                                    DataTable dtcompare = sh.Get_Table_FromQry(comparequery);
                                    if (dtcompare.Rows.Count > 0 && Convert.ToInt32(dtcompare.Rows[0]["countofsub"]) > 0)
                                    {
                                        countofsub = Convert.ToInt32(dtcompare.Rows[0]["countofsub"]);
                                        precoverflag = Convert.ToInt32(dtcompare.Rows[0]["precoverflag"]);
                                    }
                                    if (dtchkloaneligibility.Rows.Count > 0)
                                    {
                                        pflag = Convert.ToInt32(dtchkloaneligibility.Rows[0]["principal_recovered_flag"]);
                                    }

                                    if (dd_name == "Provident Fund")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //  amount = Convert.ToDecimal(pf + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = pf;
                                            //}

                                        }
                                        amount = Convert.ToDecimal(pf + (amount * months_1new));
                                        pf_new = Convert.ToDecimal(amount);
                                    }
                                    else if (dd_name == "VPF")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //    amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = vpf_data;
                                            //}

                                        }
                                        amount = Convert.ToDecimal(vpf_data + (amount * months_1new));
                                    }

                                    else if (dd_name == "LIC")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //    amount = Convert.ToDecimal(lic + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = lic;
                                            //}
                                        }
                                        amount = Convert.ToDecimal(lic + (amount * months_1new));
                                    }
                                    else if (dd_name == "Housing Loan Main")
                                    {
                                        //amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloanmain + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Addl.Loan - 2D")
                                    {
                                        //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Loan 2B-2C")
                                    {
                                        //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloan2bc + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "Housing Loan 2A")
                                    {
                                        //amount = Convert.ToDecimal(houseAddloan_2d + (amount * months_1new));
                                        if (countofsub != precoverflag)
                                        {
                                            amount = Convert.ToDecimal(houseloan2a + (amount * months_1new));
                                        }
                                        else
                                        {
                                            amount = 0;
                                        }
                                    }
                                    else if (dd_name == "GSLI")
                                    {
                                        amount = Convert.ToDecimal(gsli + (amount * months_1new));
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal((amount * months_1new));
                                    }
                                    //if amount is zero not adding to the list
                                    if (amount == 0)
                                    { continue; }
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer["id"].ToString(),
                                            name = cer["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }

                                }


                            }
                            else
                            {
                                lstCer.Add(new section80C
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //for special deductions
                            if (dt_tdssections.Rows.Count > 0)
                            {
                                foreach (DataRow cer1 in dt_tdssections.Rows)
                                {
                                    decimal? amount1 = 0;
                                    decimal? allowance_amount1 = 0;
                                    amount1 = Convert.ToDecimal(cer1["gross"]);
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount1 > min_allowance)
                                        {
                                            allowance_amount1 = min_allowance;
                                            min_allowance = min_allowance - allowance_amount1;
                                            max_allowance = max_allowance + allowance_amount1;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount1;
                                            allowance_amount1 = amount1;
                                            max_allowance = max_allowance + amount1;
                                        }
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount1)),
                                        });
                                    }
                                    else
                                    {
                                        lstCer.Add(new section80C
                                        {
                                            id = cer1["id"].ToString(),
                                            name = cer1["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount1)),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }

                            }

                            decimal pf_perkcal = 0.5m;
                            decimal pf_perktemp = 12.5m;
                            pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                            //if (dtCCC.Rows.Count > 0)
                            //{
                            //    foreach (DataRow ccc in dtCCC.Rows)
                            //    {
                            //        decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                            //        decimal? allowance_amount = 0;
                            //        if (min_allowance > 0 && max_allowance <= 150000)
                            //        {
                            //            if (amount > min_allowance)
                            //            {
                            //                allowance_amount = min_allowance;
                            //                min_allowance = min_allowance - allowance_amount;
                            //                max_allowance = max_allowance + allowance_amount;
                            //            }
                            //            else
                            //            {
                            //                min_allowance = min_allowance - amount;
                            //                allowance_amount = amount;
                            //                max_allowance = max_allowance + amount;
                            //            }
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                            //                allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //                ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                            //            });
                            //        }
                            //        else
                            //        {
                            //            lstCCC.Add(new section80CCC
                            //            {
                            //                id = ccc["id"].ToString(),
                            //                name = ccc["name"].ToString(),
                            //                amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                            //                allowance_amount = AddZerosAfterDecimal("0"),
                            //                ded_amount = AddZerosAfterDecimal("0")
                            //            });
                            //        }

                            //    }

                            //}
                            //else
                            //{
                            //    lstCCC.Add(new section80CCC
                            //    {
                            //        id = "",
                            //        name = "",
                            //        amount = AddZerosAfterDecimal("0"),
                            //        allowance_amount = AddZerosAfterDecimal("0"),
                            //        ded_amount = AddZerosAfterDecimal("0")
                            //    });
                            //}

                            if (dtCCD.Rows.Count > 0)
                            {
                                foreach (DataRow ccd in dtCCD.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                                    {
                                        if (amount > min_allowance80CCD)
                                        {
                                            allowance_amount = min_allowance80CCD;
                                            min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                            max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance80CCD = min_allowance80CCD - amount;
                                            allowance_amount = amount;
                                            max_allowance80CCD = max_allowance80CCD + amount;
                                        }
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                            allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                            ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        });
                                    }
                                    else
                                    {
                                        lstCCD.Add(new section80CCD
                                        {
                                            id = ccd["id"].ToString(),
                                            name = ccd["name"].ToString(),
                                            amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                            allowance_amount = AddZerosAfterDecimal("0"),
                                            ded_amount = AddZerosAfterDecimal("0")
                                        });
                                    }
                                }
                            }
                            else
                            {
                                lstCCD.Add(new section80CCD
                                {
                                    id = "",
                                    name = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            if (dtEdu.Rows.Count > 0)
                            {
                                foreach (DataRow ed in dtEdu.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                                    String sectionNAme = ed["section"].ToString();
                                    decimal? allowance_amount = 0;
                                    string id = ed["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = ed["name"].ToString();
                                    if (sectionNAme == "Section80G")
                                    {
                                        allowance_amount = amount * section80g;
                                        max_allowanceGG = max_allowanceGG + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80GGB")
                                    {
                                        allowance_amount = amount * section80gg;
                                        max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80DDB")
                                    {
                                        if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                        {
                                            if (amount > min_allowance80DDB)
                                            {
                                                allowance_amount = min_allowance80DDB;
                                                ded_amount = allowance_amount;
                                                min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                                max_allowance80DB = max_allowance80DB + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DDB = min_allowance80DDB - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DB = max_allowance80DB + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                    }
                                    else if (sectionNAme == "Section80DD")
                                    {
                                        if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                        {
                                            if (amount > min_allowance80DD)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80DD = min_allowance80DD - allowance_amount;
                                                max_allowance80DD = max_allowance80DD + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DD = min_allowance80DD - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DD = max_allowance80DD + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80U")
                                    {
                                        if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                        {
                                            if (amount > min_allowance80U)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80U = min_allowance80U - allowance_amount;
                                                max_allowance80U = max_allowance80U + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80U = min_allowance80U - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80U = max_allowance80U + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80E")
                                    {
                                        allowance_amount = amount;
                                        max_allowance = max_allowance + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    else if (sectionNAme == "Section80D_P")
                                    {
                                        if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                        {
                                            if (amount > min_allowance80D_P)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                                max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_P = min_allowance80D_P - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_P = max_allowance80D_P + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                        //if (min_allowance80D_P > amount)
                                        //{
                                        //    allowance_amount = amount;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}

                                        //else
                                        //{
                                        //    allowance_amount = min_allowance80D_P;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}
                                    }
                                    else if (sectionNAme == "Section80D_F")
                                    {
                                        if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                        {
                                            if (amount > min_allowance80D_F)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                                max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_F = min_allowance80D_F - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_F = max_allowance80D_F + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                                    {
                                        if (sectionNAme != "Section80EE")
                                        {
                                            sectionNAme = "Section80EE_HL";
                                        }
                                        if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                        {
                                            if (amount > min_allowance80EE)
                                            {
                                                allowance_amount = min_allowance80EE;
                                                min_allowance80EE = min_allowance80EE - allowance_amount;
                                                max_allowance80ee = max_allowance80ee + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80EE = min_allowance80EE - amount;
                                                allowance_amount = amount;
                                                max_allowance80ee = max_allowance80ee + amount;
                                            }
                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;

                                        }
                                    }

                                    else if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });

                                }

                            }

                            else
                            {
                                lstOther.Add(new sectionOther
                                {
                                    id = "",
                                    name = "",
                                    section = "",
                                    amount = AddZerosAfterDecimal("0"),
                                    allowance_amount = AddZerosAfterDecimal("0"),
                                    ded_amount = AddZerosAfterDecimal("0")
                                });
                            }

                            //special section24(b)
                            if (dt_tdssection24.Rows.Count > 0)
                            {
                                foreach (DataRow sec24 in dt_tdssection24.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(sec24["gross"].ToString());
                                    String sectionNAme = sec24["section"].ToString();
                                    string actName1 = "";
                                    decimal? allowance_amount = 0;
                                    string id = sec24["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = sec24["name"].ToString();

                                    for (int i = 0; i < lstOther.Count; i++)
                                    {
                                        actName1 = lstOther[i].name;
                                        if (actName1 == actName)
                                        {
                                            lstOther.RemoveAt(i);
                                            continue;
                                        }
                                    }

                                    if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance24b;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    lstOther.Add(new sectionOther
                                    {
                                        id = id,
                                        name = actName,
                                        section = sectionNAme,
                                        amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    });
                                }
                            }

                            max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                            if (dtTax.Rows.Count > 0)
                            {


                                DataRow tax = dtTax.Rows[0];

                                object val = tax["tax_deducted_at_source"];
                                if (val == DBNull.Value)
                                {
                                    total_tax_till = 0;
                                }
                                else
                                {
                                    total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                                }

                                tax_till = totaltaxdeductedfrm16 + total_tax_till;
                                tax_till = 0;

                            }

                            if (dtTDS.Rows.Count > 0)
                            {
                                DataRow TDS = dtTDS.Rows[0];

                                object val = TDS["tds_amount"];
                                if (val == DBNull.Value)
                                {
                                    paid_by_emp = 0;
                                }
                                else
                                {
                                    paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                                }
                            }

                            IList<TDSProcess> lstTDS = new List<TDSProcess>();

                            gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                            total_section = house_rent_allowance;

                            balance = gross - total_section;
                            //standard_deduction = PrConstants.STANDARD_DEDUCTION;

                            //decimal stndednew = Convert.ToDecimal(gross) * stndedpercent;
                            decimal stndednew = Convert.ToDecimal(balance); //standard deduction is balance and 50000 whichever is minimum.
                            if (stndednew >= 50000)
                            {
                                standard_deduction = PrConstants.STANDARD_DEDUCTION;
                            }
                            else
                            {
                                standard_deduction = Convert.ToSingle(Math.Round(stndednew, 2));
                            }
                            //standard_deduction = gross*0.04;
                            if (dtph.Rows.Count > 0)
                            {
                                if (monthcount != 1)
                                {
                                    //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);

                                    //if (emp_tax > 2400)
                                    //{
                                    //    emp_tax = 2400;
                                    //}
                                    emp_tax = (200 * monthcount);
                                }
                                else if (monthcount == 1)
                                {
                                    emp_tax = 0;
                                }
                            }

                            aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                            Income_chargable = balance - aggregate_of_4; //6

                            total_gross_income = Income_chargable + other - houseloan_allownace;

                            deductible = Convert.ToDecimal(max_allowance);
                            total_income = total_gross_income - deductible;
                            //total_income = Convert.ToDecimal(841240.01);
                            round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));
                            //tax_deducted_at_source is calculating as incometax value of current financial year.
                            decimal tax_deducted_at_source1 = 0;
                            if (dt_incometax.Rows.Count > 0)
                            {
                                DataRow incometax = dt_incometax.Rows[0];

                                object val = incometax["income_tax"];
                                if (val == DBNull.Value)
                                {
                                    tax_deducted_at_source1 = 0;
                                }
                                else
                                {
                                    tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                                }
                            }
                            if (total_income > 500000)
                            {
                                //strConvert = income.ToString();
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = 0;
                                edu_cess = income * 4 / 100;

                                tax_payable = (float)income + edu_cess;
                                tax_payable = (int)Math.Round(tax_payable);


                                //if (tax_till > tax_payable)
                                //{
                                //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                                //}
                                //else
                                //{
                                //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                                //}
                                tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                                if (tax_balance < 0)
                                {
                                    tax_balance = 0;
                                }
                                tot_months = months_1 - 1;
                                if (tot_months > 0)
                                {
                                    tds_per_month = tax_balance / tot_months;
                                }
                                else
                                {
                                    tds_per_month = tax_balance;// tot_months;
                                }
                                //tds_per_month = tax_balance / months_1;
                                if (Financial_md.Month != 03)
                                {
                                    int x = (int)Math.Round(tds_per_month);
                                    int y = (int)Math.Round(x / 100d, 0) * 100;
                                    rounding_tds_per_month = y;
                                }
                                else
                                {
                                    int xp = (int)Math.Round(tds_per_month);
                                    int Z = (10 - xp % 10) + xp;
                                    rounding_tds_per_month = Z;
                                }

                                //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                            }
                            else
                            {
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = Convert.ToDecimal(income);
                                edu_cess = 0;

                                tax_payable = 0;

                                tax_till = 0;
                                tax_balance = 0;

                                tds_per_month = 0;

                                rounding_tds_per_month = 0;
                            }
                            //string employer_name_address = PrConstants.Name;
                            //string employer_pan = PrConstants.PAN;
                            //string employer_tan = PrConstants.TAN;



                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            ////1. trans_id
                            //sbqry.Append(GenNewTransactionString());

                            //int finalSub = 0;

                            if (final == true)
                            {
                                finalSub = 1;
                            }
                            else
                            {
                                finalSub = 0;
                            }

                            string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                            DataTable details = await _sha.Get_Table_FromQry(selQry);
                            int retmonthcount = DateTime.Compare(Convert.ToDateTime(strretdate), Convert.ToDateTime(fm));
                            if (retmonthcount <= 0)
                            {
                                months_1 = 0;
                            }
                            if (details.Rows.Count > 0)
                            {
                                NewNumIndex++;
                                DataRow finaldt = details.Rows[0];
                                string tdsdelete = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                sbqry.Append(tdsdelete);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.D, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                int finalCount = Convert.ToInt32(finaldt["final"]);

                                if (finalCount == 1)
                                {
                                    return "E#TDS Process#Employee Already Processed..!!";
                                }
                                else
                                {
                                    NewNumIndex++;
                                    string tdsUpdate = "delete from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                                    sbqry.Append(tdsUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));



                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        foreach (var ccDatas in lstCer)
                                        {
                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        foreach (var cccDatas in lstCCC)
                                        {
                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                    if (lstOther != null)
                                    {
                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }



                            }
                            else
                            {

                                try
                                {


                                    NewNumIndex++;
                                    string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate1);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    string certUpdate = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(certUpdate);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + tot_months + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    if (lstCer != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate2);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var ccDatas in lstCer)
                                        {

                                            if (ccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCC != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate3);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var cccDatas in lstCCC)
                                        {

                                            if (cccDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstCCD != null)
                                    {
                                        foreach (var ccdDatas in lstCCD)
                                        {
                                            //NewNumIndex++;
                                            //string tdsUpdate3 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                            //sbqry.Append(tdsUpdate3);
                                            //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                            if (ccdDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }
                                    if (lstOther != null)
                                    {
                                        //NewNumIndex++;
                                        //string tdsUpdate4 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                        //sbqry.Append(tdsUpdate4);
                                        //sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));

                                        foreach (var otherDatas in lstOther)
                                        {
                                            if (otherDatas.id != "")
                                            {
                                                NewNumIndex++;
                                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                                string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                                    "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                                    "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                                    " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                                sbqry.Append(bioQry);

                                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                            }

                                        }
                                    }

                                }
                                catch (Exception e)
                                {
                                    return "E#TDS Process#" + e.Message;
                                }
                            }
                        }
                        else if (optn.Rows[0]["Option"].ToString() == "2" && dtretiredate.Rows.Count > 0 && zerobasic > 0)
                        {
                            decimal? min_allowance = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                                   .Where(x => x["constant"].ToString() == "Section80C")
                                   .Select(x => x["value"].ToString()).FirstOrDefault()); //150000

                            decimal? min_allowance80DD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80CCD = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80CCD")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //50000

                            decimal? min_allowance80U = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80U")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //125000

                            decimal? min_allowance80DDB = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80DDB")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //60000

                            decimal? min_allowance80D_P = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_P")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //300000

                            decimal? min_allowance80D_F = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80D_F")
                          .Select(x => x["value"].ToString()).FirstOrDefault()); //25000

                            decimal? min_allowance80EE = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section80EE")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//300000

                            decimal? min_allowance24b = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                          .Where(x => x["constant"].ToString() == "Section24(b)")
                          .Select(x => x["value"].ToString()).FirstOrDefault());//200000

                            decimal? section80g = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80G")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //0.5

                            decimal? section80gg = decimal.Parse(_dtConstants.Rows.Cast<DataRow>()
                         .Where(x => x["constant"].ToString() == "Section80GGB")
                         .Select(x => x["value"].ToString()).FirstOrDefault()); //1

                            DataTable _dtFY_FM = ds1.Tables[1];
                            _incometaxdbconstant = ds1.Tables[2];


                            //basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra,sum(er_interim_relief) as int_ref, " +
                                "sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance " +
                                "from pr_emp_payslip where emp_code =" + Convert.ToInt32(empCode) + "and fy = " + iFY + " and id in(select top 1 id from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fy = " + iFY + " and spl_type='Regular' order by id desc); ";

                            //sum of previous for basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance
                            string basicSumQry = "select sum(er_basic) as basic,sum(er_da) as da_percent,sum(er_cca) as cca,sum(er_hra) as hra," +
                                "sum(er_interim_relief) as int_ref, sum(er_telangana_inc) as t_inc,sum(spl_da) as spl_da, sum(spl_allw) as spl_allowance, sum(dd_provident_fund) pf  " +
                                "from pr_emp_payslip where emp_code = " + Convert.ToInt32(empCode) + " and fm<'" + FM + "' and fm>='" + startYear + "'; ";

                            //allowance ==> Fixed Personal Allowance,FPA-HRA Allowance,FPIIP
                            string allowaceQry = "select distinct all_name, all_amount from pr_emp_payslip_allowance  c join pr_payslip_customization cz on cz.m_id=c.all_mid where c.active=1 and cz.cust_status='Yes' and c.emp_code  = " + Convert.ToInt32(empCode) + ";";

                            //allowance ==>Get and Sum all previous months allowances 
                            string SumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<'" + FM + "' and m.fm>='" + startYear + "' and c.active=0 and c.all_amount>0 and m.active=0 and all_name!='Employee TDS'  group by all_name,c.all_mid,c.all_type;";

                            //allowance ==> Get all current month allowances
                            string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid =(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " and spl_type='Regular') group by all_name,c.all_mid,c.all_type;";
                            //string ActiveSumAllowanceQry = "select distinct c.all_mid,c.all_name,c.all_type,(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) ;";

                            ////sum Personal Allowance
                            //string sumFixedQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='Fixed Personal Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";


                            //string sumFPAQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPA-HRA Allowance' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";

                            ////sum FPIIP
                            //string sumFPIIPQry = "select sum(all_amount) from pr_emp_payslip_allowance where all_name = 'FPIIP' " +
                            //    "and emp_code = " + Convert.ToInt32(empCode) + " and fm between '" + FM + "' and '" + startYear + "'; ";

                            //string sumFPIIPQry = "select sum(all_amount) as all_amount from pr_emp_payslip_allowance a join pr_emp_payslip p on p.id=a.payslip_mid  " +
                            //    "where all_name='FPIIP' and a.emp_code = " + Convert.ToInt32(empCode) + " and p.fm<'" + FM + "' and p.fm>='" + startYear + "'; ";
                            //sum PFPerks                                                   
                            string PFPerks = "select distinct sum(amount) as pf_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks'); ";
                            // sum LOANPerks                                                    
                            string LOANPerks = "select distinct sum(amount) as loan_perk from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks'); ";
                            // sum Incentive                                                    
                            string incentive = "select distinct sum(amount) as incentive from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            // sum  val 17 -2
                            string valQry = "select sum(perq_amt+rec_amt-tax_amt) as val172,sum(tax_amt) as taxamount from pr_emp_incometax_12ba " +
                                 "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "'and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq! = 'Total Value of Profits in lieu of Salary as per 17(3)' and nature_of_perq! = 'Total Value of Perquisites');";

                            // sum val 17 -3
                            string val2Qry = "select sum(perq_amt+rec_amt+tax_amt) as val173 " +
                                "from pr_emp_incometax_12ba where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 " +
                                " and fm<='" + FM + "' and fm>='" + startYear + "' and m_id in (select id from pr_emp_incometax_12ba_master " +
                                "where nature_of_perq = 'Total Value of Profits in lieu of Salary as per 17(3)');";

                            //rent allowance
                            //string rent = "select top 1 amount as amount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and active=1;";

                            string rent = " select sum(amount) as rentamount from pr_emp_rent_details where emp_code = " + Convert.ToInt32(empCode) + " and fy=" + FY + "and active=1 and rent_mid!=1;";

                            //other
                            string otherQry = "select distinct sum(amount) as other from " +
                                        "pr_emp_perearning where emp_code = " + Convert.ToInt32(empCode) + " and active = 1 and m_id not in " +
                                        "(select id from pr_earn_field_master where type = 'per_earn' and name = 'PFPerks') and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'LOANPerks') " +
                                        "and m_id not in (select id from pr_earn_field_master where type = 'per_earn' and name = 'Incentive'); ";

                            //house loan
                            string houseQry = "select sum(epf.amount) as amount from pr_deduction_field_master ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section ='24(b)' and amount>0;";

                            //section 80c
                            //string cdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                            //    "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                            //    "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE ef.type = 'per_ded' and epf.section = 'Section80C'";

                            string cdQry = "select ef.id as id,ef.name as name, epf.amount as amount from pr_deduction_field_master ef left outer join  " +
                               "pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 and epf.emp_code = " + Convert.ToInt32(empCode) + " " +
                               "WHERE epf.m_type = 'per_ded' and epf.section = 'Section80C' and amount>0 and ef.name not in('Provident Fund','LIC','VPF','LIC','Housing Loan Main','Housing Addl.Loan - 2D','GSLI') union all select '1' as id,'Provident Fund' AS name, sum(dd_provident_fund) as amount  " +
                               "from pr_emp_payslip where active = 1 and emp_code = " + Convert.ToInt32(empCode) + " union " +
                               "all select '2' as id,'VPF' as name, sum(paydedu.dd_amount) as amount from pr_emp_payslip_deductions " +
                               "paydedu where paydedu.dd_name = 'VPF Deduction' and active=1 and emp_code = " + Convert.ToInt32(empCode) + " union all " +
                                "select '3' as id, 'LIC' as name, sum(paydedu.dd_amount)  as amount from pr_emp_payslip_deductions paydedu where paydedu.dd_name= 'LIC' and emp_code = " + Convert.ToInt32(empCode) + " and paydedu.payslip_mid in(select top 1 id from pr_emp_payslip where emp_code=" + Convert.ToInt32(empCode) + " and fy=" + iFY + " order by id desc)";

                            //section 80ccc
                            string cccQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCC'";
                            //section 80ccd
                            string ccdQry = "select ef.id as id, ef.name as name, epf.amount as amount from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and epf.section = 'Section80CCD'"+
                                " union select ef.id as id, 'NPS' as name, ef.NPS as amount from pr_emp_payslip ef WHERE ef.emp_code = " + Convert.ToInt32(empCode) + " and ef.active = 1";


                            //section other section
                            string otherSectionQry = "select ef.id as id, ef.name as name, epf.amount as amount,epf.section as section from pr_deduction_field_master " +
                                "ef left outer join  pr_emp_perdeductions epf on ef.id = epf.m_id and epf.active = 1 " +
                                "and epf.emp_code = " + Convert.ToInt32(empCode) + " WHERE epf.m_type = 'per_ded' and ef.type='per_ded' and epf.section !='Section80C' and epf.section !='Section80CCC' and epf.section !='Section80CCD' and epf.section like '%Section%';";
                            //tax till
                            string taxQry = "select tax_deducted_at_source from pr_emp_tds_process where empcode = " + Convert.ToInt32(empCode) + " and active=1;";
                            //other tds deductions
                            //spl_type in ('Regular', 'Encashment', 'Adhoc', 'stopsalary') and
                            string tdsQry = "select sum(tds_amount) as tds_amount from pr_emp_other_tds_deductions where " +
                                "emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "';";

                            string empTaxQry = "select (DATEDIFF(month, '" + startYear + "', '" + FM + "')+1) - (select count(emp_code) as records from pr_emp_payslip " +
                                "where emp_code = " + Convert.ToInt32(empCode) + " and fm<='" + FM + "' and fm>='" + startYear + "' and spl_type in ('Regular', 'StopSalary','Suspended')) as loss;";

                            //string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions paydedu where paydedu.emp_code = " + Convert.ToInt32(empCode) + " and paydedu.fm<='" + FM + "' and paydedu.fm>='" + startYear + "' AND paydedu.dd_name = 'VPF Deduction'";

                            //VPF
                            string vpfQry = "select sum(dd_amount) as amount from pr_emp_payslip_deductions a join pr_emp_payslip p on p.id = a.payslip_mid  where dd_name = 'VPF Deduction' and a.emp_code = " + Convert.ToInt32(empCode) + "  and p.fm < '" + FM + "' and p.fm >= '" + startYear + "';";

                            string strdatediff = "SELECT DATEDIFF(month, '" + startYear + "', '" + FM + "') AS DateDiff, (SELECT DATEDIFF(month,'" + startYear + "',Retirementdate) from Employees where EmpId=" + Convert.ToInt32(empCode) + ") as DateDiffRetire;";

                            string strincometax = "select sum(dd_income_tax) as income_tax from pr_emp_payslip where fm<='" + FM + "' and fM>='" + startYear + "' and emp_code=" + Convert.ToInt32(empCode) + ";";
                            string SumAllowanceQrynew = "select c.all_name,Sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on m.id=c.payslip_mid " +
                                          " where m.emp_code = " + Convert.ToInt32(empCode) + " and m.fm<='" + FM + "' and m.fm>='" + startYear + "'  and c.all_amount!=0  and " +
                                           " all_name not in('Employee TDS' ,'CCA')  group by all_name;";

                            string ActiveSumAllowanceQrynew = "select c.all_name,sum(all_amount) as Amount from pr_emp_payslip m join pr_emp_payslip_allowance c on" +
                                " m.id=c.payslip_mid  where m.emp_code = " + Convert.ToInt32(empCode) + " and c.active=1 and c.all_amount>0 and m.active=1 and all_name!='Employee TDS' and " +
                                " c.payslip_mid in(select id from pr_emp_payslip where fm='" + FM + "' and emp_code=" + Convert.ToInt32(empCode) + " ) and spl_type='Regular'  group by all_name;";

                            DataSet ds = await _sha.Get_MultiTables_FromQry(general + basicQry + basicSumQry + allowaceQry +
                                SumAllowanceQry + PFPerks + LOANPerks + incentive + valQry + val2Qry + rent + otherQry + houseQry +
                                cdQry + cccQry + ccdQry + otherSectionQry + taxQry + tdsQry + empTaxQry + vpfQry + ActiveSumAllowanceQry +
                                strdatediff + strincometax + SumAllowanceQrynew + ActiveSumAllowanceQrynew);

                            //tables
                            var dtGeneral = ds.Tables[0];
                            var dtBasic = ds.Tables[1];
                            var dtBasicSum = ds.Tables[2];
                            var dtAllowance = ds.Tables[3];
                            var dtSumAllowance = ds.Tables[4];

                            var dtPfperks = ds.Tables[5];
                            var dtLoanPerks = ds.Tables[6];
                            var dtIncentives = ds.Tables[7];
                            var dt172 = ds.Tables[8];
                            var dt173 = ds.Tables[9];
                            var dtRent = ds.Tables[10];
                            var dtOther = ds.Tables[11];
                            var dtHouse = ds.Tables[12];

                            var dtCD = ds.Tables[13];
                            var dtCCC = ds.Tables[14];
                            var dtCCD = ds.Tables[15];
                            var dtEdu = ds.Tables[16];
                            var dtTax = ds.Tables[17];
                            var dtTDS = ds.Tables[18];
                            var dtEmpTax = ds.Tables[19];
                            var dtVpf = ds.Tables[20];
                            var dtActiveSumAllowance = ds.Tables[21];
                            var dt_datediff = ds.Tables[22];
                            var dt_incometax = ds.Tables[23];
                            var dtSumAllowancenew = ds.Tables[24];
                            var dtActiveSumAllowancenew = ds.Tables[25];

                            int loss_months = 0;
                            decimal? vpf_data = 0;
                            decimal? pf = 0;

                            if (dtEmpTax.Rows.Count > 0)
                            {
                                DataRow empTax = dtEmpTax.Rows[0];

                                object val = empTax["loss"];
                                if (val == DBNull.Value)
                                {
                                    loss_months = 0;
                                }
                                else
                                {
                                    loss_months = Convert.ToInt32(empTax["loss"]);
                                }

                            }
                            //vpf

                            if (dtVpf.Rows.Count > 0)
                            {
                                DataRow vpfData = dtVpf.Rows[0];

                                object val = vpfData["amount"];
                                if (val == DBNull.Value)
                                {
                                    vpf_data = 0;
                                }
                                else
                                {
                                    vpf_data = Convert.ToDecimal(vpfData["amount"]);
                                }

                            }

                            // General Data
                            if (dtGeneral.Rows.Count > 0)
                            {
                                DataRow gen = dtGeneral.Rows[0];
                                name = Convert.ToString(gen["name"]);
                                per_address = Convert.ToString(gen["per_address"]);
                                pan_no = Convert.ToString(gen["pan_no"]);
                                emp_code = Convert.ToString(gen["emp_code"]);
                                designation = Convert.ToString(gen["designation"]);
                                sex = Convert.ToString(gen["sex"]);
                                fm = fin_month;
                            }

                            //present basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                            if (dtBasic.Rows.Count > 0)
                            {

                                DataRow rbasic = dtBasic.Rows[0];

                                //basic 
                                object val = rbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    pbasic = 0;
                                }
                                else
                                {
                                    pbasic = Convert.ToDecimal(rbasic["basic"]) * months_1;
                                }

                                //da_percent 
                                object val1 = rbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    pda_percent = 0;
                                }
                                else
                                {
                                    pda_percent = Convert.ToDecimal(rbasic["da_percent"]) * months_1;
                                }
                                //cca
                                object val2 = rbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    pcca = 0;
                                }
                                else
                                {
                                    pcca = Convert.ToDecimal(rbasic["cca"]) * months_1;
                                }
                                //hra
                                object val3 = rbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    phra = 0;
                                }
                                else
                                {
                                    phra = Convert.ToDecimal(rbasic["hra"]) * months_1;
                                }
                                //int_ref
                                object va4 = rbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    pint_ref = 0;
                                }
                                else
                                {
                                    pint_ref = Convert.ToDecimal(rbasic["int_ref"]) * months_1;
                                }

                                object val5 = rbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    pt_inc = 0;
                                }
                                else
                                {
                                    pt_inc = Convert.ToDecimal(rbasic["t_inc"]) * months_1;
                                }

                                object val6 = rbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    pspl_da = 0;
                                }
                                else
                                {
                                    pspl_da = Convert.ToDecimal(rbasic["spl_da"]) * months_1;
                                }

                                object val7 = rbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    pspl_allowance = 0;
                                }
                                else
                                {
                                    pspl_allowance = Convert.ToDecimal(rbasic["spl_allowance"]) * months_1;
                                }




                            }

                            // present + sum and final values are basic, da_percent,cca,hra,int_ref,t_inc,spl_da,spl_allowance

                            if (dtBasicSum.Rows.Count > 0)
                            {
                                DataRow sbasic = dtBasicSum.Rows[0];

                                //basic 
                                object val = sbasic["basic"];
                                if (val == DBNull.Value)
                                {
                                    basic = 0 + pbasic;
                                }
                                else
                                {
                                    basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                }

                                //da_percent 
                                object val1 = sbasic["da_percent"];
                                if (val1 == DBNull.Value)
                                {
                                    da_percent = Convert.ToDecimal(0 + pda_percent);
                                }
                                else
                                {
                                    da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                }
                                //cca
                                object val2 = sbasic["cca"];
                                if (val2 == DBNull.Value)
                                {
                                    cca = Convert.ToDecimal(0 + pcca);
                                }
                                else
                                {
                                    cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                }
                                //hra
                                object val3 = sbasic["hra"];
                                if (val3 == DBNull.Value)
                                {
                                    hra = Convert.ToDecimal(0 + phra);
                                }
                                else
                                {
                                    hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                }
                                //int_ref
                                object va4 = sbasic["int_ref"];
                                if (va4 == DBNull.Value)
                                {
                                    int_ref = 0 + pint_ref;
                                }
                                else
                                {
                                    int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                }

                                object val5 = sbasic["t_inc"];
                                if (val5 == DBNull.Value)
                                {
                                    t_inc = 0 + pt_inc;
                                }
                                else
                                {
                                    t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                }

                                object val6 = sbasic["spl_da"];
                                if (val6 == DBNull.Value)
                                {
                                    spl_da = 0 + pspl_da;
                                }
                                else
                                {
                                    spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                }

                                object val7 = sbasic["spl_allowance"];
                                if (val7 == DBNull.Value)
                                {
                                    spl_allowance = 0 + pspl_allowance;
                                }
                                else
                                {
                                    spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;
                                }

                                object val8 = sbasic["pf"];
                                if (val8 == DBNull.Value)
                                {
                                    pf = 0;
                                }
                                else
                                {
                                    pf = Convert.ToDecimal(sbasic["pf"]);
                                }



                                //basic = Convert.ToDecimal(sbasic["basic"]) + pbasic;
                                //da_percent = Convert.ToDecimal(Convert.ToDecimal(sbasic["da_percent"]) + pda_percent);
                                //cca = Convert.ToDecimal(Convert.ToDecimal(sbasic["cca"]) + pcca);
                                //hra = Convert.ToDecimal(Convert.ToDecimal(sbasic["hra"]) + phra);
                                //int_ref = Convert.ToDecimal(sbasic["int_ref"]) + pint_ref;
                                //t_inc = Convert.ToDecimal(sbasic["t_inc"]) + pt_inc;
                                //spl_da = Convert.ToDecimal(sbasic["spl_da"]) + pspl_da;
                                //spl_allowance = Convert.ToDecimal(sbasic["spl_allowance"]) + pspl_allowance;


                            }

                            //present allowances pper_allowance,pfpa_allow,pfpiip

                            //foreach (DataRow algen in dtAllowance.Rows)
                            //{


                            //    string alw_name = algen["all_name"].ToString();
                            //    float alw_amount = float.Parse(algen["all_amount"].ToString());

                            //    if (alw_name == "Fixed Personal Allowance")
                            //    {
                            //        pper_allowance = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == "FPA-HRA Allowance")
                            //    {
                            //        pfpa_allow = Convert.ToDecimal(alw_amount) * months;
                            //    }
                            //    else if (alw_name == PrConstants.FPIIP)
                            //    {
                            //        pfpiip = Convert.ToDecimal(alw_amount) * months;
                            //    }

                            //}

                            ////dtSumFixed
                            //if (dtSumFixed.Rows.Count > 0)
                            //{
                            //    DataRow sumf = dtSumFixed.Rows[0];

                            //    object val = sumf["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        per_allowance = 0 + pper_allowance;
                            //    }
                            //    else
                            //    {
                            //        per_allowance = Convert.ToDecimal(sumf["all_amount"]) + pper_allowance;
                            //    }

                            //}
                            ////dtsumFPA
                            //if (dtsumFPA.Rows.Count > 0)
                            //{
                            //    DataRow sumfpa = dtsumFPA.Rows[0];

                            //    object val = sumfpa["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpa_allow = 0 + pfpa_allow;
                            //    }
                            //    else
                            //    {
                            //        fpa_allow = Convert.ToDecimal(sumfpa["all_amount"]) + pfpa_allow;
                            //    }

                            //}
                            ////dtsumfpiip
                            //if (dtsumfpiip.Rows.Count > 0)
                            //{
                            //    DataRow sumfpiip = dtsumfpiip.Rows[0];
                            //    object val = sumfpiip["all_amount"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        fpiip = 0 + pfpiip;
                            //    }
                            //    else
                            //    {
                            //        fpiip = Convert.ToDecimal(sumfpiip["all_amount"]) + pfpiip;
                            //    }
                            //    //fpiip = Convert.ToDecimal(sumfpiip["all_amount"])+ pfpiip;

                            //}


                            //getting the date difference from finstart year and current year for allowance
                            int datediffetire = 0;
                            int minval = 0;
                            if (dt_datediff.Rows.Count > 0)
                            {
                                datediff = Convert.ToInt32(dt_datediff.Rows[0]["DateDiff"]);
                                datediffetire = Convert.ToInt32(dt_datediff.Rows[0]["DateDiffRetire"]);
                                minval = Math.Min(datediff, datediffetire);
                            }

                            List<OldAllowance> oldList = new List<OldAllowance>();
                            //foreach (DataRow dtold in dtSumAllowance.Rows)
                            //{
                            //    OldAllowance objoldlist = new OldAllowance();
                            //    objoldlist.old_Name = dtold["all_name"].ToString();
                            //    objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                            //    objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                            //    objoldlist.old_alw_type = dtold["all_type"].ToString();
                            //    oldList.Add(objoldlist);
                            //}
                            foreach (DataRow dtold in dtSumAllowancenew.Rows)
                            {
                                OldAllowance objoldlist = new OldAllowance();
                                objoldlist.old_Name = dtold["all_name"].ToString();
                                //objoldlist.old_m_id = Convert.ToInt32(dtold["all_mid"].ToString());
                                objoldlist.old_Amount = float.Parse(dtold["Amount"].ToString());
                                //objoldlist.old_alw_type = dtold["all_type"].ToString();
                                oldList.Add(objoldlist);
                            }


                            List<ActiveAllowance> NewActiveList = new List<ActiveAllowance>();
                            //foreach (DataRow dtActive in dtActiveSumAllowance.Rows)
                            //{

                            //    ActiveAllowance NewObjlist = new ActiveAllowance();
                            //    NewObjlist.Active_Name = dtActive["all_name"].ToString();
                            //    //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                            //    NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) ;
                            //    NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                            //    NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                            //    var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                            //    if (olditem != null)
                            //    {
                            //        NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                            //        NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                            //    }

                            //    NewActiveList.Add(NewObjlist);
                            //}
                            foreach (DataRow dtActive in dtActiveSumAllowancenew.Rows)
                            {

                                ActiveAllowance NewObjlist = new ActiveAllowance();
                                NewObjlist.Active_Name = dtActive["all_name"].ToString();
                                //NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1;
                                NewObjlist.Active_Amount = float.Parse(dtActive["Amount"].ToString()) * months_1new;
                                //NewObjlist.Active_m_id = Convert.ToInt32(dtActive["all_mid"].ToString());
                                //NewObjlist.Active_alw_type = dtActive["all_type"].ToString();


                                var olditem = oldList.Where(x => x.old_Name == NewObjlist.Active_Name).FirstOrDefault();
                                if (olditem != null)
                                {
                                    NewObjlist.Active_Amount = NewObjlist.Active_Amount + olditem.old_Amount;
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist.Active_Amount));
                                    NewObjlist.Active_Amount = float.Parse(ActiveAmount);
                                }

                                NewActiveList.Add(NewObjlist);
                            }



                            //if not in new list then add
                            //foreach (DataRow dtoldtonew in dtSumAllowance.Rows)
                            //{
                            //    ActiveAllowance NewObjlist1 = new ActiveAllowance();
                            //    NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                            //    NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                            //    NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                            //    var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                            //    if (olditem == null)
                            //    {
                            //        NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                            //        string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                            //        NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                            //        NewActiveList.Add(NewObjlist1);
                            //    }
                            //}
                            foreach (DataRow dtoldtonew in dtSumAllowancenew.Rows)
                            {
                                ActiveAllowance NewObjlist1 = new ActiveAllowance();
                                NewObjlist1.Active_Name = dtoldtonew["all_name"].ToString();
                                //NewObjlist1.Active_m_id = Convert.ToInt32(dtoldtonew["all_mid"].ToString());
                                //NewObjlist1.Active_alw_type = dtoldtonew["all_type"].ToString();
                                var olditem = NewActiveList.Where(x => x.Active_Name == NewObjlist1.Active_Name).FirstOrDefault();
                                if (olditem == null)
                                {
                                    NewObjlist1.Active_Amount = float.Parse(dtoldtonew["Amount"].ToString());
                                    string ActiveAmount = AddZerosAfterDecimal(Convert.ToString(NewObjlist1.Active_Amount));
                                    NewObjlist1.Active_Amount = float.Parse(ActiveAmount);
                                    NewActiveList.Add(NewObjlist1);
                                }
                            }
                            var check_currentmonth_tdsprocess_data = await _sha.Get_Table_FromQry("select emp_code from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");

                            if (check_currentmonth_tdsprocess_data.Rows.Count > 0)
                            {
                                await _sha.Run_UPDDEL_ExecuteNonQuery("delete from pr_emp_tds_process_allowances where emp_code=" + empCode + " and fm='" + FM + "';");
                            }
                            //int NewNumIndex = 0;

                            // StringBuilder sbqry = new StringBuilder();
                            //1. trans_id
                            //sbqry.Append(GenNewTransactionString());
                            decimal total_allowance = 0;
                            //foreach (var newlist in NewActiveList)
                            //{
                            //    total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                            //    NewNumIndex++;
                            //    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                            //    var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + "," + newlist.Active_m_id + ",'" + newlist.Active_Name + "','" + newlist.Active_alw_type + "'," + newlist.Active_Amount + ",1,@transidnew);";
                            //    sbqry.Append(newqry);
                            //    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            //}
                            foreach (var newlist in NewActiveList)
                            {
                                total_allowance = total_allowance + Convert.ToDecimal(newlist.Active_Amount);
                                NewNumIndex++;
                                sbqry.Append(GetNewNumStringArr("pr_emp_tds_process_allowances", NewNumIndex));
                                var newqry = "Insert into pr_emp_tds_process_allowances(Id, fy, fm, emp_id, emp_code, m_id, all_name, all_type, all_amount, active, trans_id) values" +
                                    " (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees where empid=" + empCode + ")," + empCode + ", " +
                                    "(select top 1 all_mid from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," +
                                    " '" + newlist.Active_Name + "',(select top 1 all_type from pr_emp_payslip_allowance where emp_code=" + empCode + " and all_name='" + newlist.Active_Name + "')," + newlist.Active_Amount + ",1,@transidnew);";
                                sbqry.Append(newqry);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process_allowances", "@idnew" + NewNumIndex, empCode.ToString()));
                            }



                            //List<string> lststring = new List<string>();
                            //lststring=(from a in NewActiveList join b in oldList on a.Active_Name equals b.old_Name select a.Active_Amount)


                            //// dtPfPerks
                            //if (dtPfperks.Rows.Count > 0)
                            //{
                            //    DataRow pfPerk = dtPfperks.Rows[0];

                            //    object val = pfPerk["pf_perk"];
                            //    if (val == DBNull.Value)
                            //    {
                            //        pf_perk = 0;
                            //    }
                            //    else
                            //    {
                            //        pf_perk = Convert.ToDecimal(pfPerk["pf_perk"]);
                            //    }

                            //}
                            //decimal pf_perktemp = Math.Round(Convert.ToDecimal(basic), 2) + Math.Round(Convert.ToDecimal(da_percent), 2);
                            
                            //dtLoanPerks
                            if (dtLoanPerks.Rows.Count > 0)
                            {
                                DataRow lperk = dtLoanPerks.Rows[0];

                                object val = lperk["loan_perk"];
                                if (val == DBNull.Value)
                                {
                                    loan_perk = 0;
                                }
                                else
                                {
                                    loan_perk = Convert.ToDecimal(lperk["loan_perk"]);
                                }

                            }
                            //dtIncentives
                            if (dtIncentives.Rows.Count > 0)
                            {
                                DataRow ins = dtIncentives.Rows[0];

                                object val = ins["incentive"];
                                if (val == DBNull.Value)
                                {
                                    incentives = 0;
                                }
                                else
                                {
                                    incentives = Convert.ToDecimal(ins["incentive"]);
                                }

                            }
                            //dt172
                            if (dt172.Rows.Count > 0)
                            {
                                DataRow VAL = dt172.Rows[0];
                                object val = VAL["val172"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_2 = 0;
                                }
                                else
                                {
                                    values_of_17_2 = Convert.ToDecimal(VAL["val172"]);
                                    totaltaxdeductedfrm16 = (float)Convert.ToDecimal(VAL["taxamount"]);
                                }
                            }
                            //dt173
                            if (dt173.Rows.Count > 0)
                            {
                                DataRow VAL1 = dt173.Rows[0];
                                object val = VAL1["val173"];
                                if (val == DBNull.Value)
                                {
                                    values_of_17_3 = 0;
                                }
                                else
                                {
                                    values_of_17_3 = Convert.ToDecimal(VAL1["val173"]);
                                }
                            }

                            if (dtRent.Rows.Count > 0)
                            {
                                //DataRow rents = dtRent.Rows[0];

                                //object val = rents["rentamount"];
                                //if (val == DBNull.Value)
                                //{
                                //    house_rent_allowance = 0;
                                //}
                                //else
                                //{
                                //    house_rent_allowance = Convert.ToDecimal(rents["rentamount"]);
                                //}
                            }

                            if (house_rent_allowance > 0)
                            {
                                decimal rentamt = Convert.ToDecimal(house_rent_allowance);
                                //salary(a)
                                decimal salary = da_percent + Convert.ToDecimal(basic);
                                //40%  of salary(b)
                                decimal bvalue = Convert.ToDecimal((0.40)) * (salary);
                                //houserentpaid - 10% of salary(c)
                                decimal hrentpaid = rentamt - (Convert.ToDecimal((0.10)) * (salary));
                                //house_rent_allowance = Math.Abs(Math.Min(salary, Math.Min(bvalue, hrentpaid)));
                                house_rent_allowance = Math.Min(hra, Math.Min(bvalue, hrentpaid));
                                // HouseRentAllowance calculated as on 04-09-2020
                                // minimun values of (
                                // Basic+DA --40%,
                                // House Rent Paid minus Basic+DA --10% 
                                // HRA)
                            }
                            //decimal daval = Convert.ToDecimal(da);
                            //decimal hraval = Convert.ToDecimal(hra);
                            //rent amount
                            if (house_rent_allowance < 0)
                            {
                                house_rent_allowance = 0;
                            }



                            if (dtOther.Rows.Count > 0)
                            {
                                DataRow otr = dtOther.Rows[0];

                                //other = Convert.ToDecimal(otr["other"]);

                                object val = otr["other"];
                                if (val == DBNull.Value)
                                {
                                    other = 0;
                                }
                                else
                                {
                                    other = Convert.ToDecimal(otr["other"]);
                                }

                            }

                            if (dtHouse.Rows.Count > 0)
                            {
                                //foreach (DataRow dr in dtHouse.Rows)
                                //{
                                //    if (dr["loan_type_mid"].ToString() == "4" || dr["loan_type_mid"].ToString() == "5" || dr["loan_type_mid"].ToString() == "6" ||
                                //        dr["loan_type_mid"].ToString() == "7" || dr["loan_type_mid"].ToString() == "8" || dr["loan_type_mid"].ToString() == "9"
                                //        || dr["loan_type_mid"].ToString() == "10" || dr["loan_type_mid"].ToString() == "11" || dr["loan_type_mid"].ToString() == "12"
                                //        || dr["loan_type_mid"].ToString() == "13")
                                //    {
                                //        count++;
                                //        loan_instl_amt = loan_instl_amt + Convert.ToDecimal(dr["installment_amount"]);
                                //    }

                                //}
                                //DataRow dh = dtHouse.Rows[0];

                                ////other = Convert.ToDecimal(otr["other"]);

                                //object val = dh["amount"];
                                //if (val == DBNull.Value)
                                //{
                                //    houseloan_allownace = 0;
                                //}
                                //else
                                //{
                                //    houseloan_allownace = Convert.ToDecimal(dh["amount"]);
                                //}

                            }
                            //if (count > 0)
                            //{

                            //    houseloan_allownace = 200000;
                            //}

                            //IList<section80C> lstCer = new List<section80C>();
                            //IList<section80CCC> lstCCC = new List<section80CCC>();
                            //IList<section80CCD> lstCCD = new List<section80CCD>();
                            //IList<sectionOther> lstOther = new List<sectionOther>();

                            decimal pf_new = 0;
                            if (dtCD.Rows.Count > 0)
                            {
                                foreach (DataRow cer in dtCD.Rows)
                                {
                                    //decimal amount = Convert.ToDecimal(cer["amount"].ToString());
                                    decimal? amount = 0;

                                    object val = cer["amount"];
                                    if (val == DBNull.Value)
                                    {
                                        amount = 0;
                                    }
                                    else
                                    {
                                        amount = Convert.ToDecimal(cer["amount"]);
                                    }

                                    string dd_name = Convert.ToString(cer["name"].ToString());
                                    if (dd_name == "Provident Fund")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //   amount = Convert.ToDecimal(pf + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = pf;
                                            //}

                                        }
                                        amount = Convert.ToDecimal(pf + (amount * months_1));
                                        pf_new = Convert.ToDecimal(amount);
                                    }
                                    else if (dd_name == "VPF")
                                    {
                                        if (monthcount != 1)
                                        {
                                            //if (months_1 != 2)
                                            //{
                                            //    amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                            //}
                                            //else if (months_1 == 2)
                                            //{
                                            //    amount = vpf_data;
                                            //}

                                        }
                                        amount = Convert.ToDecimal(vpf_data + (amount * months_1));
                                        
                                    }
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        //lstCer.Add(new section80C
                                        //{
                                        //    id = cer["id"].ToString(),
                                        //    name = cer["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //});
                                    }
                                    else
                                    {
                                        //lstCer.Add(new section80C
                                        //{
                                        //    id = cer["id"].ToString(),
                                        //    name = cer["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal("0"),
                                        //    ded_amount = AddZerosAfterDecimal("0")
                                        //});
                                    }

                                }


                            }
                            else
                            {
                                //lstCer.Add(new section80C
                                //{
                                //    id = "",
                                //    name = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }
                            decimal pf_perkcal = 0.5m;
                            decimal pf_perktemp = 12.5m;
                            pf_perk = (pf_new * pf_perkcal) / pf_perktemp;
                            if (dtCCC.Rows.Count > 0)
                            {
                                foreach (DataRow ccc in dtCCC.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccc["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance > 0 && max_allowance <= 150000)
                                    {
                                        if (amount > min_allowance)
                                        {
                                            allowance_amount = min_allowance;
                                            min_allowance = min_allowance - allowance_amount;
                                            max_allowance = max_allowance + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance = min_allowance - amount;
                                            allowance_amount = amount;
                                            max_allowance = max_allowance + amount;
                                        }
                                        //lstCCC.Add(new section80CCC
                                        //{
                                        //    id = ccc["id"].ToString(),
                                        //    name = ccc["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //});
                                    }
                                    else
                                    {
                                        //lstCCC.Add(new section80CCC
                                        //{
                                        //    id = ccc["id"].ToString(),
                                        //    name = ccc["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(ccc["amount"].ToString()),
                                        //    allowance_amount = AddZerosAfterDecimal("0"),
                                        //    ded_amount = AddZerosAfterDecimal("0")
                                        //});
                                    }

                                }

                            }
                            else
                            {

                                //lstCCC.Add(new section80CCC
                                //{
                                //    id = "",
                                //    name = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                            if (dtCCD.Rows.Count > 0)
                            {
                                foreach (DataRow ccd in dtCCD.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ccd["amount"].ToString());
                                    decimal? allowance_amount = 0;
                                    if (min_allowance80CCD > 0 && max_allowance80CCD <= 50000)
                                    {
                                        if (amount > min_allowance80CCD)
                                        {
                                            allowance_amount = min_allowance80CCD;
                                            min_allowance80CCD = min_allowance80CCD - allowance_amount;
                                            max_allowance80CCD = max_allowance80CCD + allowance_amount;
                                        }
                                        else
                                        {
                                            min_allowance80CCD = min_allowance80CCD - amount;
                                            allowance_amount = amount;
                                            max_allowance80CCD = max_allowance80CCD + amount;
                                        }

                                        //lstCCD.Add(new section80CCD
                                        //{
                                        //    id = ccd["id"].ToString(),
                                        //    name = ccd["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                        //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                        //});
                                    }
                                    else
                                    {

                                        //lstCCD.Add(new section80CCD
                                        //{
                                        //    id = ccd["id"].ToString(),
                                        //    name = ccd["name"].ToString(),
                                        //    amount = AddZerosAfterDecimal(ccd["amount"].ToString()),
                                        //    allowance_amount = AddZerosAfterDecimal("0"),
                                        //    ded_amount = AddZerosAfterDecimal("0")
                                        //});
                                    }
                                }
                            }
                            else
                            {

                                //lstCCD.Add(new section80CCD
                                //{
                                //    id = "",
                                //    name = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }

                            if (dtEdu.Rows.Count > 0)
                            {
                                foreach (DataRow ed in dtEdu.Rows)
                                {
                                    decimal amount = Convert.ToDecimal(ed["amount"].ToString());
                                    String sectionNAme = ed["section"].ToString();
                                    decimal? allowance_amount = 0;
                                    string id = ed["id"].ToString();
                                    decimal? ded_amount = 0;
                                    string actName = ed["name"].ToString();
                                    if (sectionNAme == "Section80G")
                                    {
                                        allowance_amount = amount * section80g;
                                        max_allowanceGG = max_allowanceGG + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80GGB")
                                    {
                                        allowance_amount = amount * section80gg;
                                        max_allowanceGGB = max_allowanceGGB + allowance_amount;
                                        ded_amount = allowance_amount;

                                    }
                                    else if (sectionNAme == "Section80DDB")
                                    {
                                        if (min_allowance80DDB > 0 && max_allowance80DB <= 60000)
                                        {
                                            if (amount > min_allowance80DDB)
                                            {
                                                allowance_amount = min_allowance80DDB;
                                                ded_amount = allowance_amount;
                                                min_allowance80DDB = min_allowance80DDB - allowance_amount;
                                                max_allowance80DB = max_allowance80DB + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DDB = min_allowance80DDB - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DB = max_allowance80DB + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                    }
                                    else if (sectionNAme == "Section80DD")
                                    {
                                        if (min_allowance80DD > 0 && max_allowance80DD <= 125000)
                                        {
                                            if (amount > min_allowance80DD)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80DD = min_allowance80DD - allowance_amount;
                                                max_allowance80DD = max_allowance80DD + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80DD = min_allowance80DD - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80DD = max_allowance80DD + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80U")
                                    {
                                        if (min_allowance80U > 0 && max_allowance80U <= 125000)
                                        {
                                            if (amount > min_allowance80U)
                                            {
                                                allowance_amount = min_allowance80DD;
                                                ded_amount = allowance_amount;
                                                min_allowance80U = min_allowance80U - allowance_amount;
                                                max_allowance80U = max_allowance80U + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80U = min_allowance80U - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80U = max_allowance80U + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80E")
                                    {
                                        allowance_amount = amount;
                                        max_allowance = max_allowance + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    else if (sectionNAme == "Section80D_P")
                                    {
                                        if (min_allowance80D_P > 0 && max_allowance80D_P <= 30000)
                                        {
                                            if (amount > min_allowance80D_P)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_P = min_allowance80D_P - allowance_amount;
                                                max_allowance80D_P = max_allowance80D_P + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_P = min_allowance80D_P - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_P = max_allowance80D_P + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }
                                        //if (min_allowance80D_P > amount)
                                        //{
                                        //    allowance_amount = amount;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}

                                        //else
                                        //{
                                        //    allowance_amount = min_allowance80D_P;
                                        //    max_allowance = max_allowance + allowance_amount;
                                        //    ded_amount = allowance_amount;
                                        //}
                                    }
                                    else if (sectionNAme == "Section80D_F")
                                    {
                                        if (min_allowance80D_F > 0 && max_allowance80D_F <= 25000)
                                        {
                                            if (amount > min_allowance80D_F)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance80D_F = min_allowance80D_F - allowance_amount;
                                                max_allowance80D_F = max_allowance80D_F + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80D_F = min_allowance80D_F - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance80D_F = max_allowance80D_F + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else if (sectionNAme == "Section80EE_HL1" || sectionNAme == "Section80EE_HL2" || sectionNAme == "Section80EE"|| sectionNAme == "Section80EE_HL")
                                    {
                                        if(sectionNAme!= "Section80EE")
                                        {
                                            sectionNAme = "Section80EE_HL";
                                        }
                                        if (min_allowance80EE > 0 && max_allowance80ee <= 200000)
                                        {
                                            if (amount > min_allowance80EE)
                                            {
                                                allowance_amount = min_allowance80EE;
                                                min_allowance80EE = min_allowance80EE - allowance_amount;
                                                max_allowance80ee = max_allowance80ee + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance80EE = min_allowance80EE - amount;
                                                allowance_amount = amount;
                                                max_allowance80ee = max_allowance80ee + amount;
                                            }
                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;

                                        }
                                    }

                                    else if (sectionNAme == "Section24(b)")
                                    {

                                        if (min_allowance24b > 0 && max_allowance24B <= 200000)
                                        {
                                            if (amount > min_allowance24b)
                                            {
                                                allowance_amount = min_allowance80D_P;
                                                ded_amount = allowance_amount;
                                                min_allowance24b = min_allowance24b - allowance_amount;
                                                max_allowance24B = max_allowance24B + allowance_amount;
                                            }
                                            else
                                            {
                                                min_allowance24b = min_allowance24b - amount;
                                                ded_amount = allowance_amount;
                                                allowance_amount = amount;
                                                max_allowance24B = max_allowance24B + amount;
                                            }

                                        }
                                        else
                                        {
                                            allowance_amount = 0;
                                            ded_amount = 0;
                                        }

                                    }
                                    else
                                    {
                                        allowance_amount = amount;
                                        max_allowance_other = max_allowance_other + allowance_amount;
                                        ded_amount = allowance_amount;
                                    }
                                    //lstOther.Add(new sectionOther
                                    //{
                                    //    id = id,
                                    //    name = actName,
                                    //    section = sectionNAme,
                                    //    amount = AddZerosAfterDecimal(Convert.ToString(amount)),
                                    //    allowance_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount)),
                                    //    ded_amount = AddZerosAfterDecimal(Convert.ToString(allowance_amount))

                                    //});

                                }

                            }

                            else
                            {
                                //lstOther.Add(new sectionOther
                                //{
                                //    id = "",
                                //    name = "",
                                //    section = "",
                                //    amount = AddZerosAfterDecimal("0"),
                                //    allowance_amount = AddZerosAfterDecimal("0"),
                                //    ded_amount = AddZerosAfterDecimal("0")
                                //});
                            }
                            max_allowance = max_allowanceGG + max_allowanceGGB + max_allowance80CCD + max_allowance80ee + max_allowance80DB + max_allowance80DD + max_allowance80U + max_allowance80D_P + max_allowance80D_F + max_allowance24B + max_allowance_other + max_allowance;
                            if (dtTax.Rows.Count > 0)
                            {


                                DataRow tax = dtTax.Rows[0];

                                object val = tax["tax_deducted_at_source"];
                                if (val == DBNull.Value)
                                {
                                    total_tax_till = 0;
                                }
                                else
                                {
                                    total_tax_till = (float)Convert.ToDecimal(tax["tax_deducted_at_source"]);
                                }

                                tax_till = totaltaxdeductedfrm16 + total_tax_till;
                                tax_till = 0; // for all employees this tax is 0

                            }

                            if (dtTDS.Rows.Count > 0)
                            {
                                DataRow TDS = dtTDS.Rows[0];

                                object val = TDS["tds_amount"];
                                if (val == DBNull.Value)
                                {
                                    paid_by_emp = 0;
                                }
                                else
                                {
                                    paid_by_emp = Convert.ToDecimal(TDS["tds_amount"]);
                                }
                            }

                            IList<TDSProcess> lstTDS = new List<TDSProcess>();

                            gross = basic + da_percent + per_allowance + int_ref + t_inc + fpa_allow + fpiip + pf_perk + loan_perk + incentives + spl_allowance + spl_da + hra + cca + values_of_17_2 + values_of_17_3 + total_allowance; // 1.

                            total_section = house_rent_allowance;

                            balance = gross - total_section;
                            //standard_deduction = PrConstants.STANDARD_DEDUCTION;
                            //emp_tax = PrConstants.EMP_TAX - (loss_months * 200);
                            //if (emp_tax > 2400)
                            //{
                            //    emp_tax = 2400;
                            //}
                            //aggregate_of_4 = Convert.ToDecimal((standard_deduction + emp_tax));
                            Income_chargable = balance; //- aggregate_of_4; //6

                            total_gross_income = Income_chargable + other;// - houseloan_allownace;

                            //deductible = Convert.ToDecimal(max_allowance);
                            total_income = total_gross_income;// - deductible;
                                                              //total_income = Convert.ToDecimal(841240.01);
                            round_income = Convert.ToDecimal(Math.Round(Convert.ToDouble(total_income)));
                            //tax_deducted_at_source is calculating as incometax value of current financial year.
                            decimal tax_deducted_at_source1 = 0;
                            if (dt_incometax.Rows.Count > 0)
                            {
                                DataRow incometax = dt_incometax.Rows[0];

                                object val = incometax["income_tax"];
                                if (val == DBNull.Value)
                                {
                                    tax_deducted_at_source1 = 0;
                                }
                                else
                                {
                                    tax_deducted_at_source1 = Convert.ToInt32(incometax["income_tax"]);
                                }
                            }
                            if (total_income > 500000)
                            {
                                //strConvert = income.ToString();
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = 0;
                                edu_cess = income * 4 / 100;

                                tax_payable = (float)income + edu_cess;
                                tax_payable = (int)Math.Round(tax_payable);


                                //if (tax_till > tax_payable)
                                //{
                                //    tax_balance = (tax_till + (float)paid_by_emp) - tax_payable;
                                //}
                                //else
                                //{
                                //    tax_balance = tax_payable - (tax_till + (float)paid_by_emp);
                                //}
                                tax_balance = tax_payable - (tax_till + (float)tax_deducted_at_source1);
                                if (tax_balance < 0)
                                {
                                    tax_balance = 0;
                                }

                                tds_per_month = tax_balance / months_1;
                                if (Financial_md.Month != 03)
                                {
                                    int x = (int)Math.Round(tds_per_month);
                                    int y = (int)Math.Round(x / 100d, 0) * 100;
                                    rounding_tds_per_month = y;
                                }
                                else
                                {
                                    int xp = (int)Math.Round(tds_per_month);
                                    int Z = (10 - xp % 10) + xp;
                                    rounding_tds_per_month = Z;
                                }

                                //int Z= (int)Math.Round(tds_per_month / 50d, 0) * 50;
                            }
                            else
                            {
                                income = (float)CalcITslabs(Convert.ToDecimal(round_income), empCode);
                                //income = (float)CalcITslabs(Convert.ToDecimal(round_income));
                                section_87a = Convert.ToDecimal(income);
                                edu_cess = 0;

                                tax_payable = 0;

                                tax_till = 0;
                                tax_balance = 0;

                                tds_per_month = 0;

                                rounding_tds_per_month = 0;
                            }
                            //string employer_name_address = PrConstants.Name;
                            //string employer_pan = PrConstants.PAN;
                            //string employer_tan = PrConstants.TAN;

                            //int NewNumIndex = 0;

                            //StringBuilder sbqry = new StringBuilder();
                            ////1. trans_id
                            //sbqry.Append(GenNewTransactionString());

                            //int finalSub = 0;

                            if (final == true)
                            {
                                finalSub = 1;
                            }
                            else
                            {
                                finalSub = 0;
                            }

                            string selQry = "select id,final from pr_emp_tds_process where active=1 and empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";

                            DataTable details = await _sha.Get_Table_FromQry(selQry);
                            if (details.Rows.Count > 0)
                            {
                                NewNumIndex++;
                                string tdsUpdate = "update pr_emp_tds_process set tds_update=0, final=" + finalSub + " where empcode = " + Convert.ToInt32(empCode) + ";";
                                sbqry.Append(tdsUpdate);
                                sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));
                            }
                            else
                            {

                                try
                                {
                                    NewNumIndex++;
                                    string tdsUpdate1 = "update pr_emp_tds_process set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    sbqry.Append(tdsUpdate1);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_process", empCode.ToString() + NewNumIndex, ""));

                                    NewNumIndex++;
                                    sbqry.Append(GetNewNumStringArr("pr_emp_tds_process", NewNumIndex));

                                    string qry = "INSERT INTO pr_emp_tds_process ([id],[fy],[fm],[empid],[empcode]," +
                                        "[tan_no],[sal_basic],[sal_fixed_personal_allowance],[sal_fpa_hra_allowance],[sal_fpiip]," +
                                        "[sal_da],[sal_hra],[sal_cca],[sal_interim_relief],[sal_telangana_increment],[sal_spl_allow]," +
                                        "[sal_spcl_da],[sal_pfperks],[sal_loanperks],[sal_incentive],[sal_value_of_perquisites]," +
                                        "[sal_profits_in_lieu_of_salary],[gross_salary],[house_rent_allowance],[total_of_sec10]," +
                                        "[balance_gross_min_sec10],[standard_deductions],[tax_of_employement],[tds_aggregate]," +
                                        "[income_chargeable_bal_minus_agg],[other_income_by_the_emp],[interest_on_housing]," +
                                        "[gross_total_income],[aggregate_of_deductible],[total_income],[tax_on_total_income]," +
                                        "[section_87a],[education_cess],[tax_payable],[tax_deducted_at_source],[tax_paid_by_the_employer]," +
                                        "[balance_tax],[balance_months],[tds_per_month],[active],[trans_id],[tds_update],[final]) VALUES (@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                            " where empid=" + empCode + ")," + empCode + ",'" + employer_tan + "'," + basic + "," +
                                            "" + per_allowance + "," + fpa_allow + "," + fpiip + "," +
                                            "" + da_percent + "," + hra + "," + cca + "," + int_ref + "," +
                                            "" + t_inc + "," + spl_allowance + "," + spl_da + "," + pf_perk + "," +
                                            "" + loan_perk + "," + incentives + "," + values_of_17_2 + "," + values_of_17_3 + "," + gross + "," + house_rent_allowance + "," +
                                            "" + total_section + "," + balance + "," + standard_deduction + "," + emp_tax + "," +
                                            "" + aggregate_of_4 + "," + Income_chargable + "," + other + "," + houseloan_allownace + "," +
                                            "" + total_gross_income + "," + deductible + "," + total_income + "," + income + "," +
                                            "" + section_87a + "," + edu_cess + "," + tax_payable + "," + tax_deducted_at_source1 + "," +
                                            "" + tax_till + "," + tax_balance + "," + months_1 + "," + rounding_tds_per_month + ",1,@transidnew,0," + finalSub + ");";

                                    sbqry.Append(qry);
                                    sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_process", "@idnew" + NewNumIndex, empCode.ToString()));


                                    //if (lstCer != null)
                                    //{
                                    //    string selQry1 = "select id from pr_emp_tds_section_deductions where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                    //    DataTable details1 = await _sha.Get_Table_FromQry(selQry1);
                                    //    if (details1.Rows.Count > 0)
                                    //    {
                                    //        NewNumIndex++;
                                    //        string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //        sbqry.Append(tdsUpdate2);
                                    //        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));
                                    //    }
                                    //    foreach (var ccDatas in lstCer)
                                    //    {

                                    //        if (ccDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + ccDatas.id + ",'Section80C'," + ccDatas.amount + "," + ccDatas.allowance_amount + "," + ccDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstCCC != null)
                                    //{
                                    //    string selQry2 = "select id from pr_emp_tds_section_deductions where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                    //    DataTable details2 = await _sha.Get_Table_FromQry(selQry2);
                                    //    if (details2.Rows.Count > 0)
                                    //    {
                                    //        NewNumIndex++;
                                    //        string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //        sbqry.Append(tdsUpdate2);
                                    //        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));
                                    //    }
                                    //    foreach (var cccDatas in lstCCC)
                                    //    {

                                    //        if (cccDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + cccDatas.id + ",'Section80CCC'," + cccDatas.amount + "," + cccDatas.allowance_amount + "," + cccDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstCCD != null)
                                    //{
                                    //    foreach (var ccdDatas in lstCCD)
                                    //    {
                                    //        string selQry1 = "select id from pr_emp_tds_section_deductions where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                    //        DataTable details1 = await _sha.Get_Table_FromQry(selQry1);
                                    //        if (details1.Rows.Count > 0)
                                    //        {
                                    //            NewNumIndex++;
                                    //            string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //            sbqry.Append(tdsUpdate2);
                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));
                                    //        }
                                    //        if (ccdDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + ccdDatas.id + ",'Section80CCD'," + ccdDatas.amount + "," + ccdDatas.allowance_amount + "," + ccdDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}
                                    //if (lstOther != null)
                                    //{
                                    //    string selQry1 = "select id from pr_emp_tds_section_deductions where empcode = " + Convert.ToInt32(empCode) + " and Month(fm)='" + checkMonth + "' and Year(fm)='" + checkYear + "';";
                                    //    DataTable details1 = await _sha.Get_Table_FromQry(selQry1);
                                    //    if (details1.Rows.Count > 0)
                                    //    {
                                    //        NewNumIndex++;
                                    //        string tdsUpdate2 = "update pr_emp_tds_section_deductions set active=0 where empcode = " + Convert.ToInt32(empCode) + ";";
                                    //        sbqry.Append(tdsUpdate2);
                                    //        sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.U, "pr_emp_tds_section_deductions", empCode.ToString() + NewNumIndex, ""));
                                    //    }
                                    //    foreach (var otherDatas in lstOther)
                                    //    {
                                    //        if (otherDatas.id != "")
                                    //        {
                                    //            NewNumIndex++;
                                    //            sbqry.Append(GetNewNumStringArr("pr_emp_tds_section_deductions", NewNumIndex));

                                    //            string bioQry = "INSERT INTO pr_emp_tds_section_deductions ([id],[fy],[fm],[empid],[empcode],[m_id]," +
                                    //                "[section_type],[gross],[qual],[ded],[active],[trans_id]) " +
                                    //                "VALUES(@idnew" + NewNumIndex + "," + FY + ",'" + FM + "',(select id from employees" +
                                    //                " where empid=" + empCode + ")," + empCode + "," + otherDatas.id + ",'Other'," + otherDatas.amount + "," + otherDatas.allowance_amount + "," + otherDatas.ded_amount + ",1,@transidnew);";
                                    //            sbqry.Append(bioQry);

                                    //            sbqry.Append(GetTransactionTouchStringArr(Transaction_Touch_Type.I, "pr_emp_tds_section_deductions", "@idnew" + NewNumIndex, empCode.ToString()));
                                    //        }

                                    //    }
                                    //}

                                }
                                catch (Exception e)
                                {
                                    return "E#TDS Process#" + e.Message;
                                }

                            }
                            //}
                        }
                    }
                    if (await _sha.Run_UPDDEL_ExecuteNonQuery(sbqry.ToString()))
                    {
                        SMessage = "I#TDS Process#TDS Processed Successfully..!!";
                        sbqry.Clear();
                        //return SMessage;
                    }
                    else
                    {
                        SMessage = "E#TDS Process#Error While TDS Process..!!";
                        sbqry.Clear();
                        //return SMessage;
                    }
                }

                if (SMessage.StartsWith("I"))
                {
                    SSMessage = "I#TDS Process#TDS Processed Sucessfully for all the Employees";
                    return SSMessage;
                }
                else
                {
                    SSMessage = "E#TDS Process#Error While TDS Process..!!";
                    return SSMessage;
                }
            }
            catch (Exception e)
            {
                return "E#TDS Process#" + e.Message;
            }

        }
        //Below CalcITslabs is only for the slab rates 5%, 20% and 30%
        //public decimal CalcITslabs(decimal taxableamount)
        //{
        //    decimal taxamount = 0;
        //    decimal MinAmount = 250000;
        //    decimal MidAmount = 500000;
        //    decimal MaxAmount = 1000000;
        //    decimal MinPercent =Convert.ToDecimal(0.05);
        //    decimal MidPercent = Convert.ToDecimal(0.2);
        //    decimal MaxPercent = Convert.ToDecimal(0.3);
        //    decimal RemainingAmt = 0;
        //    decimal ret = 0;
        //    //if(taxableamount <= MidAmount)
        //    //{
        //    //    taxamount = 0;
        //    //} else if(taxableamount > MidAmount && taxableamount<= MaxAmount)
        //    //{
        //    //    taxamount = taxableamount * Convert.ToDecimal(0.2);
        //    //} else if(taxableamount> MaxAmount)
        //    //{
        //    //    taxamount = 100000+ taxableamount * Convert.ToDecimal(0.3);
        //    //}

        //    if (taxableamount > MinAmount)
        //    {
        //        RemainingAmt = taxableamount - MinAmount;//2250000
        //        if (RemainingAmt > MinAmount)
        //        {
        //            taxamount += MinAmount * MinPercent;//250000*0.05=12500
        //            RemainingAmt = RemainingAmt - MinAmount;//2250000-250000=2000000
        //            if (RemainingAmt > MidAmount)//
        //            {
        //                taxamount += MidAmount * MidPercent;//500000*0.2=100000+125000=125000
        //                RemainingAmt = RemainingAmt - MidAmount;//2000000-500000=1500000

        //                if (RemainingAmt > MaxAmount)
        //                {
        //                    taxamount += RemainingAmt * MaxPercent;//1500000*0.3=x,125000+x
        //                }
        //                else
        //                {
        //                    taxamount += RemainingAmt * MaxPercent;
        //                }

        //            }
        //            else
        //            {
        //                taxamount += RemainingAmt * MidPercent;
        //            }
        //        }
        //        else
        //        {
        //            taxamount += RemainingAmt * MinPercent;
        //        }
        //    }
        //    return taxamount;
        //}

        //Below CalcITslabs is for the new slab rates 5%, 10%, 15%,20%,25% and 30%
        public decimal CalcITslabs(decimal taxableamount, string empCode)
        {
            //LoginCredential _loginCredential = null;
            int finyear, finyear1;
            finyear1 = _LoginCredential.FY;
            string str_empqry;
            int sel_option = 0;
            //string str_finYear= "select year(fm) as Year from pr_month_details where active=1";
            //DataTable dt_finyear = sh.Get_Table_FromQry(str_finYear);
            //finyear = Convert.ToInt32(dt_finyear.Rows[0]["Year"]);

            decimal taxamount = 0;
            decimal RemainingAmt = 0;
            string strquery_tax_rate_op1, strquery_tax_rate_op2;
            try
            {


                str_empqry = "select [EmpId],[fy],[Option] from pr_tax_option_emp_wise where [EmpId]=" + empCode + ";";
                DataTable dt_getempdet = sh.Get_Table_FromQry(str_empqry);
                if (dt_getempdet.Rows.Count > 0)
                {
                    sel_option = Convert.ToInt32(dt_getempdet.Rows[0]["Option"]);
                }
                if (sel_option == 1 || dt_getempdet.Rows.Count == 0)
                {
                    strquery_tax_rate_op1 = "Select [Id], [fy],[options],[tax_slab],[tax_rate],[tax_rebate] from pr_tax_rate where options=" + sel_option + " and fy=" + finyear1 + "";
                    DataTable dt_tax_rate_op1 = sh.Get_Table_FromQry(strquery_tax_rate_op1);
                    string str_taxslab_o1_min, str_taxslab_o1_mid1, str_taxslab_o1_mid2, str_taxslab_o1_max1, str_taxslab_o1_max2, str_taxslab_o1_max3; // for taxslab in option 1 
                    string str_taxrate_o1_min, str_taxrate_o1_mid, str_taxrate_o1_max;
                    str_taxslab_o1_min = dt_tax_rate_op1.Rows[1]["tax_slab"].ToString();
                    str_taxslab_o1_mid1 = dt_tax_rate_op1.Rows[2]["tax_slab"].ToString();
                    str_taxslab_o1_mid2 = dt_tax_rate_op1.Rows[3]["tax_slab"].ToString();
                    str_taxslab_o1_max1 = dt_tax_rate_op1.Rows[4]["tax_slab"].ToString();
                    str_taxslab_o1_max2 = dt_tax_rate_op1.Rows[5]["tax_slab"].ToString();
                    str_taxslab_o1_max3 = dt_tax_rate_op1.Rows[6]["tax_slab"].ToString();

                    str_taxrate_o1_min = dt_tax_rate_op1.Rows[1]["tax_rate"].ToString();
                    str_taxrate_o1_mid = dt_tax_rate_op1.Rows[2]["tax_rate"].ToString();
                    str_taxrate_o1_max = dt_tax_rate_op1.Rows[4]["tax_rate"].ToString();

                    decimal MinAmountOp1 = Convert.ToDecimal(str_taxslab_o1_min.Substring(0, 6));
                    decimal MidAmountOp1 = Convert.ToDecimal(str_taxslab_o1_mid1.Substring(0, 6));
                    decimal MaxAmountOp1 = Convert.ToDecimal(str_taxslab_o1_max1.Substring(0, 7));

                    decimal MinPercentop1 = Convert.ToDecimal(0.05); //  5%
                    decimal MidPercentop1 = Convert.ToDecimal(0.20); //  20%
                    decimal MaxPercentop1 = Convert.ToDecimal(0.30); //  30%

                    if (taxableamount > MinAmountOp1)
                    {
                        RemainingAmt = taxableamount - MinAmountOp1;//2250000
                        if (RemainingAmt > MinAmountOp1)
                        {
                            taxamount += MinAmountOp1 * MinPercentop1;//250000*0.05=12500
                            RemainingAmt = RemainingAmt - MinAmountOp1;//2250000-250000=2000000
                            if (RemainingAmt > MidAmountOp1)//
                            {
                                taxamount += MidAmountOp1 * MidPercentop1;//500000*0.2=100000+125000=125000
                                RemainingAmt = RemainingAmt - MidAmountOp1;//2000000-500000=1500000

                                if (RemainingAmt > MaxAmountOp1)
                                {
                                    taxamount += RemainingAmt * MaxPercentop1;//1500000*0.3=x,125000+x
                                }
                                else
                                {
                                    taxamount += RemainingAmt * MaxPercentop1;
                                }

                            }
                            else
                            {
                                taxamount += RemainingAmt * MidPercentop1;
                            }
                        }
                        else
                        {
                            taxamount += RemainingAmt * MinPercentop1;
                        }
                    }
                }
                else if (sel_option == 2)
                {
                    string str_taxslab_o2_min1, str_taxslab_o2_min2, str_taxslab_o2_mid1, str_taxslab_o2_mid2, str_taxslab_o2_max1, str_taxslab_o2_max2; //for taxslab in option 2
                    string str_taxrate_o2_min1, str_taxrate_o2_min2, str_taxrate_o2_mid1, str_taxrate_o2_mid2, str_taxrate_o2_max1, str_taxrate_o2_max2; //for taxrate in option 2
                    strquery_tax_rate_op2 = "Select [Id], [fy],[options],[tax_slab],[tax_rate],[tax_rebate] from pr_tax_rate where options=" + sel_option + " and fy=" + finyear1 + "";
                    DataTable dt_tax_rate_op2 = sh.Get_Table_FromQry(strquery_tax_rate_op2);
                    str_taxslab_o2_min1 = dt_tax_rate_op2.Rows[1]["tax_slab"].ToString();
                    str_taxslab_o2_min2 = dt_tax_rate_op2.Rows[2]["tax_slab"].ToString();
                    str_taxslab_o2_mid1 = dt_tax_rate_op2.Rows[3]["tax_slab"].ToString();
                    str_taxslab_o2_mid2 = dt_tax_rate_op2.Rows[4]["tax_slab"].ToString();
                    str_taxslab_o2_max1 = dt_tax_rate_op2.Rows[5]["tax_slab"].ToString();
                    str_taxslab_o2_max2 = dt_tax_rate_op2.Rows[6]["tax_slab"].ToString();

                    str_taxrate_o2_min1 = dt_tax_rate_op2.Rows[1]["tax_rate"].ToString();
                    str_taxrate_o2_min2 = dt_tax_rate_op2.Rows[2]["tax_rate"].ToString();
                    str_taxrate_o2_mid1 = dt_tax_rate_op2.Rows[4]["tax_rate"].ToString();
                    str_taxrate_o2_mid2 = dt_tax_rate_op2.Rows[1]["tax_rate"].ToString();
                    str_taxrate_o2_max1 = dt_tax_rate_op2.Rows[2]["tax_rate"].ToString();
                    str_taxrate_o2_max2 = dt_tax_rate_op2.Rows[4]["tax_rate"].ToString();

                    decimal MinAmountOp2_1 = Convert.ToDecimal(str_taxslab_o2_min1.Substring(0, 6));
                    decimal MinAmountOp2_2 = Convert.ToDecimal(str_taxslab_o2_min2.Substring(0, 6));
                    decimal MidAmountOp2_1 = Convert.ToDecimal(str_taxslab_o2_mid1.Substring(0, 6));
                    decimal MidAmountOp2_2 = Convert.ToDecimal(str_taxslab_o2_mid2.Substring(0, 7));
                    decimal MaxAmountOp2_1 = Convert.ToDecimal(str_taxslab_o2_max1.Substring(0, 7));
                    decimal MaxAmountOp2_2 = Convert.ToDecimal(str_taxslab_o2_max2.Substring(0, 7));

                    decimal MinPercentop2_1 = Convert.ToDecimal(0.05); //  5%
                    decimal MinPercentop2_2 = Convert.ToDecimal(0.10); //  10%
                    decimal MidPercentop2_1 = Convert.ToDecimal(0.15); //  15%
                    decimal MidPercentop2_2 = Convert.ToDecimal(0.20); //  20%
                    decimal MaxPercentop2_1 = Convert.ToDecimal(0.25); //  25%
                    decimal MaxPercentop2_2 = Convert.ToDecimal(0.30); //  30%
                    if (taxableamount > MinAmountOp2_1)
                    {
                        RemainingAmt = taxableamount - MinAmountOp2_1; // RemainingAmt = 2000000-250000 = 1750000
                        if (RemainingAmt > MinAmountOp2_1) // 1750000 > 250000
                        {
                            taxamount += MinAmountOp2_1 * MinPercentop2_1; // 
                            RemainingAmt = RemainingAmt - MinAmountOp2_1;
                            if (RemainingAmt > MinAmountOp2_2)//
                            {
                                taxamount += MinAmountOp2_2 * MinPercentop2_2;
                                RemainingAmt = RemainingAmt - MinAmountOp2_2;

                                if (RemainingAmt > MidAmountOp2_1)
                                {
                                    taxamount += MidAmountOp2_1 * MidPercentop2_1;
                                    RemainingAmt = RemainingAmt - MidAmountOp2_1;
                                    if (RemainingAmt > MidAmountOp2_2)
                                    {
                                        taxamount += MidAmountOp2_2 * MidPercentop2_2;
                                        RemainingAmt = RemainingAmt - MidAmountOp2_2;
                                        if (RemainingAmt > MaxAmountOp2_1)
                                        {
                                            taxamount += MaxAmountOp2_1 * MaxPercentop2_1;
                                            RemainingAmt = RemainingAmt - MaxAmountOp2_1;
                                            if (RemainingAmt > MaxAmountOp2_2)
                                            {
                                                taxamount += MaxAmountOp2_2 * MaxPercentop2_2;
                                                RemainingAmt = RemainingAmt - MaxAmountOp2_2;
                                            }
                                            else
                                            {
                                                taxamount += RemainingAmt * MaxPercentop2_2;
                                            }
                                        }
                                        else
                                        {
                                            taxamount += RemainingAmt * MaxPercentop2_1;
                                        }
                                    }
                                    else
                                    {
                                        taxamount += RemainingAmt * MidPercentop2_2;
                                    }
                                }
                                else
                                {
                                    taxamount += RemainingAmt * MidPercentop2_1;
                                }

                            }
                            else
                            {
                                taxamount += RemainingAmt * MinPercentop2_2;
                            }
                        }
                        else
                        {
                            taxamount += RemainingAmt * MinPercentop2_1;
                        }
                    }
                }
                return taxamount;
            }
            catch (Exception ex)
            {
                return taxamount;
            }

            //strquery_tax_rate_op1 = "Select [Id], [fy],[options],[tax_slab],[tax_rate],[tax_rebate] from pr_tax_rate where options=1 and fy="+ finyear1 + "";
            //strquery_tax_rate_op2 = "Select [Id], [fy],[options],[tax_slab],[tax_rate],[tax_rebate] from pr_tax_rate where options=2 and fy="+finyear1+"";
            //DataTable dt_tax_rate_op1 = sh.Get_Table_FromQry(strquery_tax_rate_op1);
            //DataTable dt_tax_rate_op2 = sh.Get_Table_FromQry(strquery_tax_rate_op2);
            //for option 1
            //string str_taxslab_o1_min, str_taxslab_o1_mid1, str_taxslab_o1_mid2, str_taxslab_o1_max1, str_taxslab_o1_max2, str_taxslab_o1_max3; // for taxslab in option 1 
            //string str_taxrate_o1_min, str_taxrate_o1_mid, str_taxrate_o1_max; // for taxrate in option 1 (5%,20%,30%)
            //for option 2
            //string str_taxslab_o2_min1, str_taxslab_o2_min2, str_taxslab_o2_mid1, str_taxslab_o2_mid2, str_taxslab_o2_max1, str_taxslab_o2_max2; //for taxslab in option 2
            //string str_taxrate_o2_min1, str_taxrate_o2_min2, str_taxrate_o2_mid1, str_taxrate_o2_mid2, str_taxrate_o2_max1, str_taxrate_o2_max2; //for taxrate in option 2

            // for option 1
            //str_taxslab_o1_min = dt_tax_rate_op1.Rows[1]["tax_slab"].ToString();
            //str_taxslab_o1_mid1 = dt_tax_rate_op1.Rows[2]["tax_slab"].ToString();
            //str_taxslab_o1_mid2 = dt_tax_rate_op1.Rows[3]["tax_slab"].ToString();
            //str_taxslab_o1_max1 = dt_tax_rate_op1.Rows[4]["tax_slab"].ToString();
            //str_taxslab_o1_max2 = dt_tax_rate_op1.Rows[5]["tax_slab"].ToString();
            //str_taxslab_o1_max3 = dt_tax_rate_op1.Rows[6]["tax_slab"].ToString();

            //str_taxrate_o1_min= dt_tax_rate_op1.Rows[1]["tax_rate"].ToString();
            //str_taxrate_o1_mid = dt_tax_rate_op1.Rows[2]["tax_rate"].ToString();
            //str_taxrate_o1_max = dt_tax_rate_op1.Rows[4]["tax_rate"].ToString();

            // for option 2
            //str_taxslab_o2_min1 = dt_tax_rate_op2.Rows[1]["tax_slab"].ToString();
            //str_taxslab_o2_min2 = dt_tax_rate_op2.Rows[2]["tax_slab"].ToString();
            //str_taxslab_o2_mid1 = dt_tax_rate_op2.Rows[3]["tax_slab"].ToString();
            //str_taxslab_o2_mid2 = dt_tax_rate_op2.Rows[4]["tax_slab"].ToString();
            //str_taxslab_o2_max1 = dt_tax_rate_op2.Rows[5]["tax_slab"].ToString();
            //str_taxslab_o2_max2 = dt_tax_rate_op2.Rows[6]["tax_slab"].ToString();

            //str_taxrate_o2_min1 = dt_tax_rate_op2.Rows[1]["tax_rate"].ToString();
            //str_taxrate_o2_min2 = dt_tax_rate_op2.Rows[2]["tax_rate"].ToString();
            //str_taxrate_o2_mid1 = dt_tax_rate_op2.Rows[4]["tax_rate"].ToString();
            //str_taxrate_o2_mid2 = dt_tax_rate_op2.Rows[1]["tax_rate"].ToString();
            //str_taxrate_o2_max1 = dt_tax_rate_op2.Rows[2]["tax_rate"].ToString();
            //str_taxrate_o2_max2 = dt_tax_rate_op2.Rows[4]["tax_rate"].ToString();

            //for option 1
            //decimal MinAmountOp1 = Convert.ToDecimal(str_taxslab_o1_min.Substring(0,6));
            //decimal MidAmountOp1 = Convert.ToDecimal(str_taxslab_o1_mid1.Substring(0, 6)); 
            //decimal MaxAmountOp1 = Convert.ToDecimal(str_taxslab_o1_max1.Substring(0, 7));
            //for option 2
            //decimal MinAmountOp2_1 = Convert.ToDecimal(str_taxslab_o2_min1.Substring(0, 6));
            //decimal MinAmountOp2_2 = Convert.ToDecimal(str_taxslab_o2_min2.Substring(0, 6));
            //decimal MidAmountOp2_1 = Convert.ToDecimal(str_taxslab_o2_mid1.Substring(0, 6));
            //decimal MidAmountOp2_2 = Convert.ToDecimal(str_taxslab_o2_mid2.Substring(0, 7));
            //decimal MaxAmountOp2_1 = Convert.ToDecimal(str_taxslab_o2_max1.Substring(0, 7));
            //decimal MaxAmountOp2_2 = Convert.ToDecimal(str_taxslab_o2_max2.Substring(0, 7));

            //percent calculations for options 1 slabs
            //decimal MinPercentop1 = Convert.ToDecimal(0.05); //  5%
            //decimal MidPercentop1 = Convert.ToDecimal(0.20); //  20%
            //decimal MaxPercentop1 = Convert.ToDecimal(0.30); //  30%
            //percent calculations for options 2 slabs
            //decimal MinPercentop2_1 = Convert.ToDecimal(0.05); //  5%
            //decimal MinPercentop2_2 = Convert.ToDecimal(0.10); //  10%
            //decimal MidPercentop2_1 = Convert.ToDecimal(0.15); //  15%
            //decimal MidPercentop2_2 = Convert.ToDecimal(0.20); //  20%
            //decimal MaxPercentop2_1 = Convert.ToDecimal(0.25); //  25%
            //decimal MaxPercentop2_2 = Convert.ToDecimal(0.30); //  30%

            //calculating slab for option 1
            //if (option == "Option 1")
            //{
            //if (taxableamount > MinAmountOp1)
            //{
            //    RemainingAmt = taxableamount - MinAmountOp1;//2250000
            //    if (RemainingAmt > MinAmountOp1)
            //    {
            //        taxamount += MinAmountOp1 * MinPercentop1;//250000*0.05=12500
            //        RemainingAmt = RemainingAmt - MinAmountOp1;//2250000-250000=2000000
            //        if (RemainingAmt > MidAmountOp1)//
            //        {
            //            taxamount += MidAmountOp1 * MidPercentop1;//500000*0.2=100000+125000=125000
            //            RemainingAmt = RemainingAmt - MidAmountOp1;//2000000-500000=1500000

            //            if (RemainingAmt > MaxAmountOp1)
            //            {
            //                taxamount += RemainingAmt * MaxPercentop1;//1500000*0.3=x,125000+x
            //            }
            //            else
            //            {
            //                taxamount += RemainingAmt * MaxPercentop1;
            //            }

            //        }
            //        else
            //        {
            //            taxamount += RemainingAmt * MidPercentop1;
            //        }
            //    }
            //    else
            //    {
            //        taxamount += RemainingAmt * MinPercentop1;
            //    }
            //}
            //}

            //calculating slab for option 2
            //else if( option=="Option 2")
            //{
            //    if (taxableamount > MinAmountOp2_1)
            //    {
            //        RemainingAmt = taxableamount - MinAmountOp2_1; // RemainingAmt = 2000000-250000 = 1750000
            //        if (RemainingAmt > MinAmountOp2_1) // 1750000 > 250000
            //        {
            //            taxamount += MinAmountOp2_1 * MinPercentop2_1; // 
            //            RemainingAmt = RemainingAmt - MinAmountOp2_1;
            //            if (RemainingAmt > MinAmountOp2_2)//
            //            {
            //                taxamount += MinAmountOp2_2 * MinPercentop2_2;
            //                RemainingAmt = RemainingAmt - MinAmountOp2_2;

            //                if (RemainingAmt > MidAmountOp2_1)
            //                {
            //                    taxamount += RemainingAmt * MidPercentop2_1;
            //                    RemainingAmt = RemainingAmt - MidAmountOp2_1;
            //                    if (RemainingAmt > MidAmountOp2_2)
            //                    {
            //                        taxamount += RemainingAmt * MidPercentop2_2;
            //                        RemainingAmt = RemainingAmt - MidAmountOp2_2;
            //                        if (RemainingAmt > MaxAmountOp2_1)
            //                        {
            //                            taxamount += RemainingAmt * MaxPercentop2_1;
            //                            RemainingAmt = RemainingAmt - MaxAmountOp2_1;
            //                            if (RemainingAmt > MaxAmountOp2_2)
            //                            {
            //                                taxamount += RemainingAmt * MaxPercentop2_2;
            //                                RemainingAmt = RemainingAmt - MaxAmountOp2_2;
            //                            }
            //                            else
            //                            {
            //                                taxamount += RemainingAmt * MaxPercentop2_2;
            //                            }
            //                        }
            //                        else
            //                        {
            //                            taxamount += RemainingAmt * MaxPercentop2_1;
            //                        }
            //                    }
            //                    else
            //                    {
            //                        taxamount += RemainingAmt * MidPercentop2_2;
            //                    }
            //                }
            //                else
            //                {
            //                    taxamount += RemainingAmt * MidPercentop2_1;
            //                }

            //            }
            //            else
            //            {
            //                taxamount += RemainingAmt * MinPercentop2_2;
            //            }
            //        }
            //        else
            //        {
            //            taxamount += RemainingAmt * MinPercentop2_1;
            //        }
            //    }
            //}


        }
        public string AddZerosAfterDecimal(string amount)
        {
            float number1 = float.Parse(amount);
            double number = double.Parse(amount, CultureInfo.InvariantCulture);
            string ret = "";
            ret = String.Format("{0:0.00}", number);
            return ret;
        }
        public decimal CalcHRA(decimal er_Amt, string E_designation)
        {
            decimal ret = 0;
            decimal HRAOthersPercentage = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
                .Where(x => x["constant"].ToString() == "HRAOthersPercentage")
                .Select(x => x["value"].ToString()).FirstOrDefault());

            decimal HRAStaffAsstAttenderPercentage = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
                .Where(x => x["constant"].ToString() == "HRAStaffAsstAttenderPercentage")
                .Select(x => x["value"].ToString()).FirstOrDefault());


            if (E_designation == "Staff Assistant" || E_designation == "Attender" || E_designation == "Driver" || E_designation == "Watchman")
            {
                ret = er_Amt * HRAStaffAsstAttenderPercentage;
            }
            else
            {
                ret = er_Amt * HRAOthersPercentage;
            }

            return (decimal)Math.Round(ret, 2, MidpointRounding.AwayFromZero);
        }
        private decimal CalcDA(decimal er_Amt, DataTable dtDa_slabs)
        {
            decimal retVal = 0;
            decimal d = 0;
            if (dtDa_slabs.Rows.Count > 0)
            {
                DataRow dsl = dtDa_slabs.Rows[0];
                decimal da_slab = decimal.Parse(dsl["da_percent"].ToString());
                retVal = (da_slab / 100) * er_Amt;
                d = retVal % 1;
                double res = 0.5 - Convert.ToDouble(d);
                if (res < 0.1)
                {
                    retVal = Math.Truncate(retVal * 100) / 100;
                }
                else
                {
                    retVal = Math.Round(retVal, 2, MidpointRounding.AwayFromZero);
                }
            }

            return retVal;
        }


        private decimal CalcSplDA(decimal er_Amt, DataTable dtDa_slabs)
        {
            decimal retVal = 0;
            if (dtDa_slabs.Rows.Count > 0)
            {
                DataRow dsl = dtDa_slabs.Rows[0];
                decimal da_slab = decimal.Parse(dsl["da_percent"].ToString());
                retVal = (da_slab / 100) * er_Amt;
            }

            return (decimal)Math.Round(retVal, 2);
        }

        public decimal CalcCCA(decimal er_Amt, string Designation, int workingdays, int no_of_days_mnth)
        {
            decimal ret = 0;

            //0.04
            string CCAPercentage = dt_qryconstantsnew.Rows.Cast<DataRow>()
                .Where(x => x["constant"].ToString() == "CCAPercentage")
                .Select(x => x["value"].ToString()).FirstOrDefault();

            //400
            decimal MinCCAConditionalAmt = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
                .Where(x => x["constant"].ToString() == "MinCCAConditionalAmt")
                .Select(x => x["value"].ToString()).FirstOrDefault());

            //470
            decimal MidCCAConditionalAmt = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
                .Where(x => x["constant"].ToString() == "MidCCAConditionalAmt")
                .Select(x => x["value"].ToString()).FirstOrDefault());

            //870
            decimal MaxCCAConditionalAmt = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
                .Where(x => x["constant"].ToString() == "MaxCCAConditionalAmt")
                .Select(x => x["value"].ToString()).FirstOrDefault());

            var n_CCA = er_Amt * decimal.Parse(CCAPercentage);


            if (Designation == "Attender" || Designation == "Attender Cum Watchman" || Designation == "Attender/J.C" || Designation == "Civil Engg Supervisor" || Designation == "Driver" || Designation == "Stenographer" || Designation == "Telephone Operator Cum Receptionist" || Designation == "Typist" || Designation == "Watchman" || Designation == "Subordinate Staff(Substaff)" || Designation == "Junior Clerk")
            {
                if (n_CCA <= MinCCAConditionalAmt)
                    ret = n_CCA;
                else
                {
                    ret = MinCCAConditionalAmt / no_of_days_mnth * workingdays;
                }

            }
            else if (Designation == "Staff Assistant" || Designation == "JR Staff Assistant" || Designation == "Staff Assistant Cum Assistant Cashier" || Designation == "JR Staff Assistant")
            {
                if (n_CCA <= MidCCAConditionalAmt)
                    ret = Convert.ToInt32(n_CCA);
                else
                    ret = MidCCAConditionalAmt / no_of_days_mnth * workingdays;
            }
            else if (Designation == "Managing Director" || Designation == "Chief General Manager" || Designation == "General Manager" || Designation == "Deputy General Manager" || Designation == "Assistant General Manager" || Designation == "Senior Manager" || Designation == "Manager Scale-1" || Designation == "Manager" || Designation == "Manager Tech" || Designation == "Deputy General Manager - Retired" || Designation == "GM" || Designation == "IDO/Manager")
            {
                if (n_CCA <= MaxCCAConditionalAmt)
                    ret = Convert.ToInt32(n_CCA);
                else
                    ret = MaxCCAConditionalAmt / no_of_days_mnth * workingdays;
            }

            return (decimal)Math.Round(ret, 2);
        }

        private decimal CalcSpl_Allw(decimal er_Amt, string Designation)
        {
            decimal ret = 0;

            //special Allowance
            decimal getSpecila_Allw_Min = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
           .Where(x => x["constant"].ToString() == "Special_Allw_Min")
           .Select(x => x["value"].ToString()).FirstOrDefault());

            decimal getSpecila_Allw_Mid = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
           .Where(x => x["constant"].ToString() == "Special_Allw_Mid")
           .Select(x => x["value"].ToString()).FirstOrDefault());

            decimal getSpecila_Allw_Max = decimal.Parse(dt_qryconstantsnew.Rows.Cast<DataRow>()
           .Where(x => x["constant"].ToString() == "Special_Allw_Max")
           .Select(x => x["value"].ToString()).FirstOrDefault());

            if (Designation == "Deputy General Manager" || Designation == "Assistant General Manager")
            {
                ret = er_Amt * getSpecila_Allw_Mid;
            }
            else if (Designation == "Managing Director" || Designation == "Chief General Manager" || Designation == "General Manager")
            {
                ret = er_Amt * getSpecila_Allw_Max;
            }
            else
            {
                ret = er_Amt * getSpecila_Allw_Min;
            }
            return (decimal)Math.Round(ret, 2, MidpointRounding.AwayFromZero);
        }
    }
}
